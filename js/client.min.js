function firstOfType(e,t,n,r){return n===void 0&&(n=0),r===void 0&&(r=0),kr3m.util.Util.getFirstOfType(e,t,n,r)}function log(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];kr3m.util.Log.log.apply(null,e)}function logDebug(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t]}function logVerbose(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t]}function dump(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];kr3m.util.Log.dump.apply(null,e)}function logError(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];kr3m.util.Log.logError.apply(null,e)}function logWarning(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];kr3m.util.Log.logWarning.apply(null,e)}function logFunc(e){var t=[];for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r=e+"(";for(var i=0;i<t.length;++i)t[i]=kr3m.util.Json.encode(t[i],!0);r+=t.join(", ")+")",kr3m.util.Log.log(r)}function trySafe(e){var t=[];for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];try{e.apply(void 0,t)}catch(r){kr3m.util.Log.logError(r)}}function getDevice(){return kr3m.util.Device.getInstance()}function track(){kr3m.tracking3.Track.track(arguments[0])}function tokenize(e,t,n){return n===void 0&&(n="##"),kr3m.util.Tokenizer.get(e,t,n)}function setToken(e,t){kr3m.util.Tokenizer.setToken(e,t)}function loc(e,t,n){return kr3m.util.Localization.get(e,t,n)}function locDate(e,t,n){return kr3m.util.Localization.getFormattedDate(e,t,n)}function initLoc(e,t,n){var r=e.replace(/^.*\.([^\.]+)$/,"$1").toLowerCase();kr3m.util.Localization.language=t;if(r=="xml")return kr3m.util.Localization.addXMLModuleFromUrl(e,t,n);if(r=="json"||r=="js")return kr3m.util.Localization.addJSONModuleFromUrl(e,t,n);n()}var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=n===null?Object.create(n):(r.prototype=n.prototype,new r)}}(),kr3m;(function(e){e.VERSION="1.8.3.17"})(kr3m||(kr3m={})),Function.prototype.bind||(Function.prototype.bind=function(e){if(typeof this!="function")throw new TypeError("Function.prototype.bind could not be set on legacy browser");var t=Array.prototype.slice.call(arguments,1),n=this,r=function(){},i=function(){return n.apply(this instanceof r&&e?this:e,t.concat(Array.prototype.slice.call(arguments)))};return r.prototype=this.prototype,i.prototype=new r,i}),Array.isArray||(Array.isArray=function(e){return Object.prototype.toString.call(e)==="[object Array]"}),Array.prototype.indexOf||(Array.prototype.indexOf=function(e,t){var n;if(this==null)throw new TypeError('"this" is null or not defined');var r=Object(this),i=r.length>>>0;if(i===0)return-1;var s=+t||0;Math.abs(s)===Infinity&&(s=0);if(s>=i)return-1;n=Math.max(s>=0?s:i-Math.abs(s),0);while(n<i){if(n in r&&r[n]===e)return n;n++}return-1}),Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(e,t){function o(e,t){return e===t||typeof e=="number"&&typeof t=="number"&&isNaN(e)&&isNaN(t)}if(this==null)throw new TypeError('"this" is null or not defined');var n=Object(this),r=n.length>>>0;if(r===0)return!1;var i=t|0,s=Math.max(i>=0?i:r-Math.abs(i),0);while(s<r){if(o(n[s],e))return!0;s++}return!1}}),Array.prototype.forEach||(Array.prototype.forEach=function(e,t){var n,r;if(this==null)throw new TypeError(" this is null or not defined");var i=Object(this),s=i.length>>>0;if(typeof e!="function")throw new TypeError(e+" is not a function");arguments.length>1&&(n=t),r=0;while(r<s){var o;r in i&&(o=i[r],e.call(n,o,r,i)),r++}}),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(e){if(this==null)throw new TypeError("this is null or not defined");var t=Object(this),n=t.length>>>0;if(typeof e!="function")throw new TypeError("predicate must be a function");var r=arguments[1],i=0;while(i<n){var s=t[i];if(e.call(r,s,i,t))return s;i++}return undefined}}),Array.prototype.findIndex||Object.defineProperty(Array.prototype,"findIndex",{value:function(e){if(this==null)throw new TypeError("this is null or not defined");var t=Object(this),n=t.length>>>0;if(typeof e!="function")throw new TypeError("predicate must be a function");var r=arguments[1],i=0;while(i<n){var s=t[i];if(e.call(r,s,i,t))return i;++i}return-1}}),Array.prototype.filter||(Array.prototype.filter=function(e){"use strict";if(this===void 0||this===null)throw new TypeError;var t=Object(this),n=t.length>>>0;if(typeof e!="function")throw new TypeError;var r=[],i=arguments.length>=2?arguments[1]:void 0;for(var s=0;s<n;s++)if(s in t){var o=t[s];e.call(i,o,s,t)&&r.push(o)}return r}),typeof Object.create!="function"&&(Object.create=function(){var e=function(){};return function(t){if(arguments.length>1)throw Error("Second argument not supported");if(typeof t!="object")throw TypeError("Argument must be an object");e.prototype=t;var n=new e;return e.prototype=null,n}}()),Object.keys||(Object.keys=function(){"use strict";var e=Object.prototype.hasOwnProperty,t=!{toString:null}.propertyIsEnumerable("toString"),n=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],r=n.length;return function(i){if(typeof i=="object"||typeof i=="function"&&i!==null){var s=[];for(var o in i)e.call(i,o)&&s.push(o);if(t)for(var u=0;u<r;++u)e.call(i,n[u])&&s.push(n[u]);return s}throw new TypeError("Object.keys called on non-object")}}()),typeof Element!="undefined"&&!("remove"in Element.prototype)&&(Element.prototype.remove=function(){this.parentNode&&this.parentNode.removeChild(this)});var kr3m;(function(e){e.ANDROID="ANDROID",e.IOS="IOS",e.MAX_TAB_INDEX=32767,e.PASSWORD_SECURITY_NONE=0,e.PASSWORD_SECURITY_LOW=1,e.PASSWORD_SECURITY_MEDIUM=2,e.PASSWORD_SECURITY_HIGH=3,e.FORMAT_TIME="FORMAT_TIME",e.FORMAT_DATE="FORMAT_DATE",e.FORMAT_DATETIME="FORMAT_DATETIME",e.SUCCESS="SUCCESS",e.ERROR_CANCELLED="ERROR_CANCELLED",e.ERROR_DATABASE="ERROR_DATABASE",e.ERROR_DENIED="ERROR_DENIED",e.ERROR_EMPTY_DATA="ERROR_EMPTY_DATA",e.ERROR_EXPIRED="ERROR_EXPIRED",e.ERROR_EXTERNAL="ERROR_EXTERNAL",e.ERROR_FILE="ERROR_FILE",e.ERROR_INPUT="ERROR_INPUT",e.ERROR_INTERNAL="ERROR_INTERNAL",e.ERROR_FLOOD="ERROR_FLOOD",e.ERROR_NETWORK="ERROR_NETWORK",e.ERROR_NOT_SUPPORTED="ERROR_NOT_SUPPORTED",e.ERROR_NYI="ERROR_NYI",e.ERROR_PARAMS="ERROR_PARAMS",e.ERROR_PARTIAL="ERROR_PARTIAL",e.ERROR_PENDING="ERROR_PENDING",e.ERROR_PERMISSION="ERROR_PERMISSION",e.ERROR_REQUIRED="ERROR_REQUIRED",e.ERROR_TAKEN="ERROR_TAKEN",e.ERROR_TIMEOUT="ERROR_TIMEOUT",e.ERROR_UPLOAD_COUNT="ERROR_UPLOAD_COUNT",e.ERROR_UPLOAD_SIZE="ERROR_UPLOAD_SIZE",e.ERROR_UPLOAD_DIMENSIONS="ERROR_UPLOAD_DIMENSIONS",e.ERROR_UPLOAD_TYPE="ERROR_UPLOAD_TYPE",e.ERROR_VERSIONS="ERROR_VERSIONS"})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(t){var n=function(){function t(t,n){this.status=t,this.success=this.status==e.SUCCESS,this.data=n}return t}();t.CallbackResult=n})(t=e.services||(e.services={}))})(kr3m||(kr3m={}));var kr3m;(function(e){e.REGEX_IPV4=/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/,e.REGEX_CRON=/((\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)(?:\s+(\S+))?)\s+(.+)/,e.REGEX_CRON_GROUPS=["pattern","minute","hour","dayOfMonth","month","dayOfWeek","year","command"],e.REGEX_DATA_URL=/^data:([^;]+)(?:;(base64)),(.+)$/,e.REGEX_DATA_URL_GROUPS=["mimeType","encoding","payload"],e.REGEX_DEVICE_ID=/^[A-Z]+:/,e.REGEX_EMAIL=/^[^@\s]{1,64}@[^@\s]{1,255}$/,e.REGEX_FLOAT=/^\-?\d+[,\.]?\d*$/,e.REGEX_INTEGER=/^\-?\d+$/,e.REGEX_LOCALE=/^([a-z][a-z])[_\-]?([A-Z][A-Z])$/,e.REGEX_LOCALE_GROUPS=["languageId","countryId"],e.REGEX_URL=/^(?:(http|https|ftp)\:)?(?:\/\/(?:(\w+):(\w+)@)?([^\/:#?]+)(?::(\d+))?)?([^\?#"':]*)(?:\?([^#"':]*))?(?:#(.*))?$/,e.REGEX_URL_GROUPS=["protocol","user","password","domain","port","resource","query","hash"],e.REGEX_USERNAME=/^[^<>"'&;\/]+$/,e.REGEX_WORD_SEPERATORS=/[\s!§*@$%\/\(\)\{\}=\#\[\]\\\?´`\"\'+\:;,\.<>|€\u0000]+/,e.REGEX_TIMESTAMP=/^(\d\d\d\d)\-(\d\d)\-(\d\d)[T ](\d\d)\:(\d\d)(?:\:(\d\d)(?:\.(\d\d\d)\d*)?)?(Z|[\+\-]\d\d\:\d\d)?$/,e.REGEX_TIMESTAMP_GROUPS=["year","month","day","hours","minutes","seconds","milliseconds","timezone"]})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(e){var t=function(){function t(){}return t.pad=function(e,t,n,r){n===void 0&&(n="0"),r===void 0&&(r="right");var i=e.toString(),s=n.toString();if(s.length==0)throw new Error("filler length for pad() must be greater than 0");if(r=="right")while(i.length<t)i=s+i;else if(r=="left")while(i.length<t)i+=s;else while(i.length<t)i=s+i,i.length<t&&(i+=s);return i},t.captureNamed=function(e,t,n){var r=e.match(t);if(!r)return undefined;var i={},s=Math.min(n.length,r.length-1);for(var o=0;o<s;++o)n[o]&&(i[n[o]]=r[o+1]);return i},t.toString=function(e){return e===undefined||e===null?"":e.toString()},t.captureNamedGlobal=function(e,t,n){var r=[],i=t.exec(e);while(i){var s={},o=Math.min(n.length,i.length-1);for(var u=0;u<o;++u)n[u]&&(s[n[u]]=i[u+1]);r.push(s),i=t.exec(e)}return r},t.stripBom=function(e){return e.slice(0,t.BOM.length)==t.BOM?e.slice(t.BOM.length):e},t.splitNoQuoted=function(e,t,n,r){t===void 0&&(t=","),n===void 0&&(n=['"',"'"]),r=r||n;if(n.length!=r.length)throw new Error("openingQuotes.length doesn't match closingQuotes.length");var i=-1,s=[],o=0;for(var u=0;u<e.length;++u)if(i<0){if(e.slice(u,u+t.length)==t){s.push(e.slice(o,u)),o=u+t.length,u=o-1;continue}for(var a=0;a<n.length;++a)if(e.slice(u,u+n[a].length)==n[a]){i=a;break}}else e.slice(u,u+r[i].length)==r[i]&&(i=-1);return o<e.length&&s.push(e.slice(o)),s},t.camelback=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];var n=[];for(var r=0;r<e.length;++r){var i=e[r].toString();i=i.replace(/\W+/g,"_"),n=n.concat(i.split("_"))}n.length>0&&(n[0]=n[0].toLowerCase());for(var r=1;r<n.length;++r)n[r]=n[r].slice(0,1).toUpperCase()+n[r].slice(1).toLowerCase();return n.join("")},t.camelToKebab=function(e){var t=e.split(/(?=[A-Z])/);return t.map(function(e){return e.toLowerCase()}).join("-")},t.replaceSuccessive=function(e,t,n){var r;while(r!=e)r=e,e=e.replace(t,n);return e},t.joinAssoc=function(e,t,n,r){t===void 0&&(t="&"),n===void 0&&(n="=");var i=Object.keys(e);return r?i.map(function(t){return t+n+r(e[t])}).join(t):i.map(function(t){return t+n+e[t]}).join(t)},t.splitAssoc=function(e,t,n,r){t===void 0&&(t="&"),n===void 0&&(n="=");var i={},s=e.split(t);for(var o=0;o<s.length;++o){var u=s[o].indexOf(n);if(u<0)continue;var a=s[o].substring(0,u),f=s[o].substring(u+n.length);i[a]=r?r(f):f}return i},t.joinKeys=function(e,t){t===void 0&&(t=",");var n=[];for(var r in e)n.push(r);return n.join(t)},t.joinValues=function(e,t){t===void 0&&(t=",");var n=[];for(var r in e)n.push(e[r]);return n.join(t)},t.getBefore=function(e,t,n){n===void 0&&(n=!0);var r=n?e.indexOf(t):e.lastIndexOf(t);return r>0?e.substr(0,r):e},t.getAfter=function(e,t,n){n===void 0&&(n=!0);var r=n?e.indexOf(t):e.lastIndexOf(t);return r>=0?e.substr(r+t.length):e},t.flip=function(e){var t="";for(var n=e.length-1;n>=0;--n)t+=e.charAt(n);return t},t.literalReplace=function(e,t,n){return e.split(t).join(n)},t.parseIntSafe=function(e,t){t===void 0&&(t=0);if(e===null||typeof e=="undefined")return t;var n=parseInt(e,10);return isNaN(n)&&(n=t),n},t.parseFloatSafe=function(e,t){t===void 0&&(t=0);if(e===null||typeof e=="undefined")return t;var n=parseFloat(e.replace(/,/g,"."));return isNaN(n)&&(n=t),n},t.format=function(n){var r=[];for(var i=1;i<arguments.length;i++)r[i-1]=arguments[i];var s="",o=0,u={"%":!0,n:!0,j:!0,s:!0};for(var a=0;a<n.length;++a){var f=n.charAt(a);if(f=="%"){var l=a+1;do{if(l>=n.length)return s;var c=n.charAt(l++)}while(!u[c]);var h=n.slice(a+1,l-1),p=h.match(/^([0\-\+hb]*)(\d*)\.?(\d*)([hb])*$/);if(!p)continue;var d=p[1].indexOf("0")>=0?"0":" ",v=p[1].indexOf("-")>=0,m=p[1].indexOf("+")>=0,g=t.parseIntSafe(p[2]),y=t.parseIntSafe(p[3]),b=10;if(p[1]&&p[1].indexOf("h")>=0||p[4]&&p[4].indexOf("h")>=0)b=16;else if(p[1]&&p[1].indexOf("b")>=0||p[4]&&p[4].indexOf("b")>=0)b=2;var w;switch(c){case"%":if(h==""){s+="%",++a;continue}break;case"n":w=(y>0?r[o++].toFixed(y):r[o++]).toString(b);break;case"s":w=r[o++].toString();break;case"j":w=e.Json.encode(r[o++])}w=w||"";if(m){var E=!1;while(w.length<g)E?w+=d:w=d+w,E=!E}else if(v)while(w.length<g)w+=d;else while(w.length<g)w=d+w;s+=w,a=l-1}else s+=f}return s},t.getVersionParts=function(e,n){n===void 0&&(n=0);var r=e.split(".").map(function(e){return t.parseIntSafe(e)});while(r.length<n)r.push(0);return r},t.splitArguments=function(e){var t=e.split(" ");for(var n=0;n<t.length;++n){var r=t[n].slice(0,1);if(r=="'"||r=='"'){for(var i=n+1;i<t.length;++i){t[n]+=" "+t[i];if(t[i].slice(-1)==r)break}t.splice(n+1,i-n)}else t[n]=t[n].trim();t[n]==""&&t.splice(n--,1)}return t},t.getCliParams=function(e,t){t===void 0&&(t={});var n={values:[]};for(var r=0;r<e.length;++r){var i=t[e[r]];if(i){var s=i.name||e[r],o=i.count||0;if(o==0)n[s]=[];else if(o==1)n[s]=e[++r];else{n[s]=[];for(var u=0;u<o;++u)n[s].push(e[++r])}}else n.values.push(e[r])}return n},t.wrapText=function(e,t,n,r){t===void 0&&(t=80),n===void 0&&(n=""),r===void 0&&(r="");if(t<0)return e;var i=e.split(" ");if(i.length==0)return e;var s="",o=i[0],u=i.length;for(var a=1;a<u;++a)o.length+1+i[a].length<=t?o+=" "+i[a]:(s+=n+o+r+"\n",o=i[a]);return s+=n+o+r,s},t.sortCaseIndependant=function(e){e.sort(function(e,t){return e.trim().localeCompare(t.trim())})},t.getUnitString=function(e,t,n){n===void 0&&(n=0);if(e==0)return"0"+(Object.keys(t)[0]||"");var r=[];for(var i in t){var s=e%t[i];s>0&&r.unshift(s+i),e=Math.floor(e/t[i])}return n>0&&(r=r.slice(0,n)),r.join(" ")},t.bigNumber=function(e,n){n===void 0&&(n=0);var r={"":1e3,k:1e3,M:1e3,G:1e3,T:1e3,P:1e3,E:1e3,Z:1e3,Y:1e3,ALOT:1e8};return t.getUnitString(e,r,n)},t.getSizeString=function(e,n,r){n===void 0&&(n=!1),r===void 0&&(r=0);var i=n?{Bi:1024,kiB:1024,MiB:1024,GiB:1024,TiB:1024,PiB:1024,EiB:1024,ZiB:1024,YiB:1024,ALOTi:1e8}:{B:1e3,kB:1e3,MB:1e3,GB:1e3,TB:1e3,PB:1e3,EB:1e3,ZB:1e3,YB:1e3,ALOT:1e8};return t.getUnitString(e,i,r)},t.getDurationString=function(e,n){n===void 0&&(n=0);var r={ms:1e3,s:60,m:60,h:24,d:7,w:52,y:100,centuries:10,millenia:1e3,ages:1e8};return t.getUnitString(e,r,n)},t.BOM="\ufeff",t}();e.StringEx=t})(t=e.util||(e.util={}))})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(t){var n=function(){function n(){}return n.isDate=function(e){return typeof e=="object"&&e instanceof Date&&!isNaN(e.valueOf())},n.isTimestamp=function(e){return n.isDate(e)&&e.getTime()>=0},n.getDateString=function(e,t){e===void 0&&(e=new Date),t===void 0&&(t=n.USE_UTC);if(t){var r=e.getUTCFullYear()+"-",i=e.getUTCMonth()+1;r+=i<10?"0"+i:""+i;var s=e.getUTCDate();return r+="-"+(s<10?"0"+s:""+s),r}var r=e.getFullYear()+"-",i=e.getMonth()+1;r+=i<10?"0"+i:""+i;var s=e.getDate();return r+="-"+(s<10?"0"+s:""+s),r},n.getTimeString=function(e,t,r){e===void 0&&(e=new Date),t===void 0&&(t=n.USE_UTC),r===void 0&&(r=!1);if(t){var i="",s=e.getUTCHours();i+=s<10?"0"+s:""+s;var o=e.getUTCMinutes();i+=":"+(o<10?"0"+o:""+o);var u=e.getUTCSeconds();i+=":"+(u<10?"0"+u:""+u);if(r){var a=e.getUTCMilliseconds();i+="."+(a<10?"00"+a:a<100?"0"+a:""+a)}return i+"Z"}var i="",s=e.getHours();i+=s<10?"0"+s:""+s;var o=e.getMinutes();i+=":"+(o<10?"0"+o:""+o);var u=e.getSeconds();i+=":"+(u<10?"0"+u:""+u);if(r){var a=e.getMilliseconds();i+="."+(a<10?"00"+a:a<100?"0"+a:""+a)}return i},n.getDateFromDateTimeString=function(n){if(n&&n instanceof Date)return n;if(!n||typeof n!="string")return null;var r=t.StringEx.captureNamed(n,e.REGEX_TIMESTAMP,e.REGEX_TIMESTAMP_GROUPS);if(!r)return null;r.seconds=r.seconds||"0",r.milliseconds=r.milliseconds||"0";var i=new Date;if(r.timezone=="Z")i.setUTCFullYear(parseInt(r.year,10),parseInt(r.month,10)-1,parseInt(r.day,10)),i.setUTCHours(parseInt(r.hours,10),parseInt(r.minutes,10),parseInt(r.seconds,10),parseInt(r.milliseconds,10));else if(r.timezone&&r.timezone.length==6){var s=parseInt(r.timezone.slice(1,3),10),o=parseInt(r.timezone.slice(4,5),10);r.timezone.charAt(0)=="-"&&(s*=-1,o*=-1),i.setUTCFullYear(parseInt(r.year,10),parseInt(r.month,10)-1,parseInt(r.day,10)),i.setUTCHours(parseInt(r.hours,10)-s,parseInt(r.minutes,10)-o,parseInt(r.seconds,10),parseInt(r.milliseconds,10))}else i.setFullYear(parseInt(r.year,10),parseInt(r.month,10)-1,parseInt(r.day,10)),i.setHours(parseInt(r.hours,10),parseInt(r.minutes,10),parseInt(r.seconds,10),parseInt(r.milliseconds,10));return i},n.getDateFromDateString=function(e){if(!e||typeof e!="string")return null;var t=e.match(/^(\d\d\d\d)\-(\d\d)\-(\d\d)$/);if(!t)return null;var n=new Date;return n.setFullYear(parseInt(t[1],10),parseInt(t[2],10)-1,parseInt(t[3],10)),n.setHours(0,0,0,0),n},n.getDateTimeString=function(e,t,r){return e===void 0&&(e=new Date),t===void 0&&(t=n.USE_UTC),r===void 0&&(r=!1),this.getDateString(e,t)+" "+this.getTimeString(e,t,r)},n.getToday=function(e){return e===void 0&&(e=n.USE_UTC),this.getDateString(new Date,e)},n.getYesterday=function(e){e===void 0&&(e=n.USE_UTC);var t=new Date;return t.setUTCDate(t.getUTCDate()-1),this.getDateString(t,e)},n.getTomorrow=function(e){e===void 0&&(e=n.USE_UTC);var t=new Date;return t.setUTCDate(t.getUTCDate()+1),this.getDateString(t,e)},n.getNow=function(e){return e===void 0&&(e=n.USE_UTC),this.getDateTimeString(new Date,e)},n.areSameDay=function(e,t){return e.getUTCFullYear()!=t.getUTCFullYear()?!1:e.getUTCMonth()!=t.getUTCMonth()?!1:e.getUTCDate()!=t.getUTCDate()?!1:!0},n.getSomeDaysAgo=function(e,t){var n=new Date(e.getTime());return n.setUTCDate(n.getUTCDate()-t),n},n.getSomeMonthsAgo=function(e,t){var n=new Date(e.getTime());return n.setUTCMonth(n.getUTCMonth()-t),n},n.getAgeInYears=function(e){if(!e)return-1;var t=new Date,n=t.getFullYear()-e.getFullYear(),r=t.getMonth()-e.getMonth(),i=t.getDate()-e.getDate(),s=n;return(r<0||r==0&&i<0)&&--s,s},n.max=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];if(e.length==0)return null;var n=e[0];for(var r=1;r<e.length;++r)e[r]>n&&(n=e[r]);return n},n.min=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];if(e.length==0)return null;var n=e[0];for(var r=1;r<e.length;++r)e[r]<n&&(n=e[r]);return n},n.getCalendarWeek=function(e,t){e===void 0&&(e=new Date),t===void 0&&(t=n.USE_UTC);if(t){var r=new Date(e.getTime()+(3-(e.getUTCDay()+6)%7)*864e5),i=r.getUTCFullYear(),s=new Date(0);s.setUTCFullYear(i,0,4);var o=new Date(s.getTime()+(3-(s.getUTCDay()+6)%7)*864e5),u=Math.floor(1.5+(r.getTime()-o.getTime())/864e5/7);return u}var r=new Date(e.getTime()+(3-(e.getDay()+6)%7)*864e5),i=r.getFullYear(),o=new Date(new Date(i,0,4).getTime()+(3-(new Date(i,0,4).getDay()+6)%7)*864e5),u=Math.floor(1.5+(r.getTime()-o.getTime())/864e5/7);return u},n.getCalendarWeekYear=function(e,t){e===void 0&&(e=new Date),t===void 0&&(t=n.USE_UTC);var r=t?e.getUTCFullYear():e.getFullYear(),i=n.getCalendarWeek(e,t);return i<52?r:e.getMonth()>6?r:r-1},n.getFirstOfWeek=function(e,t){e===void 0&&(e=new Date),t===void 0&&(t=n.USE_UTC);var r=new Date(e.getTime());return t?(r.setUTCDate(r.getUTCDate()-(r.getUTCDay()+6)%7),r.setUTCHours(0,0,0,0)):(r.setDate(r.getDate()-(r.getDay()+6)%7),r.setHours(0,0,0,0)),r},n.getFirstOfMonth=function(e,t){t===void 0&&(t=n.USE_UTC);var r=new Date(e.getTime());return t?(r.setUTCDate(1),r.setUTCHours(0,0,0,0)):(r.setDate(1),r.setHours(0,0,0,0)),r},n.getLastOfMonth=function(e,t){t===void 0&&(t=n.USE_UTC);var r=new Date(e.getTime());return t?(r.setUTCDate(1),r.setUTCMonth(r.getUTCMonth()+1),r.setUTCDate(0),r.setUTCHours(0,0,0,0)):(r.setDate(1),r.setMonth(r.getMonth()+1),r.setDate(0),r.setHours(0,0,0,0)),r},n.areClose=function(e,t,n){return n===void 0&&(n=1e3),!e||!t?!1:Math.abs(e.getTime()-t.getTime())<=n},n.getMonthDays=function(e){e===void 0&&(e=new Date);var t=new Date(e.getFullYear(),e.getMonth()+1,0);return t.getDate()},n.delta=function(e,t,n,r,i,s,o,u,a){t===void 0&&(t=0),n===void 0&&(n=0),r===void 0&&(r=0),i===void 0&&(i=0),s===void 0&&(s=0),o===void 0&&(o=0),u===void 0&&(u=0),a===void 0&&(a=!0);var f=new Date(e.getTime());f.setUTCFullYear(f.getUTCFullYear()+t);if(a){var l=f.getUTCMonth();f.setUTCMonth(l+n);var c=f.getUTCMonth();(l+n)%12!=c&&f.setUTCDate(0)}else f.setUTCMonth(f.getUTCMonth()+n);return f.setUTCDate(f.getUTCDate()+r),f.setUTCHours(f.getUTCHours()+i),f.setUTCMinutes(f.getUTCMinutes()+s),f.setUTCSeconds(f.getUTCSeconds()+o),f.setUTCMilliseconds(f.getUTCMilliseconds()+u),f},n.USE_UTC=!1,n}();t.Dates=n})(t=e.util||(e.util={}))})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(t){var n=function(){function t(){}return t.moveElement=function(e,t,n){t<0&&(t+=e.length),t=Math.max(t,0),n<0&&(n+=e.length),n=Math.min(n,e.length-1);if(t==n)return;var r=e[t];t<n?e.copyWithin(t,t+1,n+1):e.copyWithin(n+1,n,t),e[n]=r},t.equal=function(e,n,r){r===void 0&&(r=1e3);if(r<0)return!0;if(!e!=!n)return!1;if(!e&&!n)return!0;--r;if(typeof e!="object"||typeof n!="object")return e===n;if(!e!=!n)return!1;if(typeof e.equals=="function")return e.equals(n);if((e.length||n.length)&&e.length!=n.length)return!1;if(e instanceof Date&&n instanceof Date)return e.getTime()==n.getTime();for(var i in e)if(!t.equal(e[i],n[i],r))return!1;for(var i in n)if(!t.equal(e[i],n[i],r))return!1;return!0},t.fieldsMatch=function(e,n,r,i){i===void 0&&(i=!1);if(!e||!n)return!1;if(i){for(var s=0;s<r.length;++s)if(t.getProperty(e,r[s])!==t.getProperty(n,r[s]))return!1}else for(var s=0;s<r.length;++s)if(t.getProperty(e,r[s])!=t.getProperty(n,r[s]))return!1;return!0},t.clone=function(e){if(!e||typeof e!="object")return e;if(e instanceof Date)return new Date(e.getTime());var n=typeof e["length"]=="number"?[]:e.__proto__?Object.create(e.__proto__):{},r=Object.keys(e);for(var i=0;i<r.length;++i)typeof e[r[i]]=="object"?n[r[i]]=t.clone(e[r[i]]):n[r[i]]=e[r[i]];return n},t.encodeHtml=function(e){return e?(e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),e):e},t.decodeHtml=function(e){var t={nbsp:" ",amp:"&",lt:"<",gt:">",quot:'"'};return e=e.replace(/&(#?\w+?);/g,function(e,n){if(t[n])return t[n];try{if(n.charAt(0)=="#")return String.fromCharCode(parseInt(n.slice(1)))}catch(r){}return e}),e},t.reverse=function(e){e=e.slice();var t=Math.floor(e.length/2),n=e.length-1;for(var r=0;r<t;++r)i=[e[n-r],e[r]],e[r]=i[0],e[n-r]=i[1];return e;var i},t.contains=function(e,t,n){n===void 0&&(n=!1);if(!e||e.length<=0)return!1;for(var r=0;r<e.length;++r)if(e[r]===t||!n&&e[r]==t)return!0;return!1},t.remove=function(e,t,n){n===void 0&&(n=!1);for(var r=0;r<e.length;++r)if(e[r]===t||!n&&e[r]==t)return e.splice(r,1)[0];return null},t.difference=function(e){var n=[];for(var r=1;r<arguments.length;r++)n[r-1]=arguments[r];var i=e.slice(0);for(var s=0;s<i.length;++s)for(var o=0;o<n.length;++o)if(t.contains(n[o],i[s])){i.splice(s--,1);break}return i},t.intersect=function(){var e=[];for(var n=0;n<arguments.length;n++)e[n]=arguments[n];var r=t.merge.apply(t,e);for(var i=0;i<r.length;++i)for(var s=0;s<e.length;++s)if(!t.contains(e[s],r[i])){r.splice(i--,1);break}return r},t.merge=function(){var e=[];for(var n=0;n<arguments.length;n++)e[n]=arguments[n];var r=[];for(var i=0;i<e.length;++i)for(var s in e[i])t.contains(r,e[i][s])||r.push(e[i][s]);return r},t.mergeAssoc=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];var n={};for(var r=0;r<e.length;++r){if(!e[r])continue;for(var i in e[r])n[i]=e[r][i]}return n},t.getProperty=function(e,t){var n=t.split(".");while(n.length>0){if(!e)return undefined;e=e[n.shift()]}return e},t.getPropertyAndGetter=function(e,t){if(t=="")return e;var n=t.split(".");while(n.length>0){if(!e)return undefined;var r=n.shift();r.substr(r.length-2,2)=="()"?e=e[r.substr(0,r.length-2)]():e=e[r]}return e},t.setProperty=function(e,t,n){var r=t.split(".");while(r.length>1){var i=r.shift();if(e[i]===undefined||e[i]===null){var s=parseInt(r[0],10);if(isNaN(s))e[i]={};else{e[i]=[];for(var o=-1;o<s;++o)e[i].push(undefined)}}e=e[i]}e[r[0]]=n},t.deleteProperty=function(e,t){var n=t.split(".");while(n.length>1){var r=n.shift();if(e[r]===undefined||e[r]===null)return;e=e[r]}delete e[n[0]]},t.findBy=function(e,n,r,i,s){i===void 0&&(i=0),s===void 0&&(s=!1);if(!e)return-1;if(s){for(var o=i;o<e.length;++o)if(t.getProperty(e[o],n)===r)return o}else for(var o=i;o<e.length;++o)if(t.getProperty(e[o],n)==r)return o;return-1},t.findWhere=function(e,n,r,i){r===void 0&&(r=0),i===void 0&&(i=!1);if(!e)return-1;if(i)for(var s=r;s<e.length;++s){var o=!0;for(var u in n)if(t.getProperty(e[s],u)!==n[u]){o=!1;break}if(o)return s}else for(var s=r;s<e.length;++s){var o=!0;for(var u in n)if(t.getProperty(e[s],u)!=n[u]){o=!1;break}if(o)return s}return-1},t.getBy=function(e,n,r,i,s){i===void 0&&(i=0),s===void 0&&(s=!1);var o=t.findBy(e,n,r,i,s);return o>=0?e[o]:undefined},t.mapAssoc=function(e,t){var n={};for(var r=0;r<e.length;++r){var i=t(e[r],r),s=i[0],o=i[1];n[s]=o}return n},t.combine=function(e,t){if(e.length!=t.length)throw new Error("keys.length doesn't match values.length");var n={};for(var r=0;r<e.length;++r)n[e[r]]=t[r];return n},t.getAllBy=function(e,n,r){if(!e)return[];var i=[];for(var s=0;s<e.length;++s)t.getProperty(e[s],n)==r&&i.push(e[s]);return i},t.removeBy=function(e,n,r){var i=[];if(!e)return i;for(var s=0;s<e.length;++s)t.getProperty(e[s],n)==r&&(i=i.concat(e.splice(s--,1)));return i},t.gather=function(e,t,n){var r=[],i=t.split(".");if(n){for(var s in e)if(n(e[s])){var o=e[s];for(var u=0;u<i.length;++u)o=o[i[u]];r.push(o)}}else for(var s in e){var o=e[s];for(var u=0;u<i.length;++u)o=o[i[u]];r.push(o)}return r},t.gatherUnique=function(e,n,r){return t.removeDuplicates(t.gather(e,n,r))},t.removeDuplicates=function(e){var t=[];for(var n=0;n<e.length;++n)t.indexOf(e[n])<0&&t.push(e[n]);return t},t.arrayToAssoc=function(e,n){n===void 0&&(n="id");var r={};for(var i=0;i<e.length;++i){var s=t.getProperty(e[i],n);r[s]=e[i]}return r},t.arrayToPairs=function(e,n,r){var i={};for(var s in e){var o=t.getProperty(e[s],n),u=t.getProperty(e[s],r);i[o]=u}return i},t.arrayToSet=function(e,t){t===void 0&&(t=!0);var n={};for(var r=0;r<e.length;++r)n[e[r]]=t;return n},t.assocToArray=function(e){var t=[];for(var n in e)t.push(e[n]);return t},t.filter=function(e,t,n){for(var r=0;r<t.length;++r)if(t[r]==e)return e;return n},t.filterKey=function(e,t,n){return n===void 0&&(n=null),typeof t[e]!="undefined"?e:n},t.filterAssoc=function(e,t){var n={};for(var r in e)t(e[r],r)&&(n[r]=e[r]);return n},t.sortBy=function(){var e=arguments[0],n;typeof arguments[1]=="string"?(n={},n[arguments[1]]=arguments[2]===undefined?!0:arguments[2]):n=arguments[1],e.sort(function(e,r){for(var i in n){var s=t.getProperty(e,i),o=t.getProperty(r,i);if(s<o)return n[i]?-1:1;if(s>o)return n[i]?1:-1}return 0})},t.sortAssocByKey=function(e,t){t=t||function(e,t){return e.localeCompare(t)};var n=Object.keys(e);n.sort(t);var r={};for(var i=0;i<n.length;++i)r[n[i]]=e[n[i]];return r},t.sortAssocByValue=function(e,t){t=t||function(e,t){return e.toString().localeCompare(t.toString())};var n=Object.keys(e);n.sort(function(n,r){return t(e[n],e[r])});var r={};for(var i=0;i<n.length;++i)r[n[i]]=e[n[i]];return r},t.sortIndicesBy=function(e,n,r){r===void 0&&(r=!0);var i=r?1:-1,s=[];for(var o=0;o<e.length;++o)s.push(o);return s.sort(function(r,s){var o=t.getProperty(e[r],n),u=t.getProperty(e[s],n);return o>u?i:o<u?-i:0}),s},t.bucketBy=function(e,n){var r={};for(var i=0;i<e.length;++i){var s=t.getProperty(e[i],n);r[s]||(r[s]=[]),r[s].push(e[i])}return r},t.bucketByMap=function(e,n,r){var i=t.bucketBy(e,n),s={};for(var o in i)s[o]=i[o].map(r);return s},t.bucketByRecursive=function(e){var n=[];for(var r=1;r<arguments.length;r++)n[r-1]=arguments[r];if(n.length==0)return undefined;var i=n.shift(),s=t.bucketBy(e,i);if(n.length>0)for(var o in s)s[o]=t.bucketByRecursive.apply(t,[s[o]].concat(n));return s},t.bucketAssocBy=function(e,n){var r={};for(var i in e){var s=t.getProperty(e[i],n);r[s]||(r[s]=[]),r[s].push(e[i])}return r},t.forEachRecursive=function(n,r){if(!n||typeof n!="object")return;var i=Object.keys(n);while(i.length>0){var s=i.pop(),o=t.getProperty(n,s),u=o?typeof o:"null";switch(u){case"object":if(e.util.Dates.isDate(o))r(s,o,n);else{var a=Object.keys(o);for(var f=0;f<a.length;++f)i.push(s+"."+a[f])}break;default:r(s,o,n)}}},t.mergeAssocRecursive=function(){var e=[];for(var n=0;n<arguments.length;n++)e[n]=arguments[n];var r={};for(var i=0;i<e.length;++i)t.forEachRecursive(e[i],function(e,n){return t.setProperty(r,e,n)});return r},t.getFirstInstanceOf=function(e,t,n,r){n===void 0&&(n=0),r===void 0&&(r=0);for(var i=n;i<e.length;++i)if(e[i]instanceof t){if(r<=0)return e[i];--r}return undefined},t.getFirstOfType=function(e,t,n,r){n===void 0&&(n=0),r===void 0&&(r=0);for(var i=n;i<e.length;++i)if(typeof e[i]==t){if(r<=0)return e[i];--r}return undefined},t.getAllInstancesOf=function(e,t,n){n===void 0&&(n=0);var r=[];for(var i=n;i<e.length;++i)e[i]instanceof t&&r.push(e[i]);return r},t.getAllOfType=function(e,t,n){n===void 0&&(n=0);var r=[];for(var i=n;i<e.length;++i)typeof e[i]==t&&r.push(e[i]);return r},t.rearrange=function(e,t){var n=[];for(var r=0;r<t.length;++r)n.push(e[t[r]]);return n=n.concat(e.slice(t.length)),n},t.fill=function(){var e=[];if(typeof arguments[1]=="function")for(var t=0;t<arguments[0];++t)e.push(arguments[1](t));else for(var t=0;t<arguments[0];++t)e.push(arguments[1]);return e},t}();t.Util=n})(t=e.util||(e.util={}))})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(t){var n=function(){function n(){}return n.breakCircular=function(e){if(!e||typeof e!="object"||e instanceof Date)return e;var n=[],r=[],i=[e];while(i.length>0){var s=i.shift();n.push(s);for(var o in s){if(typeof s[o]!="object"||s[o]instanceof Date)continue;n.indexOf(s[o])>=0?r.push(s[o]):i.push(s[o])}}if(r.length==0)return e;var u=typeof e["length"]=="number"?[]:{},a=[{prefix:"",value:e}];while(a.length>0){var s=a.shift();for(var o in s.value){if(r.indexOf(s.value[o])>=0){t.Util.setProperty(u,s.prefix+o,"[CYCLICAL]");continue}typeof s.value[o]!="object"||s.value[o]instanceof Date?t.Util.setProperty(u,s.prefix+o,s.value[o]):a.push({value:s.value[o],prefix:s.prefix+o+"."})}}return u},n.encode=function(e,t){return t===void 0&&(t=!1),t&&(e=n.breakCircular(e)),JSON.stringify(e)},n.encodeNice=function(e,t,r){t===void 0&&(t=""),r===void 0&&(r=!1),r&&(e=n.breakCircular(e));if(typeof e!="object"||e instanceof Date||e===null)return t+n.encode(e);var i="";if(typeof e.length=="number"){if(e.length===0)return t+"[]";i+=t+"[";for(var s=0;s<e.length;++s)i+="\n"+n.encodeNice(e[s],t+"  ")+",";e.length>0&&(i=i.slice(0,-1)),i+="\n"+t+"]"}else{i+=t+"{";for(var o in e)typeof e[o]!="object"||e instanceof Date||e[o]===null?i+="\n  "+t+'"'+o+'":'+n.encode(e[o])+",":i+="\n  "+t+'"'+o+'":\n'+n.encodeNice(e[o],t+"  ")+",";i.slice(-1)==","&&(i=i.slice(0,-1)),i+="\n"+t+"}"}return i},n.escapeSpecialChars=function(e){return e.replace(/[\u0080-\uffff]/g,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})},n.reviver=function(t,n){if(typeof n=="string"){var r=e.util.Dates.getDateFromDateTimeString(n);if(r)return r}return n},n.isJSON=function(e){if(!e)return!1;try{return JSON.parse(e),!0}catch(t){return!1}},n.decode=function(e){if(!e)return null;try{return JSON.parse(e,n.reviver)}catch(t){return null}},n.mergeAssoc=function(){var e=[];for(var r=0;r<arguments.length;r++)e[r]=arguments[r];var i=e.map(function(e){return n.decode(e)}),s=t.Util.mergeAssoc.apply(t.Util,i);return n.encode(s)},n}();t.Json=n})(t=e.util||(e.util={}))})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(e){var t=function(){function e(){}return e.logError=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(!e.enabled||typeof console=="undefined"||typeof console.error=="undefined")return;if(t.length==1&&t[0]instanceof Error)throw typeof t[0].stack!="undefined"&&typeof window["chrome"]=="undefined"?t[0].stack:t[0];try{console.error.apply(console,t)}catch(r){console.error(t)}},e.log=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(!e.enabled||typeof console=="undefined"||typeof console.log=="undefined")return;try{console.log.apply(console,t)}catch(r){console.log(t)}},e.logWarning=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(!e.enabled||typeof console=="undefined"||typeof console.warn=="undefined")return;if(t.length==1&&t[0]instanceof Error)throw typeof t[0].stack!="undefined"&&typeof window["chrome"]=="undefined"?t[0].stack:t[0];try{console.warn.apply(console,t)}catch(r){console.warn(t)}},e.logDebug=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t]},e.logVerbose=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t]},e.dump=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t]},e.stackTrace=function(e,t){e===void 0&&(e=!1),t===void 0&&(t=0);var n=new Error,r=n.stack.split(/\s+at\s+/).slice(t+1);return r.join("\n")},e.logStackTrace=function(t,n){t===void 0&&(t=!1),n===void 0&&(n=0),e.log(e.stackTrace(t))},e.enabled=!0,e}();e.Log=t})(t=e.util||(e.util={}))})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(t){var n=function(){function t(){}return t.call=function(t,n,r,i){i=i||r;var s=!1,o,u=function(){s||(clearTimeout(o),r.apply(null,arguments))};o=setTimeout(function(){s=!0,i()},t);try{n(u)}catch(a){e.util.Log.logDebug(a.toString()),s=!0,clearTimeout(o),i()}},t}();t.Timeout=n})(t=e.async||(e.async={}))})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(e){function t(t){var n=[];for(var r=1;r<arguments.length;r++)n[r-1]=arguments[r];try{t.apply(void 0,n)}catch(i){e.Log.logError(i)}}e.trySafe=t})(t=e.util||(e.util={}))})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(t){var n=function(){function t(){this.done=!1,this.pendingCalls=[]}return t.prototype.execute=function(){for(var t=0;t<this.pendingCalls.length;++t)e.util.trySafe(this.pendingCalls[t].func);this.pendingCalls=[],this.done=!0},t.prototype.call=function(e,t,n){n===void 0&&(n=0);if(this.done){e();return}if(t)for(var r=0;r<this.pendingCalls.length;++r)if(this.pendingCalls[r].key==t){if(this.pendingCalls[r].priority>=n)return;this.pendingCalls.splice(r--,1)}this.pendingCalls.push({func:e,key:t,priority:n})},t.prototype.isDone=function(){return this.done},t.prototype.reset=function(e){e===void 0&&(e=!1),this.done=!1,e&&(this.pendingCalls=[])},t}();t.Delayed=n})(t=e.async||(e.async={}))})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(t){var n=function(){function t(){}return t.loop=function(e,n){var r=0,i=-1,s=function(o){if(o||o===undefined){++r;if(r<t.MAX_SYNC_ITERATIONS)return e(s,++i);r=0,setTimeout(s,0);return}n&&n()};s(!0)},t.times=function(e,n,r,i){i===void 0&&(i=1);if(e<1)return r&&r();var s=0,o=Math.min(i,e),u=o,a=[],f=[],l=function(i){--o;if(s<e){++o,++f[i];var u=s++;if(f[i]<t.MAX_SYNC_ITERATIONS)return n(a[i],u);f[i]=0,setTimeout(function(){return n(a[i],u)},0)}else r&&o==0&&r()};for(var c=0;c<u;++c)f[c]=0,a[c]=l.bind(null,c),a[c]()},t.forEach=function(e,n,r,i){i===void 0&&(i=1);if(!e||e.length==0)return r&&r();var s=0,o=Math.min(i,e.length),u=o,a=[],f=[],l=function(i){--o;if(s<e.length){++o,++f[i];var u=s++;if(f[i]<t.MAX_SYNC_ITERATIONS)return n(e[u],a[i],u);f[i]=0,setTimeout(function(){return n(e[u],a[i],u)},0)}else r&&o==0&&r()};for(var c=0;c<u;++c)f[c]=0,a[c]=l.bind(null,c),a[c]()},t.map=function(e,n,r,i){i===void 0&&(i=1);var s=[];t.forEach(e,function(e,t,r){n(e,function(e){return s[r]=e},r)},function(){return r(s)},i)},t.forEachAssoc=function(t,n,r,i){i===void 0&&(i=1);if(!t)return r&&r();var s=Object.keys(t);e.async.Loop.forEach(s,function(e,r){n(e,t[e],r)},r,i)},t.forEachBatch=function(e,n,r,i,s){s===void 0&&(s=1);if(!e||e.length==0)return i&&i();var o=0,u=Math.min(s,Math.ceil(e.length/n)),a=u,f=[],l=[],c=function(s){--u;if(o<e.length){++u,++l[s];var a=o,c=e.slice(o,o+n);o+=c.length;if(l[s]<t.MAX_SYNC_ITERATIONS)return r(c,f[s],a);l[s]=0,setTimeout(function(){return r(c,f[s],a)},0)}else i&&u==0&&i()};for(var h=0;h<a;++h)l[h]=0,f[h]=c.bind(null,h),f[h]()},t.MAX_SYNC_ITERATIONS=200,t}();t.Loop=n})(t=e.async||(e.async={}))})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(e){var t=function(){function e(e){e=e||{},e.document=e.document||document,e.navigator=e.navigator||navigator,e.window=e.window||window;try{e.localStorage=e.localStorage||localStorage}catch(t){}this.checkOS(e),this.checkBrowser(e),this.checkDevice(e),this.checkFeatures(e),this.checkAudio(e),this.checkTablet(e),this.mobile=!this.desktop&&!this.tablet}return e.getInstance=function(){var t=e;return typeof t.instance=="undefined"&&(t.instance=new e),t.instance},e.prototype.canPlayAudio=function(e){switch(e){case"ogg":return this.ogg;case"opus":return this.opus;case"mp3":return this.mp3;case"wav":return this.wav;case"m4a":return this.m4a;case"webm":return this.webm}return!1},e.prototype.checkOS=function(e){var t=e.navigator.userAgent;if(/Playstation Vita/.test(t))this.vita=!0,this.desktop=!1;else if(/Kindle/.test(t)||/\bKF[A-Z][A-Z]+/.test(t)||/Silk.*Mobile Safari/.test(t))this.kindle=!0,this.desktop=!1;else if(/Android/.test(t))this.android=!0,this.desktop=!1,this.checkAndroidVersion(e);else if(/CrOS/.test(t))this.chromeOS=!0;else if(/iP[ao]d|iPhone/i.test(t)){this.iOS=!0,this.desktop=!1;var n=t.match(/OS (\d+)_/i);n&&(this.iOSVersion=parseInt(n[1],10)),/OS 11_/i.test(t)?this.iOS11=!0:/OS 10_/i.test(t)?this.iOS10=!0:/OS 9_/i.test(t)&&(this.iOS9=!0)}else/Linux/.test(t)?this.linux=!0:/Mac OS/.test(t)?this.macOS=!0:/Windows/.test(t)&&(this.windows=!0,/Windows Phone/i.test(t)&&(this.windowsPhone=!0));if(this.windows||this.macOS||this.linux&&!this.silk||this.chromeOS)this.desktop=!0;if(this.windowsPhone||/Windows NT/i.test(t)&&/Touch/i.test(t))this.desktop=!1},e.prototype.checkFeatures=function(e){this.canvas=!!e.window.CanvasRenderingContext2D;try{this.localStorage=!!e.localStorage.getItem}catch(t){this.localStorage=!1}this.file=!!e.window.File&&!!e.window.FileReader&&!!e.window.FileList&&!!e.window.Blob,this.fileSystem=!!e.window.requestFileSystem,this.webGL=!this.chromeHeadless&&function(){try{var t=e.document.createElement("canvas");t.screencanvas=!1;var n={failIfMajorPerformanceCaveat:!0};return!!e.window.WebGLRenderingContext&&(t.getContext("webgl",n)||t.getContext("experimental-webgl",n))}catch(r){return!1}}(),this.webGL=!!this.webGL;if("ontouchstart"in e.document.documentElement||e.navigator.maxTouchPoints&&e.navigator.maxTouchPoints>1)this.touch=!0;if(e.navigator.msPointerEnabled||e.navigator.pointerEnabled)this.mspointer=!0;this.pointerLock="pointerLockElement"in e.document||"mozPointerLockElement"in e.document||"webkitPointerLockElement"in e.document,this.quirksMode=e.document.compatMode==="CSS1Compat"?!1:!0},e.prototype.checkBrowser=function(e){var t=e.navigator.userAgent;/Instagram/.test(t)?(this.inApp=!0,this.instagramApp=!0):/FBAV/.test(t)?(this.inApp=!0,this.fbApp=!0):/Arora/.test(t)?this.arora=!0:/Edge\/\d+/.test(t)?this.edge=!0:/Chrome/.test(t)?(this.chrome=!0,this.chromeHeadless=/HeadlessChrome/.test(t),this.checkChromeVersion(t)):/CriOS/.test(t)?(this.iOSChrome=!0,this.checkChromeVersion(t)):/Epiphany/.test(t)?this.epiphany=!0:/Firefox/.test(t)?(this.firefox=!0,this.checkFirefoxVersion(t)):/AppleWebKit/.test(t)&&this.iOS?this.mobileSafari=!0:/MSIE (\d+\.\d+);/.test(t)?(this.ie=!0,this.ieVersion=parseInt(RegExp.$1,10)):/Midori/.test(t)?this.midori=!0:/Opera/.test(t)?this.opera=!0:/Safari/.test(t)?this.safari=!0:/Trident\/(\d+\.\d+)(.*)rv:(\d+\.\d+)/.test(t)&&(this.ie=!0,this.trident=!0,this.tridentVersion=parseInt(RegExp.$1,10),this.ieVersion=parseInt(RegExp.$3,10)),this.silk=/Silk/.test(t),e.navigator.standalone&&(this.webApp=!0);var n=e.navigator.userAgent.match(/Android.*AppleWebKit\/([\d.]+)/);this.androidStockBrowser=n?parseInt(n[1],10)<537:!1},e.prototype.checkDevice=function(e){this.pixelRatio=e.window.devicePixelRatio||1,this.iPhone=e.navigator.userAgent.toLowerCase().indexOf("iphone")!=-1,this.iPhone4=this.pixelRatio==2&&this.iPhone,this.iPhone5=this.pixelRatio==2&&this.iPhone&&screen.availHeight==548,this.iPad=e.navigator.userAgent.toLowerCase().indexOf("ipad")!=-1},e.prototype.checkAudio=function(e){this.audioData=!!e.window.Audio,this.webAudio=!!e.window.AudioContext;var t=e.document.createElement("audio"),n=!1;try{if(n=!!t.canPlayType){t.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"")&&(this.ogg=!0);if(t.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,"")||t.canPlayType("audio/opus;").replace(/^no$/,""))this.opus=!0;t.canPlayType("audio/mpeg;").replace(/^no$/,"")&&(this.mp3=!0),t.canPlayType('audio/wav; codecs="1"').replace(/^no$/,"")&&(this.wav=!0);if(t.canPlayType("audio/x-m4a;")||t.canPlayType("audio/aac;").replace(/^no$/,""))this.m4a=!0;t.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")&&(this.webm=!0)}}catch(r){}},e.prototype.checkTablet=function(e){if(this.desktop){this.tablet=!1;return}var t=e.navigator.userAgent;this.tablet=!1,this.iOS&&/ipad/i.test(t)&&(this.tablet=!0),this.android&&!/mobile/i.test(t)&&(this.tablet=!0),(/blackberry/i.test(t)||/bb10/i.test(t)||/rim/i.test(t))&&/tablet/i.test(t)&&(this.tablet=!0),this.tablet&&(this.desktop=!1)},e.prototype.checkAndroidVersion=function(e){var t=e.navigator.userAgent.toLowerCase(),n=t.match(/android\s([0-9\.]*)/);if(n)try{this.androidVersion=n[1]}catch(r){}},e.prototype.checkChromeVersion=function(e){var t=e.match(/Chrome\/(\d+)/i);t&&(this.chromeVersion=parseInt(t[1],10))},e.prototype.checkFirefoxVersion=function(e){var t=e.match(/Firefox\/(\d+)/i);t&&(this.firefoxVersion=parseInt(t[1],10),this.firefoxQuantum=this.firefoxVersion>57)},e}();e.Device=t})(t=e.util||(e.util={}))})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(t){var n=function(){function n(){}return n.has=function(r){if(!n.delay){n.delay=new e.async.Delayed;var i="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js",s=t.Device.getInstance();if(s.ie)n.hasBlocker=!1,n.delay.execute();else{var o={method:"HEAD",mode:"no-cors"},u=new Request(i,o);fetch(u).then(function(){n.hasBlocker=!1,n.delay.execute()}).catch(function(e){n.hasBlocker=!0,n.delay.execute()})}}r&&n.delay.call(function(){return r(n.hasBlocker)})},n}();t.AdBlock=n})(t=e.util||(e.util={}))})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(t){var n=function(){function e(){this.protocol="",this.user="",this.password="",this.domain="",this.port="",this.resource="",this.query="",this.hash=""}return e}();t.UrlParts=n;var r;(function(e){e[e.ToString=0]="ToString",e[e.Repeat=1]="Repeat",e[e.RepeatBrackets=2]="RepeatBrackets"})(r=t.ArrayHandling||(t.ArrayHandling={}));var i=function(){function i(){}return i.mergeResource=function(e,t){if(!e)return t;if(!t)return e;if(t.charAt(0)=="/")return t;var n=e.split("/");if(n.length==0)return t;n.length>0&&n.pop(),n=n.concat(t.split("/"));for(var r=1;r<n.length-1;++r)n[r]||n.splice(r--,1);for(var r=1;r<n.length;++r)n[r]==".."&&n.splice(--r,2);return n.join("/")},i.splitQuery=function(e,t){var n={};if(!e)return n;var i=e.split("&");switch(t){case r.ToString:for(var s=0;s<i.length;++s){var o=i[s].split("="),u=o[0],a=decodeURIComponent(o[1]);n[u]=a}break;case r.Repeat:for(var s=0;s<i.length;++s){var o=i[s].split("="),u=o[0],a=decodeURIComponent(o[1]);n[u]===undefined?n[u]=a:typeof n[u]=="string"?n[u]=[n[u],a]:n[u].push(a)}break;case r.RepeatBrackets:for(var s=0;s<i.length;++s){var o=i[s].split("="),u=o[0],a=decodeURIComponent(o[1]);u.slice(-2)=="[]"?(u=u.slice(0,-2),n[u]||(n[u]=[]),n[u].push(a)):n[u]=a}}return n},i.joinQuery=function(e,t){var n=[];for(var i in e)if(Array.isArray(e[i]))switch(t){case r.ToString:n.push(i+"="+encodeURIComponent(e[i].toString()));break;case r.Repeat:for(var s=0;s<e[i].length;++s)n.push(i+"="+encodeURIComponent(e[i][s]));break;case r.RepeatBrackets:for(var s=0;s<e[i].length;++s)n.push(i+"[]="+encodeURIComponent(e[i][s]))}else e[i]===undefined||e[i]===null?n.push(i+"="):n.push(i+"="+encodeURIComponent(e[i].toString()));return n.join("&")},i.mergeQuery=function(e,t,n){n===void 0&&(n=r.ToString),e=e||"",t=t||"",e.charAt(0)=="?"&&(e=e.slice(1)),t.charAt(0)=="?"&&(t=t.slice(1));var s=i.splitQuery(e,n),o=i.splitQuery(t,n);for(var u in o)s[u]=o[u];return i.joinQuery(s,n)},i.mergeHash=function(e,t){e=e||"",t=t||"",e.charAt(0)=="#"&&(e=e.slice(1)),t.charAt(0)=="#"&&(t=t.slice(1));var n={},s=e.split("&"),o="";for(var u=0;u<s.length;++u){var a=s[u].split("=");a.length==1?o=o||a[0]:a.length==2&&(n[a[0]]=a[1])}var f=t.split("&"),l="";for(var u=0;u<f.length;++u){var a=f[u].split("=");a.length==1?l=l||a[0]:a.length==2&&(n[a[0]]=a[1])}var c=o||l||"",h=i.joinQuery(n,r.ToString);return h?c+"&"+h:c},i.merge=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];var r=new n;e=e.filter(function(e){return e});for(var s=0;s<e.length;++s){var o=i.parse(e[s].trim());r.protocol=o.protocol||r.protocol,r.user&&(r.user=o.user,r.password=r.password),o.domain?(r.domain=o.domain,r.port=o.port,r.resource=o.resource):r.resource=i.mergeResource(r.resource,o.resource),r.query=i.mergeQuery(r.query,o.query),r.hash=i.mergeHash(r.hash,o.hash)}return i.format(r)},i.getPath=function(e){var t=e.resource||"/";return e.query&&(t+="?"+e.query),e.hash&&(t+="#"+e.hash),t},i.parse=function(r){var i=new n;if(!r)return i;var s=r.slice(0,8)=="file:///";s&&(r=r.slice(7));var o=t.StringEx.captureNamed(r,e.REGEX_URL,e.REGEX_URL_GROUPS);s&&(o.protocol="file");for(var u in o)o[u]!==undefined&&(i[u]=o[u]);return i},i.format=function(e){var t="";return e.protocol&&(t+=e.protocol+"://"),e.user&&(t+=e.user+":"+e.password+"@"),e.domain&&(t+=e.domain,e.port&&(t+=":"+e.port)),e.resource&&(e.domain&&e.resource.charAt(0)!="/"&&(t+="/"),t+=e.resource),e.query&&(t+="?"+e.query),e.hash&&(t+="#"+e.hash),t},i.getResourceFromUrl=function(e){return i.parse(e).resource},i.getQueryParams=function(e,t){t===void 0&&(t=r.ToString);var n=i.parse(e),s=i.splitQuery(n.query,t);return s},i.setQueryParams=function(e,t,n){n===void 0&&(n=r.ToString);var s=i.parse(e);return s.query=i.joinQuery(t,n),i.format(s)},i.addParameter=function(e,t,n,s){s===void 0&&(s=r.ToString);var o=i.getQueryParams(e,s);return o[t]=n,i.setQueryParams(e,o,s)},i.addParameters=function(e,t,n){n===void 0&&(n=r.ToString);var s=i.getQueryParams(e,n);for(var o in t)s[o]=t[o];return i.setQueryParams(e,s,n)},i.removeParameter=function(e,t,n){n===void 0&&(n=r.ToString);var s=i.getQueryParams(e,n);return typeof s[t]=="undefined"?e:(delete s[t],i.setQueryParams(e,s,n))},i.getMailToUrl=function(e,t,n,r,i){var s=typeof e=="string"?e:e.join(","),o=[];t&&o.push("subject="+encodeURIComponent(t)),n&&o.push("body="+encodeURIComponent(n)),r!==undefined&&o.push("cc="+encodeURIComponent(typeof r=="string"?r:r.join(","))),i!=undefined&&o.push("bcc="+encodeURIComponent(typeof i=="string"?i:i.join(",")));var u="mailto:"+s;return o.length>0&&(u+="?"+o.join("&")),u},i}();t.Url=i})(t=e.util||(e.util={}))})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(t){var n=function(){function n(){}return n.hasAdBlock=function(e){setTimeout(function(){return t.AdBlock.has(e)},1)},n.downloadTextFile=function(e,t){var n="data:,"+encodeURIComponent(t),r=document.createElement("a");r.download=e,r.href=n,document.body.appendChild(r),r.click(),document.body.removeChild(r)},n.isMobile=function(){if(location.search.indexOf("force-mobile")>-1)return!0;if(location.search.indexOf("force-iphone")>-1)return!0;var e=t.Device.getInstance();return!e.desktop},n.isTablet=function(){if(location.search.indexOf("force-tablet")>-1)return!0;if(location.search.indexOf("force-ipad")>-1)return!0;var e=t.Device.getInstance();return e.tablet},n.isPhone=function(){var e=t.Device.getInstance();return n.isMobile()&&!e.tablet},n.isIPhone=function(){var e=t.Device.getInstance();return location.search.indexOf("force-iphone")>-1?!0:e.iPhone},n.isFirefox=function(){var e=t.Device.getInstance();return e.firefox},n.isAndroid=function(){var e=t.Device.getInstance();return e.android},n.isAndroidStock=function(){var e=t.Device.getInstance();return e.androidStockBrowser},n.isIOs=function(){var e=t.Device.getInstance();return location.search.indexOf("force-ios")>-1||location.search.indexOf("force-ios9")>-1||location.search.indexOf("force-ios10")>-1?!0:e.iOS},n.isIOs9=function(){var e=t.Device.getInstance();return location.search.indexOf("force-ios9")>-1?!0:e.iOS9},n.isIOs10=function(){var e=t.Device.getInstance();return location.search.indexOf("force-ios10")>-1?!0:e.iOS10},n.isInternetExplorer=function(){var e=t.Device.getInstance();return e.ie},n.isChrome=function(){var e=t.Device.getInstance();return e.chrome},n.isIOSChrome=function(){var e=t.Device.getInstance();return e.iOSChrome},n.isSafari=function(){var e=t.Device.getInstance();return e.safari},n.supportsClickJacking=function(){return n.isInternetExplorer()?!1:n.isSafari()?!1:!0},n.isOldBrowser=function(){var e=t.Device.getInstance();return e.ie&&e.ieVersion<11?!0:!1},n.getCookie=function(e){var t=new RegExp(e+"=([^;]*)"),n=document.cookie.match(t);return n?decodeURIComponent(n[1]):null},n.setCookie=function(e,t,n){n===void 0&&(n=2592e3),t=encodeURIComponent(t);if(n>0){var r=new Date;r.setTime(r.getTime()+n*1e3),t+="; expires="+r.toUTCString()}document.cookie=e+"="+t},n.deleteCookie=function(e){n.setCookie(e,"",-1)},n.getHighestSameDomainWindow=function(e){e===void 0&&(e=window);try{while(e!=e.parent&&e.document.domain==e.parent.document.domain)e=e.parent}catch(t){}return e},n.getQueryValues=function(e){e===void 0&&(e=window);try{var n=e.location.search;if(!n||n=="")return{};n=n.substr(1);var r=t.StringEx.splitAssoc(n),i={};for(var s in r)i[s]=decodeURIComponent(r[s]);return i}catch(o){return{}}},n.getQueryValue=function(e,n){n===void 0&&(n=window);try{var r=n.location.search;if(!r||r=="")return null;r=r.substr(1);var i=t.StringEx.splitAssoc(r);for(var s in i)if(s==e)return decodeURIComponent(i[s]);return null}catch(o){return null}},n.removeParam=function(e,n){n===void 0&&(n=window);var r=n.location.href;return t.Url.removeParameter(r,e)},n.getBaseUrl=function(e){e===void 0&&(e=window);var n=e.location.href;return n=t.StringEx.getBefore(n,"?",!0),n=t.StringEx.getBefore(n,"#",!0),n=t.StringEx.getBefore(n,"/",!1),n+="/",n},n.getLanguagePreferences=function(){var n=navigator.language||navigator.userLanguage||"",r=navigator.languages||n.split(","),i=[];for(var s=0;s<r.length;++s)if(e.REGEX_LOCALE.test(r[s])){var o=r[s].slice(0,2);t.Util.contains(i,o)||i.push(o)}else r[s].match(/^[a-z][a-z]$/)&&(t.Util.contains(i,r[s])||i.push(r[s]));return i},n.getCountryPreferences=function(){var n=navigator.language||navigator.userLanguage||"",r=n.split(","),i=[];for(var s=0;s<r.length;++s)if(e.REGEX_LOCALE.test(r[s])){var o=r[s].slice(-2);t.Util.contains(i,o)||i.push(o)}return i},n.isHtml5Supported=function(){var e=document.createElement("canvas"),t=!!e.getContext&&!!e.getContext("2d");return t},n.isWebAudioAvailable=function(){var e=window;return typeof e.AudioContext!="undefined"||typeof e.webkitAudioContext!="undefined"?!0:!1},n}();t.Browser=n})(t=e.util||(e.util={}))})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(t){function r(t){var n=new e.xml.Parser;return n.parse(t)}function i(e){var t=(new XMLSerializer).serializeToString(e.documentElement);return r(t)}var n=function(){function e(){this.S={" ":!0,"\n":!0,"\r":!0,"\t":!0},this.NW={" ":!0,"\n":!0,"\t":!0,"<":!0,">":!0,"=":!0,'"':!0,"'":!0,"\r":!0},this.ESC={amp:"&",lt:"<",gt:">",quot:'"'},this.styleAttibutesPattern=/^xs[a-z]+:/,this.stripStyleAttributes=!0}return e.prototype.eat=function(){return this.rawXml.charAt(this.i++)},e.prototype.skipWS=function(){while(this.S[this.rawXml.charAt(this.i)])++this.i},e.prototype.skipHeader=function(){var e=this.eat();while(e&&e!="<")e=this.eat();var t=!1;if(this.rawXml.slice(this.i,this.i+4)=="?xml"){var e=this.eat();while(e&&e!="<")e=this.eat();t=!0}return--this.i,t},e.prototype.readWord=function(){this.skipWS();var e=this.i;while(!this.NW[this.rawXml.charAt(this.i)])++this.i;return this.rawXml.slice(e,this.i)},e.prototype.readTill=function(e){var t=this.i,n=e.charAt(0);for(;;){var r=this.eat();if(!r)break;if(r==n&&this.rawXml.slice(this.i-1,this.i-1+e.length)==e)break}return this.i+=e.length-1,this.rawXml.slice(t,this.i-e.length)},e.prototype.readQuoted=function(){this.skipWS();var e=this.eat();return this.readTill(e)},e.prototype.readAttributes=function(){var e={};for(;;){this.skipWS();var t=this.rawXml.charAt(this.i);if(t==">"||t=="/")break;var n=this.readWord();this.skipWS(),++this.i;var r=this.readQuoted();if(!this.stripStyleAttributes||!this.styleAttibutesPattern.test(n))e[n]=r}return e},e.prototype.isNull=function(e){for(var t in e._attributes)if((t=="nil"||t.slice(-4)==":nil")&&e._attributes[t]=="true")return!0;return!1},e.prototype.isPrimitive=function(e){for(var t in e._attributes)return!1;for(var t in e)if(t.charAt(0)!="_")return!1;return!0},e.prototype.fillChildNodes=function(e,t){var n={};for(var r=0;r<t.length;++r)n[t[r]._tag]||(n[t[r]._tag]=[]),this.isNull(t[r])?n[t[r]._tag].push(null):this.isPrimitive(t[r])?n[t[r]._tag].push(t[r]._data):n[t[r]._tag].push(t[r]);for(var i in n)e[i]=n[i].length==1?n[i][0]:n[i]},e.prototype.readNode=function(){var e=this.i;this.skipWS(),++this.i;var t={};u=this.readWord().match(/(?:([^\:]+)\:)?([^\:]+)/),t._ns=u[1],t._tag=u[2];if(t._tag.slice(-1)=="/")return t._tag=t._tag.slice(0,-1),this.i+=1,t;t._attributes=this.readAttributes();var n=this.eat();if(n=="/")return++this.i,t;var r=this.readContent(),i=r[0],s=r[1];t._data=i.trim(),this.fillChildNodes(t,s),this.skipWS();var o=t._tag.length+(t._ns?t._ns.length+4:3);this.i+=o;return t;var u},e.prototype.readData=function(){this.i+=9;var e=this.i,t=this.rawXml.length;while(this.i<t){while(this.i<t&&this.rawXml.charAt(this.i)!="]")++this.i;if(this.rawXml.slice(this.i,this.i+3)=="]]>")return this.i+=3,this.rawXml.slice(e,this.i-3);++this.i}throw new Error("invalid xml syntax - CDATA terminator expected")},e.prototype.unescape=function(e){var t=this.ESC[e];return t?t:e.charAt(0)=="#"?String.fromCharCode(parseInt(e.slice(1),8)):String.fromCharCode(parseInt(e))},e.prototype.skipComment=function(){this.readTill("--\x3e")},e.prototype.readContent=function(){this.skipWS();var e="",t=[];for(;;){var n=this.eat();if(!n)break;if(n=="<"){n=this.eat(),this.i-=2;if(n=="!")this.rawXml.slice(this.i,this.i+4)=="\x3c!--"?this.skipComment():e+=this.readData();else{if(n=="/")break;t.push(this.readNode())}}else if(n=="&"){var r=this.readTill(";");e+=this.unescape(r)}else e+=n}return[e,t]},e.prototype.parse=function(e){this.rawXml=e,this.i=0;if(!this.skipHeader()&&this.i>3)return undefined;var t=this.readContent(),n=t[0],r=t[1];return r.length==1?r[0]:undefined},e}();t.Parser=n,t.parseString=r,t.parseXml=i})(t=e.xml||(e.xml={}))})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(t){var n=function(){function n(){}return n.getTypeFromUrl=function(e){var r=t.Url.getResourceFromUrl(e);for(var i=0;i<n.typesByExtension.length;++i){var s=n.typesByExtension[i];if(s.pattern.test(r))return s.type}return undefined},n.getXMLHttpRequestObject=function(){var e=null;return window.XMLHttpRequest?e=new XMLHttpRequest:window.ActiveXObject&&(e=new ActiveXObject("MSXML2.XMLHTTP.3.0")),e},n.responseHandler=function(n,r,i,s){if(n.readyState!=4)return;var o=n.status;if(o>=200&&o<300){if(r)try{var u={},a=n.getAllResponseHeaders();if(a&&a.length>0){var f=a.split("\r\n");for(var l=0;l<f.length;++l){var c=f[l].indexOf(": ");c>0&&(u[f[l].substr(0,c)]=f[l].substr(c+2))}}switch(i){case"json":r(t.Json.decode(n.responseText),u);break;case"xml":if(n.responseXML)return r(n.responseXML,u);if(DOMParser){var h=new DOMParser,p=h.parseFromString(n.responseText,"text/xml");return r(p,u)}t.Log.logError("error while loading xml file"),r(null,u);break;case"text":r(n.responseText,u);break;case"binary":r(n.response,u);break;case"image":r(n.response,u);break;case"arraybuffer":r(n.response,u);break;case"xml->json":r(e.xml.parseString(n.responseText),u)}}catch(d){t.Log.logError(d)}}else s&&s(o)},n.adjustMimeType=function(e,t,n){if(e instanceof XMLHttpRequest)switch(n){case"json":e.overrideMimeType("application/json");break;case"text":e.overrideMimeType("text/plain")}},n.call=function(e,t,r,i){r=r||n.getTypeFromUrl(e)||"json";var s=n.getXMLHttpRequestObject();return n.adjustMimeType(s,e,r),s.onreadystatechange=n.responseHandler.bind(null,s,t,r,i),s.open("GET",e,!0),r=="arraybuffer"&&(s.responseType=r),s.send(),s},n.callTimeout=function(t,r,i,s,o,u){if(s<=0){n.call(t,r,o,u);return}var a=null;e.async.Timeout.call(s,function(e){a=n.call(t,e,o,u)},r,function(){a.abort(),i()})},n.postCall=function(e,r,i,s,o){i===void 0&&(i={}),s=s||n.getTypeFromUrl(e)||"json";var u=n.getXMLHttpRequestObject(),a={};for(var f in i)a[f]=encodeURIComponent(i[f]);n.adjustMimeType(u,e,s);var l=t.StringEx.joinAssoc(a);return u.onreadystatechange=n.responseHandler.bind(null,u,r,s,o),u.open("POST",e,!0),u.setRequestHeader("Content-type","application/x-www-form-urlencoded"),u.send(l),u},n.postCallTimeout=function(t,r,i,s,o,u){o===void 0&&(o={});if(s<=0){n.postCall(t,r,o,u);return}var a=null;e.async.Timeout.call(s,function(e){a=n.postCall(t,e,o,u)},r,function(){a.abort(),i()})},n.callService=function(e,r,i,s,o){r===void 0&&(r={});var u="method="+e+"&payload="+encodeURIComponent(t.Json.encode(r));if(n.serviceUrl)var a=n.serviceUrl+"?_="+(new Date).getTime();else var a=t.Browser.getBaseUrl()+"gateway?_="+(new Date).getTime();s=s||n.getTypeFromUrl(a)||"json";var f=n.getXMLHttpRequestObject();return n.adjustMimeType(f,a,s),f.onreadystatechange=n.responseHandler.bind(null,f,i,s,o),f.open("POST",a,!0),f.setRequestHeader("Content-type","application/x-www-form-urlencoded"),f.send(u),f},n.callServiceUnique=function(e,t,r,i,s){t===void 0&&(t={});var o=n.pendingXhr[e];o&&o.abort();var u=n.callService(e,t,function(t,i){delete n.pendingXhr[e],r&&r(t,i)},null,s);n.pendingXhr[e]=u},n.callServiceTimeout=function(t,r,i,s,o,u,a){if(o<=0){n.callService(t,r,i,u,a);return}var f=null;e.async.Timeout.call(o,function(e){f=n.callService(t,r,e,u,a)},i,function(){f.abort(),s()})},n.pendingXhr={},n.typesByExtension=[{pattern:/\.bmp$/i,type:"image"},{pattern:/\.css$/i,type:"text"},{pattern:/\.fnt$/i,type:"xml->json"},{pattern:/\.gif$/i,type:"image"},{pattern:/\.html$/i,type:"text"},{pattern:/\.jpeg$/i,type:"image"},{pattern:/\.jpg$/i,type:"image"},{pattern:/\.js$/i,type:"text"},{pattern:/\.json$/i,type:"json"},{pattern:/\.md5anim$/i,type:"text"},{pattern:/\.md5mesh$/i,type:"text"},{pattern:/\.mp3$/i,type:"binary"},{pattern:/\.ogg$/i,type:"binary"},{pattern:/\.php$/i,type:"json"},{pattern:/\.png$/i,type:"image"},{pattern:/\.txt$/i,type:"text"},{pattern:/\.xml$/i,type:"xml"}],n}();t.Ajax=n})(t=e.util||(e.util={}))})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(t){var n=function(){function t(){this.cache={},this.showServiceCallsInLog=!1,this.htmlEscapeStrings=!0,this.timeoutDuration=0,this.cacheDuration=6e5}return t.prototype.cleanResult=function(t,n,r){var i=typeof n;if(i=="string"){var s=n;this.htmlEscapeStrings&&(s=e.util.Util.encodeHtml(s)),s!=n&&e.util.Util.setProperty(r,t,s)}},t.prototype.callService=function(t,n,r,i,s){n===void 0&&(n={}),e.util.Ajax.callServiceTimeout(t,n,function(e,t){r&&r(e,t)},function(){i&&i()},this.timeoutDuration,null,s)},t.prototype.callServiceCached=function(t,n,r,i,s){var o=this;n===void 0&&(n={});if(!r)return this.callService(t,n);var u=t+"("+e.util.Json.encode(n)+")",a=this.cache[u];if(a&&a.expires>=new Date)return r(e.util.Util.clone(a.response));this.callService(t,n,function(t){var n=new Date;n.setTime(n.getTime()+o.cacheDuration);var i={expires:n,response:t};o.cache[u]=i,r(e.util.Util.clone(i.response))},i,s)},t.prototype.clearCache=function(t,n){if(n){var r=t+"("+e.util.Json.encode(n)+")";this.cache[r]&&delete this.cache[r]}else{t+="(";for(var i in this.cache)i.indexOf(t)==0&&delete this.cache[i]}},t}();t.AjaxStub=n})(t=e.services||(e.services={}))})(kr3m||(kr3m={}));var cuboro;(function(e){var t;(function(e){var t=function(e){function t(){var t=e.call(this)||this;return t.htmlEscapeStrings=!1,t}return __extends(t,e),t.prototype.callService=function(t,n,r,i,s){var o=this;n===void 0&&(n={});if(t=="Config.get")return e.prototype.callService.call(this,t,n,r,i,s);mConfig.getLanguage(function(u){n.lang=u,e.prototype.callService.call(o,t,n,r,i,s)})},t}(kr3m.services.AjaxStub);e.Abstract=t})(t=e.stubs||(e.stubs={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){var t=function(){function e(){}return e}();e.Config=t})(t=e.vo||(e.vo={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){var t=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.get=function(e){this.callService("Config.get",{},function(t){return e&&e(t.data,t.status)})},t}(e.Abstract);e.Config=t})(t=e.stubs||(e.stubs={}))})(cuboro||(cuboro={}));var sConfig=new cuboro.stubs.Config,cuboro;(function(e){var t;(function(e){var t=function(){function e(){}return e.prototype.getConfig=function(e){var t=this;if(this.config)return e(this.config);sConfig.get(function(n){t.config=n,e(t.config)})},e.prototype.isShopAvailable=function(e){this.getConfig(function(t){return e(t.isShopAvailable)})},e.prototype.getLanguages=function(e){this.getConfig(function(t){return e(t.languages)})},e.prototype.getLanguage=function(e){var t=this;if(this.language)return e(this.language);this.getLanguages(function(n){t.language=kr3m.util.Browser.getQueryValue("lang")||n[0]&&n[0].id||"de",e(t.language)})},e}();e.Config=t})(t=e.clientmodels||(e.clientmodels={}))})(cuboro||(cuboro={}));var mConfig=new cuboro.clientmodels.Config,cuboro;(function(e){var t;(function(e){var t=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.handleCasLogin=function(e,t,n){var r={casUserId:e,casToken:t};this.callService("User.handleCasLogin",r,function(e){return n&&n(e.data,e.status)})},t.prototype.handleCasLogout=function(e){var t={};this.callService("User.handleCasLogout",t,function(t){return e&&e(t.status)})},t}(e.Abstract);e.User=t})(t=e.stubs||(e.stubs={}))})(cuboro||(cuboro={}));var sUser=new cuboro.stubs.User,cuboro;(function(e){var t;(function(e){var t=function(){function e(){}return e}();e.User=t})(t=e.vo||(e.vo={}))})(cuboro||(cuboro={}));var kr3m;(function(e){var t;(function(t){var n=function(){function t(){this.onListeners={},this.onceListeners={}}return t.prototype.on=function(t,n,r){this.onListeners[t]||(this.onListeners[t]=[]);var i=e.util.Util.getBy(this.onListeners[t],"context",r,0,!0);if(i){i.listeners.push(n);return}this.onListeners[t].push({context:r,listeners:[n]})},t.prototype.once=function(t,n,r){this.onceListeners[t]||(this.onceListeners[t]=[]);var i=e.util.Util.getBy(this.onceListeners[t],"context",r,0,!0);if(i){i.listeners.push(n);return}this.onceListeners[t].push({context:r,listeners:[n]})},t.prototype.off=function(){var t=e.util.Util.getFirstOfType.bind(null,arguments),n=t("string"),r=t("function"),i=t("object"),s=[this.onListeners,this.onceListeners],o=n?[n]:e.util.Util.merge(Object.keys(this.onListeners),Object.keys(this.onceListeners));for(var u=0;u<s.length;++u)for(var a=0;a<o.length;++a){var f=s[u][o[a]];if(!f)continue;for(var l=0;l<f.length;++l){if(i&&i!==f[l].context)continue;r?e.util.Util.remove(f[l].listeners,r,!0):f[l].listeners=[]}}},t.prototype.dispatch=function(e,t,n){if(this.onListeners[e])for(var r=0;r<this.onListeners[e].length;++r)for(var i=0;i<this.onListeners[e][r].listeners.length;++i)this.onListeners[e][r].listeners[i].call(n||this.onListeners[e][r].context||this,t);if(this.onceListeners[e]){for(var r=0;r<this.onceListeners[e].length;++r)for(var i=0;i<this.onceListeners[e][r].listeners.length;++i)this.onceListeners[e][r].listeners[i].call(n||this.onceListeners[e][r].context||this,t);this.onceListeners[e]=[]}},t}();t.EventDispatcher=n})(t=e.model||(e.model={}))})(kr3m||(kr3m={}));var cuboro;(function(e){var t;(function(e){var t=function(e){function t(){var t=e.call(this)||this;return casClient.addEventListener(t.handleCasEvent.bind(t)),t}return __extends(t,e),t.prototype.handleCasEvent=function(e,t){var n=this;this.initialized||this.dispatch("init"),this.initialized=!0,this.blocked=!1;switch(e){case cas.EVENT_ONLINE:this.dispatch("login"),casClient.getUser(function(e){casClient.getToken(function(t){sUser.handleCasLogin(e.id,t,function(t,r){if(r!=kr3m.SUCCESS){n.user=null,n.casUser=null;return}if(t.isBlocked){n.blocked=!0,n.user=null,n.casUser=null,n.logout(),n.dispatch("blocked");return}n.user=t,n.casUser=e,n.dispatch("loggedIn")})})});break;case cas.EVENT_OFFLINE:case cas.EVENT_LOGOUT:this.blocked=!1,this.user=null,this.casUser=null,sUser.handleCasLogout(),this.dispatch("logout")}},t.prototype.logout=function(e){casClient.logout(function(){e&&e()})},t.prototype.isLoggedIn=function(){return!!this.user},t.prototype.isInitialized=function(){return this.initialized},t.prototype.isBlocked=function(){return this.blocked},t.prototype.getUserId=function(){return this.isLoggedIn()?this.user.id:null},t.prototype.getUser=function(){return this.isLoggedIn()?this.user:null},t}(kr3m.model.EventDispatcher);e.User=t})(t=e.clientmodels||(e.clientmodels={}))})(cuboro||(cuboro={}));var mUser=new cuboro.clientmodels.User,cuboro;(function(e){var t;(function(e){var t=function(){function e(){this.end=null,this.hasEnd=!0,this.sets=[],this.expired=!1,this.show=!1,this.showLegacy=!1}return e}();e.Gift=t})(t=e.vo||(e.vo={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){var t=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.getGift=function(e){var t={};this.callService("Gift.getGift",t,function(t){return e(t.data,t.status)})},t}(e.Abstract);e.Gift=t})(t=e.stubs||(e.stubs={}))})(cuboro||(cuboro={}));var sGift=new cuboro.stubs.Gift,cuboro;(function(e){var t;(function(t){var n=function(t){function n(){var n=t.call(this)||this;return n.gift=new e.vo.Gift,mUser.on("loggedIn",function(){return n.updateGift()}),mUser.on("logout",function(){n._isInitialized=!1,n.gift=new e.vo.Gift,n.dispatch(e.clientmodels.Gift.GIFT)}),n}return __extends(n,t),n.prototype.updateGift=function(t){var n=this;sGift.getGift(function(r,i){n._isInitialized=!0,i==kr3m.SUCCESS&&(n.gift=r),t&&t(),n.dispatch(e.clientmodels.Gift.GIFT)})},n.prototype.missingSets=function(t){var n=this,r=[];return t.forEach(function(t){t!=e.SETS.WEB_ONE&&n.gift.sets.indexOf(t)==-1&&r.push(t)}),r},n.prototype.getGift=function(){return this.gift},n.prototype.isInitialized=function(){return this._isInitialized},n.prototype.hasGift=function(){return this.gift.sets.length>0},n.GIFT="gift",n}(kr3m.model.EventDispatcher);t.Gift=n})(t=e.clientmodels||(e.clientmodels={}))})(cuboro||(cuboro={}));var mGift=new cuboro.clientmodels.Gift,gf;(function(e){e.VERSION="4.0.1",e.RENDER_AUTO=0,e.RENDER_CANVAS=1,e.RENDER_WEBGL=2,e.LEFT="left",e.CENTER="center",e.RIGHT="right",e.TOP="top",e.BOTTOM="bottom",e.JUSTIFY="justify",e.NONE="none",e.CHANGE="change",e.COMPLETE="complete",e.HORIZONTAL="horizontal",e.VERTICAL="vertical",e.OVER="over",e.OUT="out",e.DOWN="down",e.UP="up",e.SELECTED="selected",e.HIGHLIGHT="highlight",e.ACCEPTED="accepted",e.PENDING="pending",e.SUCCESS="success",e.RENDER_TYPE_DEFAULT="default",e.RENDER_TYPE_ON_CHANGE="onChange",e.REQUEST_EPISODE="requestEpisode",e.REQUEST_LIVES="requestLives",e.SOUND_FX="fx",e.SOUND_MUSIC="music",e.BLUR="gameBlur",e.CLICK="clickOrTap",e.DATA="storageData",e.DISABLE="disable",e.DRAG_CHANGE="dragChange",e.DRAG_START="dragStart",e.DRAG_STOP="dragStop",e.ENABLE="enable",e.FOCUS="gameFocus",e.INITIALIZED="initialized",e.LANDSCAPE="landscape",e.LEVELS_LOADED="levelsLoaded",e.LOAD_COMPLETE="loadComplete",e.LOAD_ERROR="loadError",e.LOAD_PROGRESS="loadProgress",e.LOAD_RETRY_PAUSE="loadRetryPause",e.LOAD_TIMEOUT="loadTimeout",e.LOAD_TIMEOUT_RESOLVED="loadTimeoutResolved",e.LOGIN="login",e.LOGOUT="logout",e.MUSIC_LOADED="musicLoaded",e.PORTRAIT="portrait",e.RESIZE="resize",e.RUNNING="running",e.SCREEN="screen",e.TIMER="timer",e.TIMER_COMPLETE="timerComplete",e.TRANSITION_IN="transitionIn",e.TRANSITION_IN_COMPLETE="transitionInComplete",e.TRANSITION_OUT="transitionOut",e.TRANSITION_OUT_COMPLETE="transitionOutComplete",e.UPDATE="update",e.VENDORS=["ms","moz","webkit","o",""]})(gf||(gf={}));var gf;(function(e){var t;(function(e){var t=function(){function e(e,t,n,r,i){this.index=e,this.name=n,this.uid=r,this.trimmed=!1,this.orig=new PIXI.Rectangle(0,0,t.sourceSize.w/i,t.sourceSize.h/i),this.pivot=t.pivot||new PIXI.Point,t.rotated?(this.rotated=!0,this.frame=new PIXI.Rectangle(t.frame.x/i,t.frame.y/i,t.frame.h/i,t.frame.w/i)):(this.rotated=!1,this.frame=new PIXI.Rectangle(t.frame.x/i,t.frame.y/i,t.frame.w/i,t.frame.h/i)),t.trimmed&&(this.trimmed=!0,this.trim=new PIXI.Rectangle(t.spriteSourceSize.x/i,t.spriteSourceSize.y/i,t.spriteSourceSize.w/i,t.spriteSourceSize.h/i))}return e}();e.Frame=t})(t=e.utils||(e.utils={}))})(gf||(gf={}));var gf;(function(e){var t;(function(e){var t=function(){function e(){this._frames=[],this._frameNames=[]}return e.prototype.addFrame=function(e){return e.index=this._frames.length,this._frames.push(e),e.name!==""&&(this._frameNames[e.name]=e.index),e},e.prototype.getFrame=function(e){return e===void 0&&(e=0),e>this._frames.length&&(e=0),this._frames[e]},e.prototype.getFrameByName=function(e){return typeof this._frameNames[e]=="undefined"&&logWarning('Frame with name "'+e+'" is not in given sprite sheet.'),this._frames[this._frameNames[e]]},e.prototype.checkFrameName=function(e){return this._frameNames[e]!=null},e.prototype.getFrames=function(){return this._frames},Object.defineProperty(e.prototype,"total",{get:function(){return this._frames.length},enumerable:!0,configurable:!0}),e}();e.FrameData=t})(t=e.utils||(e.utils={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(){function t(){}return t.Level=function(e){return null},t.BitmapFont=function(e,t){var n={},r=e.getElementsByTagName("info")[0],i=e.getElementsByTagName("common")[0];n.font=r.getAttribute("face"),n.size=parseInt(r.getAttribute("size"),10),n.lineHeight=parseInt(i.getAttribute("lineHeight"),10),n.chars={};var s=e.getElementsByTagName("char"),o;for(o=0;o<s.length;o++){var u=parseInt(s[o].getAttribute("id"),10),a=new PIXI.Rectangle(parseInt(s[o].getAttribute("x"),10),parseInt(s[o].getAttribute("y"),10),parseInt(s[o].getAttribute("width"),10),parseInt(s[o].getAttribute("height"),10));n.chars[u]={xOffset:parseInt(s[o].getAttribute("xoffset"),10),yOffset:parseInt(s[o].getAttribute("yoffset"),10),xAdvance:parseInt(s[o].getAttribute("xadvance"),10),kerning:{},texture:PIXI.utils.TextureCache[t]=new PIXI.Texture(PIXI.utils.BaseTextureCache[t],a)}}var f=e.getElementsByTagName("kerning");for(o=0;o<f.length;o++){var l=parseInt(f[o].getAttribute("first"),10),c=parseInt(f[o].getAttribute("second"),10);n.chars[c].kerning[l]=parseInt(f[o].getAttribute("amount"),10)}return n},t.XML=function(e){var t;try{if(window.DOMParser){var n=new DOMParser;t=n.parseFromString(e,"text/xml")}else t=new ActiveXObject("Microsoft.XMLDOM"),t.async=!1,t.loadXML(e)}catch(r){t=null}return!t||!t.documentElement||t.getElementsByTagName("parsererror").length?null:t},t.JSONDataHash=function(t,n){if(!n.frames){logWarning('gf.utils.Parser.JSONDataHash: Invalid Texture Atlas JSON given, missing "frames" object');return}var r=new e.utils.FrameData,i=t.client.config.assetsResolution,s=n.frames,o,u=0;for(var a in s)o=PIXI.utils.uid(),r.addFrame(new e.utils.Frame(u,s[a],a,o,i)),u++;return r},t}();t.Parser=n})(t=e.utils||(e.utils={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(){function t(e){this.game=e,this._images={},this._textures={},this._sounds={},this._videos={},this._json={},this._svg={},this._xml={},this._bitmapFont={},this._renderTextures={},this.addDefaultImage()}return t.prototype.addDefaultImage=function(){var t=new Image;t.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",this._images.__default={url:null,data:t},this._images.__default.frame=new e.utils.Frame(0,{frame:{x:0,y:0,w:1,h:1},sourceSize:{w:1,h:1}},"__default",PIXI.utils.uid(),1),this._images.__default.frameData=new e.utils.FrameData,this._images.__default.frameData.addFrame(this._images.__default.frame),PIXI.utils.BaseTextureCache.__default=new PIXI.BaseTexture(t,PIXI.SCALE_MODES.LINEAR),PIXI.utils.TextureCache.__default=new PIXI.Texture(PIXI.utils.BaseTextureCache.__default),this._textures.__default=PIXI.utils.TextureCache.__default},t.prototype.addTextureAtlas=function(t,n,r,i){this._images[t]={url:n,data:r},PIXI.utils.BaseTextureCache[t]=new PIXI.BaseTexture(r,PIXI.SCALE_MODES.LINEAR,this.game.client.config.assetsResolution),PIXI.utils.TextureCache[t]=new PIXI.Texture(PIXI.utils.BaseTextureCache[t]),this._images[t].frameData=e.utils.Parser.JSONDataHash(this.game,i)},t.prototype.addFrameData=function(t,n){if(!this._images[t])return;this._images[t].frameData=e.utils.Parser.JSONDataHash(this.game,n)},t.prototype.addBitmapFont=function(t,n,r,i){this._images[t]={url:n,data:r},PIXI.utils.BaseTextureCache[t]=new PIXI.BaseTexture(r,PIXI.SCALE_MODES.LINEAR,this.game.client.config.assetsResolution),PIXI.utils.TextureCache[t]=new PIXI.Texture(PIXI.utils.BaseTextureCache[t]),PIXI.extras.BitmapText.fonts[t]=e.utils.Parser.BitmapFont(i,t),this._bitmapFont[t]=PIXI.extras.BitmapText.fonts[t]},t.prototype.addTexture=function(e,t){this._textures[e]=t},t.prototype.addRenderTexture=function(e,t){this._renderTextures[e]=t},t.prototype.addJSON=function(e,t,n){this._json[e]={url:t,data:n}},t.prototype.addXML=function(e,t,n){this._xml[e]={url:t,data:n}},t.prototype.addSVG=function(e,t,n){this._svg[e]={url:t,data:n}},t.prototype.addImage=function(t,n,r){this._images[t]={url:n,data:r},this._images[t].frame=new e.utils.Frame(0,{frame:{x:0,y:0,w:r.width,h:r.height},sourceSize:{w:r.width,h:r.height}},t,PIXI.utils.uid(),this.game.client.config.assetsResolution),this._images[t].frameData=new e.utils.FrameData,this._images[t].frameData.addFrame(this._images[t].frame),PIXI.utils.BaseTextureCache[t]=new PIXI.BaseTexture(r,PIXI.SCALE_MODES.LINEAR,this.game.client.config.assetsResolution),PIXI.utils.TextureCache[t]=new PIXI.Texture(PIXI.utils.BaseTextureCache[t])},t.prototype.addSound=function(e,t,n,r){this._sounds[e]={url:t,data:n,json:r}},t.prototype.addVideo=function(e,t){this._videos[e]=t},t.prototype.getSound=function(e){return this._sounds[e]?this._sounds[e]:(this.game.client.config.debug&&logWarning('gf.core.cache.getSound: Invalid key: "'+e+'"'),null)},t.prototype.getVideo=function(e){return this._videos[e]?this._videos[e]:(this.game.client.config.debug&&logWarning('gf.core.cache.getVideo: Invalid key: "'+e+'"'),null)},t.prototype.getRenderTexture=function(e){return this._renderTextures[e]?this._renderTextures[e]:(this.game.client.config.debug&&logWarning('gf.core.Cache.getRenderTexture: Invalid key: "'+e+'"'),null)},t.prototype.getImage=function(e){return this._images[e]?this._images[e].data:(this.game.client.config.debug&&logWarning('gf.core.Cache.getImage: Invalid key: "'+e+'"'),null)},t.prototype.getImageUrl=function(e){return this._images[e]?this._images[e].url:(this.game.client.config.debug&&logWarning('gf.core.Cache.getImageUrl: Invalid key: "'+e+'"'),null)},t.prototype.getSVG=function(e){return this._svg[e]?this._svg[e]:(this.game.client.config.debug&&logWarning('gf.core.Cache.getSVG: Invalid key: "'+e+'"'),null)},t.prototype.getFrameData=function(e){return this._images[e]?this._images[e].frameData:null},t.prototype.updateFrameData=function(e,t){this._images[e]&&(this._images[e].frameData=t)},t.prototype.getFrameByIndex=function(e,t){return this._images[e]?this._images[e].frameData.getFrame(t):null},t.prototype.getFrameByName=function(e,t){return this._images[e]?this._images[e].frameData.getFrameByName(t):null},t.prototype.getFrame=function(e){return this._images[e]?this._images[e].frame:null},t.prototype.getTextureByFrameName=function(e,t){if(this._images[e]&&this._images[e][t]){var n=this.getFrameData(e).getFrameByName(t).frame;return new PIXI.Texture(PIXI.utils.TextureCache[e],n,n.clone())}return null},t.prototype.getTextureFrame=function(e){return this._textures[e]?this._textures[e].frame:(this.game.client.config.debug&&logWarning('gf.core.Cache.getTextureFrame: Invalid key: "'+e+'"'),null)},t.prototype.getTexture=function(e){return this._textures[e]?this._textures[e]:(this.game.client.config.debug&&logWarning('gf.core.Cache.getTexture: Invalid key: "'+e+'"'),null)},t.prototype.getFrameCount=function(e){return this._images[e]?this._images[e].frameData.total:0},t.prototype.checkJSON=function(e){return this._json[e]?!0:!1},t.prototype.getJSON=function(e){return this._json[e]?this._json[e].data:(this.game.client.config.debug&&logWarning('gf.core.Cache.getJSON: Invalid key: "'+e+'"'),null)},t.prototype.getXML=function(e){return this._xml[e]?this._xml[e].data:(this.game.client.config.debug&&logWarning('gf.core.Cache.getXML: Invalid key: "'+e+'"'),null)},t}();t.Cache=n})(t=e.core||(e.core={}))})(gf||(gf={}));var gf;(function(e){var t=function(){function e(){}return e}();e.Client=t})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(){function t(){}return t.centerX=function(t,n){n||(n=t.game);var r,i=0;return typeof n=="number"?r=n:n instanceof e.core.Game?r=t.game.width:(i=n.getLocalBounds().x,n.scale?r=n.width/n.scale.x>>0:r=n.width>>0),r-t.width>>1},t.centerY=function(t,n){n||(n=t.game);var r,i=0;return typeof n=="number"?r=n:n instanceof e.core.Game?r=t.game.height:(i=n.getLocalBounds().y,n.scale?r=n.height/n.scale.y>>0:r=n.height>>0),r-t.height>>1},t.hAlign=function(t,n,r,i){i===void 0&&(i=0);if(!t.alignData)return;if(n==e.NONE){t.alignData.hAlignValue=null,t.alignData.hAlignOffset=null,t.alignData.hAlignParent=null;return}t.alignData.hAlignValue=n,t.alignData.hAlignOffset=i,r?t.alignData.hAlignParent=r:t.alignData.hAlignParent=r=t.game;var s,o=0;typeof r=="number"?s=r:r instanceof e.core.Game?s=t.game.width:(o=r.getLocalBounds().x,t.alignData.hAlignParent.scale?s=t.alignData.hAlignParent.width/t.alignData.hAlignParent.scale.x>>0:s=t.alignData.hAlignParent.width>>0),n==e.LEFT?t.position.x=i:n==e.CENTER?t.position.x=(s-t.width>>1)+i:n==e.RIGHT&&(t.position.x=s-t.width+i),t.position.x+=o-t.getLocalBounds().x},t.vAlign=function(t,n,r,i){i===void 0&&(i=0);if(!t.alignData)return;if(n==e.NONE){t.alignData.vAlignValue=null,t.alignData.vAlignOffset=null,t.alignData.vAlignParent=null;return}t.alignData.vAlignValue=n,t.alignData.vAlignOffset=i,r?t.alignData.vAlignParent=r:t.alignData.vAlignParent=r=t.game;var s,o=0;typeof r=="number"?s=r:r instanceof e.core.Game?s=t.game.height:(o=r.getLocalBounds().y,t.alignData.vAlignParent.scale?s=t.alignData.vAlignParent.height/t.alignData.vAlignParent.scale.y>>0:s=t.alignData.vAlignParent.height>>0),n==e.TOP?t.position.y=i:n==e.CENTER?t.position.y=(s-t.height>>1)+i:n==e.BOTTOM&&(t.position.y=s-t.height+i),t.position.y+=o-t.getLocalBounds().y},t.onResize=function(t){t.alignData&&(t.alignData.hAlignValue&&t.alignData.hAlignValue!=e.NONE&&t.hAlign(t.alignData.hAlignValue,t.alignData.hAlignParent,t.alignData.hAlignOffset),t.alignData.vAlignValue&&t.alignData.vAlignValue!=e.NONE&&t.vAlign(t.alignData.vAlignValue,t.alignData.vAlignParent,t.alignData.vAlignOffset)),t.children.forEach(function(e){typeof e["onResize"]=="function"&&e.parent===t&&e.onResize()})},t.left=function(e){return e.position.x+e.getLocalBounds().x},t.right=function(e){return e.left+e.width},t.top=function(e){return e.position.y+e.getLocalBounds().y},t.bottom=function(e){return e.top+e.height},t}();t.Align=n})(t=e.utils||(e.utils={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(){function t(){this.hAlignOffset=0,this.hAlignValue=e.NONE,this.vAlignOffset=0,this.vAlignValue=e.NONE}return t}();t.AlignData=n})(t=e.utils||(e.utils={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(){function t(){}return t.intersectRectRect=function(e,t){return e.x<t.x+t.width&&t.x<e.x+e.width&&e.y<t.y+t.height?t.y<e.y+e.height:!1},t.intersectCircleRect=function(e,t,n,r){var i=e<r.x?r.x:e>r.x+r.width?r.x+r.width:e,s=t<r.y?r.y:t>r.y+r.height?r.y+r.height:t,o=i-e,u=s-t;return o*o+u*u<=n*n},t.intersectCircleCircle=function(e,t,n,r,i,s){var o=e-r,u=t-i,a=Math.sqrt(o*o+u*u);return a<n+s},t.distance=function(e,t,n,r){var i,s;return isNaN(e)?(i=e.x-t.x,s=e.y-t.y):(i=e-n,s=t-r),Math.sqrt(i*i+s*s)},t.lerp=function(e,t,n){var r=n*e.x+(1-n)*t.x,i=n*e.y+(1-n)*t.y;return{x:r,y:i}},t.degToRad=function(e){return e*this.degreeToRadiansFactor},t.radToDeg=function(e){return e*this.radianToDegreesFactor},t.round=function(e,t){return e-e%t+((e%t>0||e==0)&&t)},t.clamp=function(e,t,n){return e<t?t:e>n?n:e},t.wrapAngle=function(e,t){t===void 0&&(t=!1);var n=t?Math.PI/180:1;return this.wrap(e,-180*n,180*n)},t.normalizeAngle=function(t){return t%=e.utils.Maths.TWO_PI,t<-Math.PI&&(t+=e.utils.Maths.TWO_PI),t>Math.PI&&(t-=e.utils.Maths.TWO_PI),t},t.wrap=function(e,t,n){var r=n-t;if(r<=0)return 0;var i=(e-t)%r;return i<0&&(i+=r),i+t},t.random=function(e,t){return Math.floor(Math.random()*(t-e+1))+e},t.randomFloat=function(e,t){return Math.random()*(t-e)+e},t.randomElement=function(t,n){if(!t)return undefined;if(t.length==0)return undefined;if(t.length==0)return undefined;var r=t[e.utils.Maths.random(0,t.length-1)],i=!1;return n&&n.length>0&&n.indexOf(r)!=-1&&(i=!0),i?this.randomElement(t,n):r},t.shuffle=function(e){var t,n,r;for(r=e.length;r;--r)t=Math.floor(Math.random()*r),n=e[r-1],e[r-1]=e[t],e[t]=n;return e},t.shuffledInts=function(t){var n=[];for(var r=0;r<t;++r)n.push(r);return e.utils.Maths.shuffle(n)},t.TWO_PI=Math.PI*2,t.degreeToRadiansFactor=Math.PI/180,t.radianToDegreesFactor=180/Math.PI,t}();t.Maths=n})(t=e.utils||(e.utils={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(){function t(){}return t.getAngle=function(t){return e.utils.Maths.wrapAngle(e.utils.Maths.radToDeg(t.rotation))},t.setAngle=function(t,n){t.rotation=e.utils.Maths.degToRad(e.utils.Maths.wrapAngle(n))},t}();t.Angle=n})(t=e.utils||(e.utils={}))})(gf||(gf={}));var gf;(function(e){var t;(function(e){var t=function(){function e(){}return e.getScaleX=function(e){return e.scale.x},e.setScaleX=function(e,t){e.scale.x=t},e.getScaleY=function(e){return e.scale.y},e.setScaleY=function(e,t){e.scale.y=t},e.setScaleXY=function(e,t){e.scale.set(t,t)},e}();e.Scale=t})(t=e.utils||(e.utils={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this)||this;return r.game=n,r.name="",r.alignData=new e.utils.AlignData,r.userData={},r}return __extends(n,t),n.prototype.hAlign=function(t,n,r){r===void 0&&(r=0),e.utils.Align.hAlign(this,t,n,r)},n.prototype.vAlign=function(t,n,r){r===void 0&&(r=0),e.utils.Align.vAlign(this,t,n,r)},n.prototype.onResize=function(){e.utils.Align.onResize(this)},n.prototype.on=function(e,n,r){var i=this;return e?(e.split(" ").forEach(function(e){return t.prototype.on.call(i,e,n,r)}),this):this},n.prototype.off=function(e,n,r){var i=this;return e?(e.split(" ").forEach(function(e){return t.prototype.off.call(i,e,n,r)}),this):this},n.prototype.once=function(e,n,r){var i=this;return e?(e.split(" ").forEach(function(e){return t.prototype.once.call(i,e,n,r)}),this):this},n.prototype.removeAllListeners=function(e){var n=this;return e?(e.split(" ").forEach(function(e){return t.prototype.removeAllListeners.call(n,e)}),this):this},Object.defineProperty(n.prototype,"angle",{get:function(){return e.utils.Angle.getAngle(this)},set:function(t){e.utils.Angle.setAngle(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scaleX",{get:function(){return e.utils.Scale.getScaleX(this)},set:function(t){e.utils.Scale.setScaleX(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scaleY",{get:function(){return e.utils.Scale.getScaleY(this)},set:function(t){e.utils.Scale.setScaleY(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scaleXY",{set:function(t){e.utils.Scale.setScaleXY(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"left",{get:function(){return e.utils.Align.left(this)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"right",{get:function(){return e.utils.Align.right(this)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"top",{get:function(){return e.utils.Align.top(this)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"bottom",{get:function(){return e.utils.Align.bottom(this)},enumerable:!0,configurable:!0}),n}(PIXI.Container);t.Container=n})(t=e.display||(e.display={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(e){var n=t.call(this,e)||this;return n.canDragX=!0,n.canDragY=!0,n.interactive=!0,n._dragDistance=new PIXI.Point,n._minX=n._minY=-Number.MAX_VALUE,n._maxX=n._maxY=Number.MAX_VALUE,n._startPosition=new PIXI.Point,n._velocity=new PIXI.Point,n.isDraggable=!0,n.smoothScrollEnabled=!0,n._isDragging=!1,n.on("touchstart mousedown",function(e){n.onDown(e)}),n}return __extends(n,t),n.prototype.onDown=function(e){var t=this;if(!this._isDraggable)return;if(this._isDragging)return;this.on("mouseup mouseupoutside touchend touchendoutside",function(e){t.onUp(e)}),this.smoothScroll&&this.smoothScroll.kill(),this._dragDistance.set(0,0),this.onDragStart(e.data)},n.prototype.onMove=function(e){this._isDragging?this.onDragMove(e.data):this.onDragStart(e.data)},n.prototype.onUp=function(e){this._isDragging&&(this.onDragStop(e.data),this.removeAllListeners("mousemove mouseup mouseupoutside touchmove touchend touchendoutside"))},n.prototype.onDragStart=function(t){var n=this;this._isDragging=!0,this._dragStart=t.getLocalPosition(this.parent).clone(),this._startPosition.set(this.x,this.y),this.on("mousemove touchmove",function(e){n.onMove(e)}),this.emit(e.DRAG_START,this)},n.prototype.onDragMove=function(t){if(this._isDragging){var n=this.x,r=this.y;this.setPosition(t.getLocalPosition(this.parent).clone()),this.emit(e.DRAG_CHANGE,this,this.x,this.y),this._velocity.set(this.x-n,this.y-r)}},n.prototype.onDragStop=function(t){var n=this;this._isDragging=!1,this.smoothScrollEnabled?this.smoothScroll=TweenMax.to(this._velocity,e.utils.Maths.distance(this._velocity.x,this._velocity.y,0,0),{x:0,y:0,ease:Linear.easeOut,onUpdate:function(){n.canDragX&&(n.x=Math.min(n._maxX,Math.max(n._minX,n._velocity.x+n.x))),n.canDragY&&(n.y=Math.min(n._maxY,Math.max(n._minY,n._velocity.y+n.y))),n.emit(e.DRAG_CHANGE,n,n.x,n.y)},onComplete:function(){n.emit(e.DRAG_STOP,n)},useFrames:!0}):(this.x=Math.min(this._maxX,Math.max(this._minX,this.x)),this.y=Math.min(this._maxY,Math.max(this._minY,this.y)),this.emit(e.DRAG_STOP,this,this.x,this.y))},n.prototype.setPosition=function(e){if(this.canDragX&&this._minX<this._maxX){var t=e.x-this._dragStart.x;this._dragDistance.x=t,this.x=Math.min(this._maxX,Math.max(this._minX,this._startPosition.x+t))}if(this.canDragY&&this._minY<this._maxY){var n=e.y-this._dragStart.y;this._dragDistance.y=n,this.y=Math.min(this._maxY,Math.max(this._minY,this._startPosition.y+n))}},n.prototype.move=function(t,n){t===void 0&&(t=0),n===void 0&&(n=0),this.x=Math.min(this._maxX,Math.max(this._minX,this.x+t)),this.y=Math.min(this._maxY,Math.max(this._minY,this.y+n)),this.emit(e.DRAG_CHANGE,this,this.x,this.y)},n.prototype.forceStopDrag=function(){this._isDragging&&(this.onDragStop(null),this.removeAllListeners("mousemove touchmove"))},Object.defineProperty(n.prototype,"dragDistance",{get:function(){return this._dragDistance},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"maxX",{get:function(){return this._maxX},set:function(e){this._maxX=e,this.x=Math.min(this._maxX,Math.max(this._minX,this.x))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"maxY",{get:function(){return this._maxY},set:function(e){this._maxY=e,this.y=Math.min(this._maxY,Math.max(this._minY,this._velocity.y+this.y))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"minX",{get:function(){return this._minX},set:function(e){this._minX=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"minY",{get:function(){return this._minY},set:function(e){this._minY=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isDraggable",{get:function(){return this._isDraggable},set:function(e){this._isDraggable=e,this.interactive=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"velocity",{get:function(){return this._velocity},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isDragging",{get:function(){return this._isDragging},enumerable:!0,configurable:!0}),n}(e.display.Container);t.Draggable=n})(t=e.display||(e.display={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(e){var n=t.call(this,e)||this;return n.visible=!1,n._isActive=!1,n._isInitialized=!1,n}return __extends(n,t),n.prototype.init=function(){},n.prototype.transitionIn=function(){var t=this;this._isInitialized||(this.init(),this._isInitialized=!0,this.emit(e.INITIALIZED)),this._isActive=!0,this.alpha=0,this.visible=!0,TweenMax.to(this,.15,{alpha:1,onComplete:function(){return t.transitionInComplete()}}),this.emit(e.TRANSITION_IN),this.onResize()},n.prototype.transitionOut=function(){var t=this;this.emit(e.TRANSITION_OUT),this._isActive=!1,this.interactive=!1,TweenMax.to(this,.15,{alpha:0,onComplete:function(){return t.transitionOutComplete()}})},n.prototype.transitionInComplete=function(){this.emit(e.TRANSITION_IN_COMPLETE),this.interactive=!0},n.prototype.transitionOutComplete=function(){this.visible=!1,this.emit(e.TRANSITION_OUT_COMPLETE)},Object.defineProperty(n.prototype,"isActive",{get:function(){return this._isActive},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isInitialized",{get:function(){return this._isInitialized},enumerable:!0,configurable:!0}),n}(e.display.Container);t.Screen=n})(t=e.screens||(e.screens={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t}(e.screens.Screen);t.Overlay=n})(t=e.overlays||(e.overlays={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){},n.prototype.addBtInvite=function(){this.btInvite&&this.btInvite.on(e.CLICK,this.onInvite,this)},n.prototype.addBtBack=function(){this.btBack&&this.btBack.on(e.CLICK,this.onBack,this)},n.prototype.onBack=function(){track("Episodes-Back"),this.game.overlays.hide(this.name)},n.prototype.onCounter=function(){},n.prototype.onInvite=function(){var t=this;track({eventAction:"Episodes-Invite",eventLabel:"CAS"});var n=this.game.episodes.next;if(!n)return;if(this.game.user.isLoggedIn){this.game.overlays.show("loader");var r=new cas.vo.RequestOptions;r.receiverHeadline=loc("episodes_receiver_headline",{episode:n.id}),r.receiverMessage=loc("episodes_receiver_message",{episode:n.id,name:this.game.user.name}),r.senderMessage=loc("episodes_sender_message",{message:r.receiverMessage,episode:n.id}),r.acceptedMessage=loc("episodes_accepted_message",{episode:n.id}),r.imageUrl=this.game.client.config.ogUrl+"/img/cas_episode.png",r.customData={type:e.REQUEST_EPISODE,episode:n.id,user:{id:this.game.user.id,imageUrl:this.game.user.imageUrl,name:this.game.user.name}},casClient.ui.showRequestDialog(r,function(){return t.game.overlays.hide("loader")})}else this.game.user.login(function(){t.game.user.isLoggedIn&&t.onInvite()})},n.prototype.onUser=function(e,t){},n.prototype.update=function(e){var t=this;this.game.episodes.startActivationCountdown(e);var n=this.game.episodes.getActivationsByEpisode(e);n&&n.length>0&&n.forEach(function(e,n){return t.onUser(e,n)})},n.prototype.transitionIn=function(){t.prototype.transitionIn.call(this),this.game.episodes.on(e.model.COOLDOWN_CHANGE,this.onCounter,this),this.game.episodes.on(e.model.COOLDOWN_COMPLETE,this.onCounter,this),this.onCounter()},n.prototype.transitionOutComplete=function(){t.prototype.transitionOutComplete.call(this),this.game.episodes.off(e.model.COOLDOWN_CHANGE,this.onCounter,this),this.game.episodes.off(e.model.COOLDOWN_COMPLETE,this.onCounter,this)},n.NAME="episodes",n}(e.overlays.Overlay);t.Episodes=n})(t=e.overlays||(e.overlays={}))})(gf||(gf={}));var gf;(function(e){var t;(function(e){var t=function(){function e(){this.level=0,this.map=0}return e}();e.TileVO=t})(t=e.vo||(e.vo={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n;(function(t){t.LEVEL_SELECT="levelSelect";var n=function(t){function n(e){var n=t.call(this,e)||this;return n.interactive=!0,n.lastLevel=-1,n.init(),n}return __extends(n,t),n.prototype.init=function(){this.addTrailContainer(),this.build(),this.game.storage.on(e.DATA,this.onStorageData,this)},n.prototype.onStorageData=function(){this.tiles.forEach(function(e){return e.update()})},n.prototype.addTrailContainer=function(){this.container=new e.display.Draggable(this.game),this.container.canDragX=!1,this.addChild(this.container)},n.prototype.getEpisodeByLevel=function(e){var t=1;return this.game.levels.data.episodes.forEach(function(n){if(n.levels.indexOf(e)!=-1)return t=n.id,!0}),t},n.prototype.getPosition=function(){this.positionIndex==this.game.levels.data.positions.length&&(this.positionIndex=0,this.mapIndex++);var e=this.game.levels.data.positions[this.positionIndex];return this.positionIndex++,new PIXI.Point(e[0]/this.game.client.config.assetsResolution,e[1]/this.game.client.config.assetsResolution)},n.prototype.addTile=function(t,n){var r=new e.vo.TileVO;r.level=t,r.episode=n;var i=this.getPosition();r.x=i.x,r.y=i.y,r.map=this.mapIndex;var s=new this.game.client.config.TrailTileClass(this.game,r);s.on(e.ui.trail.LEVEL_SELECT,this.selectLevel,this),this.container.addChild(s),this.tiles.push(s)},n.prototype.build=function(){this.mapIndex=1,this.positionIndex=0,this.tiles=[];var e,t=1;for(var n=0;n<=this.game.levels.levelCount-1;++n)e=this.getEpisodeByLevel(n),e!=t&&(this.addTile(-1,e),t=e),this.addTile(n,e)},n.prototype.selectLevel=function(t){var n=this;if(t.level==-1||!this.game.episodes.isEpisodeUnlocked(t.episode)){var r=this.game.overlays.show("episodes");r.update(t.episode)}else this.game.levels.loadLevel(t.level,function(){n.game.levels.currentLevel=n.game.levels.getLevelVO(t.level),n.emit(e.ui.trail.LEVEL_SELECT)},!0,5)},n.prototype.update=function(){var e=this;if(!this.tiles)return;this.tiles.forEach(function(t){t.update(),t.tileVO.level==e.game.user.progress.getProgress().level&&t.tileVO.level>e.lastLevel&&(e.moveToTile(t),e.lastLevel=t.tileVO.level)})},n.prototype.move=function(e){this.container.move(0,e)},n.prototype.moveToTile=function(e){var t=-e.y*this.container.scale.x+(this.game.height>>1);TweenMax.to(this.container,.5,{y:Math.min(this.container.maxY,Math.max(this.container.minY,t)),ease:Quad.easeInOut})},n.prototype.onResize=function(){this.container.minY=this.game.height,this.container.maxY=this.game.height+(this.container.height-this.game.height),this.container.y=Math.min(this.container.maxY,Math.max(this.container.minY,this.container.y)),t.prototype.onResize.call(this)},n}(e.display.Container);t.Trail=n})(n=t.trail||(t.trail={}))})(t=e.ui||(e.ui={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(){var n=t!==null&&t.apply(this,arguments)||this;return n.FooterClass=null,n.HeaderClass=null,n.TrailClass=e.ui.trail.Trail,n.appName="",n.antialias=!1,n.assetsResolution=2,n.cacheBuster="",n.canvasDomId="",n.consoleExists=typeof console!="undefined"&&typeof log!="undefined"&&typeof log.apply!="undefined",n.custom={},n.customerUrl="",n.debug=!1,n.forceCanvas=!1,n.forceWebGL=!1,n.hasEndless=!0,n.hasFooter=!0,n.hasHeader=!0,n.hasInbox=!0,n.hasLives=!0,n.hasLogin=!0,n.hasRaffle=!1,n.highscoreLimit=7,n.isIframe=!1,n.isMobile=PIXI.utils.isMobile.tablet||PIXI.utils.isMobile.phone,n.language="de",n.minHeight=321,n.minWidth=321,n.musicUrl="",n.muteFxDefault=!1,n.muteMusicDefault=!1,n.noSounds=!1,n.ogUrl="",n.queries={},n.renderType=e.RENDER_TYPE_DEFAULT,n.resolution=e.utils.Resolution.getResolution(),n.roundPixels=!1,n.shareUrl="",n.targetWindow=window,n.transparent=!0,n.unlockedLevels=1,n.useCAS=!0,n.version="",n}return __extends(n,t),n.prototype.addAssets=function(e){},n.prototype.parseQueries=function(){var e=kr3m.util.Browser.getQueryValues();for(var t in e)typeof this[t]!="undefined"&&(this[t]=e[t]);return e},n.prototype.onRun=function(e){},n}(PIXI.utils.EventEmitter);t.Config=n})(t=e.core||(e.core={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(e){var n=t.call(this)||this;return n.fixedRetryPauseLength=null,n.loadTimeoutSeconds=null,n.retryDownload=!1,n._XDomainRequestFailedOnce=!1,n._retryPauseHandle=null,n._processLoadQueueTimeoutSeconds=0,n._processLoadQueueTimeoutHandle=null,n._loadTimeoutEventSent=!1,n.game=e,n._isLoading=!1,n._hasLoaded=!1,n.crossOrigin=!1,n._fileList=[],n._flightQueue=[],n._processingHead=0,n._fileLoadStarted=!1,n._totalFileCount=0,n._loadedFileCount=0,n._retryList=[],n._retryCount=0,n}return __extends(n,t),n.prototype.processLoadQueue=function(){var t=this;if(!this._isLoading){this.finishedLoading(!0);return}this.cancelLoadTimeoutEvent(),this.loadTimeoutSeconds>0&&(this._processLoadQueueTimeoutHandle=window.setTimeout(function(){t.onLoadProcessLoadQueueTimeout()},this.loadTimeoutSeconds*1e3));var n,r;for(r=0;r<this._flightQueue.length;++r){n=this._flightQueue[r];if(n.loaded||n.error)this._flightQueue.splice(r,1),r--,n.loading=!1,n.requestUrl=null,n.requestObject=null,n.error?(this.retryDownload&&this._retryList.push(n),this.emit(e.LOAD_ERROR,n.key,n),this.loadTest("error")):this._loadedFileCount++,this.emit(e.LOAD_PROGRESS,n.key,!n.error,this._loadedFileCount,this._totalFileCount)}var i=!1;for(r=this._processingHead;r<this._fileList.length;r++)n=this._fileList[r],n.loaded||n.error?r===this._processingHead&&(this._processingHead=r+1):!n.loading&&this._flightQueue.length<4&&(i||(this._fileLoadStarted||(this._fileLoadStarted=!0),this._flightQueue.push(n),n.loading=!0,this.loadFile(n))),!n.loaded&&n.syncPoint&&(i=!0);this._processingHead>=this._fileList.length?(this.cancelLoadTimeoutEvent(),this.retryDownload&&this._retryList.length>0?(this._retryCount++,this._retryPauseSecondsLeft=this.getRetryPauseLengthSeconds(),this.retryPauseTick()):this.finishedLoading()):this._flightQueue.length||(logWarning("gf.core.Loader - aborting: processing queue empty, loading may have stalled"),setTimeout(function(){t.finishedLoading(!0)},2e3))},n.prototype.retryPauseTick=function(){var t=this;this.emit(e.LOAD_RETRY_PAUSE,this._retryCount,this._retryPauseSecondsLeft,function(){t.forceRetryNow()}),this._retryPauseHandle=window.setTimeout(function(){t._retryPauseHandle=null,t._retryPauseSecondsLeft>0?(t._retryPauseSecondsLeft--,t.retryPauseTick()):t.doRetry()},1e3)},n.prototype.forceRetryNow=function(){this._retryPauseHandle!==null&&(window.clearTimeout(this._retryPauseHandle),this._retryPauseHandle=null,this._retryPauseSecondsLeft=0,this.doRetry())},n.prototype.doRetry=function(){var e=this;this._retryList.forEach(function(t){t.loaded=!1,t.error=!1,e._fileList.push(t)}),this._retryList=[],this.processLoadQueue()},n.prototype.onLoadProcessLoadQueueTimeout=function(){this._processLoadQueueTimeoutSeconds=this.loadTimeoutSeconds,this.loadTimeoutTick()},n.prototype.loadTimeoutTick=function(){var t=this;this._loadTimeoutEventSent=!0,this.emit(e.LOAD_TIMEOUT,this._retryCount,this._processLoadQueueTimeoutSeconds),this._processLoadQueueTimeoutHandle=window.setTimeout(function(){t._processLoadQueueTimeoutSeconds++,t.loadTimeoutTick()},1e3)},n.prototype.cancelLoadTimeoutEvent=function(){this._loadTimeoutEventSent&&(this._loadTimeoutEventSent=!1,this.emit(e.LOAD_TIMEOUT_RESOLVED)),this._processLoadQueueTimeoutHandle!=null&&(window.clearTimeout(this._processLoadQueueTimeoutHandle),this._processLoadQueueTimeoutHandle=null)},n.prototype.loadTest=function(e){try{parent&&parent.location.href==window.location.href+"loadtest.html"&&(window.hasOwnProperty("_kr3m_LT_")||(window._kr3m_LT_={error:0,complete:!1}),e=="error"?window._kr3m_LT_.error+=1:e=="complete"&&(window._kr3m_LT_.complete=!0))}catch(t){}},n.prototype.finishedLoading=function(t){t===void 0&&(t=!1);if(this._hasLoaded)return;this._hasLoaded=!0,this._isLoading=!1,!t&&!this._fileLoadStarted&&(this._fileLoadStarted=!0),this.cancelLoadTimeoutEvent(),this.reset(),this.emit(e.LOAD_COMPLETE),this.loadTest("complete")},n.prototype.asyncComplete=function(e,t){var n=this;t===void 0&&(t="");if(window.simulateLoadTimeout===!0){setTimeout(function(){n.asyncCompleteEx(e,t)},1e4);return}this.asyncCompleteEx(e,t)},n.prototype.asyncCompleteEx=function(e,t){t===void 0&&(t=""),e.loaded=!0,e.error=!!t,t&&(e.errorMessage=t,logWarning("gf.core.Loader - "+e.type+"["+e.key+"]"+": "+t)),this.processLoadQueue()},n.prototype.transformUrl=function(e){var t="?_="+this.game.client.config.version;return e.indexOf(t)>=0?e:(t=(e.indexOf("?")==-1?"?":"&")+"_="+this.game.client.config.version,e.indexOf(t)<0&&(e+=t),e)},n.prototype.loadFile=function(e){var t=this;switch(e.type){case"image":case"textureatlas":case"bitmapfont":case"svg":e.url=this.transformUrl(e.url),this.loadImageTag(e);break;case"woff":WebFont.load({custom:{families:[e.key]},fontactive:function(){t.fileComplete(e)},fontinactive:function(){t.fileComplete(e)}});break;case"audioatlas":e.url=this.transformUrl(e.url),this.xhrLoad(e,e.url,"arraybuffer","fileComplete");break;case"audio":e.url?(e.url=this.transformUrl(e.url),this.xhrLoad(e,e.url,"arraybuffer","fileComplete")):this.fileError(e,null,"no supported audio URL specified");break;case"video":this.xhrLoad(e,e.url,"arraybuffer","videoBufferLoaded");break;case"script":this.xhrLoad(e,this.transformUrl(e.url),"text","fileComplete");break;case"json":e.url=this.transformUrl(e.url),this.xhrLoad(e,e.url,"text","jsonLoadComplete");break;case"xml":e.url=this.transformUrl(e.url),this.xhrLoad(e,e.url,"text","xmlLoadComplete")}},n.prototype.videoBufferLoaded=function(e,t){e.data=e.url,this.fileComplete(e,t)},n.prototype.loadImageTag=function(e){var t=this;e.data=new Image,e.data.name=e.key,this.crossOrigin&&(e.data.crossOrigin=this.crossOrigin),e.data.onload=function(){e.data.onload&&(e.data.onload=null,e.data.onerror=null,t.fileComplete(e))},e.data.onerror=function(){e.data.onload&&(e.data.onload=null,e.data.onerror=null,t.fileError(e))},e.data.src=e.url,e.data.complete&&e.data.width&&e.data.height&&(e.data.onload=null,e.data.onerror=null,this.fileComplete(e))},n.prototype.xhrLoadWithXDR=function(e,t,r,i,s){var o=this,u=new window.XDomainRequest;u.open("GET",t,!0),u.responseType=r,u.timeout=3e3,s=s||"fileError",u.onerror=function(){if(n.retryWithXhrLoad)log("Fallback to xhrLoad:"+t),o._XDomainRequestFailedOnce=!0,o.xhrLoad(e,t,r,i,s);else try{return o[s](e,u)}catch(a){o.asyncComplete(e,a.message||"Exception")}},u.ontimeout=function(){try{return o[s](e,u)}catch(t){o.asyncComplete(e,t.message||"Exception")}},u.onprogress=function(){},u.onload=function(){try{return o[i](e,u)}catch(t){o.asyncComplete(e,t.message||"Exception")}},e.requestObject=u,e.requestUrl=t,setTimeout(function(){u.send()},0)},n.prototype.xhrLoad=function(e,t,n,r,i){var s=this;if(!(this._XDomainRequestFailedOnce!=0||!window.XDomainRequest||"withCredentials"in new XMLHttpRequest)){this.xhrLoadWithXDR(e,t,n,r,i);return}var o=new XMLHttpRequest;o.open("GET",t,!0),o.withCredentials=!0,o.responseType=n,i=i||"fileError",o.onload=function(){return s[r](e,o)},o.onerror=function(){try{return s[i](e,o)}catch(t){s._hasLoaded?logDebug(t,e):s.asyncComplete(e,t.message||"Exception")}},e.requestObject=o,e.requestUrl=t,o.send()},n.prototype.fileError=function(e,t,n){n===void 0&&(n="");var r=e.requestUrl||this.transformUrl(e.url),i="Error loading file from URL "+r;!n&&t&&(n=t.status.toString()),n&&(i=i+" ("+n+")"),this.asyncComplete(e,i)},n.prototype.fileComplete=function(e,t){var n=this,r=!0;switch(e.type){case"image":this.game.cache.addImage(e.key,e.url,e.data);break;case"svg":this.game.cache.addSVG(e.key,e.url,e.data);break;case"woff":break;case"audioatlas":r=!1,e.atlasURL=this.transformUrl(e.atlasURL),this.xhrLoad(e,e.atlasURL,"text","jsonLoadComplete");break;case"script":e.data=document.createElement("script"),e.data.language="javascript",e.data.type="text/javascript",e.data.defer=!1,e.data.text=t.responseText,document.head.appendChild(e.data);break;case"textureatlas":e.atlasURL==null?this.game.cache.addTextureAtlas(e.key,e.url,e.data,e.atlasData):(r=!1,e.atlasURL=this.transformUrl(e.atlasURL),this.xhrLoad(e,e.atlasURL,"text","jsonLoadComplete"));break;case"bitmapfont":e.xmlURL?(r=!1,e.xmlURL=this.transformUrl(e.xmlURL),this.xhrLoad(e,e.xmlURL,"text","xmlLoadComplete")):this.game.cache.addBitmapFont(e.key,e.url,e.data,e.xmlData);break;case"audio":r=!1,e.data=t.response,this.game.cache.addSound(e.key,e.url,e.data),this.game.sounds.addSound(e.key,e.soundType,function(){n.asyncComplete(e)});break;case"video":this.game.cache.addVideo(e.key,e.data)}r&&this.asyncComplete(e)},n.prototype.jsonLoadComplete=function(e,t){var n=this,r;try{r=JSON.parse(t.responseText)}catch(i){logError("JSON parse error file "+e.url,i)}e.type==="json"?(this.game.cache.addJSON(e.key,e.url,r),this.asyncComplete(e)):e.type==="audioatlas"?(this.game.cache.addSound(e.key,e.url,e.data,r),this.game.sounds.addSound(e.key,e.soundType,function(){n.asyncComplete(e)})):(this.game.cache.addTextureAtlas(e.key,e.url,e.data,r),this.asyncComplete(e))},n.prototype.addToFileList=function(t,n,r,i,s){s===void 0&&(s=!1);var o=new e.core.File;o.type=t,o.key=n,o.url=r,o.data=null,o.loading=!1,o.loaded=!1,o.error=!1;if(i)for(var u in i)o[u]=i[u];var a=this.getAssetIndex(t,n);if(s&&a>-1){var f=this._fileList[a];!f.loading&&!f.loaded?this._fileList[a]=o:(this._fileList.push(o),this._totalFileCount++)}else a===-1&&(this._fileList.push(o),this._totalFileCount++)},n.prototype.checkKeyExists=function(e,t){return this.getAssetIndex(e,t)>-1},n.prototype.getAssetIndex=function(e,t){var n=-1;for(var r=0;r<this._fileList.length;r++){var i=this._fileList[r];if(i.type===e&&i.key===t){n=r;if(!i.loaded&&!i.loading)break}}return n},n.prototype.reset=function(t){t===void 0&&(t=!1),this._isLoading=!1,this._processingHead=0,this._fileList.length=0,this._flightQueue.length=0,this._fileLoadStarted=!1,this._totalFileCount=0,this._loadedFileCount=0,t&&(this.removeAllListeners(e.LOAD_COMPLETE),this.removeAllListeners(e.LOAD_ERROR),this.removeAllListeners(e.LOAD_PROGRESS),this.removeAllListeners(e.LOAD_RETRY_PAUSE),this.removeAllListeners(e.LOAD_TIMEOUT),this.removeAllListeners(e.LOAD_TIMEOUT_RESOLVED))},n.prototype.script=function(e,t){return this.addToFileList("script",e,t,{syncPoint:!0},!1),this},n.prototype.image=function(e,t,n){return n===void 0&&(n=!1),this.addToFileList("image",e,t,undefined,n),this},n.prototype.json=function(e,t,n){return n===void 0&&(n=!1),this.addToFileList("json",e,t,undefined,n),this},n.prototype.svg=function(e,t,n){return n===void 0&&(n=!1),this.addToFileList("svg",e,t,null,n),this},n.prototype.xml=function(e,t,n){return n===void 0&&(n=!1),this.addToFileList("xml",e,t,null,n),this},n.prototype.audio=function(t,n,r){return r===void 0&&(r=e.SOUND_MUSIC),this.addToFileList("audio",t,n,{buffer:null,soundType:r}),this},n.prototype.audiosprite=function(t,n,r,i){return i===void 0&&(i=e.SOUND_FX),this.addToFileList("audioatlas",t,n,{atlasURL:r,soundType:i}),this},n.prototype.bitmapFont=function(t,n,r,i){if(r)this.addToFileList("bitmapfont",t,n,{xmlURL:r});else if(typeof i=="string"){var s=e.utils.Parser.XML(i);if(!s)throw new Error("gf.core.Loader. Invalid Bitmap Font XML given");this.addToFileList("bitmapfont",t,n,{xmlURL:null,xmlData:s})}return this},n.prototype.woff=function(e,t,n){n===void 0&&(n=!1),this.addToFileList("woff",e,t,null,n);var r='<style type="text/css">@font-face {font-family:"'+e+'"; src:url("'+t+'") format("woff");}</style>';return $(r).appendTo("head"),this},n.prototype.video=function(e,t,n){return n===void 0&&(n=!1),this.addToFileList("video",e,t,null,n),this},n.prototype.atlas=function(e,t,n,r){return n?this.addToFileList("textureatlas",e,t,{atlasURL:n}):(r=JSON.parse(r),this.addToFileList("textureatlas",e,t,{atlasURL:null,atlasData:r})),this},n.prototype.removeAll=function(){this._fileList.length=0,this._flightQueue.length=0},n.prototype.start=function(){if(this._isLoading)return;this._hasLoaded=!1,this._isLoading=!0,this.processLoadQueue()},Object.defineProperty(n.prototype,"totalLoadedFiles",{get:function(){return this._loadedFileCount},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"totalQueuedFiles",{get:function(){return this._totalFileCount-this._loadedFileCount},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"progressFloat",{get:function(){var t=this._loadedFileCount/this._totalFileCount*100;return e.utils.Maths.clamp(t||0,0,100)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"progress",{get:function(){return Math.round(this.progressFloat)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"hasLoaded",{get:function(){return this._hasLoaded},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isLoading",{get:function(){return this._isLoading},enumerable:!0,configurable:!0}),n.prototype.getRetryPauseLengthSeconds=function(){return this.fixedRetryPauseLength!==null?this.fixedRetryPauseLength:this._retryCount>20?60:this._retryCount>10?20:5},n.retryWithXhrLoad=!1,n}(PIXI.utils.EventEmitter);t.Loader=n;var r=function(){function e(){}return e}();t.File=r;var i=function(){function e(e,t){this.index=e,this.file=t}return e}();t.Asset=i})(t=e.core||(e.core={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(e){function t(t){var n=e.call(this,t)||this;return n.name="overlays",n._overlays={},n.interactive=!0,n}return __extends(t,e),t.prototype.add=function(e,t){this._overlays[e]=t,t.name=e,this.addChild(t)},t.prototype.init=function(){this.game.stage.addChild(this);if(!this.game.client.config.overlays)return;var e;for(var t=0;t<this.game.client.config.overlays.length;++t)e=this.game.client.config.overlays[t],e.name&&e.class?this.add(e.name,new e.class(this.game)):this.add(e.NAME,new e(this.game))},t.prototype.show=function(e){var t=this.getOverlay(e);if(!t){logWarning("Error: gf.core.Overlays.show(). No overlay found with name: "+e);return}return this.swapChildren(this.getChildAt(this.children.length-1),t),t.transitionIn(),this._currentName=e,t},t.prototype.hide=function(e){var t=this.getOverlay(e);return t?(this.getOverlay(e).transitionOut(),this.getOverlay(e)):null},t.prototype.getOverlay=function(e){return this._overlays[e]||logWarning('Error: gf.core.Overlays.getOverlay(). No overlay with name "'+e+'" found.'),this._overlays[e]},t.prototype.onResize=function(){var e;for(var t in this._overlays)e=this._overlays[t],e.isActive&&this._overlays[t].onResize()},Object.defineProperty(t.prototype,"current",{get:function(){var e=[],t;for(var n in this._overlays)t=this._overlays[n],t.isActive&&e.push(t);return e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"currentNames",{get:function(){var e=[],t;for(var n in this._overlays)t=this._overlays[n],t.isActive&&e.push(n);return e},enumerable:!0,configurable:!0}),t}(e.display.Container);t.Overlays=n})(t=e.core||(e.core={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(e){var n=t.call(this)||this;return n._lastHeight=0,n._lastMaxHeight=0,n._lastOrientation=0,n._lastParentHeight=0,n._lastParentWidth=0,n._lastWidth=0,n._orientation=0,n.game=e,n._orientation=0,n}return __extends(n,t),n.prototype.init=function(){var e=this;$(window).on("orientationchange resize",function(){setTimeout(function(){setTimeout(function(){e.checkOrientation(),(PIXI.utils.isMobile.tablet||PIXI.utils.isMobile.phone)&&e.setMaxHeight(0)},500)},50),PIXI.utils.isMobile.apple.device||e.checkOrientation()});var t=!1;try{top.location.href!=window.location.href&&(t=!0)}catch(n){}(PIXI.utils.isMobile.tablet||PIXI.utils.isMobile.phone)&&!t&&($(window).on("focus",function(){$(e.game.canvas).hide(),setTimeout(function(){$(e.game.canvas).show(),e.checkOrientation(),e.setMaxHeight(0)},100)}),this.setMaxHeight(0)),PIXI.utils.isMobile.apple.device&&this.addOrientationFix(),this.checkOrientation()},n.prototype.addOrientationFix=function(){function f(){e.setAttribute("content",r),i=!0}function l(){e.setAttribute("content",n),i=!1}function c(e){a=e.accelerationIncludingGravity,s=Math.abs(a.x),o=Math.abs(a.y),u=Math.abs(a.z),(!window.orientation||window.orientation===180)&&(s>7||(u>6&&o<8||u<8&&o>6)&&s>5)?i&&l():i||f()}if(!window.document.querySelector)return;var e=window.document.querySelector("meta[name=viewport]"),t=e&&e.getAttribute("content"),n=t+",maximum-scale=1",r=t+",maximum-scale=10",i=!0,s,o,u,a;if(!e)return;window.addEventListener("orientationchange",f,!1),window.addEventListener("devicemotion",c,!1)},n.prototype.getScreenOrientation=function(){var e=window.screen,t=e.orientation||e.mozOrientation||e.msOrientation;return t&&typeof t.type=="string"?t.type.indexOf("portrait")!=-1?0:90:typeof t=="string"?t.indexOf("portrait")!=-1?0:90:window.matchMedia?window.matchMedia("(orientation: portrait)").matches?0:window.matchMedia("(orientation: landscape)").matches?90:this.height>this.width?0:90:this.height>this.width?0:90},n.prototype.checkOrientation=function(){this._orientation=this.getScreenOrientation(),this._wasLandscape&&this.isPortrait?this.emit(e.PORTRAIT,this._orientation,!1,!0):!this._wasLandscape&&this.isLandscape&&this.emit(e.LANDSCAPE,this._orientation,!0,!1),this._wasLandscape=this.isLandscape,this.updateSize()},n.prototype.updateSize=function(){var e=!1;PIXI.utils.isMobile.any||(e=!0),PIXI.utils.isMobile.apple.device&&(e=!0),this._lastWidth!=this.parentWidth&&this._lastHeight!=this.parentHeight&&(e=!0),this.parentHeight>this._lastHeight&&(e=!0),this._lastWidth!=this.parentWidth&&(e=!0),this._lastOrientation!=this._orientation&&(e=!0),this.parentHeight>this._lastParentHeight&&(e=!0),this.game.isCordova&&this.parentHeight<this._lastParentHeight&&(e=!1),e&&(PIXI.utils.isMobile.android.device&&$("#kr3m").css("minHeight","0px"),this._lastOrientation=this._orientation,this._lastWidth=this.parentWidth,this._lastHeight=this.parentHeight,this._lastParentWidth=this.parentWidth,this._lastParentHeight=this.parentHeight,this.game.renderer.resize(this.parentWidth,this.parentHeight),this.game.isCordova||window.scrollTo(0,0),PIXI.utils.isMobile.android.device&&$("#kr3m").css("minHeight",this._lastParentHeight+"px"),this.game.resize())},n.prototype.setMaxHeight=function(e){var t=this;if(this.game.isCordova)return;if(window.innerHeight){if(this._lastMaxHeight!=window.innerHeight){this._lastMaxHeight=window.innerHeight;var n=document.getElementById("kr3m");n&&(n.style.maxHeight=""+this._lastMaxHeight+"px",this.updateSize())}e<10&&setTimeout(function(){t.setMaxHeight(e+1)},200)}},Object.defineProperty(n.prototype,"styleSize",{get:function(){return new PIXI.Point(this.parentWidth,this.parentHeight)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isPortrait",{get:function(){return this.width<this.height},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isLandscape",{get:function(){return!this.isPortrait},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"parentWidth",{get:function(){return $(this.game.canvas.parentElement).width()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"parentHeight",{get:function(){return $(this.game.canvas.parentElement).height()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"width",{get:function(){var e=this.parentWidth<this.parentHeight;return!e&&this.parentHeight<this.game.client.config.minHeight||e&&this.parentWidth<this.game.client.config.minWidth?(this.game.stage.scaleX=this.game.stage.scaleY=1/1.5,this.parentWidth*1.5):(this.game.stage.scaleX=this.game.stage.scaleY=1,this.parentWidth)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"height",{get:function(){var e=this.parentWidth<this.parentHeight;return!e&&this.parentHeight<this.game.client.config.minHeight||e&&this.parentWidth<this.game.client.config.minWidth?(this.game.stage.scaleX=this.game.stage.scaleY=1/1.5,this.parentHeight*1.5):(this.game.stage.scaleX=this.game.stage.scaleY=1,this.parentHeight)},enumerable:!0,configurable:!0}),n}(PIXI.utils.EventEmitter);t.Scale=n})(t=e.core||(e.core={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(e){var n=t.call(this,e)||this;return n.name="screens",n._screens={},n.interactive=!0,n}return __extends(n,t),n.prototype.add=function(e,t){this._screens[e]=t,t.name=e,this.addChild(t)},n.prototype.init=function(){this.game.stage.addChild(this);if(!this.game.client.config.screens)return;var e;for(var t=0;t<this.game.client.config.screens.length;++t)e=this.game.client.config.screens[t],e.name&&e.class?this.add(e.name,new e.class(this.game)):this.add(e.NAME,new e(this.game))},n.prototype.show=function(t){var n=this;if(!this._currentName){this._currentName=t;var r=this.getScreen(t);return r.transitionIn(),this.emit(e.SCREEN,r,this._currentName),this.current}if(this._currentName==t)return this.current.transitionIn(),this.current;var i=this.getScreen(this._currentName),s=this.getScreen(t);if(!s){logWarning('Error: gf.core.Screens.show(). No screen found with name: "'+t+'"');return}return this._previousName=this._currentName,i.once(e.TRANSITION_OUT_COMPLETE,function(){n._currentName=s.name,s.transitionIn(),n.emit(e.SCREEN,s,s.name)},this),i.transitionOut(),s},n.prototype.hide=function(e){return this.getScreen(e).transitionOut(),this.getScreen(e)},n.prototype.showPrevious=function(){return!this._previousName||this._previousName===this._currentName?(this._previousName?logWarning("Error: gf.core.Screens.showPrevious(). Current screen is equal to previous screen."):logWarning("Error: gf.core.Screens.showPrevious(). No previous screen available."),null):this.show(this._previousName)},n.prototype.getScreen=function(e){return this._screens[e]||logWarning('Error: gf.core.Screens.getScreen(). No screen with name "'+e+'" found.'),this._screens[e]},n.prototype.hasScreen=function(e){return!!this._screens[e]},n.prototype.onResize=function(){var e;for(var t in this._screens)e=this._screens[t],e.isActive&&this._screens[t].onResize()},Object.defineProperty(n.prototype,"currentName",{get:function(){return this._currentName},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"current",{get:function(){return this.getScreen(this._currentName)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"previous",{get:function(){return this.getScreen(this._previousName)},enumerable:!0,configurable:!0}),n}(e.display.Container);t.Screens=n})(t=e.core||(e.core={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(){function t(t){this.game=t,this.forceFxPlay=!1,this.game.on(e.BLUR,this.onBlur,this),this.game.on(e.FOCUS,this.onFocus,this),this.game.on(e.RUNNING,this.onRun,this),this.game.storage.on(e.DATA,this.onStorage,this),this.fx=[],this.music=[],this._soundsPlaying=[]}return t.prototype.onRun=function(){var e=this;if(this.game.client.config.noSounds||!Howler.ctx)return;Howler.autoSuspend=!1,Howler.ctx.onstatechange=function(){return e.checkState()}},t.prototype.checkState=function(){var e=this;Howler.ctx.state!="running"&&Howler.ctx.suspend().then(function(){e.resumeContext()},function(t){e.resumeContext()})},t.prototype.suspendContext=function(){Howler.ctx.suspend().then(function(){},function(e){log("Howler.ctx.suspend() failed")})},t.prototype.resumeContext=function(){var e=this;Howler.ctx.resume().then(function(){typeof window["webkitAudioContext"]!="undefined"&&setTimeout(function(){return Howler.ctx.startRendering()},1500)},function(t){log("Howler.ctx.resume() failed."),e.resumeContext()})},t.prototype.onStorage=function(){typeof this._fxMuted=="undefined"&&(this._fxMuted=!1),typeof this.game.storage.getItem("fxMuted")=="undefined"?this.muteFx(this.game.client.config.muteMusicDefault?!0:this._fxMuted):this.muteFx(!!this.game.storage.getItem("fxMuted")),typeof this._musicMuted=="undefined"&&(this._musicMuted=!1),typeof this.game.storage.getItem("musicMuted")=="undefined"?this.muteMusic(this.game.client.config.muteFxDefault?!0:this._musicMuted):this.muteMusic(!!this.game.storage.getItem("musicMuted"))},t.prototype.muteSounds=function(e,t){for(var n=0;n<t.length;++n)t[n].sound.mute(e)},t.prototype.stopSound=function(t,n,r){r===void 0&&(r="");for(var i=0;i<this._soundsPlaying.length;++i)if(this._soundsPlaying[i].key==t&&this._soundsPlaying[i].frame==r){e.core.Sounds.getSound(t,n).stop(this._soundsPlaying[i].soundId),this._soundsPlaying.splice(i,1);break}},t.getSound=function(e,t){var n;for(var r=0;r<t.length;++r)if(t[r].key==e){n=t[r].sound;break}return n},t.soundAdded=function(e,t){var n=!1;for(var r=0;r<t.length;++r)if(t[r].key==e){n=!0;break}return n},t.prototype.onBlur=function(){this._fxWasMuted=this._fxMuted,this._musicWasMuted=this._musicMuted,this._fxMuted=!0,this.muteSounds(!0,this.fx),this._musicMuted=!0,this.muteSounds(!0,this.music)},t.prototype.onFocus=function(){this._fxMuted=this._fxWasMuted,this.muteSounds(this._fxWasMuted,this.fx),this._musicMuted=this._musicWasMuted,this.muteSounds(this._musicWasMuted,this.music)},t.prototype.playFx=function(t,n,r,i){var s=this;n===void 0&&(n=""),r===void 0&&(r=!1),i===void 0&&(i=1);var o=this.getFx(t,r,i);return!o||this._fxMuted&&!this.forceFxPlay?null:(o.on("play",function(r){s._soundsPlaying.push({key:t,frame:n,soundId:r}),s._fxMuted&&e.core.Sounds.getSound(t,s.fx).mute(!0,r)}),n.length>0?o.stop().play(n):o.stop().play(),o)},t.prototype.stopFx=function(e,t){t===void 0&&(t=""),this.stopSound(e,this.fx,t)},t.prototype.stopAllFx=function(){for(var e=0;e<this.fx.length;++e)for(var t=0;t<this._soundsPlaying.length;++t)this._soundsPlaying[t].key==this.fx[e].key&&this.stopFx(this._soundsPlaying[t].key,this._soundsPlaying[t].frame)},t.prototype.playMusic=function(t,n,r,i){var s=this;n===void 0&&(n=""),r===void 0&&(r=!1),i===void 0&&(i=1);var o=this.getMusic(t,r,i);return o?(o.on("play",function(r){s._soundsPlaying.push({key:t,frame:n,soundId:r}),s._musicMuted&&e.core.Sounds.getSound(t,s.music).mute(!0,r)}),n.length>0?o.stop().play(n):o.stop().play(),o.loop(r),o.volume(i),o):null},t.prototype.stopMusic=function(e){this.stopSound(e,this.music)},t.prototype.muteFx=function(e,t){t===void 0&&(t=!0),this._fxMuted=e,this.muteSounds(e,this.fx),t&&this.game.storage.setItem("fxMuted",e)},t.prototype.muteMusic=function(e,t){t===void 0&&(t=!0),this._musicMuted=e,this.muteSounds(e,this.music),t&&this.game.storage.setItem("musicMuted",e)},t.prototype.addSound=function(t,n,r){var i=this,s=n==e.SOUND_FX?this.fx:this.music;if(e.core.Sounds.soundAdded(t,s)){r&&r();return}var o,u=this.game.cache.getSound(t).json,a={src:[this.game.cache.getSound(t).url],onload:function(){r&&r()},onloaderror:function(e,n){logWarning("Error loading sound (ID: "+e+", key: "+t+", url: "+i.game.cache.getSound(t).url+". "+n),r&&r()}};return u&&(a.sprite=u.sprite),o=new Howl(a),s.push({key:t,sound:o}),o},t.prototype.reload=function(e){var t=this;this._soundsReloaded=0;var n=[];this.fx.forEach(function(e){n.push(e.key)}),this.fx=[],n.forEach(function(n){t._soundsReloaded++,t.addSound(n,"fx",function(){t.soundReloaded(e)})});var r=[];this.music.forEach(function(e){r.push(e.key)}),this.music=[],r.forEach(function(n){t._soundsReloaded++,t.addSound(n,"music",function(){t.soundReloaded(e)})})},t.prototype.soundReloaded=function(e){this._soundsReloaded--,this._soundsReloaded==0&&e&&e()},t.prototype.getFx=function(t,n,r){n===void 0&&(n=!1),r===void 0&&(r=1);var i=e.core.Sounds.getSound(t,this.fx);return i?(i.loop(n),i.volume(r),i):null},t.prototype.getMusic=function(t,n,r){n===void 0&&(n=!1),r===void 0&&(r=1);var i=e.core.Sounds.getSound(t,this.music);return i?(i.loop(n),i.volume(r),i):null},Object.defineProperty(t.prototype,"isFxMuted",{get:function(){return this._fxMuted},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isMusicMuted",{get:function(){return this._musicMuted},enumerable:!0,configurable:!0}),t}();t.Sounds=n})(t=e.core||(e.core={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n)||this;return r.name="stage",r.interactive=!0,r.game.on(e.RESIZE,r.onResize,r),r}return __extends(n,t),n.prototype.addFooter=function(){if(!this.game.client.config.FooterClass)return;this.footer=new this.game.client.config.FooterClass(this.game),this.footer.interactive=!0,this.addChild(this.footer)},n.prototype.addHeader=function(){if(!this.game.client.config.HeaderClass)return;this.header=new this.game.client.config.HeaderClass(this.game),this.header.interactive=!0,this.addChild(this.header)},n}(e.display.Container);t.Stage=n})(t=e.core||(e.core={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(n,r,i,s,o,u,a){var f=t.call(this,n.cache.getTexture("__default"),r/n.client.config.assetsResolution,i/n.client.config.assetsResolution,s/n.client.config.assetsResolution,o/n.client.config.assetsResolution)||this;return f.rtTextures={},f.game=n,f.name="",f.alignData=new e.utils.AlignData,f.userData={},f._key=u,f._frameName=a,e.utils.Render.shouldApplyPixiFix(f.game.renderer)&&f.applyPixiFix(),f.game.renderer.type==PIXI.RENDERER_TYPE.WEBGL&&f.game.renderer.gl.canvas.addEventListener("webglcontextrestored",function(e){for(var t in f.rtTextures)delete PIXI.utils.TextureCache[t];window.setTimeout(function(){f.updateTexture()})},!1),f.updateTexture(),f}return __extends(n,t),n.prototype.updateRegions=function(e,t,n,r){var i=this.width,s=this.height;this.leftWidth=e/this.game.client.config.assetsResolution,this.topHeight=t/this.game.client.config.assetsResolution,this.rightWidth=n/this.game.client.config.assetsResolution,this.bottomHeight=r/this.game.client.config.assetsResolution,this.updateTexture(),this.width=i,this.height=s},n.prototype.updateTexture=function(){var t=1;this.key instanceof PIXI.Texture?t=this.key.baseTexture.resolution:t=PIXI.utils.TextureCache[this.key.toString()].baseTexture.resolution;if(this._frameName){if(!PIXI.utils.TextureCache[this.key+"-"+this._frameName]){var n=new e.display.Sprite(this.game,this.key,this._frameName),r=new PIXI.BaseRenderTexture(n.width*t,n.height*t,PIXI.SCALE_MODES.LINEAR,t),i=new PIXI.RenderTexture(r);n.scaleX=t,n.scaleY=t,this.game.renderer.render(n,i),this.rtTextures[this.key+"-"+this._frameName]=!0,PIXI.Texture.addTextureToCache(i,this.key+"-"+this._frameName)}this.texture=PIXI.Texture.fromFrame(this.key+"-"+this._frameName)}else this.texture=PIXI.Texture.fromFrame(this.key);this._origWidth=this.texture.width/t,this._origHeight=this.texture.height/t,this._uvw=1/this._origWidth,this._uvh=1/this._origHeight,this._width=this._width>1?this._width:this._origWidth,this._height=this._height>1?this._height:this._origHeight;var s=this.uvs;s[2]=s[10]=s[18]=s[26]=this._uvw*this.leftWidth,s[4]=s[12]=s[20]=s[28]=1-this._uvw*this.rightWidth,s[9]=s[11]=s[13]=s[15]=this._uvh*this.topHeight,s[17]=s[19]=s[21]=s[23]=1-this._uvh*this.bottomHeight,this.updateHorizontalVertices(),this.updateVerticalVertices(),this.onResize()},Object.defineProperty(n.prototype,"maxWidth",{get:function(){return this._maxWidth},set:function(e){this._maxWidth=e,this.width=Math.min(this.width,this._maxWidth)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"width",{get:function(){return this._width},set:function(e){if(e==this._width)return;this._width=this._maxWidth?Math.min(e,this._maxWidth):e,this.updateVerticalVertices(),this.game&&this.alignData&&this.onResize()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"height",{get:function(){return this._height},set:function(e){if(e==this._height)return;this._height=Math.max(e,this.topHeight+this.bottomHeight),this.updateHorizontalVertices(),this.game&&this.alignData&&this.onResize()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"origWidth",{get:function(){return this._origWidth},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"origHeight",{get:function(){return this._origHeight},enumerable:!0,configurable:!0}),n.prototype.hAlign=function(t,n,r){r===void 0&&(r=0),e.utils.Align.hAlign(this,t,n,r)},n.prototype.vAlign=function(t,n,r){r===void 0&&(r=0),e.utils.Align.vAlign(this,t,n,r)},n.prototype.onResize=function(){e.utils.Align.onResize(this)},n.prototype.on=function(e,n,r){var i=this;return e?(e.split(" ").forEach(function(e){return t.prototype.on.call(i,e,n,r)}),this):this},n.prototype.off=function(e,n,r){var i=this;return e?(e.split(" ").forEach(function(e){return t.prototype.off.call(i,e,n,r)}),this):this},n.prototype.once=function(e,n,r){var i=this;return e?(e.split(" ").forEach(function(e){return t.prototype.once.call(i,e,n,r)}),this):this},n.prototype.removeAllListeners=function(e){var n=this;return e?(e.split(" ").forEach(function(e){return t.prototype.removeAllListeners.call(n,e)}),this):this},Object.defineProperty(n.prototype,"angle",{get:function(){return e.utils.Angle.getAngle(this)},set:function(t){e.utils.Angle.setAngle(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scaleX",{get:function(){return e.utils.Scale.getScaleX(this)},set:function(t){e.utils.Scale.setScaleX(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scaleY",{get:function(){return e.utils.Scale.getScaleY(this)},set:function(t){e.utils.Scale.setScaleY(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scaleXY",{set:function(t){e.utils.Scale.setScaleXY(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"left",{get:function(){return e.utils.Align.left(this)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"right",{get:function(){return e.utils.Align.right(this)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"top",{get:function(){return e.utils.Align.top(this)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"bottom",{get:function(){return e.utils.Align.bottom(this)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"key",{get:function(){return this._key},set:function(e){if(this._key==e)return;this._key=e,this.updateTexture()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"frameName",{get:function(){return this._frameName},set:function(e){if(this._frameName==e)return;this._frameName=e,this.updateTexture()},enumerable:!0,configurable:!0}),n.prototype.applyPixiFix=function(){var e=this;this.game.renderer.gl.canvas.addEventListener("webglcontextrestored",function(t){e._glDatas={},e.dirty++,e.indexDirty++,e.vertexDirty=e.vertexDirty+1},!1)},n}(PIXI.mesh.NineSlicePlane);t.Slice9=n})(t=e.display||(e.display={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(n,r,i){var s=this,o;return typeof r=="string"?o=e.utils.Texture.getTexture(n,r,i):o=r,s=t.call(this,o,100,100)||this,s.game=n,s.name="",s.alignData=new e.utils.AlignData,s.userData={},s._key=r?r:"__default",s._frameName=i,s.orgWidth=o.width,s.orgHeight=o.height,s.width=o.width,s.height=o.height,s}return __extends(n,t),n.prototype.updateTexture=function(){e.utils.Texture.update(this)},n.prototype.updateKeyAndFrameName=function(e,t){this._key=e,this._frameName=t,this.updateTexture()},n.prototype.hAlign=function(t,n,r){r===void 0&&(r=0),e.utils.Align.hAlign(this,t,n,r)},n.prototype.vAlign=function(t,n,r){r===void 0&&(r=0),e.utils.Align.vAlign(this,t,n,r)},n.prototype.onResize=function(){e.utils.Align.onResize(this)},n.prototype.on=function(e,n,r){var i=this;return e?(e.split(" ").forEach(function(e){return t.prototype.on.call(i,e,n,r)}),this):this},n.prototype.off=function(e,n,r){var i=this;return e?(e.split(" ").forEach(function(e){return t.prototype.off.call(i,e,n,r)}),this):this},n.prototype.once=function(e,n,r){var i=this;return e?(e.split(" ").forEach(function(e){return t.prototype.once.call(i,e,n,r)}),this):this},n.prototype.removeAllListeners=function(e){var n=this;return e?(e.split(" ").forEach(function(e){return t.prototype.removeAllListeners.call(n,e)}),this):this},Object.defineProperty(n.prototype,"angle",{get:function(){return e.utils.Angle.getAngle(this)},set:function(t){e.utils.Angle.setAngle(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scaleX",{get:function(){return e.utils.Scale.getScaleX(this)},set:function(t){e.utils.Scale.setScaleX(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scaleY",{get:function(){return e.utils.Scale.getScaleY(this)},set:function(t){e.utils.Scale.setScaleY(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scaleXY",{set:function(t){e.utils.Scale.setScaleXY(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"left",{get:function(){return e.utils.Align.left(this)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"right",{get:function(){return e.utils.Align.right(this)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"top",{get:function(){return e.utils.Align.top(this)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"bottom",{get:function(){return e.utils.Align.bottom(this)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"key",{get:function(){return this._key},set:function(e){this._key=e,this.updateTexture()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"frameName",{get:function(){return this._frameName},set:function(e){this._frameName=e,this.updateTexture()},enumerable:!0,configurable:!0}),n}(PIXI.extras.TilingSprite);t.TilingSprite=n})(t=e.display||(e.display={}))})(gf||(gf={}));var gf;(function(e){var t;(function(e){var t=function(){function e(){}return e.update=function(e){if(e.key instanceof PIXI.Texture)e.texture=e.key;else{var t=e.game.cache.getFrameData(e.key);if(e.frameName){var n=t.getFrameByName(e.frameName);this.setFrame(e,n)}else t?this.setFrame(e,t.getFrame()):logWarning("Warning: Can't find frame data with key: "+e.key)}},e.getTexture=function(e,t,n){var r=e.cache.getFrameData(t),i=n?r.getFrameByName(n):r.getFrame();return new PIXI.Texture(PIXI.utils.TextureCache[t],i.frame,i.orig,i.trim,i.rotated?2:0)},e.setFrame=function(e,t){try{e.frame=t,e.texture=new PIXI.Texture(PIXI.utils.TextureCache[e.key],t.frame,t.orig,t.trim,t.rotated?2:0)}catch(n){logWarning("gf.utils.Texture.setFrame() error with key: "+e.key+", frame: "+e.frameName)}},e.crop=function(e,t){var n=e.texture.frame.clone();n.x+=t.x,n.y+=t.y,n.width=t.width,n.height=t.height,e.texture.frame=n,e.texture._updateUvs()},e}();e.Texture=t})(t=e.utils||(e.utils={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(n,r,i){var s=t.call(this,n.cache.getTexture("__default"))||this;return s.game=n,s.name="",s.alignData=new e.utils.AlignData,s.userData={},s._key=r?r:"__default",s._frameName=i||"",s.updateTexture(),s}return __extends(n,t),n.prototype.updateTexture=function(){e.utils.Texture.update(this)},n.prototype.updateKeyAndFrameName=function(e,t){this._key=e,this._frameName=t||"",this.updateTexture()},n.prototype.hAlign=function(t,n,r){r===void 0&&(r=0),e.utils.Align.hAlign(this,t,n,r)},n.prototype.vAlign=function(t,n,r){r===void 0&&(r=0),e.utils.Align.vAlign(this,t,n,r)},n.prototype.onResize=function(){e.utils.Align.onResize(this)},n.prototype.on=function(e,n,r){var i=this;return e?(e.split(" ").forEach(function(e){return t.prototype.on.call(i,e,n,r)}),this):this},n.prototype.off=function(e,n,r){var i=this;return e?(e.split(" ").forEach(function(e){return t.prototype.off.call(i,e,n,r)}),this):this},n.prototype.once=function(e,n,r){var i=this;return e?(e.split(" ").forEach(function(e){return t.prototype.once.call(i,e,n,r)}),this):this},n.prototype.removeAllListeners=function(e){var n=this;return e?(e.split(" ").forEach(function(e){return t.prototype.removeAllListeners.call(n,e)}),this):this},Object.defineProperty(n.prototype,"angle",{get:function(){return e.utils.Angle.getAngle(this)},set:function(t){e.utils.Angle.setAngle(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scaleX",{get:function(){return e.utils.Scale.getScaleX(this)},set:function(t){e.utils.Scale.setScaleX(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scaleY",{get:function(){return e.utils.Scale.getScaleY(this)},set:function(t){e.utils.Scale.setScaleY(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scaleXY",{set:function(t){e.utils.Scale.setScaleXY(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"left",{get:function(){return e.utils.Align.left(this)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"right",{get:function(){return e.utils.Align.right(this)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"top",{get:function(){return e.utils.Align.top(this)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"bottom",{get:function(){return e.utils.Align.bottom(this)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"key",{get:function(){return this._key},set:function(e){this._key=e,this.updateTexture()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"frameName",{get:function(){return this._frameName},set:function(e){this._frameName=e,this.updateTexture()},enumerable:!0,configurable:!0}),n}(PIXI.Sprite);t.Sprite=n})(t=e.display||(e.display={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(n,r,i){var s=t.call(this,r,i)||this;return s.game=n,s.name="",s.alignData=new e.utils.AlignData,s.userData={},r&&i&&s.updateText(!0),s}return __extends(n,t),n.prototype.truncate=function(e){var t=this.text;this.text="...";var n=this.width;if(e<=n){this.text="...";return}t&&(this.text=t);var r=this.text.length;while(this.width>e)this.text=this.text.substring(0,r-2)+"...",r--;return this},n.prototype.update=function(e){this.updateText(e)},n.prototype.hAlign=function(t,n,r){r===void 0&&(r=0),e.utils.Align.hAlign(this,t,n,r)},n.prototype.vAlign=function(t,n,r){r===void 0&&(r=0),e.utils.Align.vAlign(this,t,n,r)},n.prototype.onResize=function(){e.utils.Align.onResize(this)},n.prototype.on=function(e,n,r){var i=this;return e?(e.split(" ").forEach(function(e){return t.prototype.on.call(i,e,n,r)}),this):this},n.prototype.off=function(e,n,r){var i=this;return e?(e.split(" ").forEach(function(e){return t.prototype.off.call(i,e,n,r)}),this):this},n.prototype.once=function(e,n,r){var i=this;return e?(e.split(" ").forEach(function(e){return t.prototype.once.call(i,e,n,r)}),this):this},n.prototype.removeAllListeners=function(e){var n=this;return e?(e.split(" ").forEach(function(e){return t.prototype.removeAllListeners.call(n,e)}),this):this},Object.defineProperty(n.prototype,"angle",{get:function(){return e.utils.Angle.getAngle(this)},set:function(t){e.utils.Angle.setAngle(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scaleX",{get:function(){return e.utils.Scale.getScaleX(this)},set:function(t){e.utils.Scale.setScaleX(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scaleY",{get:function(){return e.utils.Scale.getScaleY(this)},set:function(t){e.utils.Scale.setScaleY(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scaleXY",{set:function(t){e.utils.Scale.setScaleXY(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"left",{get:function(){return e.utils.Align.left(this)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"right",{get:function(){return e.utils.Align.right(this)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"top",{get:function(){return e.utils.Align.top(this)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"bottom",{get:function(){return e.utils.Align.bottom(this)},enumerable:!0,configurable:!0}),n}(PIXI.Text);t.Text=n})(t=e.display||(e.display={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){t.COOLDOWN_CHANGE="cooldownChange",t.COOLDOWN_COMPLETE="cooldownComplete";var n=function(t){function n(e,n,r,i,s){var o=t.call(this)||this;return o.game=e,o.duration=n,o.currentValue=r,o.maxValue=r,o.defaultValue=s?s:r,o.storageToken=i,o}return __extends(n,t),n.prototype.onStorageData=function(t){this.timeLeft=0,this.currentValue=t?t[this.storageToken]:this.game.storage.getItem(this.storageToken),typeof this.currentValue=="undefined"&&(this.currentValue=this.defaultValue),this.timestamp=t?t[this.storageToken+"Timestamp"]:this.game.storage.getItem(this.storageToken+"Timestamp"),typeof this.timestamp=="undefined"&&this.currentValue<this.maxValue&&(this.timestamp=this.currentTime,this.store());if(this.currentValue<this.maxValue){var n=(this.currentTime-this.timestamp)/this.duration>>0;this.currentValue+=n,n>0&&(this.update(),this.store()),this.timeLeft=this.duration-(this.currentTime-this.timestamp-n*this.duration)}this.update(),this.game.on(e.BLUR,this.onBlur,this),this.game.on(e.FOCUS,this.onFocus,this)},n.prototype.store=function(){this.currentValue==this.maxValue-1&&(this.timestamp=this.currentTime),this.game.storage.setItem([this.storageToken,this.storageToken+"Timestamp"],[this.currentValue,this.timestamp])},n.prototype.onFocus=function(){var t=this;this.game.removeListener(e.BLUR,this.onBlur,this),this.game.removeListener(e.FOCUS,this.onFocus,this),this.game.storage.getData(!1,function(e){return t.onStorageData(e)})},n.prototype.onBlur=function(){this.stopCountdown()},n.prototype.startCountdown=function(){var e=this;if(this.cooldownRunning)return;this.cooldownRunning=!0,this.cooldown=new TimelineMax({repeat:-1}).addCallback(function(){e.timeLeft-=1e3,e.updateCountdown()},1),this.updateCountdown()},n.prototype.stopCountdown=function(){this.cooldownRunning&&(this.cooldown.clear(),this.cooldown.kill(),this.cooldownRunning=!1)},n.prototype.updateCountdown=function(){this.timeLeft<=0&&(this.timeLeft=0,this.add()),this.emit(e.model.COOLDOWN_CHANGE)},n.prototype.update=function(){this.currentValue=Math.max(Math.min(this.currentValue,this.maxValue),0),this.currentValue==this.maxValue?(this.emit(e.model.COOLDOWN_CHANGE),this.emit(e.model.COOLDOWN_COMPLETE),this.stopCountdown()):(this.timeLeft==0&&(this.timeLeft=this.duration),this.startCountdown(),this.emit(e.model.COOLDOWN_CHANGE))},n.prototype.add=function(){var e=this;this.game.storage.getData(!1,function(){e.currentValue++,e.store(),e.update()})},n.prototype.remove=function(){var e=this;this.game.storage.getData(!1,function(){e.currentValue--,e.store(),e.update()})},Object.defineProperty(n.prototype,"currentTime",{get:function(){return(new Date).getTime()},enumerable:!0,configurable:!0}),n}(PIXI.utils.EventEmitter);t.Cooldown=n})(t=e.model||(e.model={}))})(gf||(gf={}));var gf;(function(e){var t;(function(e){var t=function(){function e(){}return e.toHHMMSS=function(e){var t=e/1e3<<0,n=t/3600<<0,r=(t-n*3600)/60<<0,i=t-n*3600-r*60,s=n<10?"0"+n.toString():n.toString(),o=r<10?"0"+r.toString():r.toString(),u=i<10?"0"+i.toString():i.toString();return s+":"+o+":"+u},e.toMMSS=function(e){var t=e/1e3/60<<0,n=e/1e3%60<<0,r=t<10?"0"+t.toString():t.toString(),i=n<10?"0"+n.toString():n.toString();return r+":"+i},e.decimalMark=function(e,t){return t===void 0&&(t="."),String(e).replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1"+t)},e}();e.Format=t})(t=e.utils||(e.utils={}))})(gf||(gf={}));var gf;(function(e){var t;(function(e){var t=function(){function e(){this.custom={}}return e}();e.ItemVO=t})(t=e.vo||(e.vo={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),Object.defineProperty(t.prototype,"lastLevel",{get:function(){return this.levels[this.levels.length-1]},enumerable:!0,configurable:!0}),t}(e.vo.ItemVO);t.EpisodeVO=n})(t=e.vo||(e.vo={}))})(gf||(gf={}));var gf;(function(e){var t;(function(e){var t=function(){function e(){this.myself=!1,this.score=0}return e.prototype.reset=function(){this.score=0,this.myself=!1,this.levelId=null,this.imageUrl=null,this.rank=null,this.name=null},e}();e.HighscoreVO=t})(t=e.vo||(e.vo={}))})(gf||(gf={}));var gf;(function(e){var t;(function(e){var t=function(){function e(){this.custom={},this.score=0,this.stars=0,this.won=!1}return e}();e.ResultVO=t})(t=e.vo||(e.vo={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(){var n=t!==null&&t.apply(this,arguments)||this;return n.jsonLoaded=!1,n.highscoreDataVO=new e.vo.HighscoreVO,n.resultVO=new e.vo.ResultVO,n}return __extends(n,t),n.prototype.getStarCount=function(e){var t=0;return e==0||!this.stars?t:(this.stars.forEach(function(n){e>=n&&t++}),t)},n.prototype.reset=function(){this.tokenFail=null,this.tokenWin=null,this.stars=null,this.custom=null,this.jsonLoaded=!1,this.id=null,this.highscoreDataVO.reset()},n.prototype.fromJson=function(e){return this.tokenFail=e.fail_text_token,this.tokenWin=e.win_text_token,this.stars=e.stars,this.custom=e.custom,this.jsonLoaded=!0,this.id=e.id,this},n}(e.vo.ItemVO);t.LevelVO=n})(t=e.vo||(e.vo={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=2592e5;t.EPISODE_UNLOCKED="episodeUnlocked",t.EPISODE_UPDATE="episodeUpdate";var r=function(t){function r(r){var i=t.call(this,r,n,1,"episode1",1)||this;return i.game.user.on(e.LOGOUT,i.reset,i),i._episodes=[],i._activations=[["default"]],i.on(e.model.COOLDOWN_COMPLETE,function(){var e=i.game.storage.getItem("episodeToUnlock");e&&i.unlockEpisodeByTime(e)},i),i}return __extends(r,t),r.prototype.onData=function(){this._activations=this.game.storage.getItem("episodes"),this._activations||this.setActivations([["default"]]),this.unlockEpisodes()},r.prototype.setActivations=function(e){this._activations=[e],this.game.storage.setItem("episodes",this._activations)},r.prototype.init=function(){if(!this.game.cache.checkJSON("levels"))return;var t=this.game.cache.getJSON("levels").episodes;this._total=t.length;if(this._total>0){var n=void 0;for(var r=0;r<this._total;++r)n=new e.vo.EpisodeVO,n.id=r+1,n.levels=t[r].levels,n.custom=t[r].custom||{},this._episodes.push(n);this._current=this.getEpisode(1)}this.game.storage.on(e.DATA,this.onData,this)},r.prototype.unlockEpisodes=function(){if(this._total<=0)return;var e=this.getEpisode(1);e.unlocked=!0,this._current=e,this.unlockLevelForEpisode(e.id);for(var t=0;t<this._total;++t){e=this._episodes[t];var n=e.levels,r=this.game.levels.getLevelVO(n[n.length-1]);r&&r.unlocked&&this._episodes[t+1]&&(e=this._episodes[t+1],e.unlocked=this.isEpisodeUnlocked(e.id),e.unlocked&&(e.id==1||this.game.levels.getLevelVO(this.getEpisode(e.id-1).lastLevel).unlocked)&&(this._current=e,this.unlockLevelForEpisode(e.id)))}this.hasNext&&(e=this.getEpisode(this.next.id),e.unlocked=this.isEpisodeUnlocked(e.id),e.unlocked&&(e.id==1||this.game.levels.getLevelVO(this.getEpisode(e.id-1).lastLevel).unlocked)&&(this._current=e,this.unlockLevelForEpisode(e.id))),e=this.getEpisode(this.game.storage.getItem("episodeToUnlock"));if(e){e.unlocked=this.isEpisodeUnlocked(e.id);if(e.unlocked){if(e.id==1||this.game.levels.getLevelVO(this.getEpisode(e.id-1).lastLevel).unlocked)this._current=e,this.unlockLevelForEpisode(e.id)}else this.startActivationCountdown(e.id)}},r.prototype.unlockLevelForEpisode=function(t){var n=this.game.levels.getLevelVO(this.getEpisode(t).levels[0]);if(n&&!n.unlocked){n.unlocked=!0;var r=new e.vo.ProgressVO;r.level=n.id,r.score=0,r.unlocked=!0,this.game.user.progress.setProgress(r)}},r.prototype.reset=function(){this._current=this.getEpisode(1),this._activations=[["default"]]},r.prototype.deletePendingRequests=function(t){var n=this,r=[];casClient.getRequests(function(i){i.outgoing.forEach(function(t){t.status=="ACCEPTED"&&t.customData.type==e.REQUEST_EPISODE&&(n.unlockEpisodeByUser(t.user,t.customData.episode),r.push(t.id))});if(r.length==0)t&&t();else{var s=0;r.forEach(function(e){casClient.deleteRequest(e,function(){s++,s==r.length&&t&&t()})})}})},r.prototype.startActivationCountdown=function(e){if(e>this._total)return;this.storageToken="episode"+e,this.game.storage.getItem(this.storageToken+"Running")||(this.game.storage.setItem(this.storageToken+"Running",!0),this.game.storage.setItem(this.storageToken,0),this.game.storage.setItem("episodeToUnlock",e)),this.onStorageData()},r.prototype.getEpisode=function(e){var t=null;return this._episodes.forEach(function(n){return n.id==e?(t=n,!1):!0}),t},r.prototype.getEpisodeByLevel=function(e){var t=null;return this._episodes.forEach(function(n){return n.levels.indexOf(e)!=-1?(t=n,!1):!0}),t},r.prototype.getActivationsByEpisode=function(e){return e?this._activations[e-1]:this._activations[this._current.id-1]},r.prototype.unlockEpisodeByUser=function(t,n){if(!n){this.unlockEpisodeByUser(t,this._current.id);return}var r=this._activations[n-1]?this._activations[n-1]:[],i=!1;r.forEach(function(e){e&&e.id==t.id&&(i=!0)}),i||(r.push(t),this._activations[n-1]=r,this.game.storage.setItem("episodes",this._activations));var s=this.getEpisode(n);return s.unlocked=this.isEpisodeUnlocked(n),s.unlocked&&this.emit(e.model.EPISODE_UNLOCKED,n,r),s.unlocked},r.prototype.unlockEpisodeByTime=function(e){var t=this.getEpisode(e),n=this._activations[e-1]?this._activations[e-1]:[];n.push("activatedByTimer"),t.unlocked=this.isEpisodeUnlocked(e),this._activations[e-1]=n,this.game.storage.setItem("episodes",this._activations),t.unlocked&&(t.id==1||this.game.levels.getLevelVO(this.getEpisode(t.id-1).lastLevel).unlocked)&&(this._current=t,this.unlockLevelForEpisode(t.id))},r.prototype.unlockEpisode=function(e){this._activations[e-1]=["default"],this.game.storage.setItem("episodes",this._activations);var t=this.getEpisode(e);t.unlocked=this.isEpisodeUnlocked(e),t.unlocked&&(t.id==1||this.game.levels.getLevelVO(this.getEpisode(t.id-1).lastLevel).unlocked)&&(this._current=t,this.unlockLevelForEpisode(t.id))},r.prototype.isEpisodeUnlocked=function(e){if(e>this._total)return!1;var t=this.getActivationsByEpisode(e);return t&&t.length>0?t.length==3||t[0]=="default"||t[0]=="activatedByCurrency"||t[0]=="activatedByTimer":this.getEpisode(e).unlocked},r.prototype.isUnlocking=function(e){var t=this.game.storage.getItem("episodeToUnlock");return t?t==e:!1},r.prototype.isUnlocked=function(e){return this.getEpisodeByLevel(e).unlocked},Object.defineProperty(r.prototype,"lastLevel",{get:function(){if(this._current)return this._current.levels[this._current.levels.length-1]},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"hasNext",{get:function(){return this.current.id<this._total},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"previous",{get:function(){return this._current.id>1?this.getEpisode(this._current.id-1):null},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"next",{get:function(){return this.hasNext?this.getEpisode(this._current.id+1):null},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"current",{get:function(){return this._current},set:function(e){this._current=e},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"formatedTime",{get:function(){return e.utils.Format.toHHMMSS(this.timeLeft)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"total",{get:function(){return this._total},enumerable:!0,configurable:!0}),r}(e.model.Cooldown);t.Episodes=r})(t=e.model||(e.model={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(){function t(t){this.game=t,this.progress=[],this.game.storage.on(e.DATA,this.onStorageData,this),this.game.user.on(e.LOGOUT,this.reset,this)}return t.prototype.onStorageData=function(){this.game.user.isLoggedIn?this.mergeProgress():(this.progress=[],this.game.levels.unlockLevels())},t.prototype.reset=function(){this.progress=[]},t.prototype.mergeProgress=function(){var e=this,t=this.game.storage.getItem("levels"),n=[];for(var r in t)t.hasOwnProperty(r)&&n.push(t[r]);var i=[],s;this.progress.forEach(function(t){s=e.getProgressByLevel(n,t.level),s?t.score>s.score&&i.push(s):i.push(t)});var o={},u=[];i.forEach(function(e){o[e.level]=e,u.push({score:e.score,level:e.level})}),i.length>0?this.game.storage.updateItem("levels",o,function(){if(e.game.client.config.useCAS){var t=[],n;u.forEach(function(e){n=new cas.vo.NewHighscore,n.category="level"+e.level,n.score=e.score,n.score!=0&&t.push(n)}),casClient.setHighscores(t,function(){})}e.game.levels.unlockLevels()}):this.game.levels.unlockLevels()},t.prototype.setProgress=function(t){var n=this,r=!1;this.progress.forEach(function(e){e.level==t.level&&(r=!0,t.score>e.score&&($.extend(e,t),n.game.storage.updateItem("levels",(i={},i[t.level]=t,i))));var i}),r||(this.progress.push($.extend(new e.vo.ProgressVO,t)),this.game.storage.updateItem("levels",(i={},i[t.level]=t,i)));var i},t.prototype.getProgress=function(t){var n=this.game.storage.getItem("levels"),r=1,i=new e.vo.ProgressVO;for(var s in n)if(n.hasOwnProperty(s)){i=n[s];if(isNaN(t))i.level>r&&(r=i.level);else if(i.level==t)return i}if(!t)return this.getProgress(r)},t.prototype.getProgressByLevel=function(e,t){var n=null;return e.forEach(function(e){if(e.level==t)return n=e,!0}),n},t}();t.Progress=n})(t=e.model||(e.model={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=5,r=6e5,i=function(t){function i(i){var s=t.call(this,i,r,n,"lives")||this;return s.game.client.config.hasLives&&s.game.storage.on(e.DATA,s.onStorageData,s),s}return __extends(i,t),Object.defineProperty(i.prototype,"formatedTime",{get:function(){return e.utils.Format.toMMSS(this.timeLeft)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"lives",{get:function(){return this.currentValue},enumerable:!0,configurable:!0}),i}(e.model.Cooldown);t.Lives=i})(t=e.model||(e.model={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(e){var n=t.call(this)||this;return n._email="",n._id=0,n._isLoggedIn=!1,n._imageUrl="",n._name="",n.game=e,n}return __extends(n,t),n.prototype.onLoggedIn=function(t,n){t.toLowerCase()==e.SUCCESS?(this._isLoggedIn=!0,this.emit(e.LOGIN),this.getUser(function(){window.scrollTo(0,0),n(e.SUCCESS)})):n(t)},n.prototype.getLoginStatus=function(t){var n=this;this.game.client.config.useCAS&&casClient.isLoggedIn(function(r){r?(n._isLoggedIn=!0,n.emit(e.LOGIN),n.getUser(function(){t(!0)})):t(!1)})},n.prototype.getUser=function(e){var t=this;this.game.client.config.useCAS&&casClient.getUser(function(n){t._id=n.id,t._name=n.username,t._imageUrl=n.imageUrl,n.email&&n.email.length>0&&(t._email=n.email),e()})},n.prototype.login=function(e){var t=this;if(this._isLoggedIn||!this.game.client.config.useCAS)return;this.game.client.config.hasRaffle?casClient.ui.showRaffleDialog(function(n){return t.onLoggedIn(n,e)}):casClient.ui.showLoginDialog(function(n){return t.onLoggedIn(n,e)})},n.prototype.logout=function(t){var n=this;if(!this._isLoggedIn||!this.game.client.config.useCAS)return;casClient.logout(function(){n._isLoggedIn=!1,n.emit(e.LOGOUT),t()})},n.prototype.raffle=function(t){var n=this;casClient.ui.showRaffleDialog(function(r){r.toLowerCase()==e.SUCCESS?(n._isLoggedIn=!0,n.emit(e.LOGIN),n.getUser(function(){t(e.SUCCESS)})):t(r)})},n.prototype.showAccountDialog=function(e){casClient.ui.showAccountDialog(function(t){e&&e(t)})},Object.defineProperty(n.prototype,"isLoggedIn",{get:function(){return this._isLoggedIn},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"email",{get:function(){return this._email},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"imageUrl",{get:function(){return this._imageUrl},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),n}(PIXI.utils.EventEmitter);t.User=n})(t=e.model||(e.model={}))})(gf||(gf={}));var gf;(function(e){var t;(function(e){var t=function(){function e(){this.custom={},this.score=0,this.unlocked=!1}return e}();e.ProgressVO=t})(t=e.vo||(e.vo={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this)||this;return r.game=n,r.levels=[],r.game.user.on(e.LOGOUT,r.reset,r),r}return __extends(n,t),n.prototype.loadLevels=function(t){var n=this;this.game.overlays.show("loader");var r=new e.core.Loader(this.game);r.retryDownload=!0,r.fixedRetryPauseLength=5;var i=this.game.client.config.hasEndless?0:1;for(var s=i;s<=t;++s)this.game.cache.checkJSON("level"+s)||r.json("level"+s,this._levelPath+"level"+s+".json");r.once(e.LOAD_COMPLETE,function(){for(var r=i;r<=t;++r)n.getLevelVO(r).fromJson(n.game.cache.getJSON("level"+r));n.game.overlays.hide("loader"),n.emit(e.LEVELS_LOADED)},this),r.start()},n.prototype.init=function(){if(!this.game.cache.checkJSON("levels"))return;this.data=this.game.cache.getJSON("levels"),this._levelCount=this.data.total,this._levelPath=this.data.path;var t;for(var n=0;n<this._levelCount;++n)t=new e.vo.LevelVO,t.id=this.game.client.config.hasEndless?n:n+1,this.levels.push(t)},n.prototype.reset=function(){this.levels=[],this.init(),this.unlockLevels()},n.prototype.loadLevel=function(t,n,r,i,s,o,u,a,f){var l=this;n===void 0&&(n=null),r===void 0&&(r=!1),i===void 0&&(i=null),s===void 0&&(s=null),o===void 0&&(o=null),u===void 0&&(u=null),a===void 0&&(a=null),f===void 0&&(f=null);if(!this.game.cache.checkJSON("levels"))return;if(t<0||t>this._levelCount)return;if(!this.game.cache.getJSON("level"+t)){var c=new e.core.Loader(this.game);c.retryDownload=r,c.fixedRetryPauseLength=i,c.loadTimeoutSeconds=u,s&&c.addListener(e.LOAD_ERROR,s),o&&c.addListener(e.LOAD_RETRY_PAUSE,o),a&&c.addListener(e.LOAD_TIMEOUT,a),f&&c.addListener(e.LOAD_TIMEOUT_RESOLVED,f),c.once(e.LOAD_COMPLETE,function(){l.getLevelVO(t).fromJson(l.game.cache.getJSON("level"+t)),s&&c.removeListener(e.LOAD_ERROR,s),o&&c.removeListener(e.LOAD_RETRY_PAUSE,o),a&&c.removeListener(e.LOAD_TIMEOUT,a),f&&c.removeListener(e.LOAD_TIMEOUT_RESOLVED,f),n&&n()},this),c.json("level"+t,this._levelPath+"level"+t+".json"),c.start()}else n&&n()},n.prototype.loadLevelsEx=function(t,n,r,i,s,o,u,a,f){var l=this;n===void 0&&(n=null),r===void 0&&(r=!1),i===void 0&&(i=null),s===void 0&&(s=null),o===void 0&&(o=null),u===void 0&&(u=null),a===void 0&&(a=null),f===void 0&&(f=null);if(!this.game.cache.checkJSON("levels"))return;var c=!0;t.forEach(function(e){l.game.cache.getJSON("level"+e)||(c=!1)});if(!c){var h=new e.core.Loader(this.game);h.retryDownload=r,h.fixedRetryPauseLength=i,h.loadTimeoutSeconds=u,s&&h.addListener(e.LOAD_ERROR,s),o&&h.addListener(e.LOAD_RETRY_PAUSE,o),a&&h.addListener(e.LOAD_TIMEOUT,a),f&&h.addListener(e.LOAD_TIMEOUT_RESOLVED,f),h.once(e.LOAD_COMPLETE,function(){s&&h.removeListener(e.LOAD_ERROR,s),o&&h.removeListener(e.LOAD_RETRY_PAUSE,o),a&&h.removeListener(e.LOAD_TIMEOUT,a),f&&h.removeListener(e.LOAD_TIMEOUT_RESOLVED,f),n&&n()},this),t.forEach(function(e){h.json("level"+e,l._levelPath+"level"+e+".json")}),h.start()}else n&&n()},n.prototype.getLevelVO=function(e){var t=null;return this.levels.forEach(function(n){if(n.id==e)return t=n,!0}),t||logWarning("Couldn't find level "+e+" in levels."),t},n.prototype.updateLevelVO=function(e,t){var n;return this.levels.forEach(function(r){if(r.id==e)return r=$.extend(r,t),n=r,!0}),this.currentLevel.id==e&&(this.currentLevel=n),n},n.prototype.unlockNextLevel=function(e,t,n,r,i,s,o,u,a){var f=this;t===void 0&&(t=null),n===void 0&&(n=!1),r===void 0&&(r=null),i===void 0&&(i=null),s===void 0&&(s=null),o===void 0&&(o=null),u===void 0&&(u=null),a===void 0&&(a=null);var l=this.getLevelVO(e);if(!l)return!0;if(!l.jsonLoaded)this.loadLevel(e,function(){f.unlockLevel(e),t&&t()},n,r,i,s,o,u,a);else{var c=this.game.episodes.getEpisodeByLevel(e).id;this.game.episodes.isEpisodeUnlocked(c)||this.game.episodes.startActivationCountdown(c),this.unlockLevel(e)}return!1},n.prototype.unlockNextLevelEx=function(e,t,n,r,i,s,o,u,a){var f=this;t===void 0&&(t=null),n===void 0&&(n=!1),r===void 0&&(r=null),i===void 0&&(i=null),s===void 0&&(s=null),o===void 0&&(o=null),u===void 0&&(u=null),a===void 0&&(a=null);var l=this.getLevelVO(e);if(l)if(!l.jsonLoaded)this.loadLevel(e,function(){f.unlockLevel(e),t&&t()},n,r,i,s,o,u,a);else{var c=this.game.episodes.getEpisodeByLevel(e).id;this.game.episodes.isEpisodeUnlocked(c)||this.game.episodes.startActivationCountdown(c),this.unlockLevel(e),t&&t()}},n.prototype.unlockLevel=function(t){if(!this.game.cache.checkJSON("levels"))return;var n=this.getLevelVO(t);n.unlocked=!0;var r=new e.vo.ProgressVO;r.level=t,r.unlocked=!0,this.game.user.progress.setProgress(r)},n.prototype.unlockLevels=function(){if(!this.game.cache.checkJSON("levels"))return;var t=this.game.storage.getItem("levels"),n=this.game.client.config.hasEndless?0:1,r=n;if(!t){for(var i=n;i<=this.game.client.config.unlockedLevels;++i){this.unlockLevel(i);var s=new e.vo.ProgressVO;s.level=i,s.unlocked=!0,this.game.storage.setItem("levels",(f={},f[s.level]=s,f))}this.currentLevel=this.getLevelVO(1)}else{var o=void 0;for(var u in t){var a=t[u];if(a.level<=this._levelCount){if(!r||a.level>r&&a.unlocked)r=a.level;o=this.getLevelVO(a.level),o&&(o.unlocked=a.unlocked,this.game.user.progress.setProgress(a))}}this._currentLevel||(this._currentLevel=this.getLevelVO(r),this._currentLevel.unlocked=!0)}this.loadLevels(r);var f},n.prototype.getStars=function(e,t,n){n===void 0&&(n=!0);var r=this.getLevelVO(t);if(e==null||e==0||r==null)return 0;var i=r.stars,s,o;if(n){o=i.length;for(s=i.length-1;s>=0;--s)e&&e<i[s]&&o--}else{o=0;for(s=0;s<i.length;++s)e&&e<i[s]&&o++}return o},n.prototype.getScoreByLevel=function(e){return this.getLevelVO(e).highscoreDataVO.score},Object.defineProperty(n.prototype,"currentLevel",{get:function(){return this._currentLevel},set:function(e){this._currentLevel=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"levelCapReached",{get:function(){return this._levelCount-1==this.lastUnlockedLevelVO.id},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"lastUnlockedLevelVO",{get:function(){var e;for(var t=0;t<this.levels.length;++t)this.levels[t]&&this.levels[t].unlocked&&(e=this.levels[t]);return e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"levelCount",{get:function(){return this._levelCount},enumerable:!0,configurable:!0}),n}(PIXI.utils.EventEmitter);t.Levels=n})(t=e.model||(e.model={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(){function t(){}return t.onChange=function(t){this.type=e.RENDER_TYPE_ON_CHANGE,PIXI.mesh.Mesh.prototype.game=t,PIXI.mesh.Mesh.prototype._onTextureUpdate=function(e){return function(){return this.game.renderState=2,e.apply(this,arguments)}}(PIXI.mesh.Mesh.prototype._onTextureUpdate),PIXI.Sprite.prototype.game=t,PIXI.Sprite.prototype._onTextureUpdate=function(e){return function(){return this.game.renderState=2,e.apply(this,arguments)}}(PIXI.Sprite.prototype._onTextureUpdate),PIXI.Text.prototype.game=t,PIXI.Text.prototype.updateTexture=function(e){return function(){return this.game.renderState=2,e.apply(this,arguments)}}(PIXI.Text.prototype.updateTexture),PIXI.DisplayObject.prototype.game=t,Object.defineProperty(PIXI.DisplayObject.prototype,"alpha",{set:function(e){this.worldVisible&&(this.game.renderState=2),this._alpha=e},get:function(){return this._alpha}}),Object.defineProperty(PIXI.DisplayObject.prototype,"rotation",{set:function(e){this.worldVisible&&(this.game.renderState=2),this.transform.rotation=e},get:function(){return this.transform.rotation}}),Object.defineProperty(PIXI.DisplayObject.prototype,"scale",{set:function(e){this.worldVisible&&(this.game.renderState=2),this.transform.scale.copy(e)},get:function(){return this.transform.scale}}),Object.defineProperty(PIXI.DisplayObject.prototype,"skew",{set:function(e){this.worldVisible&&(this.game.renderState=2),this.transform.skew.copy(e)},get:function(){return this.transform.skew}}),Object.defineProperty(PIXI.Sprite.prototype,"tint",{set:function(e){this.worldVisible&&(this.game.renderState=2),this._tint=e,this._tintRGB=(e>>16)+(e&65280)+((e&255)<<16)},get:function(){return this._tint}}),Object.defineProperty(PIXI.Text.prototype,"text",{set:function(e){e=String(e===""||e===null||e===undefined?" ":e);if(this._text===e)return;this._text=e,this.dirty=!0,this.worldVisible&&(this.game.renderState=2)},get:function(){return this._text}}),PIXI.TransformStatic.prototype.game=t,PIXI.TransformStatic.prototype.onChange=function(e){return function(){return this.game.renderState=2,e.apply(this,arguments)}}(PIXI.TransformStatic.prototype.onChange),parseInt(PIXI.VERSION.split(".").join(""))<452&&t.renderer.plugins.interaction.on("pointermove",function(){return t.renderState=2}),t.renderer.plugins.interaction.on("mousedown",function(){return t.renderState=2}),t.renderer.plugins.interaction.on("mouseup",function(){return t.renderState=2}),t.renderer.plugins.interaction.on("mousemove",function(){return t.renderState=2}),t.renderer.plugins.interaction.on("touchstart",function(){return t.renderState=2}),t.renderer.plugins.interaction.on("touchend",function(){return t.renderState=2}),t.renderer.plugins.interaction.on("touchmove",function(){return t.renderState=2})},t.shouldApplyPixiFix=function(e){if(e instanceof PIXI.WebGLRenderer){var t=PIXI.VERSION.split(".");return t[0]=="4"&&t[1]<="8"?!0:!1}return!1},t.debugTestLostWebGLContext=function(e){if(!(e instanceof PIXI.WebGLRenderer))return;e.gl.canvas.addEventListener("webglcontextlost",function(e){console.log("msg: webglcontextlost:"),console.log(e)},!1),e.gl.canvas.addEventListener("webglcontextrestored",function(e){console.log("msg: webglcontextrestored:"),console.log(e)},!1),window.setTimeout(function(){var t=e.gl.getExtension("WEBGL_lose_context");t.loseContext(),window.setTimeout(function(){console.log("isContextLost:"+e.gl.isContextLost()),t.restoreContext(),window.setTimeout(function(){console.log("isContextLost:"+e.gl.isContextLost())},100)},100)},100)},t.installPixiPatch=function(e){if(!(e instanceof PIXI.WebGLRenderer))return;PIXI.WebGLRenderer.prototype._initContextOriginal=PIXI.WebGLRenderer.prototype._initContext,PIXI.WebGLRenderer.prototype._initContext=t.WebGLRenderer_initContextOverride},t.WebGLRenderer_initContextOverride=function(){if(this.textureManager){var e=this.textureManager._managedTextures;this._initContextOriginal(),this.textureManager._managedTextures=e}else this._initContextOriginal()},t.type=e.RENDER_TYPE_DEFAULT,t}();t.Render=n})(t=e.utils||(e.utils={}))})(gf||(gf={}));var gf;(function(e){var t;(function(e){var t=function(){function e(){}return e.getResolution=function(){var e="(-webkit-min-device-pixel-ratio: 1.5), (min--moz-device-pixel-ratio: 1.5), (-o-min-device-pixel-ratio: 3/2), (min-resolution: 1.5dppx)";return window.devicePixelRatio>1?2:window.matchMedia&&window.matchMedia(e).matches?2:1},e}();e.Resolution=t})(t=e.utils||(e.utils={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this)||this;return r._dataLocal={},r._dataServer={},r._pending=[],r._running=!1,r._dataFetched=!1,r.checkIfSupported(),r.game=n,r.game.user.on(e.LOGIN,r.getData,r),r.game.user.on(e.LOGOUT,function(){r._dataFetched=!1,r.clear(function(){return r.getData()})},r),r}return __extends(n,t),n.prototype.checkIfSupported=function(){this._isSupported=!1;try{var e="kr3mTest89476";localStorage.setItem(e,"xyz"),localStorage.getItem(e),localStorage.removeItem(e),this._isSupported=!0}catch(t){}},n.prototype.getData=function(t,n,r){var i=this;t===void 0&&(t=!0),r===void 0&&(r=!1),this._dataFetched=!1;if(!this.isSupported)this._dataLocal={},this._dataServer={};else{var s=localStorage.getItem(this.game.client.config.appName);s||(s="{}");try{this._dataLocal=JSON.parse(s),this._dataServer=JSON.parse(s)}catch(o){this._dataLocal={},this._dataServer={}}}if(this.game.client.config.useCAS&&navigator.onLine&&!r){var u=setTimeout(function(){i.getData(t,n,!0)},1e4);casClient.getCookie(this.game.client.config.appName,function(r){clearTimeout(u),i._dataServer=r||{},i._dataFetched=!0,t&&i.emit(e.DATA,i._dataServer,i._dataLocal),n&&n(i._dataServer,i._dataLocal)})}else this._dataFetched=!0,t&&this.emit(e.DATA,this._dataServer,this._dataLocal),n&&n(this._dataServer,this._dataLocal)},n.prototype.clear=function(e){this._dataLocal={},this._dataServer={},this.isSupported&&localStorage.setItem(this.game.client.config.appName,JSON.stringify(this._dataLocal)),this.game.client.config.useCAS&&navigator.onLine?casClient.setCookie(this.game.client.config.appName,this._dataServer,function(){e&&e()}):e&&e()},n.prototype.getItem=function(e,t){return t===void 0&&(t=!1),t?this._dataLocal[e]:this._dataServer[e]},n.prototype.setItem=function(e,t,n){if(typeof e=="string")this._dataLocal[e]=t,this._dataServer[e]=t;else for(var r=0;r<e.length;++r)this._dataLocal[e[r]]=t[r],this._dataServer[e[r]]=t[r];this.isSupported&&localStorage.setItem(this.game.client.config.appName,JSON.stringify(this._dataLocal)),this.game.client.config.useCAS&&navigator.onLine?this._running?this._pending.push(n):this.flush(n):n&&n()},n.prototype.flush=function(e){var t=this;this._running=!0,casClient.setCookie(this.game.client.config.appName,this._dataServer,function(){t._pending.length>0?(e=t._pending.shift(),t.flush(e)):t._running=!1,e&&e()})},n.prototype.updateItem=function(e,t,n){this.setItem(e,$.extend({},this.getItem(e),t),n)},Object.defineProperty(n.prototype,"dataServer",{get:function(){return this._dataServer},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"dataLocal",{get:function(){return this._dataLocal},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"dataFetched",{get:function(){return this._dataFetched},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isSupported",{get:function(){return this._isSupported},enumerable:!0,configurable:!0}),n}(PIXI.utils.EventEmitter);t.Storage=n})(t=e.utils||(e.utils={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this)||this;return r._client=n,r._isFocused=!0,r.setCanvas(),r.setRenderer(),r.user=new e.model.User(r),r.cache=new e.core.Cache(r),r.loader=new e.core.Loader(r),r.scale=new e.core.Scale(r),r.stage=new e.core.Stage(r),r.storage=new e.utils.Storage(r),r.episodes=new e.model.Episodes(r),r.levels=new e.model.Levels(r),r.screens=new e.core.Screens(r),r.overlays=new e.core.Overlays(r),r.sounds=new e.core.Sounds(r),r.ticker=PIXI.ticker.shared,r}return __extends(n,t),n.prototype.run=function(){this.user.progress=new e.model.Progress(this),this.user.lives=new e.model.Lives(this),this.screens.init(),this.stage.addFooter(),this.stage.addHeader(),this.overlays.init(),this.scale.init(),this.episodes.init(),this.levels.init(),this.storage.getData(),this.client.config.onRun(this),this.emit(e.RUNNING)},n.prototype.setCanvas=function(){var e=this;document.hidden!==undefined&&document.addEventListener("visibilitychange",function(t){return e.onVisibilityChange(t)}),document.mozHidden!==undefined&&document.addEventListener("mozvisibilitychange",function(t){return e.onVisibilityChange(t)}),document.webkitHidden!==undefined&&document.addEventListener("webkitvisibilitychange",function(t){return e.onVisibilityChange(t)}),document.msHidden!==undefined&&document.addEventListener("msvisibilitychange",function(t){return e.onVisibilityChange(t)}),document.onfocusin!==undefined&&(document.onfocusin=document.onfocusout=function(t){return e.onVisibilityChange(t)}),window.onpageshow=window.onpagehide=window.onfocus=window.onblur=function(t){return e.onVisibilityChange(t)},this.canvas=document.getElementById(this.client.config.canvasDomId),setInterval(function(){return e.onVisibilityChange()},1e3)},n.prototype.onVisibilityChange=function(e){e===void 0&&(e=null);if(e&&e.type&&(e.type==="pagehide"||e.type==="blur"||e.type==="pageshow"||e.type==="focus")){e.type==="pagehide"||e.type==="blur"?this.blur():(e.type==="pageshow"||e.type==="focus")&&this.focus();return}document.visibilityState=="hidden"||document.hidden||document.mozHidden||document.msHidden||document.webkitHidden?this.blur():this.focus()},n.prototype.blur=function(){this._isFocused&&(this._isFocused=!1,this.emit(e.BLUR))},n.prototype.focus=function(){this._isFocused||(this._isFocused=!0,this.emit(e.FOCUS),this.emit(e.RESIZE))},n.prototype.setRenderer=function(){PIXI.utils.skipHello();var t={};t.antialias=this.client.config.antialias,t.autoResize=!0,t.resolution=this.client.config.resolution,t.roundPixels=this.client.config.roundPixels,t.transparent=this.client.config.transparent,t.view=this.canvas,t.clearBeforeRender=!0,PIXI.glCore.VertexArrayObject.FORCE_NATIVE=!0,PIXI.settings.CAN_UPLOAD_SAME_BUFFER=!1,PIXI.settings.SPRITE_MAX_TEXTURES=2,this.client.config.forceWebGL?this.renderer=new PIXI.WebGLRenderer(300,200,t):this.client.config.forceCanvas?this.renderer=new PIXI.CanvasRenderer(300,200,t):this.renderer=PIXI.autoDetectRenderer(300,200,t),this.client.config.renderType===e.RENDER_TYPE_ON_CHANGE&&e.utils.Render.onChange(this),e.utils.Render.installPixiPatch(this.renderer),PIXI.ticker.shared.add(this.update,this)},n.prototype.start=function(){var e=this;this.client.config.useCAS?this.user.getLoginStatus(function(){return e.run()}):this.run()},n.prototype.resize=function(){e.utils.Render.type===e.RENDER_TYPE_ON_CHANGE&&(this.renderState=2),this.emit(e.RESIZE)},n.prototype.update=function(){e.utils.Render.type===e.RENDER_TYPE_ON_CHANGE?this.renderState!=1&&(this.renderer.render(this.stage),this.renderState=1):this.renderer.render(this.stage)},Object.defineProperty(n.prototype,"height",{get:function(){return this.scale.height},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"width",{get:function(){return this.scale.width},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scaleX",{get:function(){return this.stage.scaleX},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scaleY",{get:function(){return this.stage.scaleY},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"client",{get:function(){return this._client},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"landscape",{get:function(){return this.scale.isLandscape},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"portrait",{get:function(){return!this.landscape},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isFocused",{get:function(){return this._isFocused},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isCordova",{get:function(){return document.URL.indexOf("http://")===-1&&document.URL.indexOf("https://")===-1||!!window.cordova},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isFacebookApp",{get:function(){var e=navigator.userAgent||navigator.vendor||window.opera;return e.indexOf("FBAN")>-1||e.indexOf("FBAV")>-1},enumerable:!0,configurable:!0}),n}(PIXI.utils.EventEmitter);t.Game=n})(t=e.core||(e.core={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n)||this;return r.addListeners(),r.buttonMode=!0,r.interactive=!0,r._currentState=e.OUT,r._isEnabled=!0,r}return __extends(n,t),n.prototype.addListeners=function(){var t=this,n=parseInt(PIXI.VERSION.split(".").join(""),10)<452;this.on(n?"mouseover pointerover":"mouseover",function(n){if(!t._isEnabled)return;t._isOver=!0,t._currentState=e.OVER,t.setState(t._currentState),t.over(n),t.emit(e.OVER,n,t)}),this.on(n?"mouseout pointerout":"mouseout",function(n){if(!t._isEnabled)return;t._isOver=!1,t._currentState=e.OUT,t.setState(t._currentState),t.out(n),t.emit(e.OUT,n,t)}),this.on(n?"mousedown pointerdown touchstart":"mousedown touchstart",function(n){if(!t._isEnabled)return;t._isOver=!0,t._currentState=e.DOWN,t.setState(t._currentState),t.down(n),t.emit(e.DOWN,n,t)}),this.on(n?"mouseup pointerup":"mouseup",function(n){if(!t._isEnabled)return;t._currentState=e.UP,t.setState(t._currentState),t.up(n),t.emit(e.UP,n,t)}),this.on("touchend",function(n){if(!t._isEnabled)return;t._currentState=e.UP,t.setState(t._currentState),t.up(n),t.emit(e.UP,n,t)}),this.on(n?"mouseupoutside pointerupoutside touchendoutside":"mouseupoutside touchendoutside",function(n){if(!t._isEnabled)return;t._isOver=!1,t._currentState=e.UP,t.setState(t._currentState),t.upOutside(n),t.emit(e.UP,n,t)}),this.on("click",function(n){if(!t._isEnabled)return;t.click(n),t.emit(e.CLICK,n,t)}),this.on("tap",function(n){if(!t._isEnabled)return;t._isOver=!1,t._currentState=e.UP,t.setState(t._currentState),t.click(n),t.emit(e.CLICK,n,t)})},n.prototype.setState=function(e){},n.prototype.over=function(e){},n.prototype.out=function(e){},n.prototype.down=function(e){},n.prototype.up=function(e){},n.prototype.upOutside=function(e){},n.prototype.click=function(e){},n.prototype.enable=function(){this.interactive=!0,this.buttonMode=!0,this._isEnabled=!0,this.setState(this._currentState),this.emit(e.ENABLE,this)},n.prototype.disable=function(){this.interactive=!1,this.buttonMode=!1,this._currentState=e.OUT,this._isEnabled=!1,this._isOver=!1,this.setState(this._currentState),this.emit(e.DISABLE,this)},Object.defineProperty(n.prototype,"currentState",{get:function(){return this._currentState},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isOver",{get:function(){return this._isOver},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(e){e?this.enable():this.disable()},enumerable:!0,configurable:!0}),n}(e.display.Container);t.Button=n})(t=e.ui||(e.ui={}))})(gf||(gf={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n)||this;return r.icon=new gf.display.Sprite(r.game,"sprites","icon_close"),r.icon.tint=e.COLOR_DARK_GREY,r.addChild(r.icon),r.overColor=e.COLOR_YELLOW,r.on(gf.CLICK,function(){return r.game.sounds.playFx("fx","click")},r),r.hitArea=new PIXI.Circle(r.icon.width>>1,r.icon.height>>1,(r.icon.width>>1)+e.PADDING*2),r}return __extends(n,t),n.prototype.setState=function(t){switch(this._currentState){case gf.DOWN:this.icon.tint=e.COLOR_GREY;break;case gf.OUT:this.icon.tint=e.COLOR_DARK_GREY;break;case gf.OVER:this.icon.tint=this.overColor;break;case gf.UP:this.isOver?this.icon.tint=this.overColor:this.icon.tint=e.COLOR_DARK_GREY}},n}(gf.ui.Button);t.CloseButton=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(e,n,r,i){i===void 0&&(i=!1);var s=t.call(this,e)||this;return s.interactiveChildren=!1,s._icon=n,s._label=r,s._isPrimary=i,s.bg=new gf.display.Sprite(e,PIXI.Texture.WHITE),s.bg.width=s.bg.height=65,s.addChild(s.bg),s._icon&&s.addIcon(),s._label&&s.addLabel(),s.hitArea=s.getLocalBounds(),s.on(gf.CLICK,function(){return s.game.sounds.playFx("fx","click")},s),s.setState(gf.OUT),s}return __extends(n,t),n.prototype.addIcon=function(){this.icon=new gf.display.Sprite(this.game,"sprites","icon_"+this._icon),this.icon.anchor.set(.5),this.icon.x=this.bg.width>>1,this.icon.y=this.bg.height>>1,this.addChild(this.icon)},n.prototype.addLabel=function(){this.tfLabel=new gf.display.Text(this.game,this._label,e.TEXT_STYLE_BUTTON_ICON.clone()),this.tfLabel.anchor.set(.5,1),this.tfLabel.style.wordWrapWidth=this.bg.width,this.tfLabel.x=this.bg.width>>1,this.tfLabel.y=this.bg.height,this.addChild(this.tfLabel)},n.prototype.setState=function(t){if(this._isSelected){this.bg.tint!=e.COLOR_YELLOW&&(this.bg.tint=e.COLOR_YELLOW);return}if(!this._isEnabled){this.bg.tint=e.COLOR_GREY,this.icon&&(this.icon.alpha=.6,this.icon.tint=e.COLOR_DARK_GREY),this.tfLabel&&(this.tfLabel.alpha=.6,this.tfLabel.style.fill=e.COLOR_DARK_GREY);return}this.icon&&(this.icon.alpha=1),this.tfLabel&&(this.tfLabel.alpha=1);switch(this._currentState){case gf.DOWN:this.bg.tint=e.COLOR_YELLOW,this.icon&&(this.icon.tint=e.COLOR_DARK_GREY),this.tfLabel&&(this.tfLabel.style.fill=e.COLOR_DARK_GREY);break;case gf.OUT:this.bg.tint=this._isPrimary?e.COLOR_YELLOW:e.COLOR_WHITE,this.icon&&(this.icon.tint=e.COLOR_DARK_GREY),this.tfLabel&&(this.tfLabel.style.fill=e.COLOR_DARK_GREY);break;case gf.OVER:this.bg.tint=e.COLOR_YELLOW,this.icon&&(this.icon.tint=e.COLOR_WHITE),this.tfLabel&&(this.tfLabel.style.fill=e.COLOR_WHITE);break;case gf.UP:this.isOver?(this.bg.tint=e.COLOR_YELLOW,this.icon&&(this.icon.tint=e.COLOR_WHITE),this.tfLabel&&(this.tfLabel.style.fill=e.COLOR_WHITE)):(this.bg.tint=this._isPrimary?e.COLOR_YELLOW:e.COLOR_WHITE,this.icon&&(this.icon.tint=e.COLOR_DARK_GREY),this.tfLabel&&(this.tfLabel.style.fill=e.COLOR_DARK_GREY))}},n.prototype.enable=function(){t.prototype.enable.call(this),this.setState(this.currentState)},n.prototype.disable=function(){t.prototype.disable.call(this),this.setState(this.currentState)},n.prototype.forceState=function(e){this._currentState=e,this.setState(e)},Object.defineProperty(n.prototype,"label",{get:function(){return this._label},set:function(e){if(e==this._label)return;this._label=e,this.tfLabel||this.addLabel(),this.tfLabel.text=this._label},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isSelected",{get:function(){return this._isSelected},set:function(e){this._isSelected=e,this._isOver=!1,this.setState(this._currentState)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isPrimary",{get:function(){return this._isPrimary},set:function(e){this._isPrimary=e,this.setState(this._currentState)},enumerable:!0,configurable:!0}),n}(gf.ui.Button);t.IconButton=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var gf;(function(e){var t;(function(t){var n=function(e){function t(t){var n=e.call(this,t)||this;return n.interactive=!0,n.onResize(),n}return __extends(t,e),t.prototype.onResize=function(){this.hitArea=new PIXI.Rectangle(0,0,this.game.width,this.game.height)},t}(e.display.Sprite);t.NoClick=n})(t=e.ui||(e.ui={}))})(gf||(gf={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){this.addNoClick(),this.addDim(),this.addBg(),this.addBtClose(),this.addTitle()},n.prototype.addNoClick=function(){this.noClick=new gf.ui.NoClick(this.game),this.addChild(this.noClick)},n.prototype.addDim=function(){this.dim=new gf.display.Sprite(this.game,PIXI.Texture.WHITE),this.dim.tint=0,this.dim.alpha=.6,this.dim.y=this.game.stage.header.bg.height,this.addChild(this.dim)},n.prototype.addBg=function(){this.bg=new gf.display.Sprite(this.game,PIXI.Texture.WHITE),this.bg.width=270,this.bg.height=315,this.bg.y=this.game.stage.header.bg.height+60,this.addChild(this.bg)},n.prototype.addBtClose=function(){this.btClose=new e.ui.CloseButton(this.game),this.btClose.on(gf.CLICK,this.onClose,this),this.btClose.y=this.bg.y+e.PADDING*2+2,this.addChild(this.btClose)},n.prototype.addTitle=function(){this.tfTitle=new gf.display.Text(this.game),this.tfTitle.style=e.TEXT_STYLE_TITLE_TAB.clone(),this.tfTitle.y=this.bg.y+e.PADDING*2,this.addChild(this.tfTitle)},n.prototype.onClose=function(){},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.bg&&(this.bg.x=this.game.width-this.bg.width>>1),this.btClose&&(this.btClose.x=this.bg.right-this.btClose.width-e.PADDING*2),this.tfTitle&&(this.tfTitle.x=this.bg.x+(this.bg.width-this.tfTitle.width>>1)),this.dim&&(this.dim.width=this.game.width,this.dim.height=this.game.height-this.game.stage.header.bg.height),this.y=0,this.dim&&this.bg&&(this.dim.height=Math.max(this.dim.height,this.bg.bottom)),this.bg&&this.bg.bottom>this.game.height&&(this.y=-(this.dim.y+60)+(this.game.height-this.bg.height>>1))},n}(gf.overlays.Overlay);t.Overlay=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){var t=function(){function e(){this.cubes=0,this.cubesById=[],this.scoreCubes=0,this.scoreTotal=0,this.scoreTrack=[0,0,0,0,0],this.scoreSubstructure=0,this.substructure=0,this.track=[0,0,0,0,0],this.trackCubeIds=[]}return e}();e.EvaluationData=t})(t=e.vo||(e.vo={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(){function t(){this.cubesHash="",this.hashed="",this.competition=null,this.evaluation=new e.vo.EvaluationData,this.previousId=null,this.sets=[]}return t}();t.TrackData=n})(t=e.vo||(e.vo={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(){function t(){this.data=new e.vo.TrackData}return t}();t.Track=n})(t=e.vo||(e.vo={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){var t=function(){function e(){}return e}();e.History=t})(t=e.vo||(e.vo={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){var t=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.getShop=function(e,t){var n={};t&&(n={countryId:t}),this.callService("Stripe.getShop",n,function(t){return e(t.data,t.status)})},t.prototype.charge=function(e,t,n,r,i,s,o){var u={token:e,planId:t,productId:n,setIds:r,countryId:i,currencyId:s};this.callService("Stripe.charge",u,function(e){return o(e.status)})},t.prototype.changeSet=function(e,t){var n={setId:e};this.callService("Stripe.changeSet",n,function(e){return t(e.status)})},t}(e.Abstract);e.Shop=t})(t=e.stubs||(e.stubs={}))})(cuboro||(cuboro={}));var sShop=new cuboro.stubs.Shop,cuboro;(function(e){var t;(function(t){var n=function(t){function n(n,r,i){var s=t.call(this,n)||this;return s._isChecked=!1,s.radio=new gf.display.Sprite(s.game,"sprites","radio_bt_out"),s.addChild(s.radio),s.tfLabel=new gf.display.Text(s.game,r,e.TEXT_STYLE_SMALL.clone()),s.tfLabel.style.fontSize=s.tfLabel.style.lineHeight=12,s.tfLabel.style.wordWrap=!0,s.tfLabel.x=s.radio.right,s.addChild(s.tfLabel),s.tfCount=new gf.display.Text(s.game,loc("shop_cube_count",{value:i}),e.TEXT_STYLE_SMALL_HEAVY.clone()),s.tfCount.x=s.tfLabel.x,s.tfCount.style.fontSize=s.tfCount.style.lineHeight=10,s.addChild(s.tfCount),s.tfLabel.y=s.radio.height-(s.tfLabel.height+s.tfCount.height)>>1,s.tfCount.y=(s.tfLabel.bottom>>0)-1,s.on(gf.CLICK,s.onClick,s),s}return __extends(n,t),n.prototype.onClick=function(){if(this.isChecked)return;this.isChecked=!0},n.prototype.setState=function(t){if(this._isChecked){this.radio.frameName="radio_bt_checked",this.tfLabel.style.fill=e.COLOR_DARK_GREY;return}switch(this._currentState){case gf.DOWN:this.radio.frameName="radio_bt_down";break;case gf.OUT:this.radio.frameName="radio_bt_out";break;case gf.OVER:this.radio.frameName="radio_bt_over";break;case gf.UP:this.isOver?this.radio.frameName="radio_bt_over":this.radio.frameName="radio_bt_out"}},Object.defineProperty(n.prototype,"isChecked",{get:function(){return this._isChecked},set:function(e){this._isChecked=e,this.setState(this._currentState),this._isChecked&&this.emit("checked",this)},enumerable:!0,configurable:!0}),n}(gf.ui.Button);t.RadioButton=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){function t(e,t){t=t.toUpperCase();var n=["BIF","CLP","DJF","GNF","JPY","KMF","KRW","MGA","PYG","RWF","VND","VUV","XAF","XOF","XPF"];return n.includes(t)?e.toString():Math.floor(e/100)+"."+(e%100).toString().padStart(2,"0")}e.getPrice=t})(t=e.utils||(e.utils={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n,r,i){var s=t.call(this,n)||this;s.interactive=!0,s._type=i,s.bgTop=new gf.display.Sprite(s.game,PIXI.Texture.WHITE),s.bgTop.width=150,s.bgTop.height=32,s.bgTop.tint=e.COLOR_MID_GREY,s.addChild(s.bgTop),s.btRadio=new e.ui.RadioButton(s.game,r,s.getCount()),s.btRadio.tfLabel.style.wordWrapWidth=s.bgTop.width-s.btRadio.tfLabel.x-10,s.addChild(s.btRadio),s.bgPackshot=new gf.display.Sprite(s.game,PIXI.Texture.WHITE),s.bgPackshot.width=s.bgTop.width,s.bgPackshot.tint=e.COLOR_LIGHT_GREY,s.addChild(s.bgPackshot);var o,u="sprites";s._type==e.ABO_SINGLE?(u="sprites-sets",o="metro"):s._type==e.ABO_BASIC?o="packshot_abo_basic":o="packshot_abo_all",s.packshot=new gf.display.Sprite(s.game,u,o),s.packshot.y=s.bgPackshot.y=s.bgTop.bottom>>0,s.addChild(s.packshot),s.bgPackshot.height=96,s.bgBottom=new gf.display.Sprite(s.game,PIXI.Texture.WHITE),s.bgBottom.width=s.bgTop.width,s.bgBottom.height=s.bgTop.height,s.bgBottom.tint=e.COLOR_MID_GREY,s.bgBottom.y=s.bgPackshot.bottom>>0,s.addChild(s.bgBottom),s.tfPrice=new gf.display.Text(s.game,"",e.TEXT_STYLE_SMALL.clone()),s.tfPrice.style.fontSize=16,s.tfPrice.style.fontFamily=e.DEFAULT_FONT_HEAVY,s.tfPrice.y=s.bgBottom.y+(s.bgBottom.height-s.tfPrice.height>>1)>>0,s.addChild(s.tfPrice),s.tfCurrency=new gf.display.Text(s.game,loc("shop_currency"),e.TEXT_STYLE_SMALL.clone()),s.tfCurrency.y=s.tfPrice.bottom-s.tfCurrency.height,s.addChild(s.tfCurrency),s.btRadio.hitArea=new PIXI.Rectangle(0,0,s.width,s.height);if(s._type==e.ABO_BASIC){s.bgRecommended=new gf.display.Graphics(s.game),s.bgRecommended.f(e.COLOR_YELLOW).mt(0,0).lt(67,0).lt(67,67).lt(0,0).ef(),s.bgRecommended.x=s.bgTop.width-s.bgRecommended.width,s.addChild(s.bgRecommended),s.tfRecommended=new gf.display.Text(s.game,loc("shop_recommended"),e.TEXT_STYLE_SMALL_HEAVY.clone());var a=s.game.client.supportedLanguage;s.tfRecommended.style.fontSize=a=="de"?11:9,s.tfRecommended.anchor.set(.5),s.tfRecommended.angle=45,s.tfRecommended.x=s.bgRecommended.x+(s.bgRecommended.width>>1)+8,s.tfRecommended.y=(s.bgRecommended.height>>1)-4,s.addChild(s.tfRecommended)}return s}return __extends(n,t),n.prototype.getCount=function(){var e=0,t=this.game.cache.getJSON("sets");return this._sets?(this._sets.forEach(function(n){t[n].forEach(function(t){e+=t[1]})}),e):0},n.prototype.onResize=function(){this.tfPrice.x=this.bgBottom.width-(this.tfPrice.width+this.tfCurrency.width+e.PADDING)>>1,this.tfCurrency.x=this.tfPrice.right+e.PADDING},n.prototype.setPrice=function(t,n){this.tfPrice.text=e.utils.getPrice(t,n),this._currency=n,this.tfCurrency.text=loc("shop_currency",{currency:this._currency.toUpperCase()}),this.onResize()},Object.defineProperty(n.prototype,"type",{get:function(){return this._type},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"currency",{get:function(){return this._currency},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"sets",{get:function(){return this._sets},set:function(e){this._sets=e,this.btRadio.tfCount.text=loc("shop_cube_count",{value:this.getCount()})},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"current",{get:function(){return this._current},set:function(t){this._current=t,this.bgTop.tint=this.bgBottom.tint=this._current?e.COLOR_YELLOW:e.COLOR_MID_GREY},enumerable:!0,configurable:!0}),n}(gf.display.Container);t.AboButton=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this)||this;return r.game=n,r.name="",r.alignData=new e.utils.AlignData,r.userData={},e.utils.Render.shouldApplyPixiFix(r.game.renderer)&&r.applyPixiFix(),r}return __extends(n,t),n.prototype.c=function(){return this.clear(),this},n.prototype.mt=function(e,t){return this.moveTo(e,t),this},n.prototype.lt=function(e,t){return this.lineTo(e,t),this},n.prototype.f=function(e,t){return this.beginFill(e,t),this},n.prototype.ef=function(){return this.endFill(),this},n.prototype.dc=function(e,t,n){return this.drawCircle(e,t,n),this},n.prototype.dr=function(e,t,n,r){return this.drawRect(e,t,n,r),this},n.prototype.rr=function(e,t,n,r,i){return this.drawRoundedRect(e,t,n,r,i),this},n.prototype.ls=function(e,t,n){return this.lineStyle(e,t,n),this},n.prototype.hAlign=function(t,n,r){r===void 0&&(r=0),e.utils.Align.hAlign(this,t,n,r)},n.prototype.vAlign=function(t,n,r){r===void 0&&(r=0),e.utils.Align.vAlign(this,t,n,r)},n.prototype.onResize=function(){e.utils.Align.onResize(this)},n.prototype.on=function(e,n,r){var i=this;return e?(e.split(" ").forEach(function(e){return t.prototype.on.call(i,e,n,r)}),this):this},n.prototype.off=function(e,n,r){var i=this;return e?(e.split(" ").forEach(function(e){return t.prototype.off.call(i,e,n,r)}),this):this},n.prototype.once=function(e,n,r){var i=this;return e?(e.split(" ").forEach(function(e){return t.prototype.once.call(i,e,n,r)}),this):this},n.prototype.removeAllListeners=function(e){var n=this;return e?(e.split(" ").forEach(function(e){return t.prototype.removeAllListeners.call(n,e)}),this):this},Object.defineProperty(n.prototype,"angle",{get:function(){return e.utils.Angle.getAngle(this)},set:function(t){e.utils.Angle.setAngle(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scaleX",{get:function(){return e.utils.Scale.getScaleX(this)},set:function(t){e.utils.Scale.setScaleX(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scaleY",{get:function(){return e.utils.Scale.getScaleY(this)},set:function(t){e.utils.Scale.setScaleY(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scaleXY",{set:function(t){e.utils.Scale.setScaleXY(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"left",{get:function(){return e.utils.Align.left(this)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"right",{get:function(){return e.utils.Align.right(this)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"top",{get:function(){return e.utils.Align.top(this)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"bottom",{get:function(){return e.utils.Align.bottom(this)},enumerable:!0,configurable:!0}),n.prototype.applyPixiFix=function(){var e=this;this.game.renderer.gl.canvas.addEventListener("webglcontextrestored",function(t){var n=e;n._webGL={},n.dirty=n.dirty+1},!1)},n}(PIXI.Graphics);t.Graphics=n})(t=e.display||(e.display={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){t.MOUSE_WHEEL="mouseWheel";var n=function(t){function n(){var e=t.call(this)||this;if(PIXI.utils.isMobile.any)return e;e.events="onwheel"in document||document.documentMode>=9?["wheel"]:["mousewheel","DomMouseScroll","MozMousePixelScroll"],e.mouseWheel=function(t){e.onWheel(t)};if(document.addEventListener)for(var n=e.events.length;n;)window.addEventListener(e.events[--n],e.mouseWheel,{passive:!1});else document.onmousewheel=e.mouseWheel;return e}return __extends(n,t),n.prototype.onWheel=function(t){t.preventDefault();var n=t||window.event,r,i,s,o=0;t.type="mousewheel","detail"in n&&(o=n.detail*-1),"wheelDelta"in n&&(o=n.wheelDelta),"wheelDeltaY"in n&&(o=n.wheelDeltaY),"wheelDeltaX"in n&&(s=n.wheelDeltaX*-1),"axis"in n&&n.axis===n.HORIZONTAL_AXIS&&(s=o*-1,o=0),i=o===0?s:o,"deltaY"in n&&(o=n.deltaY*-1,i=o),"deltaX"in n&&(s=n.deltaX,o===0&&(i=s*-1));if(o===0&&s===0)return;r=Math.max(Math.abs(o),Math.abs(s));if(!this.lowestDelta||r<this.lowestDelta)this.lowestDelta=r;t.delta=Math[i>=1?"floor":"ceil"](i/this.lowestDelta),t.deltaX=Math[s>=1?"floor":"ceil"](s/this.lowestDelta),t.deltaY=Math[o>=1?"floor":"ceil"](o/this.lowestDelta),this.emit(e.utils.MOUSE_WHEEL,t)},n}(PIXI.utils.EventEmitter);t.MouseWheel=n})(t=e.utils||(e.utils={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(n,r){r===void 0&&(r=e.VERTICAL);var i=t.call(this,n)||this;i.mouseWheelScrollValue=20,i.interactive=!0,i._direction=r,i._offsetX=0,i._offsetY=0,i._scrollPos=0,i._sizeScroll=0,i._sizeVisible=0,i._thumbMinSize=50,i._thumbMaxSize=Infinity,i.defaultThumb=new e.display.Graphics(i.game),i.defaultThumb.interactive=!0,i.defaultThumb.buttonMode=!0,i.defaultTrack=new e.display.Graphics(i.game),i.addTrack(i.defaultTrack),i.addThumb(i.defaultThumb),i.mouseWheel=new e.utils.MouseWheel,i.enable();var s=parseInt(PIXI.VERSION.split(".").join(""))<452;return s&&i.game.client.config.isMobile&&(i.on("pointerdown",function(e){return i.onDragStart(e)}),i.on("pointerup pointerupoutside",function(e){return i.onDragEnd(e)}),i.on("pointermove",function(e){return i.onDragMove(e,!0)})),i}return __extends(n,t),n.prototype.onDragStart=function(e){this._dragStart=e.data.global.clone(),this._startPos=this._scrollPos,this._dragging=!0},n.prototype.onDragEnd=function(e){this._dragging=!1},n.prototype.onDragMove=function(e,t){t===void 0&&(t=!1);if(this._dragging){var n=e.data.global.clone(),r=this.isVertical?n.y-this._dragStart.y:n.x-this._dragStart.x;this.updateScrollPos(t?this._startPos-r:this._startPos+r)}},n.prototype.onMouseWheel=function(e){this.updateScrollPos(this._scrollPos+(e.delta>0?-this.mouseWheelScrollValue:this.mouseWheelScrollValue))},n.prototype.updateScrollPos=function(e){this._scrollPos=Math.max(0,Math.min(e,this._scrollMax)),this.scroll()},n.prototype.drawThumb=function(){this.defaultThumb.c().f(0,.5).rr(0,0,this.isVertical?8:this._thumbSize,this.isVertical?this._thumbSize:8,4).ef()},n.prototype.drawTrack=function(){this.defaultTrack.c().f(0,.15).rr(0,0,this.isVertical?8:this._sizeVisible,this.isVertical?this._sizeVisible:8,4).ef()},n.prototype.addThumb=function(e){var t=this;if(this._thumb===e)return;this.game.client.config.isMobile||this._thumb&&(this._thumb==this.defaultThumb&&(this._thumb.visible=!1),this._thumb.off("pointerdown",function(e){return t.onDragStart(e)}),this._thumb.off("pointerup pointerupoutside",function(e){return t.onDragEnd(e)}),this._thumb.off("pointermove",function(e){return t.onDragMove(e)})),this._thumb=e,this._thumb.buttonMode=!0,this._thumb.on("pointerdown",function(e){return t.onDragStart(e)}),this._thumb.on("pointerup pointerupoutside",function(e){return t.onDragEnd(e)}),this._thumb.on("pointermove",function(e){return t.onDragMove(e)}),this._thumb=e,this.addChild(this._thumb),this.scroll()},n.prototype.addTrack=function(e){if(this._track===e)return;this._track&&this._track==this.defaultTrack&&(this._track.visible=!1),this._track=e,this.addChild(this._track),this.scroll()},n.prototype.enable=function(){var t=this;this.mouseWheel.on(e.utils.MOUSE_WHEEL,function(e){return t.onMouseWheel(e)},this)},n.prototype.disable=function(){this.mouseWheel.removeAllListeners(e.utils.MOUSE_WHEEL)},n.prototype.scroll=function(){var t=this;if(!this._thumb||!this._track||!this.toScroll||!this.scrollMask)return;this._thumbSize=Math.max(this._thumbMinSize,Math.min(this._thumbMaxSize,this._sizeVisible,this.sizeVisible/this._sizeScroll*this.sizeVisible)),this._scrollMax=this._sizeVisible-this._thumbSize,this._thumb==this.defaultThumb&&this.drawThumb(),this._track==this.defaultTrack&&this.drawTrack();if(this.visible){var n=this._scrollMax>0?this._scrollPos/this._scrollMax*(this.sizeScroll-this.sizeVisible):0;this.isVertical?(TweenMax.to(this._thumb,.25,{y:this._scrollPos}),TweenMax.to(this.toScroll,.25,{y:this.scrollMask.y-n,onUpdate:function(){return t.emit(e.CHANGE)}})):(TweenMax.to(this._thumb,.25,{x:this._scrollPos}),TweenMax.to(this.toScroll,.25,{x:this.scrollMask.x-n,onUpdate:function(){return t.emit(e.CHANGE)}}))}},n.prototype.update=function(t,n,r,i){r===void 0&&(r=0),i===void 0&&(i=0),this.toScroll=t,this.scrollMask=n,this.isVertical?(this._track.x=this._thumb.x=this.scrollMask.width+r,this.x=this.scrollMask.x,this.y=this.scrollMask.y+i,this.sizeVisible=this.scrollMask.height-i*2,this.sizeScroll=this.toScroll.height+this._offsetY):(this.x=this.scrollMask.x+r,this.y=this.scrollMask.y,this._track.y=this._thumb.y=this.scrollMask.height+i,this.sizeVisible=this.scrollMask.width-r*2,this.sizeScroll=this.toScroll.width+this._offsetX),this.emit(e.UPDATE),this.visible=this.sizeScroll>this.sizeVisible,this.scroll()},n.prototype.updateToContentPosition=function(){var e=this;if(!this.toScroll||!this.scrollMask)return;if(this.sizeScroll<this.sizeVisible){this.toScroll.y=this.scrollMask.y;return}var t=-(this.toScroll.y-this.scrollMask.y)/(this.toScroll.height-this.scrollMask.height);this._scrollPos=(this.sizeVisible-this._thumbSize)*t,this._scrollPos>this._scrollMax&&(this._scrollPos=this._scrollMax),this.isVertical?TweenMax.to(this._thumb,.25,{y:this._scrollPos,onComplete:function(){return e.scroll()}}):TweenMax.to(this._thumb,.25,{x:this._scrollPos,onComplete:function(){return e.scroll()}})},Object.defineProperty(n.prototype,"sizeScroll",{get:function(){return this._sizeScroll},set:function(e){if(this._sizeScroll===e)return;this._sizeScroll=e,this.scroll()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"sizeVisible",{get:function(){return this._sizeVisible},set:function(e){if(this._sizeVisible===e)return;this._sizeVisible=e,this.scroll()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"thumbMaxSize",{get:function(){return this._thumbMaxSize},set:function(e){this._thumbMaxSize=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"direction",{get:function(){return this._direction},set:function(e){if(this._direction===e)return;this._direction=e,this.scroll()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"offsetX",{get:function(){return this._offsetX},set:function(e){this._offsetX=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"offsetY",{get:function(){return this._offsetY},set:function(e){this._offsetY=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isVertical",{get:function(){return this._direction===e.VERTICAL},enumerable:!0,configurable:!0}),n}(e.display.Container);t.SimpleScrollBar=n})(t=e.ui||(e.ui={}))})(gf||(gf={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n,r){r===void 0&&(r=gf.VERTICAL);var i=t.call(this,n,r)||this;return i._thumbMinSize=18,i._thumbMaxSize=100,i.isVertical?i.defaultThumb.c().f(16777215).dr(0,0,18,18).ef():i.defaultThumb.c().f(16777215).dr(0,0,18,18).ef(),i.defaultThumb.tint=e.COLOR_DARK_GREY,i.defaultThumb.on("mouseover",function(){i.defaultThumb.tint=e.COLOR_LIGHT_GREY,i.game.renderState=2}),i.defaultThumb.on("mouseout",function(){i.defaultThumb.tint=e.COLOR_DARK_GREY,i.game.renderState=2}),i.defaultThumb.on("mousedown touchstart",function(){i.defaultThumb.tint=e.COLOR_GREY,i.game.renderState=2}),i.defaultThumb.on("mouseup",function(){i.defaultThumb.tint=e.COLOR_LIGHT_GREY,i.game.renderState=2}),i.defaultThumb.on("touchend",function(){i.defaultThumb.tint=e.COLOR_DARK_GREY,i.game.renderState=2}),i.defaultThumb.on("mouseupoutside touchendoutside",function(){i.defaultThumb.tint=e.COLOR_DARK_GREY,i.game.renderState=2}),i.defaultTrack.interactive=!0,i.isVertical?i.defaultTrack.c().f(e.COLOR_LIGHT_GREY).dr(7,0,3,300).ef():i.defaultTrack.c().f(e.COLOR_LIGHT_GREY).dr(0,7,300,3).ef(),i.defaultTrack.on("mouseup touchend",function(e){return i.onTrack(e)}),i._thumb=i.defaultThumb,i}return __extends(n,t),n.prototype.onTrack=function(e){var t=e.data.getLocalPosition(this.defaultTrack),n=this.isVertical?t.y/this.defaultTrack.height:t.x/this.defaultTrack.width;this.updateScrollPos(n*this._scrollMax)},n.prototype.drawThumb=function(){this.defaultThumb.width=this.isVertical?18:this._thumbSize,this.defaultThumb.height=this.isVertical?this._thumbSize:18},n.prototype.drawTrack=function(){this.defaultTrack.width=this.isVertical?3:this._sizeVisible,this.defaultTrack.height=this.isVertical?this._sizeVisible:3},n.prototype.enableMouseWheel=function(){var e=this;this.mouseWheel.on(gf.utils.MOUSE_WHEEL,function(t){return e.onMouseWheel(t)},this)},n.prototype.disableMouseWheel=function(){this.mouseWheel.removeAllListeners(gf.utils.MOUSE_WHEEL)},n.prototype.setMouseWheel=function(e){this.onMouseWheel(e)},n.prototype.reset=function(){this._scrollPos=0,this._thumb&&(this._thumb.y=0),this.toScroll&&(this.toScroll.y=0)},n.prototype.enable=function(){},n.prototype.disable=function(){},n}(gf.ui.SimpleScrollBar);t.Scrollbar=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var gf;(function(e){var t;(function(t){var n=function(){function t(){e.utils.Keyboard.instance=this,e.utils.Keyboard.global=[]}return t.init=function(){var e=this;this.keys=[];try{top.addEventListener("keydown",function(t){e.onKey(t)},!0),window!=top&&window.addEventListener("keydown",function(t){e.onKey(t)},!0)}catch(t){window.addEventListener("keydown",function(t){e.onKey(t)},!0)}},t.addKey=function(e,t){this.keys[e]||(this.keys[e]=[]),this.keys[e].push(t)},t.removeKey=function(e,t){if(!this.keys[e])return;this.keys[e].splice(this.keys[e].indexOf(t),1)},t.onKey=function(e){var t=e.which;if(this.keys[t]&&this.keys[t].length>0)for(var n=0;n<this.keys[t].length;++n)this.keys[t][n](e);for(var n=0;n<this.global.length;++n)this.global[n]&&this.global[n](e)},t.getInstance=function(){var t=e.utils.Keyboard;return typeof t.instance=="undefined"&&(t.instance=new e.utils.Keyboard,this.init()),t.instance},t.addGlobal=function(e){return this.instance||this.getInstance(),this.global||(this.global=[]),this.global.push(e)-1},t.add=function(e,t){var n=this;this.instance||this.getInstance(),this.callbacks||(this.callbacks={});var r;if(typeof t=="number")return r=PIXI.utils.uid(),this.callbacks[r]={callback:e,key:t},this.addKey(t,e),r;var i=[];return t.forEach(function(t){r=PIXI.utils.uid(),n.callbacks[r]={callback:e,key:t},n.addKey(t,e),i.push(r)}),i},t.has=function(e){var t=this;this.instance||this.getInstance();if(!this.callbacks)return!1;var n=!1;if(typeof e=="number"){for(var r in this.callbacks)this.callbacks[r]&&this.callbacks[r].key==e&&(n=!0);return n}e.forEach(function(e){for(var r in t.callbacks)t.callbacks[r].key==e&&(n=!0)})},t.removeGlobal=function(e){this.instance||this.getInstance();if(!e&&e!=0)return;this.global[e]&&(this.global[e]=null)},t.remove=function(e){var t=this;this.instance||this.getInstance();if(!e&&e!=0)return;if(typeof e=="number"){if(!this.callbacks[e])return;this.removeKey(this.callbacks[e].key,this.callbacks[e].callback),this.callbacks[e]=null}else e.forEach(function(e){t.removeKey(t.callbacks[e].key,t.callbacks[e].callback),t.callbacks[e]=null})},t}();t.Keyboard=n})(t=e.utils||(e.utils={}))})(gf||(gf={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n)||this;return r.interactive=!0,r.hasScrollbar=!1,r.items=[],r._isEnabled=!0,r._isOpened=!1,r.bg=new gf.display.Slice9(r.game,10,10,10,10,"sprites","dropdown_bg"),r.addChild(r.bg),r._orgHeight=r.bg.height,r.tf=new gf.display.Text(r.game,"",e.TEXT_STYLE_SMALL.clone()),r.tf.x=e.PADDING,r.tf.y=r.bg.height-r.tf.height>>1,r.addChild(r.tf),r.btArrow=new gf.ui.Button(r.game),r.btArrow.on(gf.CLICK,r.onArrow,r),r.addChild(r.btArrow),r.arrowBg=new gf.display.Sprite(r.game,"sprites","dropdown_arrow_bg"),r.btArrow.addChild(r.arrowBg),r.arrow=new gf.display.Sprite(r.game,"sprites","dropdown_arrow"),r.arrow.anchor.set(.5),r.arrow.x+=r.arrow.width>>1,r.arrow.y+=r.arrow.height>>1,r.btArrow.addChild(r.arrow),r.btArrow.x=r.bg.right-r.arrowBg.width,r.listMask=new gf.display.Sprite(r.game,PIXI.Texture.WHITE),r.listMask.y=r.bg.bottom,r.listMask.height=r.bg.height,r.listMask.width=r.bg.width,r.addChild(r.listMask),r.list=new gf.display.Container(r.game),r.list.y=r.bg.bottom,r.list.mask=r.listMask,r.addChild(r.list),r.scrollbar=new e.ui.Scrollbar(r.game),r.scrollbar.on(gf.UPDATE,r.onScrollbar,r),r.scrollbar.x=r.btArrow.x,r.scrollbar.y=r.btArrow.bottom,r.scrollbar.visible=!1,r.scrollbar.mouseWheelScrollValue=2,r.addChild(r.scrollbar),r.btArrow.hitArea=new PIXI.Rectangle(-r.btArrow.x,0,r.btArrow.right,r.arrowBg.height),r}return __extends(n,t),n.prototype.selectByChar=function(e){var t=this,n=!1;this.items.forEach(function(r){r.tf.text.charAt(0)==e&&(n=!0,t.scrollToItem(r.itemId))})},n.prototype.scrollToItem=function(e){var t=this;this.items.forEach(function(n){n.itemId==e&&(t.tf.text=n.tf.text,t.tf.truncate(t.bg.origWidth-t.arrowBg.width-2),t._currentItem=n,t.list.y=t.bg.bottom-t._currentItem.y-t.listMask.height,t.scrollbar.updateToContentPosition())})},n.prototype.addKeys=function(){var e=this;this._keyboardId=gf.utils.Keyboard.addGlobal(function(t){(t.which>=65&&t.which<=90||t.which>=97&&t.which<=122)&&e.selectByChar(t.key.toUpperCase())})},n.prototype.removeKeys=function(){gf.utils.Keyboard.removeGlobal(this._keyboardId),this._keyboardId=null},n.prototype.onScrollbar=function(){},n.prototype.onArrow=function(){this._isOpened?this.close():this.open()},n.prototype.onItem=function(e){this.tf.text=e.tf.text,this.tf.truncate(this.bg.origWidth-this.arrowBg.width-2),this._currentItem=e,this.close(),this.emit("select")},n.prototype.close=function(){if(!this.isOpened)return;this.isOpened=!1,this.removeKeys(),this.listMask.height=this.bg.height=this.bg.origHeight,this.items.forEach(function(e){e.visible=!1}),this.bg.width=this.bg.origWidth,this.bg.x=0,this.listMask.x=this.bg.x,this.listMask.width=this.bg.width,this.scrollbar.visible=!1,this.scrollbar.reset(),this.scrollbar.disableMouseWheel()},n.prototype.open=function(){if(this.isOpened)return;this.isOpened=!0,this.addKeys(),this.items.forEach(function(e){e.visible=!0}),this.listMask.width=this._maxWidth,this.listMask.x=this.list.x=this.bg.width-this.listMask.width,this.bg.width=this.listMask.width,this.bg.x=this.listMask.x,this.scrollbar.enableMouseWheel(),this.update()},n.prototype.addItem=function(t,n){var r=this,i=new e.ui.DropdownItem(this.game,n,t);return i.on(gf.CLICK,function(){return r.onItem(i)},this),i.y=i.height*this.items.length,i.visible=!1,this.list.addChild(i),this.items.push(i),this._maxWidth=Math.max(this._maxWidth,this.bg.width,i.width+(this.hasScrollbar?this.scrollbar.width:0))>>0,i},n.prototype.addItems=function(e,t){e.length!=t.length&&logWarning("cuboro.ui.Dropdown error. Item IDs length doesn't match labels length!",e,t);for(var n=0;n<Math.min(e.length,t.length);++n)this.addItem(e[n],t[n])},n.prototype.selectItem=function(e){var t=this;this.items.forEach(function(n){n.itemId==e&&(t.tf.text=n.tf.text,t.tf.truncate(t.bg.origWidth-t.arrowBg.width-2),t._currentItem=n)})},n.prototype.update=function(){if(!this.items.length)return;this.listMask.scaleY=1,this.scrollbar.visible=!1,this.listMask.height=this.items.length*this.items[0].height,this.bg.height=this.listMask.height+this.items[0].height,this._maxVisible&&this._maxVisible>0&&(this.listMask.height=this._maxVisible*this.items[0].height,this.bg.height=this.listMask.height+this.items[0].height+2,this.list.height>this.listMask.height&&(this.scrollbar.visible=!0,this.scrollbar.update(this.list,this.listMask,-(this.scrollbar.width+5))))},Object.defineProperty(n.prototype,"maxVisible",{get:function(){return this._maxVisible},set:function(e){this._maxVisible=e,this.update()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"currentItem",{get:function(){return this._currentItem},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(e){this.btArrow.isEnabled=this._isEnabled=e,this.interactive=this.interactiveChildren=this._isEnabled,this.alpha=this._isEnabled?1:.5},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isOpened",{get:function(){return this._isOpened},set:function(e){this._isOpened=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"orgHeight",{get:function(){return this._orgHeight},enumerable:!0,configurable:!0}),n}(gf.display.Container);t.Dropdown=n;var r=function(t){function n(n,r,i){var s=t.call(this,n)||this;return s.itemId=i,s.bg=new gf.display.Sprite(s.game,"sprites","dropdown_bg"),s.bg.alpha=0,s.addChild(s.bg),s.tf=new gf.display.Text(s.game,r,e.TEXT_STYLE_SMALL.clone()),s.tf.x=e.PADDING,s.tf.y=s.bg.height-s.tf.height>>1,s.addChild(s.tf),s.bg.width=Math.max(s.tf.width,s.bg.width)>>0,s}return __extends(n,t),n.prototype.setState=function(t){switch(this._currentState){case gf.DOWN:this.tf.style.fill=e.COLOR_YELLOW;break;case gf.OUT:this.tf.style.fill=e.COLOR_DARK_GREY;break;case gf.OVER:this.tf.style.fill=e.COLOR_YELLOW;break;case gf.UP:this.isOver?this.tf.style.fill=e.COLOR_YELLOW:this.tf.style.fill=e.COLOR_DARK_GREY}},n}(gf.ui.Button);t.DropdownItem=r})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){var t=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t}(gf.ui.Button);e.PaymentButton=t})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){t.prototype.init.call(this),this.tfTitle.text=loc("shop_title"),this.bg.width=500,this.bg.height=420,this.content=new gf.display.Container(this.game),this.content.y=this.tfTitle.bottom+e.PADDING*4,this.addChild(this.content),this.tfInfo=new gf.display.Text(this.game,loc("shop_info")),this.tfInfo.style=e.TEXT_STYLE_SMALL.clone(),this.tfInfo.style.wordWrap=!0,this.tfInfo.style.wordWrapWidth=this.bg.width-44,this.content.addChild(this.tfInfo),this.tfCanceledTitle=new gf.display.Text(this.game,loc("shop_manage_abo_current_cancelled_title")),this.tfCanceledTitle.style=e.TEXT_STYLE_SMALL_HEAVY.clone(),this.tfCanceledTitle.style.wordWrap=!0,this.tfCanceledTitle.style.wordWrapWidth=this.bg.width-44,this.tfCanceledTitle.y=this.tfInfo.bottom+e.PADDING*2,this.content.addChild(this.tfCanceledTitle),this.tfCanceled=new gf.display.Text(this.game),this.tfCanceled.style=e.TEXT_STYLE_SMALL.clone(),this.tfCanceled.style.wordWrap=!0,this.tfCanceled.style.wordWrapWidth=this.bg.width-44,this.tfCanceled.y=this.tfCanceledTitle.bottom+e.PADDING*2,this.content.addChild(this.tfCanceled),this.tfSelectAbo=new gf.display.Text(this.game,loc("shop_select_abo"),e.TEXT_STYLE_SMALL_HEAVY.clone()),this.tfSelectAbo.style.wordWrap=!0,this.tfSelectAbo.style.wordWrapWidth=this.bg.width-44,this.tfSelectAbo.y=this.tfInfo.bottom+e.PADDING*2,this.content.addChild(this.tfSelectAbo),this.tfSelectPayment=new gf.display.Text(this.game,loc("shop_select_payment"),e.TEXT_STYLE_SMALL_HEAVY.clone()),this.tfSelectPayment.style.wordWrap=!0,this.tfSelectPayment.style.wordWrapWidth=this.bg.width-44,this.tfSelectPayment.visible=!1,this.content.addChild(this.tfSelectPayment),this.paymentContainer=new gf.display.Container(this.game),this.paymentContainer.visible=!1,this.content.addChild(this.paymentContainer),this.addPayment(),this.btBuy=new e.ui.TextButton(this.game,loc("bt_shop_buy"),!0),this.btBuy.on(gf.CLICK,this.onBuy,this),this.content.addChild(this.btBuy),this.addDisclaimer(),this.aboContainer=new gf.display.Container(this.game),this.aboContainer.y=this.tfSelectAbo.bottom+e.PADDING*2,this.content.addChild(this.aboContainer),this.addAbos(),this.addCountries(),this.btBuy.y=this.countries.bottom+e.PADDING*4,this.bg.height=this.content.bottom-this.bg.y+e.PADDING*4},n.prototype.onAboGet=function(){this.onResize()},n.prototype.addDisclaimer=function(){var t=this.game.client.supportedLanguage;this.disclaimer=new gf.display.Container(this.game),this.disclaimer.interactive=!0,this.content.addChild(this.disclaimer);var n=new gf.display.Text(this.game,loc("shop_disclaimer"),e.TEXT_STYLE_SMALL.clone());n.style.wordWrap=!0,n.style.wordWrapWidth=this.bg.width-22,this.disclaimer.addChild(n);var r=new gf.display.Sprite(this.game,PIXI.Texture.EMPTY);r.interactive=!0,r.buttonMode=!0,r.on("click tap",function(){track("Shop-Terms"),window.open("/html/terms_"+t+".html","_blank")},this),this.disclaimer.addChild(r),t=="de"?(r.width=218,r.height=14,r.y=16):t=="en"?(r.width=128,r.height=14,r.x=288):(r.width=218,r.height=14,r.y=16);var i=new gf.display.Sprite(this.game,PIXI.Texture.WHITE);i.x=r.x,i.y=(r.bottom>>0)-1,i.width=r.width,i.height=1,i.tint=e.COLOR_DARK_GREY,this.disclaimer.addChild(i)},n.prototype.addAbos=function(){var t=this;this.abos=[],this.abo1=new e.ui.AboButton(this.game,loc("shop_set_single"),e.ABO_SINGLE),this.abo1.index=1,this.abo1.name=e.ABO_SINGLE,this.abo1.packshot.x=this.abo1.width-this.abo1.packshot.width>>1,this.abo1.packshot.y=this.abo1.bgPackshot.y+(this.abo1.bgPackshot.height-this.abo1.packshot.height>>1),this.abo1.sets=[e.SETS.METRO],this.aboContainer.addChild(this.abo1),this.abos.push(this.abo1),this.abo1Dropdown=new e.ui.Dropdown(this.game),this.abo1Dropdown.y=this.abo1.height+e.PADDING*2,this.abo1Dropdown.on("select",this.onAboDropdown,this),this.abo1Dropdown.addItems([e.SETS.METRO,e.SETS.BUILD,e.SETS.DUO,e.SETS.PROFI,e.SETS.PLUS,e.SETS.MULTI],[loc("packshot_"+e.SETS.METRO),loc("packshot_"+e.SETS.BUILD),loc("packshot_"+e.SETS.DUO),loc("packshot_"+e.SETS.PROFI),loc("packshot_"+e.SETS.PLUS),loc("packshot_"+e.SETS.MULTI)]),this.abo1Dropdown.selectItem(e.SETS.METRO),this.abo1.addChild(this.abo1Dropdown),this.abo2=new e.ui.AboButton(this.game,loc("shop_set_basic"),e.ABO_BASIC),this.abo2.x=this.abo1.right+10,this.abo2.btRadio.isChecked=!0,this.abo2.index=2,this.abo2.name=e.ABO_BASIC,this.abo2.sets=[e.SETS.STANDARD,e.SETS.BASIC],this.aboContainer.addChild(this.abo2),this.abos.push(this.abo2),this.abo3=new e.ui.AboButton(this.game,loc("shop_set_all"),e.ABO_ALL),this.abo3.x=this.abo2.right+10,this.abo3.index=3,this.abo3.name=e.ABO_ALL,this.abo3.sets=[e.SETS.STANDARD,e.SETS.BASIC,e.SETS.BUILD,e.SETS.DUO,e.SETS.PROFI,e.SETS.METRO,e.SETS.PLUS,e.SETS.MULTI],this.aboContainer.addChild(this.abo3),this.abos.push(this.abo3),this.abos.forEach(function(e){e.btRadio.on("checked",t.onAboChecked,t)}),this.onAboChecked(this.abo2.btRadio)},n.prototype.onAboDropdown=function(){this.abo1.packshot.frameName=this.abo1Dropdown.currentItem.itemId,this.abo1.sets=[this.abo1Dropdown.currentItem.itemId],this.onAboChecked(this.abo1.btRadio)},n.prototype.addCountries=function(){var t=this;this.tfSelectCountry=new gf.display.Text(this.game,loc("shop_select_country"),e.TEXT_STYLE_SMALL.clone()),this.tfSelectCountry.style.align=gf.RIGHT,this.tfSelectCountry.style.wordWrap=!0,this.tfSelectCountry.style.wordWrapWidth=this.abo2.width,this.content.addChild(this.tfSelectCountry),this.countries=new e.ui.Dropdown(this.game),this.countries.hasScrollbar=!0,this.countries.maxVisible=5,this.countries.x=this.abo3.right-this.countries.width,this.countries.y=this.aboContainer.y+this.abo3.height+e.PADDING*2,this.countries.on("select",function(){t.countryId=t.countries.currentItem.itemId,t.getShop()});var n=this.getCountries(),r=this.game.client.config.language;n.forEach(function(e){var n=t.countries.addItem(e.iso.toLowerCase(),r=="de"?e.de:e.en)}),this.countries.tf.text="",this.content.addChild(this.countries),this.tfSelectCountry.x=this.abo2.right-this.tfSelectCountry.width,this.tfSelectCountry.y=this.countries.y+(this.countries.height-this.tfSelectCountry.height>>1)},n.prototype.getCountries=function(){var e=this,t=this.game.cache.getJSON("countries");return t.sort(function(t,n){return e.game.client.config.language=="de"?t.de.localeCompare(n.de):t.en.localeCompare(n.en)}),t},n.prototype.addPayment=function(){this.payment=[]},n.prototype.getPlanById=function(e){var t=null;return this.plans.forEach(function(n){n.id==e&&(t=n)}),t},n.prototype.getAboByName=function(e){var t=null;return this.abos.forEach(function(n){n.name==e&&(t=n)}),t},n.prototype.onAboChecked=function(e){var t=this;this.abos.forEach(function(n){n.btRadio!=e?n.btRadio.isChecked=!1:t.currentAbo=n}),this.abo1Dropdown.isEnabled=e==this.abo1.btRadio&&mAbo.getAbo().daysForNextSingleChange==0,!this.abo1Dropdown.isEnabled&&this.abo1Dropdown.isOpened&&this.abo1Dropdown.close(),this.btBuy.isEnabled=!0,this.btBuy.label=loc("bt_shop_buy"),this.checkAbo()},n.prototype.checkAbo=function(){var e=mAbo.getAbo();e.type==this.currentAbo.type&&(e.cancelled?this.btBuy.label=loc("bt_shop_revoke_termination"):this.currentAbo==this.abo1?e.sets[0]==this.abo1Dropdown.currentItem.itemId&&(this.btBuy.isEnabled=!1):this.btBuy.isEnabled=!1),e.downgrade&&e.downgrade.type==this.currentAbo.type&&(this.btBuy.isEnabled=!1),this.onResize()},n.prototype.onClose=function(){track("Shop-Close"),this.game.overlays.hide(e.overlays.Shop.NAME)},n.prototype.onBuy=function(){var t=this;track("Shop-Buy_"+this.currentAbo.type),this.game.overlays.show(e.overlays.Loader.NAME);var n=this.getPlanById(this.currentAbo.planId),r=this.currentAbo.index==1?[this.abo1Dropdown.currentItem.itemId]:this.currentAbo.sets;if(mAbo.getAbo().type==this.currentAbo.type&&mAbo.getAbo().cancelled)sAbo.reactiveAbo(function(i){track("Shop-Reactivate_Abo_"+t.currentAbo.type);if(i==kr3m.SUCCESS){var s=e.utils.getPrice(n.amount,n.currency),o=t.game.overlays.show(e.overlays.AboChanged.NAME);o.sets=r,o.revoked(s,n.currency.toUpperCase(),t.getAboTypeText(mAbo.getAbo().type)),mAbo.updateAbo(function(){t.game.overlays.hide(e.overlays.Loader.NAME),t.game.overlays.hide(e.overlays.Shop.NAME),t.getShop()})}else{t.game.overlays.hide(e.overlays.Loader.NAME);var u=t.game.overlays.show(e.overlays.RevokeFailed.NAME);u.onRetry=function(){return t.onBuy()}}});else{var i=mAbo.getAbo().type,s=this.game.client.config.language;s!="de"&&(s="en"),StripeCheckout.configure({key:this.game.client.config.stripePublishableKey,image:"/img/shop_abo"+this.currentAbo.index+".jpg",locale:s,token:function(s){t.game.overlays.show(e.overlays.Loader.NAME),sShop.charge(s,n.id,n.product,r,t.countryId,t.currencyId,function(s){track("Shop-Abo_charged_"+t.currentAbo.type);if(s==kr3m.SUCCESS)mAbo.updateAbo(function(){t.game.overlays.hide(e.overlays.Loader.NAME);if(i==e.ABO_NONE){var s=t.game.overlays.show(e.overlays.PaymentSuccess.NAME);s.sets=r}else{var o=e.utils.getPrice(n.amount,n.currency),u=t.game.overlays.show(e.overlays.AboChanged.NAME);u.sets=r,t.isUpgrade(i)?(track("AboChanged-Downgrade_From_"+i+"_to_"+t.currentAbo.type),u.upgrade(o)):(track("AboChanged-Upgrade_From_"+i+"_to_"+t.currentAbo.type),u.downgrade(o,n.currency.toUpperCase()))}t.game.overlays.hide(e.overlays.Abo.NAME),t.game.overlays.hide(e.overlays.Shop.NAME)});else{t.game.overlays.hide(e.overlays.Loader.NAME);var o=t.game.overlays.show(e.overlays.PaymentFailed.NAME);o.onRetry=function(){return t.onBuy()}}})}}).open({name:loc("shop_customer_name"),description:loc("shop_description_"+n.name.toLowerCase()),currency:n.currency,amount:n.amount,locale:s,opened:function(){t.game.overlays.hide(e.overlays.Loader.NAME)}})}},n.prototype.isUpgrade=function(t){var n=mAbo.getAbo().type;return t!=e.ABO_SINGLE||n!=e.ABO_BASIC&&n!=e.ABO_ALL?t==e.ABO_BASIC&&n==e.ABO_ALL:!0},n.prototype.getAboTypeText=function(t){return t==e.ABO_SINGLE?loc("shop_set_single"):t==e.ABO_BASIC?loc("shop_set_basic"):loc("shop_set_all")},n.prototype.getShop=function(){var t=this;this.tfCanceledTitle.visible=!1;if(mAbo.hasAbo()&&!mAbo.getAbo().cancelled||mAbo.hasAbo()&&mAbo.getAbo().cancelled&&mAbo.getAbo().downgrade)this.game.overlays.hide(e.overlays.Shop.NAME),this.game.overlays.show(e.overlays.Abo.NAME);else if(mAbo.hasAbo()&&mAbo.getAbo().cancelled){track("Shop-Show");var n=mAbo.getAbo();this.countryId=mAbo.getAbo().countryId,this.tfCanceledTitle.visible=!0,this.tfCanceled.text=loc("shop_manage_abo_current_cancelled",{abo:this.getAboTypeText(n.type),date:locDate("track_info_last_saved",n.nextPayment)}),this.checkAbo()}else this.tfCanceled.text="";mAbo.getAbo().countryId&&(this.countryId=mAbo.getAbo().countryId),mAbo.getAbo().currencyId&&(this.currencyId=mAbo.getAbo().currencyId),this.game.overlays.show(e.overlays.Loader.NAME),this.onResize(),sShop.getShop(function(n){t.plans=n;if(t.plans)t.plans.forEach(function(e){var n=t.getAboByName(e.name);n&&(n.planId=e.id,n.setPrice(e.amount,e.currency),t.countryId=e.countryId,t.currencyId=e.currency)}),t.countryId&&t.countries.selectItem(t.countryId);else{var r=t.game.overlays.show(e.overlays.Message.NAME);r.text=loc("shop_no_plans"),t.game.overlays.hide(e.overlays.Shop.NAME)}t.game.overlays.hide(e.overlays.Loader.NAME),t.onShopGet()},this.countryId)},n.prototype.onShopGet=function(){},n.prototype.transitionIn=function(){var n=this;t.prototype.transitionIn.call(this),this.countryId=null;if(!mUser.isLoggedIn()){this.game.overlays.hide(e.overlays.Shop.NAME),this.game.overlays.show(e.overlays.Login.NAME);var r=this.game.overlays.getOverlay(e.overlays.Login.NAME);r.once(gf.LOGIN,function(t){t&&(mUser.isLoggedIn()?n.game.overlays.show(e.overlays.Shop.NAME):mUser.once("loggedIn",function(){n.game.overlays.show(e.overlays.Shop.NAME)}))},this)}else mUser.isLoggedIn()&&!mAbo.isInitialized()?(this.game.overlays.show(e.overlays.Loader.NAME),mAbo.once(e.clientmodels.Abo.ABO,function(){n.game.overlays.hide(e.overlays.Loader.NAME),n.getShop()})):this.getShop()},n.prototype.transitionOut=function(){t.prototype.transitionOut.call(this),this.abo1Dropdown.isOpened&&this.abo1Dropdown.close(),this.countries.isOpened&&this.countries.close()},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.countries&&(this.countries.isEnabled=!mAbo.hasAbo(),mAbo.getAbo().countryId&&(this.countries.isEnabled=!1),this.bg.width=this.aboContainer.width+44,this.bg.x=this.game.width-this.bg.width>>1,this.tfSelectAbo.y=this.tfCanceled.bottom+e.PADDING*2,this.aboContainer.y=this.tfSelectAbo.bottom+e.PADDING*2,this.countries.y=this.aboContainer.y+this.abo3.height+e.PADDING*2,this.tfSelectCountry.y=this.countries.y+(this.countries.orgHeight-this.tfSelectCountry.height>>1),this.btBuy.y=this.countries.y+this.countries.orgHeight+e.PADDING*4,this.disclaimer.y=this.btBuy.bottom+e.PADDING*2>>0,this.bg.height=this.content.y+this.btBuy.y+this.btBuy.height-this.bg.y+e.PADDING*4,this.disclaimer.visible&&(this.bg.height+=this.disclaimer.height+e.PADDING*2)),this.content.x=this.bg.x+22,this.btBuy.x=this.bg.width-44-this.btBuy.width>>1},n.NAME="shop",n}(e.overlays.Overlay);t.Shop=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){t.prototype.init.call(this),this.tfTitle.text=loc("shop_manage_abo_title"),this.tfCurrent=new gf.display.Text(this.game,loc("shop_manage_abo_current")),this.tfCurrent.style=e.TEXT_STYLE_SMALL_HEAVY.clone(),this.tfCurrent.style.wordWrap=!0,this.tfCurrent.style.wordWrapWidth=this.bg.width-44,this.content.addChild(this.tfCurrent),this.tfInfo.text=loc("shop_manage_abo_next_payment"),this.tfInfo.y=this.tfCurrent.bottom,this.tfSelectAbo.text=loc("shop_manage_abo_change"),this.tfSelectPayment.text=loc("shop_manage_abo_payment"),this.btBuy.label=loc("bt_shop_save_changes"),this.tfCanceledTitle.y=this.tfInfo.bottom+e.PADDING*2,this.tfCanceled.y=this.tfCanceledTitle.bottom+e.PADDING*2,this.tfSelectAbo.y=this.tfInfo.bottom+e.PADDING*2,this.btCancel=new e.ui.TextButton(this.game,loc("bt_shop_cancel_abo"),!1),this.btCancel.on(gf.CLICK,this.onCancel,this),this.content.addChild(this.btCancel),this.tfCooldown=new gf.display.Text(this.game,loc("shop_abo_cooldown")),this.tfCooldown.style=e.TEXT_STYLE_SMALL.clone(),this.tfCooldown.style.fontSize=11,this.tfCooldown.style.wordWrap=!0,this.tfCooldown.style.wordWrapWidth=this.abo1Dropdown.width,this.tfCooldown.y=this.abo1Dropdown.bottom+e.PADDING,this.aboContainer.addChild(this.tfCooldown),this.tfSelectAbo.y=this.tfInfo.bottom+e.PADDING*2,this.aboContainer.y=this.tfSelectAbo.bottom+e.PADDING*2,this.tfSelectPayment.y=this.aboContainer.bottom+e.PADDING*4,this.paymentContainer.y=this.tfSelectPayment.bottom+e.PADDING*2,this.btBuy.y=this.btCancel.y=this.countries.bottom+e.PADDING*4,this.bg.height=this.content.bottom-this.bg.y+e.PADDING*4,this.disclaimer.visible=!1},n.prototype.onBuy=function(){var n=this;mAbo.getAbo().type==e.ABO_SINGLE&&this.currentAbo.type==e.ABO_SINGLE?(this.game.overlays.show(e.overlays.Loader.NAME),sShop.changeSet(this.abo1Dropdown.currentItem.itemId,function(t){n.game.overlays.hide(e.overlays.Loader.NAME);if(t==kr3m.SUCCESS){var r=n.game.overlays.show(e.overlays.AboChanged.NAME);r.sets=[n.abo1Dropdown.currentItem.itemId],r.changed(),n.game.overlays.hide(e.overlays.Abo.NAME),n.game.overlays.show(e.overlays.Loader.NAME),mAbo.updateAbo(function(){n.game.overlays.hide(e.overlays.Loader.NAME)})}})):t.prototype.onBuy.call(this)},n.prototype.onAboChecked=function(e){t.prototype.onAboChecked.call(this,e),this.btBuy.label=loc("bt_shop_save_changes"),this.onResize()},n.prototype.onClose=function(){track("Abo-Close"),this.game.overlays.hide(e.overlays.Abo.NAME)},n.prototype.onCancel=function(){var t=this;mAbo.getAbo().cancelled?(track("Abo-Revoke-Termination"),this.game.overlays.show(e.overlays.Loader.NAME),sAbo.reactiveAbo(function(n){if(n==kr3m.SUCCESS){var r=t.getPlanById(t.currentAbo.planId),i=e.utils.getPrice(r.amount,r.currency),s=t.game.overlays.show(e.overlays.AboChanged.NAME),o=t.currentAbo.index==1?[t.abo1Dropdown.currentItem.itemId]:t.currentAbo.sets;s.sets=o,s.revoked(i,r.currency.toUpperCase(),t.getAboTypeText(mAbo.getAbo().type)),mAbo.updateAbo(function(){t.game.overlays.hide(e.overlays.Loader.NAME),t.game.overlays.hide(e.overlays.Abo.NAME),t.getShop()})}else{t.game.overlays.hide(e.overlays.Loader.NAME);var u=t.game.overlays.show(e.overlays.RevokeFailed.NAME);u.onRetry=function(){return t.onCancel()}}})):(track("Abo-Cancel"),track("Abo-Cancel_"+mAbo.getAbo().type),this.game.overlays.hide(e.overlays.Abo.NAME),this.game.overlays.show(e.overlays.AboTerminate.NAME))},n.prototype.getShop=function(){var t=this;this.tfCanceledTitle.visible=!1,this.game.overlays.show(e.overlays.Loader.NAME),this.countryId=mAbo.getAbo().countryId,sShop.getShop(function(n){t.plans=n;if(t.plans)t.plans.forEach(function(e){var n=t.getAboByName(e.name);n&&(n.planId=e.id,n.setPrice(e.amount,e.currency),t.countryId=e.countryId,t.currencyId=e.currency)}),t.countryId&&t.countries.selectItem(t.countryId);else{var r=t.game.overlays.show(e.overlays.Message.NAME);r.text=loc("shop_no_plans"),t.game.overlays.hide(e.overlays.Shop.NAME)}t.game.overlays.hide(e.overlays.Loader.NAME),t.onShopGet()},this.countryId)},n.prototype.onShopGet=function(){var t=this,n=mAbo.getAbo();n.cancelled?this.btCancel.label=loc("bt_shop_revoke_termination"):this.btCancel.label=loc("bt_shop_cancel_abo"),this.tfInfo.text=loc(n.cancelled?"shop_manage_abo_current_cancelled":"shop_manage_abo_next_payment",{abo:this.getAboTypeText(n.type),payment:n.paymentMethod,date:locDate("track_info_last_saved",n.nextPayment)}),this.tfCurrent.text=loc("shop_manage_abo_current",{abo:this.getAboTypeText(n.type)}),this.abos.forEach(function(e){e.type==n.type?(e.current=!0,t.onAboChecked(e.btRadio),e.btRadio.isChecked=!0):e.current=!1}),this.abo2.bgRecommended.visible=this.abo2.tfRecommended.visible=!1,this.tfCooldown.visible=!1,n.type==e.ABO_SINGLE&&(this.abo1Dropdown.selectItem(n.sets[0]),n.daysForNextSingleChange!=0&&(this.abo1Dropdown.isEnabled=!1,this.tfCooldown.text=loc("shop_abo_cooldown",{days:n.daysForNextSingleChange}),this.tfCooldown.visible=!0),this.abo1.packshot.frameName=this.abo1Dropdown.currentItem.itemId),n.downgrade&&(n.downgrade.type==e.ABO_SINGLE&&(this.abo1Dropdown.selectItem(n.sets[0]),n.daysForNextSingleChange!=0&&(this.abo1Dropdown.isEnabled=!1,this.tfCooldown.text=loc("shop_abo_cooldown",{days:n.daysForNextSingleChange}),this.tfCooldown.visible=!0),this.abo1.packshot.frameName=this.abo1Dropdown.currentItem.itemId),this.tfInfo.text=loc("shop_downgrade",{oldAbo:this.getAboTypeText(n.type),aboDate:locDate("track_info_last_saved",n.downgrade.downgradeWhen),newAbo:this.getAboTypeText(n.downgrade.type),paymentMethod:n.paymentMethod,paymentLast4:n.paymentLast4,nextPayment:locDate("track_info_last_saved",n.nextPayment)})),this.onResize()},n.prototype.transitionIn=function(){t.prototype.transitionIn.call(this),track("Abo-Show"),this.countryId=mAbo.getAbo().countryId,this.countries.selectItem(this.countryId)},n.prototype.transitionOut=function(){if(!this.isActive)return;t.prototype.transitionOut.call(this)},n.prototype.onResize=function(){t.prototype.onResize.call(this);if(!this.btCancel)return;this.btCancel.visible?(this.btBuy.x=this.bg.width-44-this.btBuy.width-this.btCancel.width-e.PADDING*2>>1,this.btCancel.x=this.btBuy.right+e.PADDING*2):this.btBuy.x=this.bg.width-44-this.btBuy.width>>1,this.tfSelectPayment.y=this.aboContainer.bottom+e.PADDING*4,this.paymentContainer.y=this.tfSelectPayment.bottom+e.PADDING*2,this.btBuy.y=this.btCancel.y=this.aboContainer.bottom+e.PADDING*4,this.bg.height=this.content.bottom-this.bg.y+e.PADDING*4},n.NAME="abo",n}(e.overlays.Shop);t.Abo=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){t.prototype.init.call(this),this.dim.interactive=!0,this.dim.on("click tap",this.onClose,this),this.tfMessage=new gf.display.Text(this.game),this.tfMessage.style=e.TEXT_STYLE_DEFAULT.clone(),this.tfMessage.style.align=gf.CENTER,this.tfMessage.style.fontSize=13,this.tfMessage.style.wordWrap=!0,this.tfMessage.style.wordWrapWidth=this.bg.width-44,this.tfMessage.y=this.tfTitle.bottom+e.PADDING*4,this.addChild(this.tfMessage)},n.prototype.onClose=function(){this.game.overlays.hide(e.overlays.Message.NAME)},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.tfMessage.x=this.bg.x+(this.bg.width-this.tfMessage.width>>1),this.bg.height=this.tfMessage.bottom-this.bg.y+e.PADDING*4},n.prototype.transitionOutComplete=function(){t.prototype.transitionOutComplete.call(this),this.tfTitle&&(this.tfTitle.text=""),this.tfMessage&&(this.tfMessage.text="")},Object.defineProperty(n.prototype,"text",{set:function(e){this.tfMessage.text=e,this.onResize()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"title",{set:function(e){this.tfTitle.text=e,this.onResize()},enumerable:!0,configurable:!0}),n.NAME="message",n}(e.overlays.Overlay);t.Message=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){t.prototype.init.call(this),this.setCols=3,this.setsContainer=new gf.display.Container(this.game),this.addChild(this.setsContainer)},n.prototype.addSets=function(){var t=this;this.setsContainer.removeChildren();var n=0,r=0;this._sets.forEach(function(i){var s=i;s==e.SETS.WEB_ONE&&(s="webone_"+t.game.client.supportedLanguage);var o=new gf.display.Sprite(t.game,"sprites-sets",s);o.width=120,o.scaleY=o.scaleX,o.x=n*o.width+e.PADDING*2*n,o.y=r*o.height+e.PADDING*2*r,t.setsContainer.addChild(o),n++,n==t.setCols&&(n=0,r++)}),this.onResize()},Object.defineProperty(n.prototype,"sets",{get:function(){return this._sets},set:function(e){this._sets=e,this.addSets()},enumerable:!0,configurable:!0}),n}(e.overlays.Message);t.AboSets=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(n,r,i,s,o,u){u===void 0&&(u=e.HORIZONTAL);var a=this,f=u==e.HORIZONTAL;return a=t.call(this,n,f?r:10,f?10:r,f?i:10,f?10:i,s,o)||this,a}return __extends(n,t),n}(e.display.Slice9);t.Slice3=n})(t=e.display||(e.display={}))})(gf||(gf={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n,r,i){var s=t.call(this,n)||this;return s.isPrimary=i,s.bg=new gf.display.Slice3(n,10,80,"sprites",s.isPrimary?"bt_text_out":"bt_text_sek_out"),s.addChild(s.bg),s.tfLabel=new gf.display.Text(n,"",e.TEXT_STYLE_BUTTON_TEXT.clone()),s.tfLabel.anchor.y=.5,s.tfLabel.x=10,s.tfLabel.y=s.bg.height>>1,s.addChild(s.tfLabel),s.label=r,s.on(gf.CLICK,function(){return s.game.sounds.playFx("fx","click")},s),s.setState(gf.OUT),s}return __extends(n,t),n.prototype.setState=function(t){this.tfLabel.alpha=1;if(!this.isEnabled){this.bg.frameName="bt_text_disabled",this.tfLabel.style.fill=e.COLOR_DARK_GREY,this.tfLabel.alpha=.5;return}switch(this._currentState){case gf.DOWN:this.bg.frameName="bt_text_down",this.tfLabel.style.fill=e.COLOR_DARK_GREY;break;case gf.OUT:this.bg.frameName=this.isPrimary?"bt_text_out":"bt_text_sek_out",this.tfLabel.style.fill=e.COLOR_DARK_GREY;break;case gf.OVER:this.bg.frameName="bt_text_over",this.tfLabel.style.fill=e.COLOR_WHITE;break;case gf.UP:this.isOver?(this.bg.frameName="bt_text_over",this.tfLabel.style.fill=e.COLOR_WHITE):(this.bg.frameName=this.isPrimary?"bt_text_out":"bt_text_sek_out",this.tfLabel.style.fill=e.COLOR_DARK_GREY)}},n.prototype.setWidth=function(e){this.bg.width=e,this.tfLabel.hAlign(gf.CENTER,e),this.hitArea=this.getLocalBounds()},n.prototype.autoFit=function(t){t===void 0&&(t=e.PADDING),this.bg.width=this.tfLabel.width+t*2,this.tfLabel.hAlign(gf.CENTER,this.bg.width)},n.prototype.enable=function(){t.prototype.enable.call(this),this.setState(this._currentState)},n.prototype.disable=function(){t.prototype.disable.call(this),this.setState(this._currentState)},Object.defineProperty(n.prototype,"label",{get:function(){return this._label},set:function(e){if(e==this._label)return;this._label=e,this.tfLabel.text=this._label,this.bg.width=Math.round(this.tfLabel.width)+20,this.hitArea=this.getLocalBounds()},enumerable:!0,configurable:!0}),n}(gf.ui.Button);t.TextButton=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){t.prototype.init.call(this),this.bg.width=554,this.setCols=4,this.tfMessage.style.wordWrapWidth=this.bg.width-44,this.tfMessage.style.align=gf.LEFT,this.btContinue=new e.ui.TextButton(this.game,loc("bt_shop_payment_continue"),!0),this.btContinue.on(gf.CLICK,this.onClose,this),this.addChild(this.btContinue),this.tfChanged=new gf.display.Text(this.game),this.tfChanged.style=this.tfMessage.style.clone(),this.addChild(this.tfChanged),this.title=loc("shop_abo_changed")},n.prototype.onClose=function(){track("AboChanged-Close"),this.game.overlays.hide(e.overlays.AboChanged.NAME)},n.prototype.changed=function(){this.title=loc("shop_abo_set_changed"),this.tfMessage.text=loc("shop_abo_changed_single"),this.tfChanged.text=loc("shop_abo_changed_single_hint"),this.onResize()},n.prototype.revoked=function(e,t,n){track("AboChanged-Revoked");var r=locDate("track_info_last_saved",mAbo.getAbo().nextPayment);this.title=loc("shop_abo_revoke_title"),this.tfMessage.text=loc("shop_abo_revoke",{date:r,abo:n}),this.tfChanged.text=loc("shop_abo_revoke_costs",{date:r,price:e,currency:t}),this.onResize()},n.prototype.upgrade=function(e){track("AboChanged-Update");var t=locDate("track_info_last_saved",mAbo.getAbo().nextPayment);this.title=loc("shop_abo_changed"),this.tfMessage.text=loc("shop_abo_changed_upgrade",{date:t}),this.tfChanged.text=loc("shop_abo_changed_upgrade_costs",{date:t,price:e}),this.onResize()},n.prototype.downgrade=function(e,t){track("AboChanged-Downgrade");var n=locDate("track_info_last_saved",mAbo.getAbo().nextPayment);this.title=loc("shop_abo_changed"),this.tfMessage.text=loc("shop_abo_changed_downgrade",{date:n}),this.tfChanged.text=loc("shop_abo_changed_downgrade_costs",{date:n,price:e,currency:t}),this.onResize()},n.prototype.transitionOutComplete=function(){this.visible=!1,this.emit(gf.TRANSITION_OUT_COMPLETE)},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.tfMessage.x=this.tfChanged.x=this.setsContainer.x=this.bg.x+22,this._sets&&this._sets.length<3&&(this.setsContainer.x=this.bg.x+(this.bg.width-this.setsContainer.width>>1)),this.setsContainer.y=this.tfMessage.bottom+e.PADDING*4,this.tfChanged.y=this.setsContainer.bottom+e.PADDING*4,this.btContinue.x=this.bg.x+(this.bg.width-this.btContinue.width>>1),this.btContinue.y=this.tfChanged.bottom+e.PADDING*4,this.bg.height=this.btContinue.bottom-this.bg.y+e.PADDING*4},n.NAME="aboChanged",n}(e.overlays.AboSets);t.AboChanged=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){e.VERSION="3.27.0.0",e.DB_VERSION="3.20.0.0"})(cuboro||(cuboro={}));var cuboro;(function(e){e.SHOP_LINK_RU="https://cuboro.ru/products/cuboro_webkit/",e.DEFAULT_FONT="avenir",e.DEFAULT_FONT_HEAVY="avenir-heavy",e.COLOR_YELLOW=16698368,e.COLOR_GREEN=43520,e.COLOR_DARK_GREY=1907995,e.COLOR_GREY=11184810,e.COLOR_MID_GREY=13487565,e.COLOR_LIGHT_GREY=15790320,e.COLOR_RED=13369344,e.COLOR_INDICATOR=16711680,e.COLOR_WHITE=16777215,e.COLOR_FB_BLUE=3889560,e.COLOR_SET_MULTI=13880887,e.COLOR_TRACK_PUBLISHED=15066597,e.COLOR_TRACK_PUBLISHED_OWN=14344946,e.COLOR_TRACK_OWN=16310416,e.COLOR_TRACK_COMPETITION=e.COLOR_YELLOW,e.CAMERA_UPDATE="cameraUpdate",e.CAMERA_UPDATED="cameraUpdated",e.CUBE_UPDATE="cubeUpdate",e.CUBE_SELECTED="cubeSelected",e.CUBE_DESELECTED="cubeDeselected",e.PLAYGROUND_READY="playgroundReady",e.DEG_RAD_90=1.5707963268,e.EMPTY="0",e.PADDING=5,e.CUBES_RANDOM=["cube_29","cube_92","cube_d59","cube_d69"],e.LEFT_MENU_CHANGE="leftMenuChange",e.RIGHT_MENU_CHANGE="rightMenuChange",e.MARBLE_SKIP_THRESHOLD=.3,e.MARBLE_DEATH_SLOW_FACTOR=.99,e.MARBLE_DROP_HEIGHT_DEFAULT="LOW",e.MARBLE_DROP_HEIGHTS={LOW:-.75,MEDIUM:-.5,HIGH:0},e.HISTORY={CURRENT:"current",PREDECESSOR:"predecessor",SUCCESSOR:"successor"},e.MAX_X=12,e.MAX_Y=9,e.MAX_Z=12,e.SETS={BASIC:"basic",BUILD:"build",DUO:"duo",PROFI:"profi",METRO:"metro",PLUS:"plus",MULTI:"multi",STANDARD:"standard",WEB_ONE:"webOne"},e.DEFAULT_SETS=[e.SETS.WEB_ONE],e.LEGACY_SETS=[e.SETS.BASIC,e.SETS.STANDARD],e.SET_ORDER=[e.SETS.WEB_ONE,e.SETS.STANDARD,e.SETS.BASIC,e.SETS.BUILD,e.SETS.DUO,e.SETS.METRO,e.SETS.MULTI,e.SETS.PLUS,e.SETS.PROFI],e.START_CUBES=["cube_11","cube_12","cube_21","cube_22","cube_31","cube_41","cube_42","cube_51","cube_61","cube_71","cube_92"],e.SWAP="swap",e.TIMESTEP=1/120,e.TRACK_NAME_MAX_LENGTH=25,e.SCREENSHOT_CAMERA_POSITION=new THREE.Vector3(25,21,26),e.SCREENSHOT_CAMERA_LOOK_AT=new THREE.Vector3(-1.2,5,-1.5),e.MAX_SAME_Y_HITS=18,e.TEXT_STYLE_BUTTON_CHECKBOX=new PIXI.TextStyle({fontFamily:e.DEFAULT_FONT,fontSize:11,lineHeight:12,fill:e.COLOR_DARK_GREY}),e.TEXT_STYLE_BUTTON_ICON=new PIXI.TextStyle({fontFamily:e.DEFAULT_FONT,fontSize:11,align:"center",lineHeight:11,wordWrap:!0,fill:e.COLOR_DARK_GREY}),e.TEXT_STYLE_BUTTON_CUBE=new PIXI.TextStyle({fontFamily:e.DEFAULT_FONT,fontSize:13,fill:e.COLOR_DARK_GREY}),e.TEXT_STYLE_BUTTON_TEXT=new PIXI.TextStyle({fontFamily:e.DEFAULT_FONT,fontSize:13,fill:e.COLOR_DARK_GREY}),e.TEXT_STYLE_BUTTON_FOOTER=new PIXI.TextStyle({fontFamily:e.DEFAULT_FONT,fontSize:10,fill:e.COLOR_DARK_GREY}),e.TEXT_STYLE_BUTTON_TAB=new PIXI.TextStyle({fontFamily:e.DEFAULT_FONT,fontSize:20,fill:e.COLOR_DARK_GREY}),e.TEXT_STYLE_BUTTON_TAB_SELECTED=new PIXI.TextStyle({fontFamily:e.DEFAULT_FONT_HEAVY,fontSize:20,fill:e.COLOR_DARK_GREY}),e.TEXT_STYLE_INPUT_ERROR=new PIXI.TextStyle({fontFamily:e.DEFAULT_FONT,fontSize:10,fill:e.COLOR_RED,wordWrap:!0}),e.TEXT_STYLE_INPUT_SUCCESS=new PIXI.TextStyle({fontFamily:e.DEFAULT_FONT,fontSize:10,fill:e.COLOR_GREEN,wordWrap:!0}),e.TEXT_STYLE_LAYER=new PIXI.TextStyle({align:"center",fontFamily:e.DEFAULT_FONT,fontSize:96,fill:e.COLOR_DARK_GREY}),e.TEXT_STYLE_LOADER=new PIXI.TextStyle({fontFamily:e.DEFAULT_FONT,fontSize:18,fill:e.COLOR_DARK_GREY}),e.TEXT_STYLE_SMALL=new PIXI.TextStyle({fontFamily:e.DEFAULT_FONT,fontSize:13,fill:e.COLOR_DARK_GREY}),e.TEXT_STYLE_SMALL_HEAVY=new PIXI.TextStyle({fontFamily:e.DEFAULT_FONT_HEAVY,fontSize:13,fill:e.COLOR_DARK_GREY}),e.TEXT_STYLE_TITLE=new PIXI.TextStyle({fontFamily:e.DEFAULT_FONT,fontSize:42,fill:e.COLOR_DARK_GREY}),e.TEXT_STYLE_TITLE_RIGHT_MENU_TAB=new PIXI.TextStyle({fontFamily:e.DEFAULT_FONT,fontSize:42,fill:e.COLOR_DARK_GREY}),e.TEXT_STYLE_TITLE_HINT=new PIXI.TextStyle({fontFamily:e.DEFAULT_FONT,fontSize:20,lineHeight:20,fill:e.COLOR_DARK_GREY}),e.TEXT_STYLE_INDICATOR=new PIXI.TextStyle({fontFamily:e.DEFAULT_FONT_HEAVY,fontSize:11,fill:e.COLOR_WHITE}),e.TEXT_STYLE_TITLE_TAB=new PIXI.TextStyle({fontFamily:e.DEFAULT_FONT_HEAVY,fontSize:20,fill:e.COLOR_DARK_GREY}),e.TEXT_STYLE_DEFAULT=new PIXI.TextStyle({fontFamily:e.DEFAULT_FONT,fontSize:15,fill:e.COLOR_DARK_GREY}),e.TEXT_STYLE_DEFAULT_HEAVY=new PIXI.TextStyle({fontFamily:e.DEFAULT_FONT_HEAVY,fontSize:15,fill:e.COLOR_DARK_GREY}),e.TEXT_STYLE_PACKSHOT=new PIXI.TextStyle({fontFamily:e.DEFAULT_FONT_HEAVY,fontSize:15,fill:e.COLOR_DARK_GREY,lineHeight:14}),e.TEXT_STYLE_VERSION=new PIXI.TextStyle({fontFamily:e.DEFAULT_FONT,fontSize:10,fill:e.COLOR_DARK_GREY}),e.COUNTRIES=["be","bg","ch","cz","dk","de","ee","ie","es","fr","hr","it","cy","jp","lv","lt","lu","hu","mt","nl","at","pl","pt","ro","si","sk","fi","se","uk","no","is","li"],e.CURRENCIES={CHF:["ch"],GBP:["uk"],JPY:["jp"],EUR:["be","bg","cz","dk","de","ee","ie","es","fr","hr","it","cy","lv","lt","lu","hu","mt","nl","at","pl","pt","ro","si","sk","fi","se","uk","no","is","li"]},e.RATING_VALUES=[1,2,3,4,5],e.RATING_THRESHOLD=10,e.ABO_NONE="none",e.ABO_SINGLE="single",e.ABO_BASIC="basic",e.ABO_ALL="all",e.ERROR_ALREADY_PARTICIPATED="ERROR_ALREADY_PARTICIPATED",e.ERROR_CANT_RATE_OWN_TRACKS="ERROR_CANT_RATE_OWN_TRACKS",e.ERROR_IS_NOT_TRACK_OWNER="ERROR_IS_NOT_TRACK_OWNER",e.ERROR_RANKING_IS_NOT_PUBLISHED="ERROR_RANKING_IS_NOT_PUPLISHED",e.ERROR_TRACK_IS_PUBLISHED="ERROR_TRACK_IS_PUBLISHED",e.ERROR_TRACK_NAME_NOT_OVERWRITTEN="ERROR_TRACK_NAME_NOT_OVERWRITTEN",e.USER_HAVE_ABO="USER_HAS_THIS_ABO"})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(){function t(){this.type=e.ABO_NONE,this.sets=[]}return t}();t.Downgradeabo=n})(t=e.vo||(e.vo={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(){function t(){this.type=e.ABO_NONE,this.paymentMethod="",this.paymentLast4="",this.sets=[],this.daysForNextSingleChange=0,this.cancelled=!1,this.downgrade=null}return t}();t.Abo=n})(t=e.vo||(e.vo={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){var t=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.getAbo=function(e){var t={};this.callService("Stripe.getAbo",t,function(t){return e(t.data,t.status)})},t.prototype.cancelAbo=function(e){var t={};this.callService("Stripe.cancelAbo",t,function(t){return e(t.data,t.status)})},t.prototype.reactiveAbo=function(e){var t={};this.callService("Stripe.reactiveAbo",t,function(t){return e(t.status)})},t}(e.Abstract);e.Abo=t})(t=e.stubs||(e.stubs={}))})(cuboro||(cuboro={}));var sAbo=new cuboro.stubs.Abo,cuboro;(function(e){var t;(function(t){var n=function(t){function n(){var n=t.call(this)||this;return n.abo=new e.vo.Abo,mUser.on("loggedIn",function(){return n.updateAbo()}),mUser.on("logout",function(){n._isInitialized=!1,n.abo=new e.vo.Abo,n.dispatch(e.clientmodels.Abo.ABO)}),n}return __extends(n,t),n.prototype.updateAbo=function(t){var n=this;sAbo.getAbo(function(r,i){n._isInitialized=!0,i==kr3m.SUCCESS&&(n.abo=r),t&&t(),n.dispatch(e.clientmodels.Abo.ABO)})},n.prototype.missingSets=function(t){var n=this,r=[];return t.forEach(function(t){t!=e.SETS.STANDARD&&n.abo.sets.indexOf(t)==-1&&r.push(t)}),r},n.prototype.getAbo=function(){return this.abo},n.prototype.isInitialized=function(){return this._isInitialized},n.prototype.hasAbo=function(){return this.abo.type!=e.ABO_NONE},n.ABO="abo",n}(kr3m.model.EventDispatcher);t.Abo=n})(t=e.clientmodels||(e.clientmodels={}))})(cuboro||(cuboro={}));var mAbo=new cuboro.clientmodels.Abo,cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){t.prototype.init.call(this),this.bg.width=424,this.tfMessage.style.wordWrapWidth=this.bg.width-44,this.tfMessage.style.align=gf.LEFT,this.btAbort=new e.ui.TextButton(this.game,loc("bt_abort_termination"),!1),this.btAbort.on(gf.CLICK,this.onClose,this),this.addChild(this.btAbort),this.btConfirm=new e.ui.TextButton(this.game,loc("bt_shop_cancel_abo_confirm"),!0),this.btConfirm.on(gf.CLICK,this.onConfirm,this),this.addChild(this.btConfirm),this.tfChanged=new gf.display.Text(this.game,loc("shop_abo_terminate_until")),this.tfChanged.style=this.tfMessage.style.clone(),this.addChild(this.tfChanged),this.title=loc("shop_abo_terminate_title"),this.text=loc("shop_abo_terminate")},n.prototype.onClose=function(){track("AboTerminate-Close"),this.game.overlays.hide(e.overlays.AboTerminate.NAME)},n.prototype.onConfirm=function(){var t=this;track("AboTerminate-Confirm"),this.game.overlays.show(e.overlays.Loader.NAME),sAbo.cancelAbo(function(n){mAbo.updateAbo(function(){t.game.overlays.hide(e.overlays.Loader.NAME),t.game.overlays.hide(e.overlays.AboTerminate.NAME)})})},n.prototype.transitionIn=function(){t.prototype.transitionIn.call(this),this.tfChanged.text=loc("shop_abo_terminate_until",{date:locDate("track_info_last_saved",mAbo.getAbo().nextPayment)}),this.sets=[e.SETS.WEB_ONE]},n.prototype.transitionOutComplete=function(){this.visible=!1,this.emit(gf.TRANSITION_OUT_COMPLETE)},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.tfMessage.x=this.tfChanged.x=this.setsContainer.x=this.bg.x+22,this._sets&&this._sets.length<3&&(this.setsContainer.x=this.bg.x+(this.bg.width-this.setsContainer.width>>1)),this.setsContainer.y=this.tfMessage.bottom+e.PADDING*4,this.tfChanged.y=this.setsContainer.bottom+e.PADDING*4,this.btConfirm.x=this.bg.x+(this.bg.width-this.btAbort.width-this.btConfirm.width-e.PADDING*2>>1),this.btAbort.x=this.btConfirm.right+e.PADDING*2,this.btConfirm.y=this.btAbort.y=this.tfChanged.bottom+e.PADDING*4,this.bg.height=this.btConfirm.bottom-this.bg.y+e.PADDING*4},n.NAME="aboTerminate",n}(e.overlays.AboSets);t.AboTerminate=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var gf;(function(e){var t;(function(t){var n=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i._domParent=n,i._tag=typeof r=="string"&&r.length>0?r:"div",i._pointerEventsEnabled=!0,i.createDom(),i._dom.style.pointerEvents="all",i.paddingLeft=0,i.paddingRight=0,i.paddingTop=0,i.paddingBottom=0,typeof i._domParent!="string"&&i._domParent.addDomChild(i),i}return __extends(t,e),t.prototype.addClass=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];this._dom.classList.add.apply(this._dom.classList,e)},t.prototype.hasClass=function(e){return this._dom.classList.contains(e)},t.prototype.removeClass=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];this._dom.classList.remove.apply(this._dom.classList,e)},t.prototype.createDom=function(){this._dom=document.createElement(this._tag)},t.prototype.onChange=function(){typeof this._domParent!="string"&&this._domParent.emit("change")},t.prototype.enablePointerEvents=function(){this._dom.style.pointerEvents="all"},t.prototype.disablePointerEvents=function(){this._dom.style.pointerEvents="none"},Object.defineProperty(t.prototype,"domParent",{get:function(){return this._domParent},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dom",{get:function(){return this._dom},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"tag",{get:function(){return this._tag},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"paddingLeft",{get:function(){return this._paddingLeft},set:function(e){this._paddingLeft=e,this._dom.style.paddingLeft=String(e)+"px",this.setWidth(this.width)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"tabIndex",{get:function(){return this._dom.tabIndex},set:function(e){this._dom.tabIndex=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"padding",{set:function(e){this.paddingLeft=e,this.paddingRight=e,this.paddingTop=e,this.paddingBottom=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"paddingRight",{get:function(){return this._paddingRight},set:function(e){this._paddingRight=e,this._dom.style.paddingRight=String(e)+"px",this.setWidth(this.width)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"paddingTop",{get:function(){return this._paddingTop},set:function(e){this._paddingTop=e,this._dom.style.paddingTop=String(e)+"px",this.setHeight(this.height)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"paddingBottom",{get:function(){return this._paddingBottom},set:function(e){this._paddingBottom=e,this._dom.style.paddingBottom=String(e)+"px",this.setHeight(this.height)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"x",{get:function(){return this.position.x},set:function(e){this.setX(e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this.position.y},set:function(e){this.setY(e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return this.getLocalBounds().width},set:function(e){this.setWidth(e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this.getLocalBounds().height},set:function(e){this.setHeight(e)},enumerable:!0,configurable:!0}),t.prototype.validate=function(){return!0},t.prototype.updatePosition=function(){this.setX(this.x),this.setY(this.y)},t.prototype.setX=function(e){this.position.x=e,this.parent&&(this._dom.style.left=String(this.parent.toGlobal(this.position).x/this.game.scaleX)+"px")},t.prototype.setY=function(e){this.position.y=e,this.parent&&(this._dom.style.top=String(this.parent.toGlobal(this.position).y/this.game.scaleY)+"px")},t.prototype.setWidth=function(e){this._dom.style.width=e>0?String(e)+"px":"auto"},t.prototype.setHeight=function(e){this._dom.style.height=e>0?String(e)+"px":"auto"},t.prototype.reset=function(){},t}(e.display.Container);t.DomDisplayObject=n})(t=e.display||(e.display={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(e){function t(t,n,r){var i=e.call(this,t,typeof r=="string"?r:"kr3m",n)||this;return i._tag=typeof n=="string"&&n.length>0?n:"div",i._transformScaleX=1,i._transformScaleY=1,i._domChildren=[],i.createDom(),i}return __extends(t,e),t.prototype.createDom=function(){e.prototype.createDom.call(this),this._dom.setAttribute("style","1")},t.prototype.setTransformScale=function(){var e=this._dom.style.opacity?this._dom.style.opacity:"1";typeof e!="string"&&(e="1");var t="scale("+this._transformScaleX+","+this._transformScaleY+")",n="0 0 0";this._dom.style.opacity=e,this._dom.style["-webkit-transform"]=t,this._dom.style["-ms-transform"]=t,this._dom.style["-moz-transform"]=t,this._dom.style.transform=t,this._dom.style["-webkit-transform-origin"]=n,this._dom.style["-ms-transform-origin"]=n,this._dom.style["-moz-transform-origin"]=n,this._dom.style.transformOrigin=t,this._dom.style.position="absolute"},t.prototype.addDomChild=function(e){this._dom.appendChild(e.dom),this._domChildren.push(e)},t.prototype.onResize=function(){var t=this;e.prototype.onResize.call(this),this.transformScaleX=parseFloat(this.game.canvas.style.width)/this.game.width,this.transformScaleY=parseFloat(this.game.canvas.style.height)/this.game.height,this.setTransformScale(),setTimeout(function(){t.updateElementPositions()},100),setTimeout(function(){t.updateElementPositions()},10)},Object.defineProperty(t.prototype,"domChildren",{get:function(){return this._domChildren},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"transformScaleX",{get:function(){return this._transformScaleX},set:function(e){this._transformScaleX=e,this.setTransformScale()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"transformScaleY",{get:function(){return this._transformScaleY},set:function(e){this._transformScaleY=e,this.setTransformScale()},enumerable:!0,configurable:!0}),t.prototype.showDom=function(){this._domChildren.forEach(function(e){e.reset()}),this.appendToDom(),this.updateElementPositions()},t.prototype.hideDom=function(){this.removeFromDom()},t.prototype.updateElementPositions=function(){this._domChildren.forEach(function(e){e.updatePosition()})},t.prototype.validate=function(){for(var e=0,t=this._domChildren.length;e<t;e++)if(!this._domChildren[e].validate())return!1;return!0},t.prototype.appendToDom=function(){document.getElementById(String(this._domParent)).contains(this._dom)||document.getElementById(String(this._domParent)).appendChild(this._dom)},t.prototype.removeFromDom=function(){document.getElementById(String(this._domParent)).contains(this._dom)&&document.getElementById(String(this._domParent)).removeChild(this._dom)},t}(e.display.DomDisplayObject);t.DomContainer=n})(t=e.input||(e.input={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(e,n,r){var i=t.call(this,e,n,"input")||this;return i._regExp=/(\w|\W)+/,i.required=!0,i._inputDom.name=r,i._italic=!1,i._bold=!1,i.validateTrimmedValue=!0,i.addChangeListeners(),i}return __extends(n,t),n.prototype.addChangeListeners=function(){var e=this;this._inputDom.addEventListener("keyup",function(t){t.keyCode!=9&&e.onChange()}),this._inputDom.oninput=function(){return e.onChange()},$(this._inputDom).blur(function(){return e.onInputBlur()}),$(this._inputDom).focus(function(){return e.onInputFocus()})},n.prototype.onInputBlur=function(){this.emit(e.BLUR),PIXI.utils.isMobile.apple.device&&($(window).scrollTop(0),window.scrollTo(0,0)),this.game.isCordova&&PIXI.utils.isMobile.android.device&&(this.inputDom.scrollIntoView(),$("#kr3m").css("top","0px"))},n.prototype.onInputFocus=function(){this.emit(e.FOCUS);if(this.game.isCordova&&PIXI.utils.isMobile.android.device){var t=this.parent.toGlobal(this.position).y/this.game.renderer.resolution;$("#kr3m").css("top",-t+"px")}},n.prototype.setFocus=function(){var e=this;setTimeout(function(){return $(e._inputDom).focus()},1)},Object.defineProperty(n.prototype,"inputDom",{get:function(){return this._inputDom},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"name",{get:function(){return this._inputDom.name},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"regExp",{get:function(){return this._regExp},set:function(e){this._regExp=e,this.onChange()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"readOnly",{get:function(){return this._inputDom.readOnly},set:function(e){this._inputDom.readOnly=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"value",{get:function(){return this._inputDom.value},set:function(e){this._inputDom.value!=e&&this.onChange(),this._inputDom.value=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"autoComplete",{get:function(){return this._inputDom.autocomplete=="on"},set:function(e){this.type=="password"&&(e=!1),this._inputDom.autocomplete=e?"on":"off"},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"placeholder",{get:function(){return this._inputDom.placeholder},set:function(e){this._inputDom.placeholder=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"type",{get:function(){return this._inputDom.type},set:function(e){this._inputDom.type=e,e=="password"&&(this.autoComplete=!1)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"fontFamily",{get:function(){return this._inputDom.style.fontFamily},set:function(e){this._inputDom.style.fontFamily=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"fontSize",{get:function(){return this._fontSize},set:function(e){this._inputDom.style.fontSize=String(e)+"px",this._fontSize=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"color",{get:function(){return this._color},set:function(e){this._inputDom.style.color="#"+e.toString(16),this._color=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"italic",{get:function(){return this._italic},set:function(e){this._inputDom.style.fontStyle=e?"italic":"regular",this._italic=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"bold",{get:function(){return this._bold},set:function(e){this._inputDom.style.fontWeight=e?"bold":"normal",this._bold=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"maxLength",{get:function(){return this._inputDom.maxLength?this._inputDom.maxLength:0},set:function(e){this._inputDom.maxLength=e},enumerable:!0,configurable:!0}),n.prototype.createDom=function(){t.prototype.createDom.call(this),this._inputDom=this._dom,this._inputDom.style.position="absolute",this._inputDom.style.border="none",this._inputDom.style.fontFamily="Arial, Helvetica, sans-serif",this._inputDom.type="text"},n.prototype.setHeight=function(e){t.prototype.setHeight.call(this,e),this._inputDom.style.lineHeight=String(e)+"px"},n.prototype.validate=function(){if(this.readOnly)return!0;var e=this.validateTrimmedValue?this.value.trim():this.value;return!this.required&&this.value.length==0||this.regExp.test(e)},n.prototype.copyToClipboard=function(){if(PIXI.utils.isMobile.apple.device){var e=document.createRange();e.selectNodeContents($(this._inputDom).get(0));var t=window.getSelection();t.removeAllRanges(),t.addRange(e),$(this._inputDom).get(0).setSelectionRange(0,999999)}else $(this._inputDom).get(0).select();document.execCommand("copy")},n}(e.display.DomDisplayObject);t.TextInput=n})(t=e.input||(e.input={}))})(gf||(gf={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n,r,i){var s=t.call(this,n,r,i)||this;return s.fontFamily=e.DEFAULT_FONT,s.fontSize=13,s.tfTitle=new gf.display.Text(s.game),s.tfTitle.style=e.TEXT_STYLE_SMALL.clone(),s.tfTitle.x=e.PADDING,s.tfTitle.text="",s.addChild(s.tfTitle),s.border=new gf.display.Sprite(s.game,PIXI.Texture.WHITE),s.border.width=227,s.border.height=27,s.border.tint=e.COLOR_GREY,s.border.y=s.tfTitle.bottom,s.addChild(s.border),s.bg=new gf.display.Sprite(s.game,PIXI.Texture.WHITE),s.bg.width=225,s.bg.height=25,s.bg.x=1,s.bg.y=s.border.y+1,s.addChild(s.bg),s.tfError=new gf.display.Text(s.game),s.tfError.style=e.TEXT_STYLE_INPUT_ERROR.clone(),s.tfError.style.wordWrapWidth=s.border.width-e.PADDING*2,s.tfError.text="",s.tfError.x=e.PADDING,s.tfError.y=s.border.bottom+2,s.addChild(s.tfError),s.paddingLeft=e.PADDING*s.game.scaleX,s.paddingRight=e.PADDING*s.game.scaleX,s._dom.style.marginTop="18px",s.width=s.bg.width,s.height=s.bg.height,s}return __extends(n,t),n.prototype.onChange=function(){t.prototype.onChange.call(this),this.tfError.visible&&this.hideError()},n.prototype.onInputBlur=function(){this.validate(),t.prototype.onInputBlur.call(this)},n.prototype.hideError=function(){this.tfError.text="",this.tfError.visible=!1,this.border.tint=e.COLOR_GREY},n.prototype.showError=function(t){this.tfError.text=t,this.tfError.visible=!0,this.border.tint=e.COLOR_RED},n.prototype.validate=function(){return this._inputDom.value=this.value.trim(),this.validation?this.validation(this.value):!0},n}(gf.input.TextInput);t.TextInput=n})(t=e.input||(e.input={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n,r){var i=t.call(this,n)||this;return i.interactiveChildren=!1,i.bg=new gf.display.Sprite(n,"sprites","checkbox_out"),i.addChild(i.bg),i.check=new gf.display.Sprite(n,"sprites","icon_check"),i.check.anchor.set(.5),i.check.tint=e.COLOR_DARK_GREY,i.check.x=i.bg.width>>1,i.check.y=i.bg.height>>1,i.addChild(i.check),r&&(i.label=r),i.hitArea=i.getLocalBounds(),i.setState(gf.OUT),i.on(gf.CLICK,function(){if(!i._isEnabled)return;i.game.sounds.playFx("fx","click"),i.isChecked=!i.isChecked},i),i}return __extends(n,t),n.prototype.addLabel=function(){this.tfLabel=new gf.display.Text(this.game,"",e.TEXT_STYLE_BUTTON_CHECKBOX.clone()),this.tfLabel.x=this.bg.right+5,this.tfLabel.y=2,this.addChild(this.tfLabel)},n.prototype.setState=function(e){this.check.visible=this._isChecked;switch(this._currentState){case gf.DOWN:this.bg.frameName="checkbox_down";break;case gf.OUT:this.bg.frameName="checkbox_out";break;case gf.OVER:this.bg.frameName="checkbox_over";break;case gf.UP:this.isOver?this.bg.frameName="checkbox_over":this.bg.frameName="checkbox_out"}},n.prototype.enable=function(){t.prototype.enable.call(this),this.alpha=1,this.setState(this._currentState)},n.prototype.disable=function(){t.prototype.disable.call(this),this.bg.frameName="checkbox_over",this.alpha=.5},n.prototype.forceState=function(e){this._currentState=e,this.setState(e)},Object.defineProperty(n.prototype,"label",{get:function(){return this._label},set:function(e){if(e==this._label)return;this.tfLabel||this.addLabel(),this._label=e,this.tfLabel.text=this._label},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isChecked",{get:function(){return this._isChecked},set:function(e){this._isChecked=e,this.setState(this._currentState)},enumerable:!0,configurable:!0}),n}(gf.ui.Button);t.Checkbox=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var gf;(function(e){var t;(function(t){var n=function(e){function t(t,n,r){var i=e.call(this,t,"form",r)||this;return i._additionalData={},typeof n=="string"&&(i._formDom.name=i._formName,i._formName=n),i.disableSubmitButtonByInvalidInputs=!0,i.on("change",function(){return i.change()}),i}return __extends(t,e),t.prototype.change=function(){this.disableSubmitButtonByInvalidInputs&&this._submitButton&&(this.validate()?this._submitButton.enable():this._submitButton.disable())},t.prototype.createDom=function(){var t=this;e.prototype.createDom.call(this),this._formDom=this._dom,this._formDom.autocomplete="on",this._formDom.action="form/submit",this._formDom.method="post",this._formDom.name=this._formName,typeof this._formName=="string"&&(this._formDom.name=this._formName),this._formDom.onsubmit=function(e){var n=document.activeElement?document.activeElement:document.body;return n.blur(),typeof t.onSubmit=="function"&&t.onSubmit(t.data),e.preventDefault(),!0};var n=document.createElement("button");n.type="submit",n.name="Submit",n.style.opacity="0",this._formDom.appendChild(n)},t.prototype.addData=function(e,t){this._additionalData[e]=t},t.prototype.addDomChild=function(t){e.prototype.addDomChild.call(this,t),this.change()},t.prototype.clear=function(){this._domChildren.forEach(function(e){e.value&&(e.value="")})},t.prototype.submit=function(){var e;typeof document.createEvent=="function"?(e=document.createEvent("Event"),e.initEvent("submit",!0,!0)):e=new Event("submit"),this._formDom.dispatchEvent(e)},Object.defineProperty(t.prototype,"data",{get:function(){var e=$(this._formDom).serializeArray(),t={};e.forEach(function(e){t[e.name]=e.value});for(var n in this._additionalData)t[n]=this._additionalData[n];return t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"submitButton",{get:function(){return this._submitButton},set:function(e){this._submitButton=e,this.change()},enumerable:!0,configurable:!0}),t}(e.input.DomContainer);t.Form=n})(t=e.input||(e.input={}))})(gf||(gf={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){var n=this;t.prototype.init.call(this),this.tfTitle.text=loc("account_title"),this.tfInfo=new gf.display.Text(this.game,loc("account"),e.TEXT_STYLE_SMALL.clone()),this.tfInfo.style.wordWrap=!0,this.tfInfo.style.wordWrapWidth=this.bg.width-44,this.tfInfo.y=this.tfTitle.bottom+e.PADDING*4,this.addChild(this.tfInfo),this.form=new gf.input.Form(this.game,"login"),this.form.onSubmit=function(){return n.onSave()},this.addChild(this.form),this.username=new e.input.TextInput(this.game,this.form,"username"),this.username.maxLength=20,this.username.placeholder=loc("placeholder_username"),this.username.tabIndex=1,this.username.tfTitle.text=loc("placeholder_username"),this.username.validation=function(e){return n.usernameValidation(e)},this.username.y=this.tfInfo.bottom+e.PADDING*2,this.form.addChild(this.username),this.email=new e.input.TextInput(this.game,this.form,"email"),this.email.maxLength=100,this.email.placeholder=loc("placeholder_email"),this.email.tabIndex=2,this.email.tfTitle.text=loc("placeholder_email"),this.email.type="email",this.email.validation=function(e){return n.emailValidation(e)},this.email.y=this.username.bottom+e.PADDING*2,this.form.addChild(this.email),this.btSave=new e.ui.TextButton(this.game,loc("bt_save"),!0),this.btSave.on(gf.CLICK,this.form.submit,this.form),this.btSave.y=this.email.bottom+e.PADDING*2,this.btSave.setWidth(this.username.width),this.addChild(this.btSave),this.tfError=new gf.display.Text(this.game),this.tfError.style=e.TEXT_STYLE_INPUT_ERROR.clone(),this.tfError.style.wordWrapWidth=this.bg.width-44,this.tfError.visible=!1,this.tfError.y=this.btSave.bottom+e.PADDING*2,this.addChild(this.tfError),this.bg.height=this.btSave.bottom-this.bg.y+e.PADDING*4},n.prototype.emailValidation=function(e){this.email.hideError();var t=!1;return kr3m.util.Validator.email(e)?t=!0:this.email.showError(loc("error_input_default")),t},n.prototype.usernameValidation=function(e){this.username.hideError();var t=!1;return e.length>0?t=!0:this.username.showError(loc("error_input_default")),t},n.prototype.onSave=function(){var t=this;track("Account-Save"),this.form.validate()&&(this.accountData.email=this.email.value,this.accountData.user.name=this.username.value,this.accountData.newsletter=!1,this.game.overlays.show(e.overlays.Loader.NAME),casClient.saveUserAccount(this.accountData,function(n){t.game.overlays.hide(e.overlays.Loader.NAME);if(n==kr3m.SUCCESS){t.game.overlays.hide(e.overlays.Account.NAME),t.tfError.visible=!1;var r=t.game.overlays.show(e.overlays.Message.NAME);r.text=loc("account_changed")}else t.tfError.text=loc("error_account_changed"),t.tfError.visible=!0;t.onResize()}))},n.prototype.onClose=function(){track("Account-Close"),this.game.overlays.hide(e.overlays.Account.NAME)},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.email.x=this.username.x=this.tfInfo.x=this.btSave.x=this.bg.x+22,this.tfError.x=this.btSave.x+(this.btSave.width-this.tfError.width>>1),this.tfError.visible?this.bg.height=this.tfError.bottom-this.bg.y+e.PADDING*4:this.bg.height=this.btSave.bottom-this.bg.y+e.PADDING*4},n.prototype.transitionIn=function(){var n=this;t.prototype.transitionIn.call(this),this.form.showDom(),this.game.overlays.show(e.overlays.Loader.NAME),casClient.getUserAccount(function(t){n.game.overlays.hide(e.overlays.Loader.NAME),n.accountData=t,n.username.value=n.accountData.user.name,n.email.value=n.accountData.email,n.form.validate()})},n.prototype.transitionOut=function(){t.prototype.transitionOut.call(this),this.form.hideDom()},n.NAME="account",n}(e.overlays.Overlay);t.Account=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n,r){var i=t.call(this,n)||this;i.setName=r,i.cb=new e.ui.Checkbox(i.game,loc("packshot_"+i.setName)),i.cb.on(gf.CLICK,i.onCheckbox,i),i.addChild(i.cb);var s=i.setName;s==e.SETS.WEB_ONE&&(s="webone_"+i.game.client.supportedLanguage),i.packshot=new gf.display.Sprite(i.game,"sprites-sets",s),i.packshot.y=i.cb.bottom,i.packshot.interactive=!0,i.packshot.on("click tap",i.onPackshot,i),i.addChild(i.packshot),i.buy=new gf.display.Container(i.game),i.addChild(i.buy);var o=new gf.display.Sprite(i.game,PIXI.Texture.WHITE);o.alpha=.75,o.width=i.packshot.width,i.buy.addChild(o);var u=new gf.display.Text(i.game,loc(i.game.client.config.isShopAvailable?"shop_buy_set":"soon"),e.TEXT_STYLE_SMALL.clone());return i.buy.addChild(u),o.height=u.height+e.PADDING,u.x=o.width-u.width>>1,u.y=o.height-u.height>>1,i.buy.y=i.height-i.buy.height>>1,i.on(gf.CLICK,function(){return i.game.sounds.playFx("fx","click")},i),i}return __extends(n,t),n.prototype.onCheckbox=function(){if(!this.cb.isEnabled)return;this.emit(gf.CHANGE,this)},n.prototype.onPackshot=function(){this.cb.isEnabled?this.cb.isEnabled&&(this.cb.isChecked=!this.cb.isChecked,this.emit(gf.CHANGE,this)):this.game.client.config.isRussian?mUser.isLoggedIn()?window.open(e.SHOP_LINK_RU,"_blank"):this.game.overlays.show(e.overlays.Login.NAME):this.game.overlays.show(e.overlays.Shop.NAME)},n.prototype.enable=function(){this.packshot.alpha=1,this.buy.visible=!1,this.cb.isEnabled=!0},n.prototype.disable=function(){this.packshot.alpha=.5,this.buy.visible=!0,this.cb.isEnabled=!1},Object.defineProperty(n.prototype,"isSelected",{get:function(){return this.cb.isChecked},set:function(e){this.cb.isChecked=e},enumerable:!0,configurable:!0}),n}(gf.ui.Button);t.SelectSetButton=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){var n=this;t.prototype.init.call(this),this.tfTitle.text=loc("add_sets"),this.bg.width=500,this.bg.height=420,this.contentMask=new gf.display.Sprite(this.game,PIXI.Texture.WHITE),this.contentMask.y=this.tfTitle.bottom+e.PADDING*4,this.addChild(this.contentMask),this.content=new gf.display.Container(this.game),this.content.mask=this.contentMask,this.addChild(this.content),this.bounds=new gf.display.Sprite(this.game,PIXI.Texture.WHITE),this.bounds.alpha=.5,this.bounds.tint=16711935,this.content.addChild(this.bounds),this.scrollbar=new e.ui.Scrollbar(this.game),this.scrollbar.on(gf.UPDATE,this.onScrollbar,this),this.scrollbar.visible=!1,this.addChild(this.scrollbar),this.btAbort=new e.ui.TextButton(this.game,loc("bt_abort"),!1),this.btAbort.on(gf.CLICK,this.onClose,this),this.btAbort.y=this.bg.bottom-this.btAbort.height-e.PADDING,this.btAbort.autoFit(),this.addChild(this.btAbort),this.btAddSets=new e.ui.TextButton(this.game,loc("bt_add_sets"),!0),this.btAddSets.on(gf.CLICK,this.onAddSets,this),this.btAddSets.y=this.btAbort.y,this.btAddSets.autoFit(),this.addChild(this.btAddSets),this.tfSelected=new gf.display.Text(this.game,loc("new_track_selected",{sets:0}),e.TEXT_STYLE_TITLE_TAB.clone()),this.tfSelected.style.fontFamily=e.DEFAULT_FONT,this.tfSelected.style.fontSize=13,this.tfSelected.style.wordWrap=!0,this.tfSelected.y=this.btAbort.y+(this.btAbort.height-this.tfSelected.height>>1),this.addChild(this.tfSelected),this.activeSets=this.game.cache.getJSON("sets").active,this.addSets(),mAbo.on(e.clientmodels.Abo.ABO,function(){return n.onSets()}),mGift.on(e.clientmodels.Gift.GIFT,function(){return n.onSets()}),this.onSets()},n.prototype.onSets=function(){var t=[];if(mAbo.hasAbo()||mAbo.getAbo().sets.length>0)t=t.concat(mAbo.getAbo().sets);t=t.concat(mGift.getGift().sets),this.items.forEach(function(n){t.indexOf(n.setName)!=-1?n.isEnabled=!0:n.setName!=e.SETS.WEB_ONE&&(n.isEnabled=!1)})},n.prototype.addSet=function(t){var n=new e.ui.SelectSetButton(this.game,t);n.isEnabled=this.activeSets.indexOf(t)!=-1,n.on(gf.CHANGE,this.onSet,this),this.content.addChild(n),this.items.push(n)},n.prototype.addSets=function(){var t=this;this.items=[],e.SET_ORDER.forEach(function(e){t.addSet(e)}),this.arrange()},n.prototype.onSet=function(){var e=0;this.items.forEach(function(t){t.isSelected&&t.isEnabled&&e++}),this.tfSelected.text=loc("new_track_selected",{sets:e})},n.prototype.onDown=function(e){if(this._isDragging)return;if(!this.scrollbar.visible)return;this.on("mouseup mouseupoutside touchend touchendoutside",this.onUp,this),this._dragDistance=0,this.onMove(e)},n.prototype.onMove=function(e){if(this._isDragging){var t=e.data.global.y-this._dragStart;this.content.y=Math.min(this.contentMask.y,Math.max(this._minY,this._startY+t)),this.scrollbar.updateToContentPosition()}else this._isDragging=!0,this._dragStart=e.data.global.y,this._startY=this.content.y,this.on("mousemove touchmove",this.onMove,this),this.emit(gf.DRAG_START)},n.prototype.onUp=function(){this._isDragging&&(this._isDragging=!1,this.removeAllListeners("mousemove mouseup mouseupoutside touchmove touchend touchendoutside"))},n.prototype.onScrollbar=function(){this.bounds.width=this.bounds.height=1,this._minY=this.contentMask.y-this.content.height+this.contentMask.height},n.prototype.onAddSets=function(){var t=this;track("AddSets-Add_sets"),this.game.overlays.show(e.overlays.Loader.NAME);var n=[];this.items.forEach(function(e){e.isSelected&&mTrack.data.sets.indexOf(e.setName)==-1&&(mTrack.data.sets.push(e.setName),t.bottomMenu.cubeList.addSet(e.setName),t.bottomMenu.cubeList.sets[e.setName].forEach(function(e){n.push("cube_"+e[0])}))});var r=new e.core.AssetLoader(this.game,this.bottomMenu.gameScreen.playground.assets);n.forEach(function(t){r.threeJSON(t,"models/"+t+".json"),e.CUBES_RANDOM.indexOf(t)!=-1&&r.threeJSON(t+"_mirrored","models/"+t+"_mirrored.json")}),r.once(gf.LOAD_COMPLETE,function(){t.game.overlays.hide(e.overlays.Loader.NAME),t.bottomMenu.cubeList.arrange(t.bottomMenu.cubeList.lastWidth),t.bottomMenu.cubeList.updateUsed(),t.bottomMenu.btAddSets.label=loc("bt_select_sets",{count:mTrack.data.sets.length}),t.game.overlays.hide(e.overlays.AddSets.NAME)}),r.start()},n.prototype.arrange=function(){var t=this;if(this.items.length==0)return;this._itemSize=this.items[1].width;var n=this.contentMask.width-(this.scrollbar.width+e.PADDING*4),r=0,i=0,s=Math.min(n/(this._itemSize+e.PADDING)>>0,5);this.items.forEach(function(n){r==s&&(i++,r=0),n.x=r*t._itemSize+r*e.PADDING*2,n.y=i*t._itemSize+i*e.PADDING,r++}),this.bounds.width=s*this._itemSize+s*e.PADDING*2,this.bounds.height=i*this._itemSize+i*e.PADDING+this._itemSize,this.scrollbar.update(this.content,this.contentMask,0),this.scrollbar.visible||(this.content.x=this.bg.x+(this.bg.width-this.content.width>>1))},n.prototype.onClose=function(){track("AddSets-Close"),this.game.overlays.hide(e.overlays.AddSets.NAME)},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.bg.width=this.game.width*.75>>0,this.bg.height=this.game.height*.75>>0,this.bg.x=this.game.width-this.bg.width>>1,this.bg.y=this.game.height-this.bg.height>>1,this.btClose.x=this.bg.right-this.btClose.width-e.PADDING*2,this.btClose.y=this.bg.y+e.PADDING*2+2,this.tfTitle.x=this.bg.x+(this.bg.width-this.tfTitle.width>>1),this.tfTitle.y=this.bg.y+e.PADDING*2,this.btAbort.x=this.bg.x+22,this.btAddSets.x=this.bg.right-this.btAddSets.width-22,this.tfSelected.x=this.btAbort.right+e.PADDING*2,this.tfSelected.style.wordWrapWidth=this.btAddSets.x-this.btAbort.right-e.PADDING*4,this.btAbort.y=this.btAddSets.y=this.bg.bottom-this.btAbort.height-e.PADDING*4,this.tfSelected.y=this.btAbort.y+(this.btAbort.height-this.tfSelected.height>>1),this.content.x=this.contentMask.x=this.bg.x+e.PADDING*4,this.content.y=this.contentMask.y=this.scrollbar.y=this.tfTitle.bottom+e.PADDING*4,this.contentMask.width=this.bg.width-e.PADDING*10,this.contentMask.height=this.bg.height-this.btAbort.height-this.tfTitle.height-e.PADDING*10,this.arrange()},n.prototype.transitionIn=function(){var e=this;t.prototype.transitionIn.call(this),this.items.forEach(function(e){e.isSelected=!1,e.interactive=e.interactiveChildren=!0}),mTrack.data.sets.forEach(function(t){e.items.forEach(function(e){e.setName==t&&(e.isSelected=!0,e.interactive=e.interactiveChildren=!1)})}),this.onSet(),this.scrollbar.reset(),this.scrollbar.enableMouseWheel(),this.onResize()},n.prototype.transitionOut=function(){t.prototype.transitionOut.call(this),this.scrollbar.disableMouseWheel()},n.NAME="addSets",n}(e.overlays.Overlay);t.AddSets=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){var n=this;t.prototype.init.call(this),this.tfTitle.text=loc("change_password_title"),this.form=new gf.input.Form(this.game,"changePassword"),this.form.onSubmit=function(){return n.onChangePassword()},this.addChild(this.form),this.tfInfo=new gf.display.Text(this.game,loc("change_password"),e.TEXT_STYLE_SMALL.clone()),this.tfInfo.style.wordWrap=!0,this.tfInfo.style.wordWrapWidth=this.bg.width-44,this.tfInfo.y=this.tfTitle.bottom+e.PADDING*4,this.addChild(this.tfInfo),this.passwordOld=new e.input.TextInput(this.game,this.form,"passwordOld"),this.passwordOld.maxLength=50,this.passwordOld.placeholder=loc("placeholder_password_old"),this.passwordOld.tabIndex=1,this.passwordOld.type="password",this.passwordOld.tfTitle.text=loc("placeholder_password_old"),this.passwordOld.validation=function(e){return n.passwordValidation(e,n.passwordOld)},this.passwordOld.y=this.tfInfo.bottom+e.PADDING*2,this.form.addChild(this.passwordOld),this.passwordNew=new e.input.TextInput(this.game,this.form,"passwordNew"),this.passwordNew.maxLength=50,this.passwordNew.placeholder=loc("placeholder_password_new"),this.passwordNew.tabIndex=2,this.passwordNew.type="password",this.passwordNew.tfTitle.text=loc("placeholder_password_new"),this.passwordNew.validation=function(e){return n.passwordValidationNew(e,n.passwordNew)},this.passwordNew.y=this.passwordOld.bottom+e.PADDING,this.form.addChild(this.passwordNew),this.passwordNewRepeat=new e.input.TextInput(this.game,this.form,"passwordNewRepeat"),this.passwordNewRepeat.maxLength=50,this.passwordNewRepeat.placeholder=loc("placeholder_password_new_repeat"),this.passwordNewRepeat.tabIndex=3,this.passwordNewRepeat.type="password",this.passwordNewRepeat.tfTitle.text=loc("placeholder_password_new_repeat"),this.passwordNewRepeat.validation=function(e){return n.passwordValidationNew(e,n.passwordNewRepeat)},this.passwordNewRepeat.y=this.passwordNew.bottom+e.PADDING,this.form.addChild(this.passwordNewRepeat),this.cbShowPasswords=new e.ui.Checkbox(this.game,loc("bt_show_passwords")),this.cbShowPasswords.y=this.passwordNewRepeat.bottom+e.PADDING,this.cbShowPasswords.on(gf.CLICK,this.onTogglePasswords,this),this.addChild(this.cbShowPasswords),this.btChangePassword=new e.ui.TextButton(this.game,loc("bt_change_password2"),!0),this.btChangePassword.on(gf.CLICK,this.onChangePassword,this),this.btChangePassword.y=this.cbShowPasswords.bottom+e.PADDING*2,this.btChangePassword.setWidth(this.passwordOld.width),this.addChild(this.btChangePassword),this.tfError=new gf.display.Text(this.game),this.tfError.style=e.TEXT_STYLE_INPUT_ERROR.clone(),this.tfError.style.wordWrapWidth=this.bg.width-44,this.tfError.visible=!1,this.tfError.y=this.btChangePassword.bottom+e.PADDING*2,this.addChild(this.tfError),this.bg.height=this.btChangePassword.bottom-this.bg.y+e.PADDING*4},n.prototype.passwordValidation=function(e,t){t.hideError();var n=!1;return e.length>=6&&e.length<=50?n=!0:t.showError(loc("error_password")),n},n.prototype.passwordValidationNew=function(e,t){this.passwordNew.hideError(),this.passwordNewRepeat.hideError();var n=!1;return e.length>=6&&e.length<=50?this.passwordNew.value.length>=6&&this.passwordNewRepeat.value.length>=6&&(this.passwordNew.value==this.passwordNewRepeat.value?n=!0:t.showError(loc("error_password_mismatch"))):t.showError(loc("error_password")),n},n.prototype.onTogglePasswords=function(){this.passwordOld.type=this.cbShowPasswords.isChecked?"text":"password",this.passwordNew.type=this.cbShowPasswords.isChecked?"text":"password",this.passwordNewRepeat.type=this.cbShowPasswords.isChecked?"text":"password"},n.prototype.onChangePassword=function(){var t=this;track("ChangePassword-Change"),this.form.validate()&&(this.game.overlays.show(e.overlays.Loader.NAME),casClient.setPassword(this.passwordOld.value,this.passwordNew.value,function(n){t.game.overlays.hide(e.overlays.Loader.NAME);if(n==kr3m.SUCCESS){track("ChangePassword-Changed"),t.game.overlays.hide(e.overlays.ChangePassword.NAME),t.tfError.visible=!1;var r=t.game.overlays.show(e.overlays.Message.NAME);r.text=loc("change_password_changed")}else t.tfError.text=loc("error_password_change"),t.tfError.visible=!0;t.onResize()}))},n.prototype.onClose=function(){track("ChangePassword-Close"),this.game.overlays.hide(e.overlays.ChangePassword.NAME)},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.cbShowPasswords.x=this.passwordNew.x=this.passwordNewRepeat.x=this.passwordOld.x=this.btChangePassword.x=this.tfError.x=this.tfInfo.x=this.bg.x+22,this.tfError.visible?this.bg.height=this.tfError.bottom-this.bg.y+e.PADDING*4:this.bg.height=this.btChangePassword.bottom-this.bg.y+e.PADDING*4},n.prototype.transitionIn=function(){t.prototype.transitionIn.call(this),this.form.showDom(),this.passwordNew.value="",this.passwordNewRepeat.value="",this.passwordOld.value=""},n.prototype.transitionOut=function(){t.prototype.transitionOut.call(this),this.form.hideDom()},n.NAME="changePassword",n}(e.overlays.Overlay);t.ChangePassword=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){var t=function(){function e(){this.hasSubmitted=!1,this.expired=!1,this.trackData=null}return e}();e.Competition=t})(t=e.vo||(e.vo={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){var t=function(){function e(){}return e}();e.CompetitionsOverview=t})(t=e.vo||(e.vo={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){var t=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t}(e.Track);e.RankedTrack=t})(t=e.vo||(e.vo={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){var t=function(){function e(){}return e}();e.Ranking=t})(t=e.vo||(e.vo={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){var t=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.hasSeen=function(e,t){var n={competitionId:e};this.callService("Competition.hasSeen",n,function(e){return t(e.data,e.status)})},t.prototype.getCurrent=function(e){var t={};this.callService("Competition.getCurrent",t,function(t){return e(t.data,t.status)})},t.prototype.getRanking=function(e,t){var n={competitionId:e};this.callService("Competition.getRanking",n,function(e){return t(e.data,e.status)})},t.prototype.sendApplication=function(e,t,n){var r={competitionId:e,message:t};this.callService("Competition.sendApplication",r,function(e){return n(e.data,e.status)})},t.prototype.canSubmit=function(e,t,n){var r={competitionId:e,trackId:t};this.callService("Competition.canSubmit",r,n)},t.prototype.submit=function(e,t,n,r){var i={competitionId:e,trackId:t,scoreTotal:n};this.callService("Competition.submit",i,r)},t.prototype.getById=function(e,t){var n={competitionId:e};this.callService("Competition.getCompetition",n,function(e){return t(e.data,e.status)})},t}(e.Abstract);e.Competition=t})(t=e.stubs||(e.stubs={}))})(cuboro||(cuboro={}));var sCompetition=new cuboro.stubs.Competition,cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){var n=this;t.prototype.init.call(this),this.tfTitle.text=loc("competition_title"),this.bg.width=500,this.bg.height=420,this.tfCompetition=new gf.display.Text(this.game,""),this.tfCompetition.style=e.TEXT_STYLE_TITLE_TAB.clone(),this.tfCompetition.style.wordWrap=!0,this.tfCompetition.style.wordWrapWidth=this.bg.width-44,this.tfCompetition.y=this.tfTitle.bottom+e.PADDING*4,this.addChild(this.tfCompetition),this.content=new gf.display.Container(this.game),this.content.y=this.tfCompetition.bottom+e.PADDING*4,this.addChild(this.content),this.picture=new gf.display.Sprite(this.game,PIXI.Texture.WHITE),this.picture.width=200,this.picture.height=200,this.content.addChild(this.picture);var r=this.picture.height+e.PADDING*2,i=this.bg.width-r-44;this.tfPeriod=new gf.display.Text(this.game),this.tfPeriod.style=e.TEXT_STYLE_DEFAULT_HEAVY.clone(),this.tfPeriod.style.wordWrap=!0,this.tfPeriod.style.wordWrapWidth=i,this.tfPeriod.x=r,this.content.addChild(this.tfPeriod),this.tfDescription=new gf.display.Text(this.game),this.tfDescription.style=e.TEXT_STYLE_SMALL.clone(),this.tfDescription.style.wordWrap=!0,this.tfDescription.style.wordWrapWidth=i,this.tfDescription.x=r,this.content.addChild(this.tfDescription),this.tfGoalTitle=new gf.display.Text(this.game,loc("competition_goals_title")),this.tfGoalTitle.style=e.TEXT_STYLE_DEFAULT_HEAVY.clone(),this.tfGoalTitle.style.wordWrap=!0,this.tfGoalTitle.style.wordWrapWidth=i,this.tfGoalTitle.x=r,this.content.addChild(this.tfGoalTitle),this.tfGoal=new gf.display.Text(this.game),this.tfGoal.style=e.TEXT_STYLE_SMALL.clone(),this.tfGoal.style.wordWrap=!0,this.tfGoal.style.wordWrapWidth=i,this.tfGoal.x=r,this.content.addChild(this.tfGoal),this.tfPrizeTitle=new gf.display.Text(this.game,loc("competition_prize_title")),this.tfPrizeTitle.style=e.TEXT_STYLE_DEFAULT_HEAVY.clone(),this.tfPrizeTitle.style.wordWrap=!0,this.tfPrizeTitle.style.wordWrapWidth=i,this.tfPrizeTitle.x=r,this.content.addChild(this.tfPrizeTitle),this.tfPrize=new gf.display.Text(this.game),this.tfPrize.style=e.TEXT_STYLE_SMALL.clone(),this.tfPrize.style.wordWrap=!0,this.tfPrize.style.wordWrapWidth=i,this.tfPrize.x=r,this.content.addChild(this.tfPrize),this.form=new gf.input.Form(this.game,"contact"),this.form.onSubmit=function(){return n.onContinue()},this.addChild(this.form),this.message=new e.input.TextArea(this.game,this.form,"message"),this.message.placeholder=loc("placeholder_apply"),this.message.tabIndex=3,this.message.maxLength=300,this.message.tfTitle.text=loc("competition_apply_reason"),this.message.validation=function(e){return n.messageValidation(e)},this.message.required=!0,this.message.setRows(5),this.message.width=this.bg.width-44,this.message.y=this.content.bottom,this.form.addChild(this.message),this.btContinue=new e.ui.TextButton(this.game,loc("bt_apply"),!0),this.btContinue.on(gf.CLICK,this.onContinue,this),this.addChild(this.btContinue),this.btLoad=new e.ui.TextButton(this.game,loc("bt_load_track"),!0),this.btLoad.on(gf.CLICK,this.onLoad,this),this.addChild(this.btLoad),this.tf=new gf.display.Text(this.game,"",e.TEXT_STYLE_SMALL.clone()),this.tf.style.wordWrap=!0,this.tf.style.wordWrapWidth=this.bg.width-44,this.addChild(this.tf),this.addTerms()},n.prototype.addTerms=function(){var t=this;this.terms=new gf.display.Container(this.game),this.terms.interactive=!0,this.addChild(this.terms);var n=new gf.display.Text(this.game,loc("competition_terms1"),e.TEXT_STYLE_SMALL.clone());this.terms.addChild(n);var r=new gf.display.Text(this.game,loc("competition_terms2"),e.TEXT_STYLE_SMALL.clone());r.y=n.bottom>>0,r.interactive=!0,r.buttonMode=!0,r.on("click tap",function(){track("Competetition-Terms");var e=t.game.client.supportedLanguage;window.open("html/terms_participation_"+e+".html","_blank")},this),this.terms.addChild(r);var i=new gf.display.Sprite(this.game,PIXI.Texture.WHITE);i.x=r.x,i.y=r.bottom-3,i.width=r.width,i.height=1,i.tint=1907995,this.terms.addChild(i);var s=new gf.display.Text(this.game,loc("competition_terms3"),e.TEXT_STYLE_SMALL.clone());s.x=r.right+3,s.y=r.y,this.terms.addChild(s);var o=n.width-(i.width+s.width+3)>>1;r.x=o,i.x=o,s.x=r.right+3>>0},n.prototype.messageValidation=function(e){this.message.hideError();var t=!1;return e.length>0?t=!0:this.message.showError(loc("error_input_default")),t},n.prototype.onContinue=function(){this.competition.isParticipating?(track("Competetition-Apply"),this.applyCompetition()):(track("Competetition-Send_application"),this.sendApplication())},n.prototype.onLoad=function(){track("Competetition-Load_existing_track"),mTrack=this.competition.trackData,mTrack.data.competition.id=this.competition.id,e.core.Loader.loadTrack(this.game,mTrack,!1),this.game.overlays.hide(e.overlays.Competition.NAME)},n.prototype.applyCompetition=function(){var t=this;mTrack=new e.vo.Track,mTrack.owner=mUser.getUser(),mTrack.data.competition=this.competition;for(var n in this.competition.availableSets)for(var r=0;r<this.competition.availableSets[n];++r)mTrack.data.sets.push(n);this.game.overlays.show(e.overlays.Loader.NAME),sTrack.generateUniqueRandomName(loc("trackname_prefix"),function(n){t.game.overlays.hide(e.overlays.Loader.NAME),t.game.overlays.hide(e.overlays.Competition.NAME),mTrack.name=n,e.core.Loader.loadTrack(t.game,mTrack,!1)})},n.prototype.sendApplication=function(){var t=this;this.form.validate()&&(this.game.overlays.show(e.overlays.Loader.NAME),sCompetition.sendApplication(this.competition.id,this.message.value,function(n){t.game.overlays.hide(e.overlays.Loader.NAME),t.game.overlays.hide(e.overlays.Competition.NAME);var r=t.game.overlays.show(e.overlays.Message.NAME);r.text=loc(n?"competition_application_sent":"error")}))},n.prototype.onClose=function(){track("Competition-Close"),this.game.overlays.hide(e.overlays.Competition.NAME)},n.prototype.update=function(t){this.competition=t,this.tfCompetition.text=this.competition.title;var n=locDate("competition_period_date",this.competition.starts),r=locDate("competition_period_date",this.competition.ends);this.tfPeriod.text=loc("competition_period",{periodFrom:n,periodTo:r}),this.tfDescription.text=this.competition.description,this.tfDescription.y=this.tfPeriod.bottom,this.tfGoalTitle.y=this.tfDescription.bottom+e.PADDING*2,this.tfGoal.text=this.competition.summary,this.tfGoal.y=this.tfGoalTitle.bottom,this.tfPrizeTitle.y=this.tfGoal.bottom+e.PADDING*2,this.tfPrize.text=this.competition.prize,this.tfPrize.y=this.tfPrizeTitle.bottom,this.tf.visible=!1,this.terms.visible=!0,this.btContinue.visible=!0,this.btLoad.visible=!0,this.competition.hasSubmitted?(this.form.hideDom(),this.message.visible=!1,this.btContinue.visible=!1,this.btLoad.visible=!1,this.tf.visible=!0,this.tf.text=loc("competition_submit_already_submitted"),this.terms.visible=!1):this.competition.trackData?(this.form.hideDom(),this.message.visible=!1,this.btContinue.visible=!1,this.btLoad.visible=!0,this.tf.visible=!0,this.tf.text=loc("competition_submit_already_partaken"),this.terms.visible=!1,this.btContinue.y=this.btLoad.y=this.content.bottom+e.PADDING*4):this.competition.isParticipating?(this.form.hideDom(),this.message.visible=!1,this.btContinue.label=loc("bt_participate"),this.btContinue.y=this.content.bottom+e.PADDING*4,this.btLoad.visible=!1):this.competition.canApply?(this.form.showDom(),this.message.y=this.content.y+this.content.height+e.PADDING*4,this.message.visible=!0,this.btContinue.label=loc("bt_apply"),this.btContinue.y=this.message.bottom+e.PADDING*4,this.btLoad.visible=!1):(this.form.hideDom(),this.message.visible=!1,this.btContinue.visible=!1,this.tf.visible=!0,this.tf.text=loc("competition_submit_can_not_apply"),this.terms.visible=!1,this.btLoad.visible=!1),this.tf.y=(this.btContinue.visible||this.btLoad.visible?this.btContinue.bottom:this.content.bottom+e.PADDING*4)+e.PADDING*4,this.picture.texture=PIXI.Texture.fromImage(this.competition.imageUrl),this.picture.texture.once("update",this.onResize,this),this.picture.width=200,this.picture.scaleY=this.picture.scaleX,this.bg.height=(this.tf.visible?this.tf.bottom:this.btContinue.bottom)-this.bg.y+e.PADDING*4,this.onResize()},n.prototype.transitionIn=function(){t.prototype.transitionIn.call(this),this.message.value=""},n.prototype.transitionOut=function(){t.prototype.transitionOut.call(this),this.form.hideDom()},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.content.x=this.message.x=this.bg.x+22,this.btContinue.x=this.btLoad.x=this.bg.x+(this.bg.width-this.btContinue.width>>1),this.tfCompetition.x=this.bg.x+(this.bg.width-this.tfCompetition.width>>1),this.picture.width=200,this.picture.scaleY=this.picture.scaleX,this.tf.x=this.bg.x+(this.bg.width-this.tf.width>>1),this.terms.x=this.bg.x+(this.bg.width-this.terms.width>>1),this.terms.y=this.tf.visible?this.tf.bottom+e.PADDING*2:this.btContinue.bottom+e.PADDING*2,this.bg.scale.y=1;var n=this.terms.visible?this.terms.bottom:this.tf.visible?this.tf.bottom:this.btContinue.bottom;this.bg.height=n-this.bg.y+e.PADDING*4>>0},n.NAME="competition",n}(e.overlays.Overlay);t.Competition=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){t.prototype.init.call(this),this.tfTitle.text=loc("competition_apply_title"),this.bg.width=400,this.tfReviewTitle=new gf.display.Text(this.game,loc("competition_apply_title"),e.TEXT_STYLE_SMALL.clone()),this.tfReviewTitle.style.fontFamily=e.DEFAULT_FONT_HEAVY,this.tfReviewTitle.y=this.tfTitle.bottom+e.PADDING*2,this.addChild(this.tfReviewTitle),this.tfReview=new gf.display.Text(this.game,loc("competition_review"),e.TEXT_STYLE_SMALL.clone()),this.tfReview.style.lineHeight=16,this.tfReview.y=this.tfReviewTitle.bottom+e.PADDING,this.addChild(this.tfReview),this.tfReviewValues=new gf.display.Text(this.game,loc("competition_review_values"),e.TEXT_STYLE_SMALL.clone()),this.tfReviewValues.style.lineHeight=16,this.tfReviewValues.y=this.tfReview.y,this.addChild(this.tfReviewValues),this.tfInfo=new gf.display.Text(this.game,loc("competition_info"),e.TEXT_STYLE_SMALL.clone()),this.tfInfo.style.wordWrap=!0,this.tfInfo.style.wordWrapWidth=this.bg.width-44,this.tfInfo.y=this.tfReview.bottom+e.PADDING*4,this.addChild(this.tfInfo),this.btSubmit=new e.ui.TextButton(this.game,loc("bt_submit_competition"),!0),this.btSubmit.on(gf.CLICK,this.onSubmit,this),this.btSubmit.autoFit(),this.btSubmit.y=this.tfInfo.bottom+e.PADDING*4,this.addChild(this.btSubmit),this.bg.height=this.btSubmit.bottom-this.bg.y+e.PADDING*4},n.prototype.onClose=function(){track("CompetitionApply-Close"),this.game.overlays.hide(e.overlays.CompetitionApply.NAME)},n.prototype.onSubmit=function(){var t=this;track("CompetitionApply-Submit"),this.game.overlays.show(e.overlays.Loader.NAME),sCompetition.submit(mTrack.data.competition.id,mTrack.id,mTrack.scoreTotal,function(n){t.game.overlays.hide(e.overlays.Loader.NAME);var r=t.game.overlays.show(e.overlays.Message.NAME);n==kr3m.SUCCESS?(r.text=loc("competition_submit_success"),t.game.overlays.hide(e.overlays.CompetitionApply.NAME),t.game.screens.show(e.screens.Start.NAME)):n=="ERROR_ALREADY_PARTICIPATED"?r.text=loc("competition_submit_already_participated"):n=="ERROR_EXPIRED"?r.text=loc("competition_submit_expired"):r.text=loc("error")})},n.prototype.update=function(){this.tfReviewValues.text=mTrack.name+"\n"+locDate("publish_date",mTrack.lastSavedWhen)+"\n"+mTrack.data.evaluation.scoreTotal.toString()},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.tfInfo.x=this.tfReview.x=this.tfReviewTitle.x=this.bg.x+22,this.tfReviewValues.x=this.tfReview.right+e.PADDING,this.btSubmit.x=this.bg.x+(this.bg.width-this.btSubmit.width>>1)},n.prototype.transitionIn=function(){t.prototype.transitionIn.call(this),this.update()},n.NAME="competitionApply",n}(e.overlays.Overlay);t.CompetitionApply=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){t.prototype.init.call(this),this.tfTitle.text=loc("competition_goals_title"),this.bg.width=400,this.tfInfo=new gf.display.Text(this.game,loc("competition_goals"),e.TEXT_STYLE_SMALL.clone()),this.tfInfo.style.wordWrap=!0,this.tfInfo.style.wordWrapWidth=this.bg.width-44,this.tfInfo.y=this.tfTitle.bottom+e.PADDING*2,this.addChild(this.tfInfo),this.bg.height=this.tfInfo.bottom-this.bg.y+e.PADDING*4},n.prototype.onClose=function(){track("CompetitionGoals-Close"),this.game.overlays.hide(e.overlays.CompetitionGoals.NAME)},n.prototype.update=function(){this.tfInfo.text=mTrack.data.competition.summary,this.bg.height=this.tfInfo.bottom-this.bg.y+e.PADDING*4},n.prototype.transitionIn=function(){t.prototype.transitionIn.call(this),this.update()},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.tfInfo.x=this.bg.x+22},n.NAME="competitionGoals",n}(e.overlays.Overlay);t.CompetitionGoals=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){t.prototype.init.call(this),this.bt=new e.ui.TextButton(this.game,loc("competition_new_button"),!0),this.bt.on(gf.CLICK,this.onCompetition,this),this.bt.autoFit(),this.addChild(this.bt)},n.prototype.onCompetition=function(){var t=this;if(!mUser.isLoggedIn()){var n=this.game.overlays.show(e.overlays.Login.NAME);n.once(gf.TRANSITION_OUT,function(){n.off(gf.LOGIN,t.onLogin,!0)},this),n.once(gf.LOGIN,this.onLogin,this),this.game.overlays.hide(e.overlays.CompetitionNew.NAME);return}var r=this.game.overlays.show(e.overlays.Competition.NAME);r.update(this.current),this.game.overlays.hide(e.overlays.CompetitionNew.NAME)},n.prototype.onLogin=function(e){var t=this;e&&(mUser.isLoggedIn()?this.onCompetition():mUser.once("loggedIn",function(){t.onCompetition()}))},n.prototype.onClose=function(){this.game.overlays.hide(e.overlays.CompetitionNew.NAME)},n.prototype.update=function(e){this.current=e,this.title=loc("competition_new_title");var t=locDate("competition_period_date",this.current.starts),n=locDate("competition_period_date",this.current.ends);this.text=loc("competition_new_message",{from:t,to:n,title:this.current.title,prize:this.current.prize})},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.tfMessage.y=this.tfTitle.bottom+e.PADDING*4,this.bt.x=this.bg.x+(this.bg.width-this.bt.width>>1),this.bt.y=this.tfMessage.bottom+e.PADDING*4,this.bg.height=this.bt.bottom-this.bg.y+e.PADDING*4},n.NAME="competitionNew",n}(e.overlays.Message);t.CompetitionNew=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n,r){var i=t.call(this,n.game)||this;return i.competitionRanking=n,i._track=r,i.tfRank=new gf.display.Text(i.game,i._track.rank.toString(),e.TEXT_STYLE_SMALL.clone()),i.addChild(i.tfRank),i.tfOwner=new gf.display.Text(i.game,i._track.owner.name,e.TEXT_STYLE_SMALL.clone()),i.tfOwner.style=e.TEXT_STYLE_SMALL.clone(),i.tfOwner.x=50,i.addChild(i.tfOwner),i.tfScore=new gf.display.Text(i.game,i._track.scoreTotal.toString(10),e.TEXT_STYLE_SMALL.clone()),i.tfScore.style=e.TEXT_STYLE_SMALL.clone(),i.tfScore.x=250+i.competitionRanking.tfScore.width-i.tfScore.width>>0,i.addChild(i.tfScore),i.btDetails=new e.ui.GalleryItemButton(i.game,loc("bt_track_details")),i.btDetails.colorOver=e.COLOR_YELLOW,i.btDetails.on(gf.CLICK,i.onDetails,i),i.btDetails.x=340,i.addChild(i.btDetails),i}return __extends(n,t),n.prototype.onDetails=function(){var t=this;track("Competition-Ranking-Details");var n=this.game.overlays.show(e.overlays.TrackDetails.NAME);n.track=this._track,n.once(e.overlays.TrackDetails.LOADING,function(){t.game.overlays.hide(e.overlays.CompetitionRanking.NAME)},this),n.once(gf.TRANSITION_OUT,function(){n.removeAllListeners(e.overlays.TrackDetails.LOADING)},this)},n}(gf.display.Container);t.CompetitionRankingItem=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){t.prototype.init.call(this),this.tfTitle.text=loc("competition_ranking_title"),this.tfDescription=new gf.display.Text(this.game,loc("competition_ranking_description"),e.TEXT_STYLE_TITLE_TAB.clone()),this.tfDescription.style.align=gf.CENTER,this.tfDescription.y=this.tfTitle.bottom+e.PADDING*4>>0,this.addChild(this.tfDescription),this.bg.width=500,this.bg.height=420,this.tfOwnRank=new gf.display.Text(this.game,loc("competition_ranking_own_rank",{value:"-"}),e.TEXT_STYLE_TITLE_TAB.clone()),this.tfOwnRank.y=this.tfDescription.bottom+e.PADDING*4>>0,this.addChild(this.tfOwnRank),this.btDetails=new e.ui.GalleryItemButton(this.game,loc("bt_track_details")),this.btDetails.y=this.tfOwnRank.y+(this.tfOwnRank.height-this.btDetails.height>>1),this.btDetails.colorOver=e.COLOR_YELLOW,this.btDetails.on(gf.CLICK,this.onDetails,this),this.addChild(this.btDetails),this.line=new gf.display.Sprite(this.game,PIXI.Texture.WHITE),this.line.height=2,this.line.tint=e.COLOR_DARK_GREY,this.line.y=this.tfOwnRank.bottom+e.PADDING>>0,this.addChild(this.line),this.tfRank=new gf.display.Text(this.game,loc("competition_ranking_rank"),e.TEXT_STYLE_SMALL.clone()),this.tfRank.style.fontFamily=e.DEFAULT_FONT_HEAVY,this.tfRank.x=22,this.tfRank.y=this.line.bottom+e.PADDING>>0,this.addChild(this.tfRank),this.tfOwner=new gf.display.Text(this.game,loc("competition_ranking_owner"),e.TEXT_STYLE_SMALL.clone()),this.tfOwner.style.fontFamily=e.DEFAULT_FONT_HEAVY,this.tfOwner.x=50,this.tfOwner.y=this.tfRank.y,this.addChild(this.tfOwner),this.tfScore=new gf.display.Text(this.game,loc("competition_ranking_score"),e.TEXT_STYLE_SMALL.clone()),this.tfScore.style.fontFamily=e.DEFAULT_FONT_HEAVY,this.tfScore.x=250,this.tfScore.y=this.tfRank.y,this.addChild(this.tfScore),this.tfDetails=new gf.display.Text(this.game,loc("competition_ranking_details"),e.TEXT_STYLE_SMALL.clone()),this.tfDetails.style.fontFamily=e.DEFAULT_FONT_HEAVY,this.tfDetails.x=300,this.tfDetails.y=this.tfRank.y,this.addChild(this.tfDetails),this.tfMessage=new gf.display.Text(this.game),this.tfMessage.style=e.TEXT_STYLE_SMALL.clone(),this.addChild(this.tfMessage),this.contentMask=new gf.display.Sprite(this.game,PIXI.Texture.WHITE),this.contentMask.y=this.tfRank.bottom+e.PADDING*2>>0,this.addChild(this.contentMask),this.content=new gf.display.Container(this.game),this.content.interactive=!0,this.content.on("touchstart mousedown",this.onDown,this),this.content.mask=this.contentMask,this.content.y=this.contentMask.y,this.addChild(this.content),this.bounds=new gf.display.Sprite(this.game,PIXI.Texture.EMPTY),this.content.addChild(this.bounds),this.scrollbar=new e.ui.Scrollbar(this.game),this.scrollbar.on(gf.UPDATE,this.onScrollbar,this),this.scrollbar.visible=!1,this.scrollbar.y=this.contentMask.y,this.addChild(this.scrollbar),this.contentMask.width=this.bg.width-44-this.scrollbar.width,this.contentMask.height=this.bg.bottom-this.contentMask.y-22>>0},n.prototype.onDown=function(e){if(this._isDragging)return;if(!this.scrollbar.visible)return;this.on("mouseup mouseupoutside touchend touchendoutside",this.onUp,this),this._dragDistance=0,this.onMove(e)},n.prototype.onMove=function(e){if(this._isDragging){var t=e.data.global.y-this._dragStart;this.content.y=Math.min(this.contentMask.y,Math.max(this._minY,this._startY+t)),this.scrollbar.updateToContentPosition()}else this._isDragging=!0,this._dragStart=e.data.global.y,this._startY=this.content.y,this.on("mousemove touchmove",this.onMove,this),this.emit(gf.DRAG_START)},n.prototype.onUp=function(){this._isDragging&&(this._isDragging=!1,this.removeAllListeners("mousemove mouseup mouseupoutside touchmove touchend touchendoutside"))},n.prototype.onScrollbar=function(){this.bounds.width=this.bounds.height=1,this._minY=this.contentMask.y-this.content.height+this.contentMask.height,this.bounds.width=this.contentMask.width,this.bounds.height=this.scrollbar.sizeScroll},n.prototype.onClose=function(){track("CompetitionRanking-Close"),this.game.overlays.hide(e.overlays.CompetitionRanking.NAME)},n.prototype.onDetails=function(){var t=this;track("CompetitionRanking-Details");var n=this.game.overlays.show(e.overlays.TrackDetails.NAME);n.track=this._track,n.track.data.competition.id=null,n.once(e.overlays.TrackDetails.LOADING,function(){t.game.overlays.hide(e.overlays.CompetitionRanking.NAME)},this),n.once(gf.TRANSITION_OUT,function(){n.removeAllListeners(e.overlays.TrackDetails.LOADING)},this)},n.prototype.update=function(t){var n=this;this.scrollbar.reset(),this.tfMessage.visible=!1,this._competition=t,this.tfOwnRank.text=loc("competition_ranking_own_rank",{value:"-"});var r=locDate("competition_period_date",t.starts),i=locDate("competition_period_date",t.ends);this.tfDescription.text=loc("competition_ranking_description",{title:t.title,periodFrom:r,periodTo:i}),this.content.removeChildren(),this.content.addChild(this.bounds),this.content.y=this.contentMask.y,this.bounds.height=1,this.tfRank.visible=!0,this.tfOwner.visible=!0,this.tfScore.visible=!0,this.tfDetails.visible=!0,this.btDetails.visible=!0,this.btDetails.isEnabled=!1,this.game.overlays.show(e.overlays.Loader.NAME),sCompetition.getRanking(this._competition.id,function(t){n.game.overlays.hide(e.overlays.Loader.NAME);if(!t){n.tfMessage.text=loc("competition_ranking_not_published"),n.tfMessage.visible=!0,n.btDetails.visible=!1,n.tfRank.visible=!1,n.tfOwner.visible=!1,n.tfScore.visible=!1,n.tfDetails.visible=!1,n.onResize();return}t.forEach(function(t,r){var i=new e.ui.CompetitionRankingItem(n,t);i.y=r*i.height+r*e.PADDING,n.content.addChild(i),mUser.isLoggedIn()&&t.owner.id==mUser.getUserId()&&(n.tfOwnRank.text=loc("competition_ranking_own_rank",{value:r+1}),n._track=t,n.btDetails.isEnabled=!0)}),n.bounds.height=n.content.height,n.scrollbar.update(n.content,n.contentMask,0),n.scrollbar.visible=n.scrollbar.sizeScroll>n.scrollbar.sizeVisible}),this.onResize()},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.content.x=this.contentMask.x=this.tfRank.x=this.tfOwnRank.x=this.line.x=this.bg.x+22,this.tfMessage.x=this.bg.x+(this.bg.width-this.tfMessage.width>>1),this.tfMessage.y=this.bg.y+(this.bg.height-this.tfMessage.height>>1),this.tfOwner.x=this.tfRank.x+50,this.tfDetails.x=this.bg.right-34-this.scrollbar.width-this.tfDetails.width,this.tfScore.x=this.tfRank.x+250,this.btDetails.x=this.bg.x+340+22,this.tfDescription.x=this.bg.x+(this.bg.width-this.tfDescription.width>>1),this.line.width=this.btDetails.right-this.line.x},n.NAME="competitionRanking",n}(e.overlays.Overlay);t.CompetitionRanking=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){t.prototype.init.call(this),this.btYes=new e.ui.TextButton(this.game,loc("bt_yes_delete"),!0),this.btYes.on(gf.CLICK,this.onYes,this),this.addChild(this.btYes)},n.prototype.onClose=function(){this.game.overlays.hide(e.overlays.Confirm.NAME),this.confirmCb=null},n.prototype.onYes=function(){this.confirmCb&&this.confirmCb(),this.onClose()},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.btYes.y=this.tfMessage.bottom+e.PADDING*4,this.tfMessage.x=this.bg.x+(this.bg.width-this.tfMessage.width>>1),this.btYes.x=this.bg.x+(this.bg.width-this.btYes.width>>1),this.bg.height=this.btYes.bottom-this.bg.y+e.PADDING*4},n.NAME="confirm",n}(e.overlays.Message);t.Confirm=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var gf;(function(e){var t;(function(t){var n=function(e){function t(t,n,r){var i=e.call(this,t,n,"textarea")||this;return i._regExp=/(\w|\W)+/,i.required=!0,i._inputDom.name=r,i._italic=!1,i._bold=!1,i.validateTrimmedValue=!0,i.addChangeListeners(),i}return __extends(t,e),t.prototype.addChangeListeners=function(){var e=this;this._inputDom.addEventListener("keyup",function(t){t.keyCode!=9&&e.onChange()}),this._inputDom.oninput=function(){return e.onChange()},$(this._inputDom).blur(function(){return e.onInputBlur()}),$(this._inputDom).focus(function(){return e.onInputFocus()})},t.prototype.createDom=function(){e.prototype.createDom.call(this),this._inputDom=this._dom,this._inputDom.style.position="absolute",this._inputDom.style.border="none",this._inputDom.style.fontFamily="Arial, Helvetica, sans-serif"},t.prototype.onInputBlur=function(){},t.prototype.onInputFocus=function(){},t.prototype.setFocus=function(){var e=this;setTimeout(function(){return $(e._inputDom).focus()},1)},t.prototype.validate=function(){if(this.readOnly)return!0;var e=this.validateTrimmedValue?this.value.trim():this.value;return!this.required&&this.value.length==0||this.regExp.test(e)},Object.defineProperty(t.prototype,"inputDom",{get:function(){return this._inputDom},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"name",{get:function(){return this._inputDom.name},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"regExp",{get:function(){return this._regExp},set:function(e){this._regExp=e,this.onChange()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"readOnly",{get:function(){return this._inputDom.readOnly},set:function(e){this._inputDom.readOnly=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"value",{get:function(){return this._inputDom.value},set:function(e){this._inputDom.value!=e&&this.onChange(),this._inputDom.value=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"placeholder",{get:function(){return this._inputDom.placeholder},set:function(e){this._inputDom.placeholder=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fontFamily",{get:function(){return this._inputDom.style.fontFamily},set:function(e){this._inputDom.style.fontFamily=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fontSize",{get:function(){return this._fontSize},set:function(e){this._inputDom.style.fontSize=String(e)+"px",this._fontSize=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){return this._color},set:function(e){this._inputDom.style.color="#"+e.toString(16),this._color=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"italic",{get:function(){return this._italic},set:function(e){this._inputDom.style.fontStyle=e?"italic":"regular",this._italic=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bold",{get:function(){return this._bold},set:function(e){this._inputDom.style.fontWeight=e?"bold":"normal",this._bold=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maxLength",{get:function(){return this._inputDom.maxLength?this._inputDom.maxLength:0},set:function(e){this._inputDom.maxLength=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"cols",{get:function(){return this._inputDom.cols},set:function(e){this._inputDom.cols=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rows",{get:function(){return this._inputDom.rows},set:function(e){this._inputDom.rows=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"wrap",{get:function(){return this._inputDom.wrap},set:function(e){this._inputDom.wrap=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"resize",{get:function(){return this._inputDom.style.resize},set:function(e){this._inputDom.style.resize=e},enumerable:!0,configurable:!0}),t}(e.display.DomDisplayObject);t.TextArea=n})(t=e.input||(e.input={}))})(gf||(gf={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n,r,i){var s=t.call(this,n,r,i)||this;return s.fontFamily=e.DEFAULT_FONT,s.fontSize=13,s.resize=gf.NONE,s.tfTitle=new gf.display.Text(s.game),s.tfTitle.style=e.TEXT_STYLE_SMALL.clone(),s.tfTitle.x=e.PADDING,s.tfTitle.text="",s.addChild(s.tfTitle),s.border=new gf.display.Sprite(s.game,PIXI.Texture.WHITE),s.border.width=227,s.border.height=27,s.border.tint=e.COLOR_GREY,s.border.y=s.tfTitle.bottom,s.addChild(s.border),s.bg=new gf.display.Sprite(s.game,PIXI.Texture.WHITE),s.bg.width=225,s.bg.height=25,s.bg.x=1,s.bg.y=s.border.y+1,s.addChild(s.bg),s.tfError=new gf.display.Text(s.game),s.tfError.style=e.TEXT_STYLE_INPUT_ERROR.clone(),s.tfError.style.wordWrapWidth=s.border.width-e.PADDING*2,s.tfError.text="",s.tfError.x=e.PADDING,s.tfError.y=s.border.bottom+2,s.addChild(s.tfError),s.paddingLeft=e.PADDING,s.paddingRight=e.PADDING,s._dom.style.marginTop="18px",s.width=s.bg.width,s}return __extends(n,t),n.prototype.onChange=function(){t.prototype.onChange.call(this),this.tfError.visible&&this.hideError()},n.prototype.onInputBlur=function(){this.validate(),this.emit(gf.BLUR)},n.prototype.setRows=function(e){this.rows=e;var t=this.fontSize*e;this.inputDom.style.height=t+"px",this.bg.height=t,this.border.height=this.bg.height+2,this.tfError.y=this.border.bottom+2},n.prototype.hideError=function(){this.tfError.text="",this.tfError.visible=!1,this.border.tint=e.COLOR_GREY},n.prototype.showError=function(t){this.tfError.text=t,this.tfError.visible=!0,this.border.tint=e.COLOR_RED},n.prototype.validate=function(){return this._inputDom.value=this.value.trim(),this.validation?this.validation(this.value):!0},Object.defineProperty(n.prototype,"width",{get:function(){return this.getLocalBounds().width},set:function(e){this.setWidth(e),this.bg.width=e,this.border.width=e+2},enumerable:!0,configurable:!0}),n}(gf.input.TextArea);t.TextArea=n})(t=e.input||(e.input={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){var t=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.sendEcard=function(e,t,n,r,i,s,o){var u={trackId:e,recipienEmail:t,recipienName:n,senderEmail:r,senderName:i,message:s};this.callService("Mail.sendEcard",u,function(e){return o(e.data,e.status)})},t.prototype.sendContact=function(e,t,n,r){var i={senderName:e,senderEmail:t,message:n};this.callService("Mail.sendContact",i,function(e){return r(e.data,e.status)})},t}(e.Abstract);e.Mail=t})(t=e.stubs||(e.stubs={}))})(cuboro||(cuboro={}));var sMail=new cuboro.stubs.Mail,cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){var n=this;t.prototype.init.call(this),this.tfTitle.text=loc("contact"),this.form=new gf.input.Form(this.game,"contact"),this.form.onSubmit=function(){return n.onContact()},this.addChild(this.form),this.tfInfo=new gf.display.Text(this.game,loc("contact_info"),e.TEXT_STYLE_DEFAULT.clone()),this.tfInfo.style.fontSize=13,this.tfInfo.style.wordWrap=!0,this.tfInfo.style.wordWrapWidth=this.bg.width-44,this.tfInfo.y=this.tfTitle.bottom+e.PADDING*4,this.addChild(this.tfInfo),this.username=new e.input.TextInput(this.game,this.form,"username"),this.username.maxLength=100,this.username.placeholder=loc("placeholder_username"),this.username.required=!0,this.username.tabIndex=1,this.username.tfTitle.text=loc("placeholder_username"),this.username.validation=function(e){return n.usernameValidation(e)},this.username.y=this.tfInfo.bottom+e.PADDING*2,this.form.addChild(this.username),this.email=new e.input.TextInput(this.game,this.form,"email"),this.email.maxLength=100,this.email.placeholder=loc("placeholder_email"),this.email.required=!0,this.email.tabIndex=2,this.email.tfTitle.text=loc("placeholder_email"),this.email.type="email",this.email.validation=function(e){return n.emailValidation(e)},this.email.y=this.username.bottom+e.PADDING*2,this.form.addChild(this.email),this.message=new e.input.TextArea(this.game,this.form,"message"),this.message.placeholder=loc("placeholder_message"),this.message.tabIndex=3,this.message.tfTitle.text=loc("placeholder_message"),this.message.validation=function(e){return n.messageValidation(e)},this.message.required=!0,this.message.setRows(5),this.message.y=this.email.bottom+e.PADDING*2,this.form.addChild(this.message),this.tfDisclaimer=new gf.display.Text(this.game,loc("contact_disclaimer"),e.TEXT_STYLE_DEFAULT.clone()),this.tfDisclaimer.style.fontSize=13,this.tfDisclaimer.style.wordWrap=!0,this.tfDisclaimer.style.wordWrapWidth=this.bg.width-44,this.tfDisclaimer.y=this.message.bottom+e.PADDING*4,this.addChild(this.tfDisclaimer);var r=this.bg.width-44-e.PADDING*2>>1;this.btSubmit=new e.ui.TextButton(this.game,loc("bt_submit"),!0),this.btSubmit.x=e.PADDING,this.btSubmit.y=this.tfDisclaimer.bottom+e.PADDING*2,this.btSubmit.on(gf.CLICK,this.onContact,this),this.btSubmit.setWidth(r),this.addChild(this.btSubmit),this.btAbort=new e.ui.TextButton(this.game,loc("bt_abort"),!1),this.btAbort.y=this.btSubmit.y,this.btAbort.on(gf.CLICK,this.onClose,this),this.btAbort.setWidth(r),this.addChild(this.btAbort),this.bg.height=this.btAbort.bottom-this.bg.y+e.PADDING*4},n.prototype.usernameValidation=function(e){this.username.hideError();var t=!1;return e.length>0?t=!0:this.username.showError(loc("error_input_default")),t},n.prototype.emailValidation=function(e){this.email.hideError();var t=!1;return kr3m.util.Validator.email(e)?t=!0:this.email.showError(loc("error_input_default")),t},n.prototype.messageValidation=function(e){this.message.hideError();var t=!1;return e.length>0?t=!0:this.message.showError(loc("error_input_default")),t},n.prototype.onContact=function(){var t=this;this.form.validate()&&(track("Contact-Submit"),this.game.overlays.show(e.overlays.Loader.NAME),sMail.sendContact(this.username.value,this.email.value,this.message.value,function(){t.game.overlays.hide(e.overlays.Loader.NAME),t.game.overlays.hide(e.overlays.Contact.NAME)}))},n.prototype.onClose=function(){track("Contact-Close"),this.game.overlays.hide(e.overlays.Contact.NAME)},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.btSubmit.x=this.username.x=this.email.x=this.message.x=this.tfDisclaimer.x=this.tfInfo.x=this.bg.x+22,this.btAbort.x=this.username.right-this.btAbort.width},n.prototype.transitionIn=function(){t.prototype.transitionIn.call(this),this.form.showDom(),this.username.value="",this.email.value="",this.message.value=""},n.prototype.transitionOut=function(){t.prototype.transitionOut.call(this),this.form.hideDom()},n.NAME="contact",n}(e.overlays.Overlay);t.Contact=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){t.prototype.init.call(this),this.tfTitle.text=loc("edutrack_task_title"),this.bg.width=400,this.tfInfo=new gf.display.Text(this.game,loc("edutrack_task"),e.TEXT_STYLE_SMALL.clone()),this.tfInfo.style.wordWrap=!0,this.tfInfo.style.wordWrapWidth=this.bg.width-44,this.tfInfo.y=this.tfTitle.bottom+e.PADDING*2,this.addChild(this.tfInfo),this.bg.height=this.tfInfo.bottom-this.bg.y+e.PADDING*4},n.prototype.onClose=function(){track("EduTrackTask-Close"),this.game.overlays.hide(e.overlays.EduTrackTask.NAME)},n.prototype.update=function(){this.tfInfo.text=mTrack.eduTask,this.bg.height=this.tfInfo.bottom-this.bg.y+e.PADDING*4},n.prototype.transitionIn=function(){t.prototype.transitionIn.call(this),this.update()},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.tfInfo.x=this.bg.x+22},n.NAME="edutracktask",n}(e.overlays.Overlay);t.EduTrackTask=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){t.prototype.init.call(this),this.bg.width=340,this.tfTitle.text=loc("finish_register_title"),this.tfValidateTitle=new gf.display.Text(this.game,loc("finish_register_validate_title"),e.TEXT_STYLE_DEFAULT_HEAVY.clone()),this.tfValidateTitle.y=this.tfTitle.bottom+e.PADDING*4,this.addChild(this.tfValidateTitle),this.tfValidate=new gf.display.Text(this.game,loc("finish_register_validate"),e.TEXT_STYLE_DEFAULT.clone()),this.tfValidate.style.fontSize=13,this.tfValidate.style.wordWrap=!0,this.tfValidate.style.wordWrapWidth=this.bg.width-44,this.tfValidate.y=this.tfValidateTitle.bottom+e.PADDING*2,this.addChild(this.tfValidate),this.tfResendTitle=new gf.display.Text(this.game,loc("finish_register_resend_title"),e.TEXT_STYLE_DEFAULT_HEAVY.clone()),this.tfResendTitle.y=this.tfValidate.bottom+e.PADDING*4,this.addChild(this.tfResendTitle),this.tfResend=new gf.display.Text(this.game,loc("finish_register_resend"),e.TEXT_STYLE_DEFAULT.clone()),this.tfResend.style.fontSize=13,this.tfResend.style.wordWrap=!0,this.tfResend.style.wordWrapWidth=this.bg.width-44,this.tfResend.y=this.tfResendTitle.bottom+e.PADDING*2,this.addChild(this.tfResend),this.btResend=new e.ui.TextButton(this.game,loc("bt_resend"),!0),this.btResend.on(gf.CLICK,this.onResend,this),this.btResend.y=this.tfResend.bottom+e.PADDING*2,this.btResend.setWidth(220),this.addChild(this.btResend),this.bg.height=this.btResend.bottom-this.bg.y+e.PADDING*4},n.prototype.onResend=function(){var t=this;track("FinishRegister-Resend"),this.game.overlays.show(e.overlays.Loader.NAME),casClient.resendValidationEmail(function(n){t.game.overlays.hide(e.overlays.Loader.NAME),n==kr3m.SUCCESS&&t.game.overlays.hide(e.overlays.FinishRegister.NAME)})},n.prototype.onClose=function(){track("FinishRegister-Close"),this.game.overlays.hide(e.overlays.FinishRegister.NAME)},Object.defineProperty(n.prototype,"email",{set:function(e){this.tfValidate.text=loc("finish_register_validate",{email:e})},enumerable:!0,configurable:!0}),n.prototype.onResize=function(){t.prototype.onResize.call(this),this.tfValidate.x=this.tfValidateTitle.x=this.tfResend.x=this.tfResendTitle.x=this.bg.x+22,this.btResend.x=this.bg.x+(this.bg.width-this.btResend.width>>1)},n.NAME="finishRegister",n}(e.overlays.Overlay);t.FinishRegister=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){var n=this;t.prototype.init.call(this),this.tfTitle.text=loc("forgot_password"),this.form=new gf.input.Form(this.game,"forgotPassword"),this.form.onSubmit=function(){return n.onForgotPassword()},this.addChild(this.form),this.tfInfo=new gf.display.Text(this.game,loc("forgot_password_info"),e.TEXT_STYLE_SMALL.clone()),this.tfInfo.style.wordWrap=!0,this.tfInfo.style.wordWrapWidth=227,this.tfInfo.y=this.tfTitle.bottom+e.PADDING*4,this.addChild(this.tfInfo),this.email=new e.input.TextInput(this.game,this.form,"email"),this.email.maxLength=100,this.email.placeholder=loc("placeholder_email"),this.email.tabIndex=1,this.email.tfTitle.text=loc("placeholder_email"),this.email.type="email",this.email.validation=function(e){return n.emailValidation(e)},this.email.y=this.tfInfo.bottom+e.PADDING*2,this.form.addChild(this.email),this.btRequestPassword=new e.ui.TextButton(this.game,loc("bt_request_password"),!0),this.btRequestPassword.on(gf.CLICK,this.onForgotPassword,this),this.btRequestPassword.y=this.email.bottom+e.PADDING*2,this.btRequestPassword.setWidth(this.email.width),this.addChild(this.btRequestPassword),this.btRegister=new e.ui.TextButton(this.game,loc("bt_register"),!1),this.btRegister.y=this.btRequestPassword.bottom+e.PADDING*2,this.btRegister.on(gf.CLICK,this.onRegister,this),this.btRegister.setWidth(this.email.width),this.addChild(this.btRegister),this.btLogin=new e.ui.TextButton(this.game,loc("bt_back_to_login"),!1),this.btLogin.y=this.btRegister.bottom+e.PADDING,this.btLogin.on(gf.CLICK,this.onLogin,this),this.btLogin.setWidth(this.email.width),this.addChild(this.btLogin),this.bg.height=this.btLogin.bottom-this.bg.y+e.PADDING*4},n.prototype.emailValidation=function(e){this.email.tfError.text="";var t=!1;return kr3m.util.Validator.email(e)?t=!0:this.email.tfError.text=loc("error_input_default"),t},n.prototype.onForgotPassword=function(){var t=this;this.form.validate()&&(this.game.overlays.show(e.overlays.Loader.NAME),casClient.sendPasswordRecoverMail(this.email.value,function(){track("ForgotPassword-Sent"),t.game.overlays.hide(e.overlays.Loader.NAME),t.game.overlays.hide(e.overlays.ForgotPassword.NAME);var n=t.game.overlays.show(e.overlays.Message.NAME);n.text=loc("forgot_password_send")}))},n.prototype.onLogin=function(){this.game.overlays.hide(e.overlays.ForgotPassword.NAME),this.game.overlays.show(e.overlays.Login.NAME)},n.prototype.onRegister=function(){track("ForgotPassword-Register"),this.game.overlays.hide(e.overlays.ForgotPassword.NAME),this.game.overlays.show(e.overlays.Register.NAME)},n.prototype.onClose=function(){track("ForgotPassword-Close"),this.game.overlays.hide(e.overlays.ForgotPassword.NAME)},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.email.x=this.btLogin.x=this.btRegister.x=this.btRequestPassword.x=this.tfInfo.x=this.bg.x+22},n.prototype.transitionIn=function(){t.prototype.transitionIn.call(this),this.form.showDom()},n.prototype.transitionOut=function(){t.prototype.transitionOut.call(this),this.form.hideDom()},n.NAME="forgotPassword",n}(e.overlays.Overlay);t.ForgotPassword=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){t.prototype.init.call(this),this.setCols=5,this.bg.width=424,this.btContinue=new e.ui.TextButton(this.game,loc("bt_continue"),!0),this.btContinue.on(gf.CLICK,this.onClose,this),this.btContinue.y=this.bg.bottom-this.btContinue.height-e.PADDING,this.btContinue.autoFit(),this.btContinue.setWidth(this.btContinue.width+e.PADDING*4),this.addChild(this.btContinue)},n.prototype.onClose=function(){track("Gifts-Close"),this.game.overlays.hide(e.overlays.Gifts.NAME)},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.bg.width=Math.max(this.setsContainer.width+e.PADDING*8,400),this.bg.x=this.game.width-this.bg.width>>1,this.setsContainer.x=this.tfMessage.x=this.bg.x+22>>0,this._sets&&this._sets.length<3&&(this.setsContainer.x=this.bg.x+(this.bg.width-this.setsContainer.width>>1)>>0),this.setsContainer.y=this.tfMessage.bottom+e.PADDING*4>>0,this.tfMessage.style.wordWrapWidth=this.bg.width-e.PADDING*4,this.btClose.x=this.bg.right-this.btClose.width-e.PADDING*2,this.btClose.y=this.bg.y+e.PADDING*2+2,this.tfTitle.x=this.bg.x+(this.bg.width-this.tfTitle.width>>1),this.tfTitle.y=this.bg.y+e.PADDING*2,this.btContinue.x=this.bg.x+(this.bg.width-this.btContinue.width>>1),this.btContinue.y=this.setsContainer.bottom+e.PADDING*4,this.bg.height=this.btContinue.bottom-this.bg.y+e.PADDING*4>>0},n.prototype.transitionIn=function(){t.prototype.transitionIn.call(this);if(!mGift.hasGift())this.title=loc("gift_expired_title"),this.text=loc("gift_expired"),this.sets=mAbo.getAbo().sets.concat(e.SETS.WEB_ONE);else{this.title=loc("gift_received_title");if(mGift.getGift().hasEnd){var n=locDate("track_info_last_saved",mGift.getGift().end);this.text=loc("gift_received",{date:n})}else this.text=loc("gift_received_unlimited");this.sets=mGift.getGift().sets.concat(e.SETS.WEB_ONE)}this.onResize()},n.NAME="gifts",n}(e.overlays.AboSets);t.Gifts=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){t.prototype.init.call(this),this.tfTitle.text=loc("imprint_title"),this.tf=new gf.display.Text(this.game,loc("imprint"),e.TEXT_STYLE_DEFAULT.clone()),this.tf.style.fontSize=13,this.tf.style.wordWrap=!0,this.tf.style.wordWrapWidth=this.bg.width-44,this.tf.y=this.tfTitle.bottom+e.PADDING*4,this.addChild(this.tf),this.bg.height=this.tf.bottom-this.bg.y+e.PADDING*4},n.prototype.onClose=function(){track("Imprint-Close"),this.game.overlays.hide(e.overlays.Imprint.NAME)},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.tf.x=this.bg.x+22},n.NAME="imprint",n}(e.overlays.Overlay);t.Imprint=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){t.prototype.init.call(this),this.bg.width=424,this.tfMessage.style.wordWrapWidth=this.bg.width-44,this.tfMessage.style.align=gf.LEFT,this.btContinue=new e.ui.TextButton(this.game,loc("bt_shop_payment_continue"),!0),this.btContinue.on(gf.CLICK,this.onClose,this),this.addChild(this.btContinue),this.btShop=new e.ui.TextButton(this.game,loc("bt_shop_visit"),!1),this.btShop.on(gf.CLICK,this.onShop,this),this.addChild(this.btShop),this.title=loc("shop_legacy_user_title"),this.text=loc("shop_legacy_user_text"),this.tfMore=new gf.display.Text(this.game,loc("shop_legacy_user_more"),this.tfMessage.style.clone()),this.addChild(this.tfMore),this.sets=[e.SETS.STANDARD,e.SETS.BASIC]},n.prototype.onClose=function(){track("LegacyUser-Close"),this.game.overlays.hide(e.overlays.LegacyUser.NAME)},n.prototype.onShop=function(){track("LegacyUser-Shop"),this.game.client.config.isRussian?mUser.isLoggedIn()?window.open(e.SHOP_LINK_RU,"_blank"):this.game.overlays.show(e.overlays.Login.NAME):(this.game.overlays.hide(e.overlays.LegacyUser.NAME),this.game.overlays.show(e.overlays.Shop.NAME))},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.setsContainer.x=this.tfMessage.x=this.bg.x+22>>0,this._sets&&this._sets.length<3&&(this.setsContainer.x=this.bg.x+(this.bg.width-this.setsContainer.width>>1)>>0),this.setsContainer.y=this.tfMessage.bottom+e.PADDING*4>>0,this.btContinue.x=this.bg.x+(this.bg.width-(this.btShop.width+this.btContinue.width+e.PADDING*2)>>1),this.btShop.x=this.btContinue.right+e.PADDING*2>>0,this.tfMore&&(this.tfMore.x=this.tfMessage.x,this.tfMore.y=this.setsContainer.bottom+e.PADDING*4>>0,this.btContinue.y=this.btShop.y=this.tfMore.bottom+e.PADDING*4>>0),this.bg.height=this.btShop.bottom-this.bg.y+e.PADDING*4>>0},n.NAME="legacyUser",n}(e.overlays.AboSets);t.LegacyUser=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){this.addNoClick(),this.addDim(),this.animationContainer=new gf.display.Container(this.game),this.animationContainer.hAlign(gf.CENTER),this.animationContainer.vAlign(gf.CENTER,this.game,-5),this.addChild(this.animationContainer),this.animationBg=new gf.display.Sprite(this.game,PIXI.Texture.WHITE),this.animationBg.width=100,this.animationBg.height=130,this.animationContainer.addChild(this.animationBg),this.animation=new gf.display.Container(this.game),this.animation.x=3,this.animation.y=3,this.animationContainer.addChild(this.animation),this.tf=new gf.display.Text(this.game),this.tf.style=e.TEXT_STYLE_SMALL.clone(),this.tf.text=loc("please_wait"),this.tf.hAlign(gf.CENTER,100),this.tf.y=this.animationBg.height-this.tf.height-e.PADDING,this.animationContainer.addChild(this.tf),this.quads=[];var t=this.getQuad(),n=t.width+2,r=t.width*2+4;this.data=[{x:0,y:0},{x:n,y:0},{x:r,y:0},{x:r,y:n},{x:r,y:r},{x:n,y:r},{x:0,y:r},{x:0,y:n}];for(var i=0;i<7;++i)t=this.getQuad(),t.x=this.data[i].x,t.y=this.data[i].y,this.animation.addChild(t),this.quads.push(t);t=this.getQuad(),t.x=n,t.y=n,this.animation.addChild(t)},n.prototype.getQuad=function(){var t=new gf.display.Sprite(this.game,PIXI.Texture.WHITE);return t.tint=e.COLOR_YELLOW,t.width=30,t.height=30,t},n.prototype.timeout=function(){var t=this.game.overlays.show(e.overlays.Message.NAME);t.text=loc("error_offline"),this.transitionOut()},n.prototype.animateQuad=function(e){var t=this,n=this.quads[e],r=e-1<0?this.quads.length-1:e-1,i=this.getNextPosition(n.x,n.y);this.tween=TweenMax.to(n,.25,{x:i.x,y:i.y}),this.delayedCall=TweenMax.delayedCall(.1,function(){t.animateQuad(r)})},n.prototype.getNextPosition=function(e,t){var n=this,r=null;return this.data.forEach(function(i,s){if(i.x==e&&i.y==t)return s+1>n.data.length-1?r=new PIXI.Point(n.data[0].x,n.data[0].y):r=new PIXI.Point(n.data[s+1].x,n.data[s+1].y),!0}),r},n.prototype.transitionIn=function(){var e=this;t.prototype.transitionIn.call(this),!this.tween&&!this.delayedCall?this.animateQuad(6):(this.tween.resume(),this.delayedCall.resume()),window.clearTimeout(this.timeoutId),this.timeoutId=window.setTimeout(function(){return e.timeout()},15e3)},n.prototype.transitionOut=function(){t.prototype.transitionOut.call(this),window.clearTimeout(this.timeoutId)},n.prototype.transitionOutComplete=function(){t.prototype.transitionOutComplete.call(this),this.tween.pause(),this.delayedCall.pause()},n.NAME="loader",n}(e.overlays.Overlay);t.Loader=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){var n=this;t.prototype.init.call(this),this.tfTitle.text=loc("login"),this.form=new gf.input.Form(this.game,"login"),this.form.onSubmit=function(){return n.onLogin()},this.addChild(this.form),this.email=new e.input.TextInput(this.game,this.form,"email"),this.email.maxLength=100,this.email.placeholder=loc("placeholder_email"),this.email.tabIndex=1,this.email.tfTitle.text=loc("placeholder_email"),this.email.type="email",this.email.required=!0,this.email.validation=function(e){return n.emailValidation(e)},this.email.y=this.tfTitle.bottom+e.PADDING*4,this.form.addChild(this.email),this.password=new e.input.TextInput(this.game,this.form,"password"),this.password.maxLength=50,this.password.placeholder=loc("placeholder_password_login"),this.password.tabIndex=2,this.password.type="password",this.password.required=!0,this.password.tfTitle.text=loc("placeholder_password_login"),this.password.validation=function(e){return n.passwordValidation(e)},this.password.y=this.email.bottom+e.PADDING*2,this.form.addChild(this.password),this.cbShowPassword=new e.ui.Checkbox(this.game,loc("bt_show_password")),this.cbShowPassword.y=this.password.bottom+e.PADDING,this.cbShowPassword.on(gf.CLICK,this.onTogglePassword,this),this.addChild(this.cbShowPassword),this.cbAlwaysLogin=new e.ui.Checkbox(this.game,loc("bt_always_login")),this.cbAlwaysLogin.y=this.cbShowPassword.bottom+e.PADDING,this.addChild(this.cbAlwaysLogin),this.btLogin=new e.ui.TextButton(this.game,loc("bt_login"),!0),this.btLogin.on(gf.CLICK,this.form.submit,this.form),this.btLogin.x=gf.utils.Align.centerX(this.btLogin,this.width),this.btLogin.y=this.cbAlwaysLogin.bottom+e.PADDING,this.btLogin.setWidth(this.email.width),this.addChild(this.btLogin),this.tfError=new gf.display.Text(this.game),this.tfError.style=e.TEXT_STYLE_INPUT_ERROR.clone(),this.tfError.style.align=gf.CENTER,this.tfError.style.wordWrapWidth=this.bg.width-44,this.tfError.visible=!1,this.tfError.y=this.btLogin.bottom+e.PADDING*2,this.addChild(this.tfError),this.tfRegister=new gf.display.Text(this.game,loc("login_register"),e.TEXT_STYLE_TITLE_TAB.clone()),this.tfRegister.style.fontSize=13,this.tfRegister.y=this.btLogin.bottom+e.PADDING*4,this.addChild(this.tfRegister),this.btRegister=new e.ui.TextButton(this.game,loc("bt_register"),!1),this.btRegister.y=this.tfRegister.bottom+e.PADDING,this.btRegister.on(gf.CLICK,this.onRegister,this),this.btRegister.setWidth(this.email.width),this.addChild(this.btRegister),this.btForgotPassword=new e.ui.TextButton(this.game,loc("bt_forgot_password"),!1),this.btForgotPassword.on(gf.CLICK,this.onForgotPassword,this),this.btForgotPassword.y=this.btRegister.bottom+e.PADDING*2,this.btForgotPassword.setWidth(this.email.width),this.addChild(this.btForgotPassword),this.bg.height=this.btForgotPassword.bottom-this.bg.y+e.PADDING*4},n.prototype.emailValidation=function(e){this.email.hideError();var t=!1;return kr3m.util.Validator.email(e)?t=!0:this.email.showError(loc("error_input_default")),t},n.prototype.passwordValidation=function(e){this.password.hideError();var t=!1;return e.length>=6&&e.length<=50?t=!0:this.password.showError(loc("error_password")),t},n.prototype.onForgotPassword=function(){track("Login-Forgot_password"),this.emit(gf.LOGIN,!1),this.game.overlays.hide(e.overlays.Login.NAME),this.game.overlays.show(e.overlays.ForgotPassword.NAME)},n.prototype.onRegister=function(){track("Login-Register"),this.emit(gf.LOGIN,!1),this.game.overlays.hide(e.overlays.Login.NAME),this.game.overlays.show(e.overlays.Register.NAME)},n.prototype.onLogin=function(){var t=this;this.form.validate()&&(this.game.overlays.show(e.overlays.Loader.NAME),casClient.loginEmail(this.email.value,this.password.value,function(n){t.game.overlays.hide(e.overlays.Loader.NAME),n==kr3m.SUCCESS?(track("Login-LoggedIn"),t.emit(gf.LOGIN,!0),t.game.overlays.hide(e.overlays.Login.NAME),t.tfError.visible=!1):(t.tfError.text=loc("error_login_failed"),t.tfError.visible=!0),t.onResize()}))},n.prototype.onTogglePassword=function(){this.password.type=this.cbShowPassword.isChecked?"text":"password"},n.prototype.onClose=function(){track("Login-Close"),this.emit(gf.LOGIN,!1),this.game.overlays.hide(e.overlays.Login.NAME)},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.email.x=this.password.x=this.cbShowPassword.x=this.btForgotPassword.x=this.btLogin.x=this.btRegister.x=this.cbAlwaysLogin.x=this.bg.x+22,this.tfRegister.x=this.btRegister.x+(this.btRegister.width-this.tfRegister.width>>1),this.tfError.visible?(this.tfError.x=this.btRegister.x+(this.btRegister.width-this.tfError.width>>1),this.tfRegister.y=this.tfError.bottom+e.PADDING*4):this.tfRegister.y=this.btLogin.bottom+e.PADDING*4,this.btRegister.y=this.tfRegister.bottom+e.PADDING,this.btForgotPassword.y=this.btRegister.bottom+e.PADDING*2,this.bg.height=this.btForgotPassword.bottom-this.bg.y+e.PADDING*4},n.prototype.transitionIn=function(){t.prototype.transitionIn.call(this),this.form.showDom(),this.email.value="",this.password.value="",this.cbShowPassword.isChecked=!1,this.cbAlwaysLogin.isChecked=!1},n.prototype.transitionOut=function(){t.prototype.transitionOut.call(this),this.form.hideDom()},n.NAME="login",n}(e.overlays.Overlay);t.Login=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){t.prototype.init.call(this),this.bg.width=400,this.tfTitle.text=loc("save_login_title"),this.tf=new gf.display.Text(this.game,loc("save_login"),e.TEXT_STYLE_SMALL.clone()),this.tf.style.wordWrap=!0,this.tf.style.wordWrapWidth=this.bg.width-44,this.tf.y=this.tfTitle.bottom+e.PADDING*4,this.addChild(this.tf),this.btLogin=new e.ui.TextButton(this.game,loc("bt_login"),!0),this.btLogin.y=this.tf.bottom+e.PADDING*2,this.btLogin.on(gf.CLICK,this.onLogin,this),this.addChild(this.btLogin),this.bg.height=this.btLogin.bottom-this.bg.y+e.PADDING*4},n.prototype.onLogin=function(){track("LoginToSave-Login"),this.game.overlays.show(e.overlays.Login.NAME),this.onClose()},n.prototype.onClose=function(){track("LoginToSave-Close"),this.game.overlays.hide(e.overlays.LoginToSave.NAME)},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.bg.x=this.game.width-this.bg.width>>1,this.bg.y=this.game.height-this.bg.height>>1,this.btClose.y=this.bg.y+e.PADDING*2+2,this.tfTitle.y=this.bg.y+e.PADDING*2,this.tf.x=this.bg.x+(this.bg.width-this.tf.width>>1),this.tf.y=this.tfTitle.bottom+e.PADDING*4>>0,this.btLogin.x=this.bg.x+(this.bg.width-this.btLogin.width>>1),this.btLogin.y=this.tf.bottom+e.PADDING*2>>0},n.NAME="loginToSave",n}(e.overlays.Overlay);t.LoginToSave=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){t.prototype.init.call(this),this.btReload=new e.ui.TextButton(this.game,loc("bt_reload"),!1),this.btReload.on(gf.CLICK,this.onReload,this),this.addChild(this.btReload),this.text=loc("hint_low_quality"),this.title=loc("hint_low_quality_title",{name:loc("app_title")})},n.prototype.onReload=function(){track("LowQuality-Reload"),location.href=window.location.href+(window.location.href.indexOf("?")==-1?"?":"&")+"lowquality=1"},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.btReload.x=this.bg.x+(this.bg.width-this.btReload.width>>1),this.btReload.y=this.tfMessage.bottom+e.PADDING*2,this.bg.height=this.btReload.bottom-this.bg.y+e.PADDING*4},n.NAME="lowquality",n}(e.overlays.Message);t.LowQuality=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){var n=this;t.prototype.init.call(this),this.form=new gf.input.Form(this.game,"newComment"),this.form.onSubmit=function(){return n.onSubmit()},this.addChild(this.form),this.tfTitle.text=loc("comment_new_title"),this.tfInfo=new gf.display.Text(this.game,loc("comment_info"),e.TEXT_STYLE_DEFAULT.clone()),this.tfInfo.style.fontSize=13,this.tfInfo.style.wordWrap=!0,this.tfInfo.style.wordWrapWidth=this.bg.width-44,this.tfInfo.y=this.tfTitle.bottom+e.PADDING*4,this.addChild(this.tfInfo),this.message=new e.input.TextArea(this.game,this.form,"comment"),this.message.placeholder=loc("placeholder_comment"),this.message.tabIndex=3,this.message.tfTitle.text=loc("placeholder_comment"),this.message.validation=function(e){return n.messageValidation(e)},this.message.required=!0,this.message.setRows(5),this.message.y=this.tfInfo.bottom+e.PADDING*2,this.message.maxLength=500,this.form.addChild(this.message);var r=this.bg.width-44-e.PADDING*2>>1;this.btSubmit=new e.ui.TextButton(this.game,loc("bt_submit"),!0),this.btSubmit.x=e.PADDING,this.btSubmit.y=this.message.bottom+e.PADDING*2,this.btSubmit.on(gf.CLICK,this.onSubmit,this),this.btSubmit.setWidth(r),this.addChild(this.btSubmit),this.btAbort=new e.ui.TextButton(this.game,loc("bt_abort"),!1),this.btAbort.y=this.btSubmit.y,this.btAbort.on(gf.CLICK,this.onClose,this),this.btAbort.setWidth(r),this.addChild(this.btAbort),this.bg.height=this.btAbort.bottom-this.bg.y+e.PADDING*4},n.prototype.messageValidation=function(e){this.message.hideError();var t=!1;return e.length>0?t=!0:this.message.showError(loc("error_input_default")),t},n.prototype.onSubmit=function(){var t=this;this.form.validate()&&(this.game.overlays.show(e.overlays.Loader.NAME),sComment.saveTrackComment(this.trackId,this.message.value,function(){track("NewComment-Submitted"),t.game.overlays.hide(e.overlays.Loader.NAME),t.game.overlays.hide(e.overlays.NewComment.NAME)}))},n.prototype.onClose=function(){track("NewComment-Close"),this.game.overlays.hide(e.overlays.NewComment.NAME)},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.btSubmit.x=this.tfInfo.x=this.message.x=this.bg.x+22,this.btAbort.x=this.bg.x+(this.bg.width-this.btAbort.width-22)},n.prototype.transitionIn=function(){t.prototype.transitionIn.call(this),this.form.showDom(),this.message.value=""},n.prototype.transitionOut=function(){t.prototype.transitionOut.call(this),this.form.hideDom()},n.NAME="newComment",n}(e.overlays.Overlay);t.NewComment=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(e){var n=t.call(this,e)||this;return n.init(),n._isInitialized=!0,n}return __extends(n,t),n.prototype.init=function(){t.prototype.init.call(this),this.phone=new gf.display.Sprite(this.game,"sprites","orientation_phone"),this.phone.anchor.set(.5),this.phone.hAlign(gf.CENTER),this.phone.vAlign(gf.CENTER),this.phone.alpha=0,this.phone.tint=e.COLOR_DARK_GREY,this.addChild(this.phone),this.hook=new gf.display.Sprite(this.game,"sprites","orientation_hook"),this.hook.anchor.set(.5),this.hook.hAlign(gf.CENTER),this.hook.vAlign(gf.CENTER),this.hook.alpha=0,this.addChild(this.hook),this.tf=new gf.display.Text(this.game,loc("orientation_change"),e.TEXT_STYLE_TITLE_HINT.clone()),this.tf.style.align=gf.CENTER,this.addChild(this.tf),this._tl=new TimelineMax({repeat:-1}),this._tl.add(TweenMax.to(this.phone,.25,{alpha:1}),.5),this._tl.add(TweenMax.fromTo(this.phone,1,{angle:0},{angle:-90,ease:Back.easeOut,delay:.25}),.75),this._tl.add(TweenMax.fromTo(this.hook,.75,{scaleX:1.5,scaleY:1.5},{scaleX:1,scaleY:1,ease:Back.easeOut}),1.75),this._tl.add(TweenMax.to(this.hook,.25,{alpha:1}),1.75),this._tl.add(TweenMax.to(this.hook,.25,{alpha:0}),3),this._tl.add(TweenMax.to(this.phone,.25,{alpha:0}),3),this.game.on(gf.RESIZE,this.checkOrientation,this)},n.prototype.addBtClose=function(){},n.prototype.addBg=function(){},n.prototype.addDim=function(){t.prototype.addDim.call(this),this.dim.tint=e.COLOR_WHITE,this.dim.alpha=1,this.dim.y=0},n.prototype.addTitle=function(){},n.prototype.checkOrientation=function(){$(window).width()<$(window).height()?this.isActive||this.transitionIn():this.isActive&&this.transitionOut()},n.prototype.transitionIn=function(){var e=this;t.prototype.transitionIn.call(this),this._tl.play(0),$("#kr3m > form").hide(),setTimeout(function(){return e.onResize()},100)},n.prototype.transitionOutComplete=function(){t.prototype.transitionOutComplete.call(this),this._tl.pause(),$("#kr3m > form").show()},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.phone.hAlign(gf.CENTER),this.phone.vAlign(gf.CENTER),this.hook.x=this.game.width>>1,this.hook.y=this.game.height>>1,this.tf.width=this.game.width-40,this.tf.scaleY=this.tf.scaleX,this.tf.scaleXY=Math.min(1,this.tf.scaleX),this.tf.x=this.game.width-this.tf.width>>1,this.tf.y=(this.game.height>>1)+(this.phone.height>>1)+20,this.dim.width=this.game.width,this.dim.height=this.game.height},n.NAME="orientation",n}(e.overlays.Overlay);t.Orientation=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){var n=this;t.prototype.init.call(this),this.bg.width=400,this.tfMessage.style.wordWrapWidth=this.bg.width-44,this.tfMessage.style.align=gf.LEFT,this.tfSupport=new gf.display.Text(this.game,loc("shop_payment_failed_support"),this.tfMessage.style.clone()),this.tfSupport.y=this.tfMessage.bottom+e.PADDING*8,this.addChild(this.tfSupport),this.btRetry=new e.ui.TextButton(this.game,loc("bt_shop_payment_retry"),!0),this.btRetry.on(gf.CLICK,function(){track("PaymentFailed-Retry"),n.retry()},this),this.btRetry.y=this.tfSupport.bottom+e.PADDING*2,this.addChild(this.btRetry),this.btAbort=new e.ui.TextButton(this.game,loc("bt_shop_payment_abort"),!1),this.btAbort.on(gf.CLICK,this.onClose,this),this.btAbort.y=this.btRetry.y,this.addChild(this.btAbort),this.title=loc("shop_payment_failed_title"),this.text=loc("shop_payment_failed")},n.prototype.onClose=function(){track("PaymentFailed-Close"),this.game.overlays.hide(e.overlays.PaymentFailed.NAME)},n.prototype.transitionOutComplete=function(){this.visible=!1,this.emit(gf.TRANSITION_OUT_COMPLETE)},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.tfMessage.x=this.bg.x+22,this.tfSupport.x=this.bg.x+22,this.btRetry.x=this.bg.x+(this.bg.width-(this.btAbort.width+this.btRetry.width+e.PADDING*2)>>1),this.btAbort.x=this.btRetry.right+e.PADDING*2,this.bg.height=this.btRetry.bottom-this.bg.y+e.PADDING*4},n.NAME="paymentFailed",n}(e.overlays.Message);t.PaymentFailed=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){t.prototype.init.call(this),this.bg.width=424,this.tfMessage.style.wordWrapWidth=this.bg.width-44,this.tfMessage.style.align=gf.LEFT,this.btContinue=new e.ui.TextButton(this.game,loc("bt_shop_payment_continue"),!0),this.btContinue.on(gf.CLICK,this.onClose,this),this.addChild(this.btContinue),this.title=loc("shop_payment_success_title"),this.text=loc("shop_payment_success")},n.prototype.onClose=function(){track("PaymentSuccess-Close"),this.game.overlays.hide(e.overlays.PaymentSuccess.NAME)},n.prototype.addSets=function(){t.prototype.addSets.call(this),this.sets.length==1?this.text=loc("shop_payment_success_1"):this.text=loc("shop_payment_success"),this.onResize()},n.prototype.transitionOutComplete=function(){this.visible=!1,this.emit(gf.TRANSITION_OUT_COMPLETE)},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.setsContainer.x=this.tfMessage.x=this.bg.x+22,this._sets&&this._sets.length<3&&(this.setsContainer.x=this.bg.x+(this.bg.width-this.setsContainer.width>>1)),this.setsContainer.y=this.tfMessage.bottom+e.PADDING*4,this.btContinue.x=this.bg.x+(this.bg.width-this.btContinue.width>>1),this.btContinue.y=this.setsContainer.bottom+e.PADDING*4,this.bg.height=this.btContinue.bottom-this.bg.y+e.PADDING*4},n.NAME="paymentSuccess",n}(e.overlays.AboSets);t.PaymentSuccess=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){var n=this;t.prototype.init.call(this),this.tfTitle.text=loc("publish_title"),this.bg.width=400,this.form=new gf.input.Form(this.game,"forgotPassword"),this.form.onSubmit=function(){return n.onNext()},this.addChild(this.form),this.progress=new gf.display.Sprite(this.game,"sprites","progress_1"),this.progress.y=this.tfTitle.bottom+e.PADDING*4,this.addChild(this.progress),this.trackName=new e.input.TextInput(this.game,this.form,"trackName"),this.trackName.maxLength=e.TRACK_NAME_MAX_LENGTH,this.trackName.placeholder=loc("placeholder_track"),this.trackName.tabIndex=1,this.trackName.tfTitle.text=loc("placeholder_track"),this.trackName.y=this.progress.bottom+e.PADDING*2,this.trackName.validation=function(e){return n.trackNameValidation(e)},this.trackName.on(gf.BLUR,this.onTrackName,this),this.form.addChild(this.trackName),this.tfTrackNameValid=new gf.display.Text(this.game,loc("publish_trackname_accepted"),e.TEXT_STYLE_INPUT_SUCCESS.clone()),this.tfTrackNameValid.style.wordWrapWidth=this.trackName.tfError.style.wordWrapWidth,this.tfTrackNameValid.x=this.trackName.tfError.x,this.tfTrackNameValid.y=this.trackName.tfError.y,this.tfTrackNameValid.visible=!1,this.trackName.addChild(this.tfTrackNameValid);var r=(this.trackName.width>>1)-e.PADDING*2;this.btBack=new e.ui.TextButton(this.game,loc("bt_back"),!1),this.btBack.on(gf.CLICK,this.onBack,this),this.btBack.setWidth(r),this.addChild(this.btBack),this.btNext=new e.ui.TextButton(this.game,loc("bt_next"),!0),this.btNext.on(gf.CLICK,this.onNext,this),this.btNext.setWidth(r),this.addChild(this.btNext),this.btPublish=new e.ui.TextButton(this.game,loc("bt_publish2"),!0),this.btPublish.on(gf.CLICK,this.onPublish,this),this.btPublish.autoFit(),this.btPublish.y=this.btBack.y,this.addChild(this.btPublish),this.tfReviewTitle=new gf.display.Text(this.game,loc("publish_review_title"),e.TEXT_STYLE_SMALL.clone()),this.tfReviewTitle.style.fontFamily=e.DEFAULT_FONT_HEAVY,this.tfReviewTitle.y=this.progress.bottom+e.PADDING*2,this.addChild(this.tfReviewTitle),this.tfReview=new gf.display.Text(this.game,loc("publish_review"),e.TEXT_STYLE_SMALL.clone()),this.tfReview.style.lineHeight=16,this.tfReview.y=this.tfReviewTitle.bottom+e.PADDING,this.addChild(this.tfReview),this.tfReviewValues=new gf.display.Text(this.game,loc("publish_review_values"),e.TEXT_STYLE_SMALL.clone()),this.tfReviewValues.style.lineHeight=16,this.tfReviewValues.y=this.tfReview.y,this.addChild(this.tfReviewValues),this.tfInfo=new gf.display.Text(this.game,loc("publish_info"),e.TEXT_STYLE_SMALL.clone()),this.tfInfo.style.wordWrap=!0,this.tfInfo.style.wordWrapWidth=this.bg.width-44,this.tfInfo.y=this.tfReview.bottom+e.PADDING*4,this.addChild(this.tfInfo),this.step=1},n.prototype.update=function(){this.tfReviewValues.text=mTrack.name+"\n"+locDate("publish_date",mTrack.lastSavedWhen)+"\n"+mTrack.data.evaluation.scoreTotal.toString()},n.prototype.trackNameValidation=function(e){this.trackName.hideError();var t=!1;return e.length>=3?t=!0:this.trackName.showError(loc("error_input_track_name")),t},n.prototype.getUniqueName=function(){var t=this;this.game.overlays.show(e.overlays.Loader.NAME),sTrack.generateUniqueRandomName(loc("trackname_prefix"),function(n){t.game.overlays.hide(e.overlays.Loader.NAME),mTrack.name=n,t.trackName.value=n,t.trackName.showError(loc("error_track_name_taken"))})},n.prototype.onTrackName=function(t){var n=this;this.form.validate()&&(this.trackName.hideError(),this.tfTrackNameValid.visible=!1,this.game.overlays.show(e.overlays.Loader.NAME),sTrack.isNameUnique(mTrack.id,this.trackName.value,function(r){n.game.overlays.hide(e.overlays.Loader.NAME),r?(n.tfTrackNameValid.visible=!0,mTrack.name=n.trackName.value,n.game.stage.header.trackMenu.trackName.value=n.trackName.value,n.update(),t&&t(!0)):(n.getUniqueName(),t&&t(!1))}))},n.prototype.onBack=function(){track("Publish-Back"),this.step--},n.prototype.onNext=function(){var e=this;track("Publish-Next"),this._step==1&&this.onTrackName(function(t){t&&e.step++})},n.prototype.onClose=function(){track("Publish-Close"),this.game.overlays.hide(e.overlays.Publish.NAME)},n.prototype.onPublish=function(){var t=this;track("Publish-Publish"),mTrack.id&&(this.game.overlays.show(e.overlays.Loader.NAME),sTrack.publish(mTrack.id,mTrack.name,function(n){track("Publish-Published"),t.game.overlays.hide(e.overlays.Loader.NAME),t.game.overlays.hide(e.overlays.Publish.NAME);if(n==kr3m.SUCCESS){t.game.stage.header.trackMenu.checkPublish();var r=t.game.overlays.show(e.overlays.Message.NAME);r.text=loc("track_published")}else{var r=t.game.overlays.show(e.overlays.Message.NAME);r.text=loc("error_track_publish")}}))},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.btBack.x=this.tfInfo.x=this.tfReview.x=this.tfReviewTitle.x=this.bg.x+22,this.trackName.x=this.bg.x+(this.bg.width-this.trackName.width>>1),this.tfReviewValues.x=this.tfReview.right+e.PADDING,this.progress.x=this.bg.x+(this.bg.width-this.progress.width>>1),this.btNext.x=this.bg.right-this.btNext.width-22,this.btPublish.x=this.bg.right-this.btPublish.width-22},n.prototype.transitionIn=function(){var e=this;t.prototype.transitionIn.call(this),this.step=1,this.trackName.value=mTrack.name,this.update(),this.onTrackName(function(t){t||e.getUniqueName()})},n.prototype.transitionOut=function(){t.prototype.transitionOut.call(this),this.form.hideDom()},Object.defineProperty(n.prototype,"step",{get:function(){return this._step},set:function(t){this._step=Math.min(2,Math.max(1,t)),this.progress.frameName="progress_"+this._step,this.btPublish.visible=this._step==2,this.tfInfo.visible=this.btPublish.visible,this.tfReview.visible=this.btPublish.visible,this.tfReviewValues.visible=this.btPublish.visible,this.tfReviewTitle.visible=this.btPublish.visible,this.btNext.visible=this._step==1,this.step==1?(this.form.showDom(),this.trackName.visible=!0,this.btBack.y=this.btNext.y=this.trackName.bottom+e.PADDING*4,this.bg.height=this.btNext.bottom-this.bg.y+e.PADDING*4):(this.form.hideDom(),this.trackName.visible=!1,this.btBack.y=this.btPublish.y=this.tfInfo.bottom+e.PADDING*4,this.bg.height=this.btPublish.bottom-this.bg.y+e.PADDING*4),this.btBack.visible=this.step==2},enumerable:!0,configurable:!0}),n.NAME="publish",n}(e.overlays.Overlay);t.Publish=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){var n=this;t.prototype.init.call(this),this.tfTitle.text=loc("register"),this.form=new gf.input.Form(this.game,"register"),this.form.onSubmit=function(){return n.onRegister()},this.addChild(this.form),this.username=new e.input.TextInput(this.game,this.form,"username"),this.username.maxLength=20,this.username.placeholder=loc("placeholder_username"),this.username.tabIndex=1,this.username.tfTitle.text=loc("placeholder_username"),this.username.validation=function(e){return n.usernameValidation(e)},this.username.y=this.tfTitle.bottom+e.PADDING*4,this.form.addChild(this.username),this.email=new e.input.TextInput(this.game,this.form,"email"),this.email.maxLength=100,this.email.placeholder=loc("placeholder_email"),this.email.tabIndex=2,this.email.tfTitle.text=loc("placeholder_email"),this.email.type="email",this.email.validation=function(e){return n.emailValidation(e)},this.email.y=this.username.bottom+e.PADDING*2,this.form.addChild(this.email),this.password=new e.input.TextInput(this.game,this.form,"password"),this.password.maxLength=50,this.password.placeholder=loc("placeholder_password_register"),this.password.tabIndex=3,this.password.type="password",this.password.validation=function(e){return n.passwordValidation(e)},this.password.tfTitle.text=loc("placeholder_password_login"),this.password.y=this.email.bottom+e.PADDING*2,this.form.addChild(this.password),this.cbShowPassword=new e.ui.Checkbox(this.game,loc("bt_show_password")),this.cbShowPassword.y=this.password.bottom+e.PADDING,this.cbShowPassword.on(gf.CLICK,this.onTogglePassword,this),this.addChild(this.cbShowPassword),this.tfTerms=new gf.display.Text(this.game,loc("bt_terms_privacy"),e.TEXT_STYLE_SMALL.clone()),this.tfTerms.style.wordWrap=!0,this.tfTerms.style.wordWrapWidth=this.username.width,this.tfTerms.y=this.cbShowPassword.bottom+e.PADDING*2,this.addChild(this.tfTerms),this.btRegister=new e.ui.TextButton(this.game,loc("bt_register"),!0),this.btRegister.on(gf.CLICK,this.form.submit,this.form),this.btRegister.y=this.tfTerms.bottom+e.PADDING*2,this.btRegister.setWidth(this.username.width),this.addChild(this.btRegister),this.btAlreadyRegistered=new e.ui.TextButton(this.game,loc("bt_already_registered"),!1),this.btAlreadyRegistered.on(gf.CLICK,this.onLogin,this),this.btAlreadyRegistered.y=this.btRegister.bottom+e.PADDING,this.btAlreadyRegistered.setWidth(this.username.width),this.addChild(this.btAlreadyRegistered),this.tfError=new gf.display.Text(this.game),this.tfError.style=e.TEXT_STYLE_INPUT_ERROR.clone(),this.tfError.style.align=gf.CENTER,this.tfError.style.wordWrapWidth=this.bg.width-44,this.tfError.visible=!1,this.tfError.y=this.btAlreadyRegistered.bottom+e.PADDING*2,this.addChild(this.tfError),this.bg.height=this.btAlreadyRegistered.bottom-this.bg.y+e.PADDING*4},n.prototype.emailValidation=function(e){this.email.hideError();var t=!1;return kr3m.util.Validator.email(e)?t=!0:this.email.showError(loc("error_input_default")),t},n.prototype.passwordValidation=function(e){this.password.hideError();var t=!1;return e.length>=6&&e.length<=50?t=!0:this.password.showError(loc("error_password")),t},n.prototype.usernameValidation=function(e){this.username.hideError();var t=!1;return e.length>0?t=!0:this.username.showError(loc("error_input_default")),t},n.prototype.onLogin=function(){track("Register-Login"),this.game.overlays.hide(e.overlays.Register.NAME),this.game.overlays.show(e.overlays.Login.NAME)},n.prototype.onRegister=function(){var t=this;this.form.validate()&&(this.game.overlays.show(e.overlays.Loader.NAME),casClient.registerEmail(this.username.value,this.email.value,this.password.value,!1,{},function(n){t.game.overlays.hide(e.overlays.Loader.NAME),n==kr3m.SUCCESS?(track("Register-Registered"),t.game.overlays.hide(e.overlays.Register.NAME),t.game.overlays.show(e.overlays.FinishRegister.NAME),t.tfError.visible=!1):(t.tfError.text=loc("error_register_failed"),t.tfError.visible=!0),t.onResize()}))},n.prototype.onTogglePassword=function(){this.password.type=this.cbShowPassword.isChecked?"text":"password"},n.prototype.onClose=function(){track("Register-Close"),this.game.overlays.hide(e.overlays.Register.NAME)},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.username.x=this.email.x=this.password.x=this.cbShowPassword.x=this.btRegister.x=this.btAlreadyRegistered.x=this.tfTerms.x=this.cbShowPassword.x=this.bg.x+22,this.tfError.visible?(this.tfError.x=this.btRegister.x+(this.btRegister.width-this.tfError.width>>1),this.bg.height=this.tfError.bottom-this.bg.y+e.PADDING*4):this.bg.height=this.btAlreadyRegistered.bottom-this.bg.y+e.PADDING*4},n.prototype.transitionIn=function(){t.prototype.transitionIn.call(this),this.form.showDom()},n.prototype.transitionOut=function(){t.prototype.transitionOut.call(this),this.form.hideDom()},n.NAME="register",n}(e.overlays.Overlay);t.Register=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){var n=this;t.prototype.init.call(this),this.tfTitle.text=loc("reset_password_title"),this.form=new gf.input.Form(this.game,"resetPassword"),this.form.onSubmit=function(){return n.onSetPassword()},this.addChild(this.form),this.tfInfo=new gf.display.Text(this.game,loc("reset_password"),e.TEXT_STYLE_SMALL.clone()),this.tfInfo.style.wordWrap=!0,this.tfInfo.style.wordWrapWidth=this.bg.width-44,this.tfInfo.y=this.tfTitle.bottom+e.PADDING*4,this.addChild(this.tfInfo),this.passwordNew=new e.input.TextInput(this.game,this.form,"passwordNew"),this.passwordNew.maxLength=50,this.passwordNew.placeholder=loc("placeholder_password_new"),this.passwordNew.tabIndex=1,this.passwordNew.type="password",this.passwordNew.tfTitle.text=loc("placeholder_password_new"),this.passwordNew.validation=function(e){return n.passwordValidationNew(e,n.passwordNew)},this.passwordNew.y=this.tfInfo.bottom+e.PADDING*2,this.form.addChild(this.passwordNew),this.passwordNewRepeat=new e.input.TextInput(this.game,this.form,"passwordNewRepeat"),this.passwordNewRepeat.maxLength=50,this.passwordNewRepeat.placeholder=loc("placeholder_password_new_repeat"),this.passwordNewRepeat.tabIndex=2,this.passwordNewRepeat.type="password",this.passwordNewRepeat.tfTitle.text=loc("placeholder_password_new_repeat"),this.passwordNewRepeat.validation=function(e){return n.passwordValidationNew(e,n.passwordNewRepeat)},this.passwordNewRepeat.y=this.passwordNew.bottom+e.PADDING,this.form.addChild(this.passwordNewRepeat),this.cbShowPasswords=new e.ui.Checkbox(this.game,loc("bt_show_passwords")),this.cbShowPasswords.y=this.passwordNewRepeat.bottom+e.PADDING,this.cbShowPasswords.on(gf.CLICK,this.onTogglePasswords,this),this.addChild(this.cbShowPasswords),this.btResetPassword=new e.ui.TextButton(this.game,loc("bt_reset_password"),!0),this.btResetPassword.on(gf.CLICK,this.onSetPassword,this),this.btResetPassword.y=this.cbShowPasswords.bottom+e.PADDING*2,this.btResetPassword.setWidth(this.passwordNew.width),this.addChild(this.btResetPassword),this.tfError=new gf.display.Text(this.game),this.tfError.style=e.TEXT_STYLE_INPUT_ERROR.clone(),this.tfError.style.wordWrapWidth=this.bg.width-44,this.tfError.visible=!1,this.tfError.y=this.btResetPassword.bottom+e.PADDING*2,this.addChild(this.tfError),this.bg.height=this.btResetPassword.bottom-this.bg.y+e.PADDING*4},n.prototype.passwordValidation=function(e,t){t.hideError();var n=!1;return e.length>=6&&e.length<=50?n=!0:t.showError(loc("error_password")),n},n.prototype.passwordValidationNew=function(e,t){this.passwordNew.hideError(),this.passwordNewRepeat.hideError();var n=!1;return e.length>=6&&e.length<=50?this.passwordNew.value==this.passwordNewRepeat.value?n=!0:t.showError(loc("error_password_mismatch")):t.showError(loc("error_password")),n},n.prototype.onTogglePasswords=function(){this.passwordNew.type=this.cbShowPasswords.isChecked?"text":"password",this.passwordNewRepeat.type=this.cbShowPasswords.isChecked?"text":"password"},n.prototype.onSetPassword=function(){var t=this;this.form.validate()&&(this.game.overlays.show(e.overlays.Loader.NAME),casClient.setPasswordWithToken(this.token,this.passwordNew.value,function(n){t.game.overlays.hide(e.overlays.Loader.NAME);if(n==kr3m.SUCCESS){track("ResetPassword-Success"),t.game.overlays.hide(e.overlays.ResetPassword.NAME),t.tfError.visible=!1;var r=t.game.overlays.show(e.overlays.Message.NAME);r.text=loc("reset_password_set")}else n==kr3m.ERROR_EXPIRED?(track("ResetPassword-Expired"),t.tfError.text=loc("error_password_set"),t.tfError.visible=!0):(track("ResetPassword-Error"),t.tfError.text=loc("error_password_change"),t.tfError.visible=!0);t.onResize()}))},n.prototype.onClose=function(){track("ResetPassword-Close"),this.game.overlays.hide(e.overlays.ResetPassword.NAME)},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.cbShowPasswords.x=this.passwordNew.x=this.passwordNewRepeat.x=this.btResetPassword.x=this.tfError.x=this.tfInfo.x=this.bg.x+22,this.tfError.visible?this.bg.height=this.tfError.bottom-this.bg.y+e.PADDING*4:this.bg.height=this.btResetPassword.bottom-this.bg.y+e.PADDING*4},n.prototype.transitionIn=function(){t.prototype.transitionIn.call(this),this.form.showDom(),this.passwordNew.value="",this.passwordNewRepeat.value="",casClient.logout()},n.prototype.transitionOut=function(){t.prototype.transitionOut.call(this),this.form.hideDom()},n.NAME="resetPassword",n}(e.overlays.Overlay);t.ResetPassword=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){var n=this;t.prototype.init.call(this),this.bg.width=400,this.tfMessage.style.wordWrapWidth=this.bg.width-44,this.tfMessage.style.align=gf.LEFT,this.btRetry=new e.ui.TextButton(this.game,loc("bt_shop_payment_retry"),!0),this.btRetry.on(gf.CLICK,function(){track("RevokeFailed-Retry"),n.retry()},this),this.addChild(this.btRetry),this.btAbort=new e.ui.TextButton(this.game,loc("bt_shop_payment_abort"),!1),this.btAbort.on(gf.CLICK,this.onClose,this),this.addChild(this.btAbort),this.title=loc("shop_abo_revoke_failed_title"),this.text=loc("shop_abo_revoke_failed"),this.btAbort.y=this.btRetry.y=this.tfMessage.bottom+e.PADDING*2},n.prototype.onClose=function(){track("RevokeFailed-Close"),this.game.overlays.hide(e.overlays.RevokeFailed.NAME)},n.prototype.transitionOutComplete=function(){this.visible=!1,this.emit(gf.TRANSITION_OUT_COMPLETE)},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.tfMessage.x=this.bg.x+22,this.btRetry.x=this.bg.x+(this.bg.width-(this.btAbort.width+this.btRetry.width+e.PADDING*2)>>1),this.btAbort.x=this.btRetry.right+e.PADDING*2,this.bg.height=this.btRetry.bottom-this.bg.y+e.PADDING*4},n.NAME="revokeFailed",n}(e.overlays.Message);t.RevokeFailed=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){var n=this;t.prototype.init.call(this),this.bg.width=400,this.tfTitle.text=loc("bt_track_duplicate"),this.content=new gf.display.Container(this.game),this.content.y=this.tfTitle.bottom+e.PADDING*4,this.addChild(this.content),this.tfMessage=new gf.display.Text(this.game,loc("save_changes"),e.TEXT_STYLE_SMALL.clone()),this.tfMessage.style.wordWrap=!0,this.tfMessage.style.wordWrapWidth=this.bg.width-44,this.content.addChild(this.tfMessage),this.form=new gf.input.Form(this.game,"forgotPassword"),this.form.onSubmit=function(){return n.onSubmit()},this.content.addChild(this.form),this.trackName=new e.input.TextInput(this.game,this.form,"trackName"),this.trackName.maxLength=e.TRACK_NAME_MAX_LENGTH,this.trackName.placeholder=loc("placeholder_track"),this.trackName.tabIndex=1,this.trackName.tfTitle.text=loc("placeholder_track"),this.trackName.validation=function(e){return n.trackNameValidation(e)},this.trackName.y=this.tfMessage.bottom+e.PADDING*2,this.trackName.on(gf.BLUR,this.onTrackName,this),this.form.addChild(this.trackName),this.tfTrackNameValid=new gf.display.Text(this.game,loc("publish_trackname_accepted"),e.TEXT_STYLE_INPUT_SUCCESS.clone()),this.tfTrackNameValid.style.wordWrapWidth=this.trackName.tfError.style.wordWrapWidth,this.tfTrackNameValid.x=this.trackName.tfError.x,this.tfTrackNameValid.y=this.trackName.tfError.y,this.tfTrackNameValid.visible=!1,this.trackName.addChild(this.tfTrackNameValid),this.btYes=new e.ui.TextButton(this.game,loc("bt_yes"),!0),this.btYes.y=this.trackName.bottom+e.PADDING*2,this.btYes.on(gf.CLICK,this.onYes,this),this.content.addChild(this.btYes),this.btNo=new e.ui.TextButton(this.game,loc("bt_no"),!1),this.btNo.y=this.btYes.y,this.btNo.on(gf.CLICK,this.onNo,this),this.content.addChild(this.btNo),this.bg.height=this.content.bottom-this.bg.y+e.PADDING*4,this.btClose.visible=!1},n.prototype.getUniqueName=function(){var t=this;this.form.hideDom(),this.game.overlays.show(e.overlays.Loader.NAME),sTrack.generateUniqueRandomName(loc("trackname_prefix"),function(n){t.form.showDom(),t.game.overlays.hide(e.overlays.Loader.NAME),t.trackName.value=n,t.tfTrackNameValid.visible=!0})},n.prototype.trackNameValidation=function(e){this.trackName.hideError();var t=!1;return e.length>=3?t=!0:(this.tfTrackNameValid.visible=!1,this.trackName.showError(loc("error_input_track_name"))),t},n.prototype.onTrackName=function(t){var n=this;this.form.validate()&&(this.trackName.hideError(),this.tfTrackNameValid.visible=!1,this.game.overlays.show(e.overlays.Loader.NAME),sTrack.isNameUnique(mTrack.id,this.trackName.value,function(r){n.game.overlays.hide(e.overlays.Loader.NAME),r?(n.tfTrackNameValid.visible=!0,t&&t()):n.getUniqueName()}))},n.prototype.onSubmit=function(){var e=this;this.onTrackName(function(){track("SaveChanges-Saved"),e.onSave(),e.onClose()})},n.prototype.onNo=function(){this.onQuit&&this.onQuit(),this.onClose()},n.prototype.onYes=function(){var e=this;track("SaveChanges-Save"),this.onTrackName(function(){e.onSave(),e.onClose()})},n.prototype.onClose=function(){track("SaveChanges-Close"),this.game.overlays.hide(e.overlays.SaveChanges.NAME)},n.prototype.transitionIn=function(){t.prototype.transitionIn.call(this),this.getUniqueName(),this.form.showDom()},n.prototype.transitionOut=function(){t.prototype.transitionOut.call(this),this.form.hideDom()},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.bg.x=this.game.width-this.bg.width>>1,this.bg.y=this.game.height-this.bg.height>>1,this.btClose.y=this.bg.y+e.PADDING*2+2,this.tfTitle.y=this.bg.y+e.PADDING*2,this.btYes.x=this.content.width-this.btYes.width-this.btNo.width-e.PADDING*3>>1,this.btNo.x=this.btYes.right+e.PADDING*3,this.content.x=this.bg.x+(this.bg.width-this.content.width>>1),this.content.y=this.tfTitle.bottom+e.PADDING*4},n.NAME="saveChanges",n}(e.overlays.Overlay);t.SaveChanges=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){t.prototype.init.call(this),this.tfTitle.text=loc("select_sets"),this.bg.width=300,this.contentMask=new gf.display.Sprite(this.game,PIXI.Texture.WHITE),this.contentMask.y=this.tfTitle.bottom+e.PADDING*4,this.addChild(this.contentMask),this.content=new gf.display.Container(this.game),this.content.mask=this.contentMask,this.addChild(this.content),this.bounds=new gf.display.Sprite(this.game,PIXI.Texture.WHITE),this.bounds.alpha=.5,this.bounds.tint=16711935,this.content.addChild(this.bounds),this.scrollbar=new e.ui.Scrollbar(this.game),this.scrollbar.on(gf.UPDATE,this.onScrollbar,this),this.scrollbar.visible=!1,this.addChild(this.scrollbar),this.btFilter=new e.ui.TextButton(this.game,loc("bt_apply_sets"),!0),this.btFilter.on(gf.CLICK,this.onFilter,this),this.btFilter.autoFit(),this.addChild(this.btFilter),this.activeSets=this.game.cache.getJSON("sets").active,this.addSets()},n.prototype.addSet=function(t){var n=new e.ui.SelectSetButton(this.game,t);n.isEnabled=!0,n.on(gf.CLICK,this.onSet,this),this.content.addChild(n),this.items.push(n)},n.prototype.addSets=function(){var t=this;this.items=[],e.SET_ORDER.forEach(function(e){t.addSet(e)}),this.onResize()},n.prototype.onFilter=function(){this.gallery.updateSets(this._selectedItems),this.game.overlays.hide(e.overlays.SelectSets.NAME)},n.prototype.onScrollbar=function(){this.bounds.width=this.bounds.height=1,this._minY=this.contentMask.y-this.content.height+this.contentMask.height},n.prototype.onSet=function(){var e=this;this._selectedItems=[],this.items.forEach(function(t){t.isSelected&&t.isEnabled&&e._selectedItems.push(t.setName)})},n.prototype.onDown=function(e){if(this._isDragging)return;if(!this.scrollbar.visible)return;this.on("mouseup mouseupoutside touchend touchendoutside",this.onUp,this),this._dragDistance=0,this.onMove(e)},n.prototype.onMove=function(e){if(this._isDragging){var t=e.data.global.y-this._dragStart;this.content.y=Math.min(this.contentMask.y,Math.max(this._minY,this._startY+t)),this.scrollbar.updateToContentPosition()}else this._isDragging=!0,this._dragStart=e.data.global.y,this._startY=this.content.y,this.on("mousemove touchmove",this.onMove,this),this.emit(gf.DRAG_START)},n.prototype.onUp=function(){this._isDragging&&(this._isDragging=!1,this.removeAllListeners("mousemove mouseup mouseupoutside touchmove touchend touchendoutside"))},n.prototype.onClose=function(){track("SelectSets-Close"),this.game.overlays.hide(e.overlays.SelectSets.NAME)},n.prototype.getItemBySetName=function(e){var t=null;return this.items.forEach(function(n){if(n.setName==e)return t=n,!0}),t},n.prototype.arrange=function(){var t=this;if(this.items.length==0)return;this._itemSize=this.items[1].width;var n=this.contentMask.width-(this.scrollbar.width+e.PADDING*4),r=0,i=0,s=Math.min(n/(this._itemSize+e.PADDING)>>0,5);this.items.forEach(function(n){r==s&&(i++,r=0),n.x=r*t._itemSize+r*e.PADDING*2,n.y=i*t._itemSize+i*e.PADDING,r++}),this.bounds.width=s*this._itemSize+s*e.PADDING*2,this.bounds.height=i*this._itemSize+i*e.PADDING+this._itemSize,this.scrollbar.update(this.content,this.contentMask,0),this.scrollbar.visible||(this.content.x=this.bg.x+(this.bg.width-this.content.width>>1))},n.prototype.update=function(e){var t=this;this.gallery=e,this.gallery.galleryFilters.sets.forEach(function(e){t.getItemBySetName(e).isSelected=!0}),this.onSet(),this.scrollbar.reset(),this.scrollbar.enableMouseWheel(),this.onResize()},n.prototype.transitionOut=function(){t.prototype.transitionOut.call(this),this.scrollbar.disableMouseWheel()},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.bg.width=this.game.width*.75>>0,this.bg.height=this.game.height*.75>>0,this.bg.x=this.game.width-this.bg.width>>1,this.bg.y=this.game.height-this.bg.height>>1,this.btClose.x=this.bg.right-this.btClose.width-e.PADDING*2,this.btClose.y=this.bg.y+e.PADDING*2+2,this.tfTitle.x=this.bg.x+(this.bg.width-this.tfTitle.width>>1),this.tfTitle.y=this.bg.y+e.PADDING*2,this.btFilter.x=this.bg.x+(this.bg.width-this.btFilter.width>>1),this.btFilter.y=this.bg.bottom-this.btFilter.height-e.PADDING*4,this.content.x=this.contentMask.x=this.bg.x+e.PADDING*4,this.content.y=this.contentMask.y=this.scrollbar.y=this.tfTitle.bottom+e.PADDING*4,this.contentMask.width=this.bg.width-e.PADDING*10,this.contentMask.height=this.bg.height-this.btFilter.height-this.tfTitle.height-e.PADDING*10,this.arrange()},n.NAME="selectSets",n}(e.overlays.Overlay);t.SelectSets=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n,r){var i=t.call(this,n)||this;return i.bg=new gf.display.Sprite(i.game,PIXI.Texture.WHITE),i.bg.height=40,i.addChild(i.bg),i.borderL=new gf.display.Sprite(i.game,PIXI.Texture.WHITE),i.borderL.tint=e.COLOR_MID_GREY,i.borderL.width=1,i.borderL.height=i.bg.height,i.addChild(i.borderL),i.borderT=new gf.display.Sprite(i.game,PIXI.Texture.WHITE),i.borderT.tint=e.COLOR_MID_GREY,i.borderT.height=1,i.addChild(i.borderT),i.borderR=new gf.display.Sprite(i.game,PIXI.Texture.WHITE),i.borderR.tint=e.COLOR_MID_GREY,i.borderR.width=1,i.borderR.height=i.bg.height,i.addChild(i.borderR),i.tfLabel=new gf.display.Text(i.game,r,e.TEXT_STYLE_BUTTON_TAB.clone()),i.tfLabel.x=20,i.tfLabel.y=10,i.addChild(i.tfLabel),i.container=new gf.display.Container(i.game),i.container.y=5,i.container.visible=!1,i.addChild(i.container),i.indicatorBg=new gf.display.Sprite(i.game,"sprites","indicator_bg"),i.indicatorBg.tint=e.COLOR_INDICATOR,i.container.addChild(i.indicatorBg),i.tfIndicator=new gf.display.Text(i.game),i.tfIndicator.style=e.TEXT_STYLE_INDICATOR.clone(),i.container.addChild(i.tfIndicator),i.on(gf.CLICK,function(){return i.game.sounds.playFx("fx","click")},i),i.setState(i.currentState),i}return __extends(n,t),n.prototype.setState=function(t){this.tfLabel.style.fill=e.COLOR_DARK_GREY,this.borderL.visible=this.borderT.visible=this._isSelected,this.isFirst&&(this.borderL.visible=!1),this.isLast&&(this.borderR.visible=!1);if(!this._isEnabled){this.tfLabel.style.fill=e.COLOR_MID_GREY;return}if(this._isSelected){this.bg.tint=e.COLOR_WHITE,this.tfLabel.style.fontFamily!=e.TEXT_STYLE_BUTTON_TAB_SELECTED.fontFamily&&(this.tfLabel.style=e.TEXT_STYLE_BUTTON_TAB_SELECTED.clone());return}this.tfLabel.style.fontFamily!=e.TEXT_STYLE_BUTTON_TAB.fontFamily&&(this.tfLabel.style=e.TEXT_STYLE_BUTTON_TAB.clone());switch(this._currentState){case gf.DOWN:this.bg.tint=e.COLOR_GREY;break;case gf.OUT:this.bg.tint=e.COLOR_LIGHT_GREY;break;case gf.OVER:this.bg.tint=e.COLOR_MID_GREY;break;case gf.UP:this.isOver?this.bg.tint=e.COLOR_MID_GREY:this.bg.tint=e.COLOR_LIGHT_GREY}},n.prototype.setHeight=function(e){this.bg.height=this.borderL.height=this.borderR.height=e},n.prototype.setWidth=function(e){this.bg.width=e,this.borderT.width=e,this.borderR.x=e-this.borderR.width,this.container.x=this.tfLabel.right>>0},n.prototype.enable=function(){t.prototype.enable.call(this),this.setState(this._currentState)},n.prototype.disable=function(){t.prototype.disable.call(this),this.setState(this._currentState)},Object.defineProperty(n.prototype,"isSelected",{get:function(){return this._isSelected},set:function(e){if(e==this._isSelected)return;this._isSelected=e,this.setState(this.currentState)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"indicator",{get:function(){return parseInt(this.tfIndicator.text)},set:function(e){this.tfIndicator.text=e.toString(),this.tfIndicator.x=(this.indicatorBg.width-this.tfIndicator.width>>1)+1,this.container.visible=e!=0},enumerable:!0,configurable:!0}),n}(gf.ui.Button);t.TabButton=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n;(function(t){var n=function(t){function n(n,r){var i=t.call(this,n)||this;return i.name=r,i.interactive=!0,i._minY=0,i.contentMask=new gf.display.Sprite(i.game,PIXI.Texture.WHITE),i.addChild(i.contentMask),i.content=new gf.display.Container(i.game),i.content.interactive=!0,i.content.on("touchstart mousedown",i.onDown,i),i.content.mask=i.contentMask,i.addChild(i.content),i.bounds=new gf.display.Sprite(i.game,PIXI.Texture.EMPTY),i.content.addChild(i.bounds),i.scrollbar=new e.ui.Scrollbar(i.game),i.scrollbar.on(gf.UPDATE,i.onScrollbar,i),i.scrollbar.visible=!1,i.addChild(i.scrollbar),i}return __extends(n,t),n.prototype.onScrollbar=function(){this.bounds.width=this.bounds.height=1,this._minY=this.contentMask.y-this.scrollbar.sizeScroll+this.contentMask.height,this.bounds.width=this.contentMask.width,this.bounds.height=this.scrollbar.sizeScroll},n.prototype.onDown=function(e){if(this._isDragging)return;if(!this.scrollbar.visible)return;this.on("mouseup mouseupoutside touchend touchendoutside",this.onUp,this),this._dragDistance=0,this.onMove(e)},n.prototype.onMove=function(e){if(this._isDragging){var t=e.data.global.y-this._dragStart;this.content.y=Math.min(this.contentMask.y,Math.max(this._minY,this._startY+t)),this.scrollbar.updateToContentPosition()}else this._isDragging=!0,this._dragStart=e.data.global.y,this._startY=this.content.y,this.on("mousemove touchmove",this.onMove,this),this.emit(gf.DRAG_START)},n.prototype.onUp=function(){this._isDragging&&(this._isDragging=!1,this.removeAllListeners("mousemove mouseup mouseupoutside touchmove touchend touchendoutside"))},n.prototype.updateSize=function(t,n){this.contentMask.width=Math.max(0,t),this.contentMask.height=Math.max(0,n);var r=-(this.scrollbar.defaultThumb.width+e.PADDING),i=e.PADDING;this.scrollbar.y=this.content.y,this.scrollbar.update(this.content,this.contentMask,r,i)},n.prototype.show=function(){this.visible=!0,this.scrollbar.reset()},n.prototype.hide=function(){this.visible=!1},n}(gf.display.Container);t.Tab=n})(n=t.tabs||(t.tabs={}))})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(e){var n=t.call(this,e)||this;return n.interactive=!0,n.isSmall=!1,n.sameWidth=!0,n.spacing=0,n.maxWidth=n.game.width,n._tabs=[],n._tabButtons=[],n.tabButtons=new gf.display.Container(n.game),n.tabButtons.interactive=!0,n.addChild(n.tabButtons),n.tabContent=new gf.display.Container(n.game),n.tabContent.interactive=!0,n.tabContent.y=40,n.addChild(n.tabContent),n}return __extends(n,t),n.prototype.onTabButton=function(e){if(e.isSelected)return;track("Tab-"+e.tab.name),this.current=e.tab},n.prototype.resizeTabButtons=function(){var e=this;if(this.sameWidth){var t=(this.maxWidth-(this._tabButtons.length-1)*this.spacing)/this._tabButtons.length,n=0;this._tabButtons.forEach(function(r,i){r.setWidth(t),r.x=n,n+=t+e.spacing,r.isFirst=i==0,r.isLast=i==e._tabButtons.length-1})}else{var r=0;this._tabButtons.forEach(function(t,n){t.setWidth(t.tfLabel.width+40),t.x=r,r+=t.tfLabel.width+40+e.spacing,t.isFirst=n==0,t.isLast=n==e._tabButtons.length-1})}},n.prototype.add=function(t,n){var r=this;if(n){var i=new e.ui.TabButton(this.game,n);i.on(gf.CLICK,function(){return r.onTabButton(i)}),i.tab=t,this.isSmall&&(i.setHeight(27),i.tfLabel.style.fontSize=13,i.tfLabel.y=6),this.tabButtons.addChild(i),this._tabButtons.push(i)}this.tabContent.addChild(t),this._tabs.push(t),this.resizeTabButtons()},n.prototype.updateSize=function(e,t){this.size=new PIXI.Point(e,t),this._tabs.forEach(function(n){n.updateSize(e,t)}),this.resizeTabButtons()},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.resizeTabButtons()},n.prototype.getTabButtonByContent=function(e){var t=null;return this._tabButtons.forEach(function(n){if(n.tab==e){t=n;return}}),t},Object.defineProperty(n.prototype,"current",{get:function(){return this._current},set:function(e){var t=this;this._current=e,this._tabButtons.forEach(function(n){n.isSelected=n.tab==e,t.isSmall&&(n.tfLabel.style.fontSize=13),n.isSelected?n.tab.show():n.tab.hide()}),this.emit(gf.CHANGE,this._current)},enumerable:!0,configurable:!0}),n}(gf.display.Container);t.Tabs=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){var t=function(){function e(){}return e}();e.Comment=t})(t=e.vo||(e.vo={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){var t=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.saveTrackComment=function(e,t,n){var r={trackId:e,comment:t};this.callService("Comment.saveTrackComment",r,function(e){return n(e.data,e.status)})},t.prototype.getTrackComment=function(e,t){var n={trackId:e};this.callService("Comment.getTrackComment",n,function(e){return t(e.data,e.status)})},t.prototype.reportAbuse=function(e,t){var n={commentId:e};this.callService("Comment.reportAbuse",n,function(e){return t(e.data,e.status)})},t}(e.Abstract);e.Comment=t})(t=e.stubs||(e.stubs={}))})(cuboro||(cuboro={}));var sComment=new cuboro.stubs.Comment,cuboro;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n)||this;return r.icon=new gf.display.Sprite(r.game,"sprites","icon_report_abuse"),r.addChild(r.icon),r.tfLabel=new gf.display.Text(r.game,loc("bt_report_abuse"),e.TEXT_STYLE_SMALL.clone()),r.tfLabel.x=r.icon.right+e.PADDING,r.addChild(r.tfLabel),r.icon.y=r.tfLabel.height-r.icon.height>>1,r.on(gf.CLICK,function(){return r.game.sounds.playFx("fx","click")},r),r}return __extends(n,t),n.prototype.setState=function(t){this.tfLabel.alpha=1,this.icon.alpha=1;if(!this.isEnabled){this.tfLabel.alpha=.5,this.icon.alpha=.5;return}switch(this._currentState){case gf.DOWN:this.tfLabel.style.fill=e.COLOR_GREY,this.icon.tint=e.COLOR_GREY;break;case gf.OUT:this.tfLabel.style.fill=e.COLOR_DARK_GREY,this.icon.tint=e.COLOR_DARK_GREY;break;case gf.OVER:this.tfLabel.style.fill=e.COLOR_YELLOW,this.icon.tint=e.COLOR_YELLOW;break;case gf.UP:this.isOver?(this.tfLabel.style.fill=e.COLOR_YELLOW,this.icon.tint=e.COLOR_YELLOW):(this.tfLabel.style.fill=e.COLOR_DARK_GREY,this.icon.tint=e.COLOR_DARK_GREY)}},n.prototype.enable=function(){t.prototype.enable.call(this),this.setState(this._currentState)},n.prototype.disable=function(){t.prototype.disable.call(this),this.setState(this._currentState)},n}(gf.ui.Button);t.ReportAbuseButton=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n,r){var i=t.call(this,n)||this;i.comment=r,i.interactive=!0;var s=locDate("comment_date",i.comment.createdWhen),o=loc("comment_title",{username:i.comment.name,date:s});return i.tfTitle=new gf.display.Text(i.game,o),i.tfTitle.style=e.TEXT_STYLE_SMALL_HEAVY.clone(),i.addChild(i.tfTitle),i.tfText=new gf.display.Text(i.game,i.comment.comment),i.tfText.style=e.TEXT_STYLE_SMALL.clone(),i.addChild(i.tfText),i.btReportAbuse=new e.ui.ReportAbuseButton(i.game),i.btReportAbuse.on(gf.CLICK,i.onReportAbuse,i),i.btReportAbuse.isEnabled=mUser.isLoggedIn(),i.addChild(i.btReportAbuse),i}return __extends(n,t),n.prototype.onReportAbuse=function(){var t=this;this.game.overlays.show(e.overlays.Loader.NAME),sComment.reportAbuse(this.comment.id,function(){t.game.overlays.hide(e.overlays.Loader.NAME);var n=t.game.overlays.show(e.overlays.Message.NAME);n.text=loc("abuse_reported")})},Object.defineProperty(n.prototype,"text",{get:function(){return this._text},set:function(e){this._text=e,this.tfText.text=this._text},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"title",{get:function(){return this._title},set:function(e){this._title=e,this.tfTitle.text=this._title,this.tfText.y=this.tfTitle.bottom},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"wordWrapWidth",{get:function(){return this.tfText.style.wordWrapWidth},set:function(t){this.tfText.style.breakWords=!0,this.tfText.style.wordWrap=!0,this.tfText.style.wordWrapWidth=t-this.tfText.x,this.tfTitle.style.wordWrap=!0,this.tfTitle.style.wordWrapWidth=t-this.btReportAbuse.width-e.PADDING*2,this.tfText.y=this.tfTitle.bottom,this.btReportAbuse.x=t-this.btReportAbuse.width-e.PADDING},enumerable:!0,configurable:!0}),n}(gf.display.Container);t.Comment=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n;(function(t){var n=function(t){function n(n){var r=t.call(this,n,"Comments")||this;return r.contentMask.width=480-r.scrollbar.width-20,r.contentMask.height=180,r.contentMask.x=20,r.scrollbar.y=r.contentMask.y,r.content.x=r.contentMask.x,r.content.y=r.contentMask.y,r.btNewComment=new e.ui.TextButton(r.game,loc("bt_new_comment"),!0),r.btNewComment.on(gf.CLICK,r.onNewComment,r),r.btNewComment.x=500-r.btNewComment.width-20,r.btNewComment.y=r.contentMask.bottom+e.PADDING,r.btNewComment.isEnabled=mUser.isLoggedIn(),r.addChild(r.btNewComment),r.tfCount=new gf.display.Text(r.game,loc("comments_empty"),e.TEXT_STYLE_SMALL.clone()),r.tfCount.x=r.contentMask.x,r.tfCount.y=r.btNewComment.y+(r.btNewComment.height-r.tfCount.height>>1),r.tfCount.visible=!1,r.addChild(r.tfCount),r.tfNoComments=new gf.display.Text(r.game,loc("comments_empty"),e.TEXT_STYLE_SMALL.clone()),r.tfNoComments.x=gf.utils.Align.centerX(r.tfNoComments,500),r.tfNoComments.y=gf.utils.Align.centerY(r.tfNoComments,r.contentMask.height),r.tfNoComments.visible=!1,r.addChild(r.tfNoComments),mUser.on("loggedIn",r.onLogin,r),mUser.on("logout",r.onLogout,r),r}return __extends(n,t),n.prototype.onLogin=function(){this.btNewComment.isEnabled=!0;if(!this.items)return;this.items.forEach(function(e){e.btReportAbuse.isEnabled=!0})},n.prototype.onLogout=function(){this.btNewComment.isEnabled=!1;if(!this.items)return;this.items.forEach(function(e){e.btReportAbuse.isEnabled=!1})},n.prototype.addItem=function(t){var n=new e.ui.Comment(this.game,t);n.wordWrapWidth=this.contentMask.width,this.content.addChild(n),this.items.push(n)},n.prototype.onNewComment=function(){var t=this,n=this.game.overlays.show(e.overlays.NewComment.NAME);n.once(gf.TRANSITION_OUT,function(){return t.update(t.track)},this),n.trackId=this.track.id},n.prototype.arrange=function(){this.tfCount.visible=this.items.length!=0,this.tfCount.text=loc("comments_count",{value:this.items.length}),this.tfNoComments.visible=this.items.length==0,this.content.y=this.contentMask.y;var t=0;this.items.forEach(function(n){n.y=t,t+=n.height+e.PADDING*2}),this.scrollbar.update(this.content,this.contentMask)},n.prototype.reset=function(){this.content.removeChildren(),this.items=[]},n.prototype.updateSize=function(e,t){},n.prototype.update=function(t){var n=this;this.track=t,this.reset(),this.game.overlays.show(e.overlays.Loader.NAME),sComment.getTrackComment(this.track.id,function(t){n.game.overlays.hide(e.overlays.Loader.NAME),t.forEach(function(e){n.addItem(e)}),n.arrange()})},n.prototype.show=function(){t.prototype.show.call(this),this.scrollbar.enableMouseWheel()},n.prototype.hide=function(){t.prototype.hide.call(this),this.scrollbar.disableMouseWheel()},n}(e.ui.tabs.Tab);t.Comments=n})(n=t.tabs||(t.tabs={}))})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n,r,i){var s=t.call(this,n)||this;s.track=r,s.type=i,s.bg=new gf.display.Slice3(s.game,10,10,"sprites","bt_text_disabled"),s.bg.width=442-e.PADDING,s.addChild(s.bg);var o=new gf.display.Sprite(s.game,PIXI.Texture.EMPTY);return o.width=s.bg.width,o.height=s.bg.height,s.addChild(o),s.icon=new gf.display.Sprite(s.game,"sprites","icon_successor"),s.icon.tint=e.COLOR_DARK_GREY,s.icon.y=1,s.addChild(s.icon),s.type==e.HISTORY.PREDECESSOR&&(s.icon.frameName="icon_predecessor"),s.tfTrackName=new gf.display.Text(s.game,s.track.name,e.TEXT_STYLE_SMALL.clone()),s.tfTrackName.x=s.icon.right+e.PADDING*2,s.tfTrackName.y=6,s.addChild(s.tfTrackName),s.tfOwner=new gf.display.Text(s.game,s.track.owner.name,e.TEXT_STYLE_SMALL.clone()),s.tfOwner.x=200,s.tfOwner.y=s.tfTrackName.y,s.addChild(s.tfOwner),s.tfScore=new gf.display.Text(s.game,s.track.scoreTotal.toString(),e.TEXT_STYLE_SMALL.clone()),s.tfScore.x=s.bg.width-s.tfScore.width-e.PADDING*2,s.tfScore.y=s.tfOwner.y,s.addChild(s.tfScore),s.icon.visible=s.type!=e.HISTORY.CURRENT,s.bg.visible=s.icon.visible,s.tfTrackName.truncate(s.tfOwner.x-s.tfTrackName.x-e.PADDING*2),s.tfOwner.truncate(s.tfScore.x-s.tfOwner.x-e.PADDING*2),s.type!=e.HISTORY.CURRENT&&(s.interactive=!0,s.buttonMode=!0,s.on("click tap",s.onClick,s)),s}return __extends(n,t),n.prototype.onClick=function(){this.game.sounds.playFx("fx","click");var t=this.game.overlays.currentNames,n;t.indexOf(e.overlays.TrackDetails.NAME)!=-1?n=this.game.overlays.getOverlay(e.overlays.TrackDetails.NAME):n=this.game.overlays.getOverlay(e.overlays.TrackDetailsIngame.NAME),n.transitionIn(),n.track=this.track},n}(gf.display.Container);t.HistoryItem=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n;(function(t){var n=function(t){function n(n){var r=t.call(this,n,"History")||this;return r.iconPredecessor=new gf.display.Sprite(r.game,"sprites","icon_predecessor"),r.iconPredecessor.tint=e.COLOR_DARK_GREY,r.iconPredecessor.x=20,r.addChild(r.iconPredecessor),r.tfPredecessor=new gf.display.Text(r.game,loc("track_predecessor"),e.TEXT_STYLE_SMALL.clone()),r.tfPredecessor.x=r.iconPredecessor.right+e.PADDING,r.tfPredecessor.y=r.iconPredecessor.height-r.tfPredecessor.height>>1,r.addChild(r.tfPredecessor),r.iconSuccessor=new gf.display.Sprite(r.game,"sprites","icon_successor"),r.iconSuccessor.tint=e.COLOR_DARK_GREY,r.iconSuccessor.x=r.tfPredecessor.right+e.PADDING*4,r.addChild(r.iconSuccessor),r.tfSuccessor=new gf.display.Text(r.game,loc("track_successor"),e.TEXT_STYLE_SMALL.clone()),r.tfSuccessor.x=r.iconSuccessor.right+e.PADDING,r.tfSuccessor.y=r.tfPredecessor.y,r.addChild(r.tfSuccessor),r.contentMask.width=480-r.scrollbar.width-20,r.contentMask.x=20,r.contentMask.y=r.iconPredecessor.bottom+e.PADDING,r.contentMask.height=180-r.contentMask.y+27+e.PADDING,r.scrollbar.y=r.contentMask.y,r.content.x=r.contentMask.x,r.content.y=r.contentMask.y,r}return __extends(n,t),n.prototype.arrange=function(){this.content.y=this.contentMask.y,this.items.forEach(function(t,n){t.y=n*t.height+n*e.PADDING}),this.scrollbar.update(this.content,this.contentMask)},n.prototype.reset=function(){this.content.removeChildren(),this.items=[]},n.prototype.addItem=function(t,n){var r=new e.ui.HistoryItem(this.game,t,n);this.content.addChild(r),this.items.push(r)},n.prototype.updateSize=function(e,t){},n.prototype.update=function(t){var n=this;this.track=t,this.reset(),this.game.overlays.show(e.overlays.Loader.NAME),sTrack.getHistory(this.track.id,function(t){n.game.overlays.hide(e.overlays.Loader.NAME),t.previousTracks.forEach(function(t){n.addItem(t,e.HISTORY.PREDECESSOR)}),n.addItem(n.track,e.HISTORY.CURRENT),t.forwardTracks.forEach(function(t){n.addItem(t,e.HISTORY.SUCCESSOR)}),n.arrange()})},n.prototype.show=function(){t.prototype.show.call(this),this.scrollbar.enableMouseWheel()},n.prototype.hide=function(){t.prototype.hide.call(this),this.scrollbar.disableMouseWheel()},n}(e.ui.tabs.Tab);t.History=n})(n=t.tabs||(t.tabs={}))})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n;(function(t){var n=function(t){function n(n){var r=t.call(this,n,"Scores")||this,i=18;return r.tfTitleType=new gf.display.Text(r.game,loc("cube_info_type"),e.TEXT_STYLE_SMALL_HEAVY.clone()),r.tfTitleType.x=20,r.content.addChild(r.tfTitleType),r.tfTitleCount=new gf.display.Text(r.game,loc("cube_info_count"),e.TEXT_STYLE_SMALL_HEAVY.clone()),r.content.addChild(r.tfTitleCount),r.tfTitleValue=new gf.display.Text(r.game,loc("cube_info_value"),e.TEXT_STYLE_SMALL_HEAVY.clone()),r.content.addChild(r.tfTitleValue),r.tfTitleScore=new gf.display.Text(r.game,loc("cube_info_score"),e.TEXT_STYLE_SMALL_HEAVY.clone()),r.content.addChild(r.tfTitleScore),r.tfCubeTitles=new gf.display.Text(r.game,loc("cube_info"),e.TEXT_STYLE_SMALL.clone()),r.tfCubeTitles.style.lineHeight=i,r.tfCubeTitles.x=20,r.tfCubeTitles.y=r.tfTitleType.bottom+e.PADDING,r.content.addChild(r.tfCubeTitles),r.tfCubeValues=new gf.display.Text(r.game),r.tfCubeValues.style=e.TEXT_STYLE_SMALL.clone(),r.tfCubeValues.style.align=gf.RIGHT,r.tfCubeValues.style.lineHeight=i,r.tfCubeValues.y=r.tfCubeTitles.y,r.content.addChild(r.tfCubeValues),r.tfCubeScores=new gf.display.Text(r.game,loc("cube_info_scores"),e.TEXT_STYLE_SMALL.clone()),r.tfCubeScores.y=r.tfCubeTitles.y,r.tfCubeScores.style.lineHeight=i,r.content.addChild(r.tfCubeScores),r.tfCubeScoresValues=new gf.display.Text(r.game),r.tfCubeScoresValues.style=e.TEXT_STYLE_SMALL.clone(),r.tfCubeScoresValues.style.lineHeight=i,r.tfCubeScoresValues.y=r.tfCubeTitles.y,r.content.addChild(r.tfCubeScoresValues),r.tfTitleTotal=new gf.display.Text(r.game,loc("cube_info_total"),e.TEXT_STYLE_SMALL_HEAVY.clone()),r.tfTitleTotal.x=r.tfCubeTitles.x,r.tfTitleTotal.y=r.tfCubeTitles.bottom+e.PADDING*2,r.content.addChild(r.tfTitleTotal),r.tfTitleTotalScore=new gf.display.Text(r.game),r.tfTitleTotalScore.style=e.TEXT_STYLE_SMALL_HEAVY.clone(),r.tfTitleTotalScore.y=r.tfTitleTotal.y,r.content.addChild(r.tfTitleTotalScore),r.tfCubeValues.x=r.tfTitleCount.x=r.tfCubeTitles.right+e.PADDING*2,r.tfCubeScores.x=r.tfTitleValue.x=r.tfTitleCount.right+e.PADDING*2,r.tfCubeScoresValues.x=r.tfTitleScore.x=r.tfTitleTotalScore.x=r.tfTitleValue.right+e.PADDING*4,r}return __extends(n,t),n.prototype.update=function(e){e.data.evaluation.track[4]||(e.data.evaluation.track[4]=0),e.data.evaluation.scoreTrack[4]||(e.data.evaluation.scoreTrack[4]=0),this.tfCubeValues.text=e.data.evaluation.cubes+"\n"+e.data.evaluation.track[0]+"\n"+e.data.evaluation.track[1]+"\n"+e.data.evaluation.track[2]+"\n"+e.data.evaluation.track[3]+"\n"+e.data.evaluation.track[4],this.tfCubeScoresValues.text="= "+e.data.evaluation.scoreCubes+"\n= "+e.data.evaluation.scoreTrack[0]+"\n= "+e.data.evaluation.scoreTrack[1]+"\n= "+e.data.evaluation.scoreTrack[2]+"\n= "+e.data.evaluation.scoreTrack[3]+"\n= "+e.data.evaluation.scoreTrack[4],this.game.client.config.isRussian||(this.tfCubeValues.text+="\n"+e.data.evaluation.substructure,this.tfCubeScoresValues.text+="\n= "+e.data.evaluation.scoreSubstructure),this.tfTitleTotalScore.text="= "+e.data.evaluation.scoreTotal},n}(e.ui.tabs.Tab);t.Scores=n})(n=t.tabs||(t.tabs={}))})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(e){function t(t,n){return e.call(this,t,n)||this}return __extends(t,e),t.prototype.setState=function(e){},t}(e.ui.IconButton);t.StatelessButton=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var gf;(function(e){var t;(function(t){var n=function(){function t(){}return t.getUrl=function(e,t,n,r,i,s){return r&&(t+=(t.indexOf("?")==-1?"?ogdescription=":"&ogdescription=")+encodeURIComponent(r)),i&&(t+=(t.indexOf("?")==-1?"?ogtitle=":"&ogtitle=")+encodeURIComponent(i)),n&&(t+=(t.indexOf("?")==-1?"?ogurl=":"&ogurl=")+encodeURIComponent(n)),s&&(t+=(t.indexOf("?")==-1?"?ogimage=":"&ogimage=")+encodeURIComponent(s)),t},t.share=function(t,n,r){r===void 0&&(r="_blank");switch(t){case e.utils.Social.FACEBOOK:window.open("https://www.facebook.com/sharer/sharer.php?u="+encodeURIComponent(n),r);break;case e.utils.Social.GPLUS:logWarning("Google+ will be discontinued in april 2019!"),window.open("https://plus.google.com/share?url="+encodeURIComponent(n),r);break;case e.utils.Social.XING:window.open("https://www.xing.com/spi/shares/new?url="+encodeURIComponent(n),r);break;case e.utils.Social.TWITTER:window.open("https://twitter.com/intent/tweet?text="+encodeURIComponent(n),r);break;case e.utils.Social.WHATSAPP:top.location.href="WhatsApp://send?text="+n;break;case e.utils.Social.MAIL:top.location.href="mailto:"+n}},t.FACEBOOK="facebook",t.GPLUS="gplus",t.MAIL="mail",t.TWITTER="twitter",t.WHATSAPP="whatsapp",t.XING="xing",t}();t.Social=n})(t=e.utils||(e.utils={}))})(gf||(gf={}));var cuboro;(function(e){var t;(function(t){var n;(function(t){var n=function(t){function n(n){var r=t.call(this,n,"Share")||this;return r.btMail=new e.ui.StatelessButton(r.game,"email"),r.btMail.on(gf.CLICK,r.onMail,r),r.btMail.x=20,r.addChild(r.btMail),r.btFacebook=new e.ui.StatelessButton(r.game,"fb"),r.btFacebook.on(gf.CLICK,r.onFacebook,r),r.btFacebook.x=r.btMail.right+e.PADDING*2,r.addChild(r.btFacebook),r.form=new gf.input.Form(r.game,"share"),r.addChild(r.form),r.link=new e.input.TextInput(r.game,r.form,"trackName"),r.link.tabIndex=1,r.link.tfTitle.text=loc("share_link"),r.link.x=20,r.link.y=r.btMail.bottom+e.PADDING*2,r.link.readOnly=!0,r.link.inputDom.onclick=function(){r.link.inputDom.setSelectionRange(0,r.link.value.length)},r.form.addChild(r.link),r}return __extends(n,t),n.prototype.onMail=function(){var e=loc("share_og_title"),t=loc("share_og_mail",{username:mUser.isLoggedIn()?mUser.getUser().name:"",shorturl:this.shortUrl}),n="?subject="+encodeURIComponent(e)+"&body="+encodeURIComponent(t);gf.utils.Social.share(gf.utils.Social.MAIL,n)},n.prototype.getShareUrl=function(e){var t=location.href;return e&&(t=kr3m.util.Url.setQueryParams(t,e)),t},n.prototype.onFacebook=function(){var e=gf.utils.Social.FACEBOOK,t=this.getShareUrl()+"share.html",n=this.getShareUrl({tid:this.track.id}),r=loc("share_og_description"),i=loc("share_og_title"),s=kr3m.util.StringEx.getBefore(this.getShareUrl(),"?")+this.track.imageUrl,o=gf.utils.Social.getUrl(e,t,n,r,i,s);gf.utils.Social.share(gf.utils.Social.FACEBOOK,o)},n.prototype.update=function(t){var n=this;this.track=t,this.game.overlays.show(e.overlays.Loader.NAME);var r=this.getShareUrl({tid:this.track.id});casClient.getShortUrl(r,function(t){n.game.overlays.hide(e.overlays.Loader.NAME),n.shortUrl=t,n.link.value=n.shortUrl})},n.prototype.show=function(){t.prototype.show.call(this),this.form.showDom()},n.prototype.hide=function(){t.prototype.hide.call(this),this.form.hideDom()},n}(e.ui.tabs.Tab);t.Share=n})(n=t.tabs||(t.tabs={}))})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(e,n){var r=t.call(this,e)||this;return r.bg=new gf.display.Sprite(r.game,PIXI.Texture.WHITE),r.bg.width=150,r.bg.height=150,r.addChild(r.bg),r.preview=new gf.display.Sprite(r.game,PIXI.Texture.EMPTY),r.preview.width=150,r.preview.height=150,r.addChild(r.preview),n&&(r.url=n),r}return __extends(n,t),n.GenerateTexture=function(t,n,r){n===void 0&&(n=150),t.cubes.cubes.forEach(function(e){e.mesh.material=e.isFixed?e.materialFixed:e.materialOut});var i=t.controls.settings.camera.position.clone(),s=e.SCREENSHOT_CAMERA_POSITION;t.camera.position.set(s.x,s.y,s.z),t.spotLight.position.x=s.x-2,t.spotLight.position.y=s.y-2,t.spotLight.position.z=s.z-2,t.spotLight.target.position.copy(e.SCREENSHOT_CAMERA_LOOK_AT),t.camera.lookAt(e.SCREENSHOT_CAMERA_LOOK_AT),t.canvas.renderer.render(t.scene,t.camera);var o=t.canvas.renderer.domElement.toDataURL(),u=new Image;u.src=o,u.onload=function(){var e=new PIXI.Container,s=new PIXI.Texture(new PIXI.BaseTexture(u,PIXI.SCALE_MODES.LINEAR,2)),o=new PIXI.Sprite(s);o.width=n,o.scale.y=o.scale.x,e.addChild(o);var a=t.game.renderer.generateTexture(e,PIXI.SCALE_MODES.LINEAR,2);t.camera.position.set(i.x,i.y,i.z),t.camera.lookAt(t.controls.settings.lookAt),t.spotLight.position.x=i.x-2,t.spotLight.position.y=i.y-2,t.spotLight.position.z=i.z-2,t.spotLight.target.position.copy(t.controls.settings.lookAt),r&&r(a)}},n.GetBase64=function(e,t,n){t===void 0&&(t=150),this.GenerateTexture(e,t,function(t){n(e.game.renderer.extract.base64(t))})},n.GetRenderTexture=function(e,t,n){t===void 0&&(t=150),this.GenerateTexture(e,t,function(e){n(e)})},n.bitwise=function(e){var t=0;if(e.length==0)return t;for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);t=(t<<5)-t+r,t&=t}return t},n.table=function(e){var t="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";return t[e]},n.binaryTransfer=function(e,t){t=t||62;var n=[],r,i="",s=e<0?"-":"";e=Math.abs(e);while(e>=t)r=e%t,e=Math.floor(e/t),n.push(this.table(r));e>0&&n.push(this.table(e));for(var o=n.length-1;o>=0;o--)i+=n[o];return s+i},n.unique=function(e){var t=this.binaryTransfer(this.bitwise(e),61);return t.replace("-","Z")},n.prototype.clear=function(){this.preview.texture&&this.preview.texture.destroy(!0),this.preview.texture=PIXI.Texture.EMPTY},Object.defineProperty(n.prototype,"url",{get:function(){return this._url},set:function(e){if(!e)return;this._url=e,this.clear(),this.preview.texture=PIXI.Texture.fromImage(e+"?_="+PIXI.utils.uid())},enumerable:!0,configurable:!0}),n}(gf.display.Container);t.TrackPreview=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n.game)||this;r.details=n,r.previewBg=new gf.display.Sprite(r.game,PIXI.Texture.WHITE),r.previewBg.tint=e.COLOR_GREY,r.previewBg.width=152,r.previewBg.height=r.previewBg.width,r.addChild(r.previewBg),r.preview=new e.ui.TrackPreview(r.game),r.preview.x=1,r.preview.y=r.preview.x,r.addChild(r.preview);var i=18;return r.tfTitles=new gf.display.Text(r.game,loc("track_info"),e.TEXT_STYLE_SMALL.clone()),r.tfTitles.style.lineHeight=i,r.tfTitles.x=150+e.PADDING*3,r.tfTitles.y=r.preview.y+e.PADDING,r.addChild(r.tfTitles),r.tfValues=new gf.display.Text(r.game),r.tfValues.style=e.TEXT_STYLE_SMALL.clone(),r.tfValues.style.align=gf.RIGHT,r.tfValues.style.lineHeight=i,r.tfValues.x=r.tfTitles.right+e.PADDING,r.tfValues.y=r.tfTitles.y,r.addChild(r.tfValues),r}return __extends(n,t),n.prototype.getTruncatedName=function(t){var n=this.details.bg.width-this.tfTitles.right-e.PADDING-40,r=new gf.display.Text(this.game,t,this.tfValues.style);return r.truncate(n).text},n.prototype.reset=function(){this.tfValues.text=loc("track_info_values",{creator:"-",elementScore:"-",scoreTotal:"-",trackname:"-"}),this.onResize()},n.prototype.update=function(e){var t="-",n="-",r="-",i="-";if(e.data.evaluation){e.data.evaluation.scoreTotal&&(t=e.data.evaluation.scoreTotal.toString());if(e.data.evaluation.cubes>0){var s=e.data.evaluation.track,o=s[0]-s[1]+2*(s[1]-s[2])+3*(s[2]-s[3])+(4*(s[3]-s[4])+5*s[4]),u=e.data.evaluation.cubes,a=o>0?Math.round(o/u*100)/100:0;n=a.toString().replace(".",",")}}e.owner&&(r=e.owner.name),e.lastSavedWhen&&(i=locDate("track_info_last_saved",e.lastSavedWhen)),this.tfValues.text=loc("track_info_values",{creator:r,date:i,scoreElement:n,scoreTotal:t,trackname:this.getTruncatedName(e.name)}),e.imageUrl?this.preview.url=e.imageUrl:this.preview.clear(),this.onResize()},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.tfValues.x=this.details.bg.width-this.tfValues.width-40},n}(gf.display.Container);t.TrackInfo=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){t.prototype.init.call(this),this.tfTitle.text=loc("tab_track_details"),this.trackInfo=new e.ui.TrackInfo(this),this.trackInfo.y=this.tfTitle.bottom+e.PADDING*2,this.addChild(this.trackInfo),this.tabScores=new e.ui.tabs.Scores(this.game),this.tabHistory=new e.ui.tabs.History(this.game),this.tabComments=new e.ui.tabs.Comments(this.game),this.tabShare=new e.ui.tabs.Share(this.game),this.tabs=new e.ui.Tabs(this.game),this.tabs.maxWidth=500,this.tabs.isSmall=!0,this.tabs.sameWidth=!1,this.tabs.add(this.tabScores,loc("bt_track_scores")),this.tabs.add(this.tabHistory,loc("bt_track_history")),this.tabs.add(this.tabComments,loc("bt_track_comments")),this.tabs.add(this.tabShare,loc("bt_track_share")),this.tabs.y=this.trackInfo.bottom+e.PADDING*2,this.tabs.current=this.tabScores,this.tabs.updateSize(500,215),this.tabs.on(gf.CHANGE,this.onTab,this),this.addChild(this.tabs),this.btDuplicate=new e.ui.TextButton(this.game,loc("bt_track_duplicate"),!1),this.btDuplicate.on(gf.CLICK,this.onDuplicate,this),this.btDuplicate.y=this.tabs.bottom+e.PADDING*2,this.addChild(this.btDuplicate),this.btDelete=new e.ui.TextButton(this.game,loc("bt_track_delete"),!1),this.btDelete.on(gf.CLICK,this.onDelete,this),this.btDelete.y=this.btDuplicate.y,this.addChild(this.btDelete),this.btUnpublish=new e.ui.TextButton(this.game,loc("bt_track_unpublish"),!1),this.btUnpublish.on(gf.CLICK,this.onUnpublish,this),this.btUnpublish.y=this.btDuplicate.y,this.addChild(this.btUnpublish),this.btLoad=new e.ui.TextButton(this.game,loc("bt_track_load"),!0),this.btLoad.on(gf.CLICK,this.onLoad,this),this.btLoad.y=this.btDuplicate.y,this.addChild(this.btLoad),this.bg.width=500,this.bg.height=480},n.prototype.onTab=function(e){switch(e){case this.tabComments:this.tabComments.update(this._track);break;case this.tabHistory:this.tabHistory.update(this._track);break;case this.tabScores:break;case this.tabShare:this.tabShare.update(this._track),this.tabShare.show()}e!=this.tabShare&&this.tabShare.hide(),this.btDuplicate.visible=this.btDelete.visible=this.btUnpublish.visible=this.btLoad.visible=e==this.tabScores},n.prototype.onDuplicate=function(){track("TrackDetails-Duplicate"),this.emit(e.overlays.TrackDetails.LOADING),e.core.Loader.loadTrack(this.game,this._track,!0),this.game.overlays.hide(e.overlays.TrackDetails.NAME)},n.prototype.onUnpublish=function(){var t=this;track("TrackDetails-Unpublish"),this.game.overlays.show(e.overlays.Loader.NAME),sTrack.unpublish(this._track.id,function(n){t.game.overlays.hide(e.overlays.Loader.NAME);if(n==kr3m.SUCCESS){t.update(),t.reloadGallery();var r=t.game.overlays.show(e.overlays.Message.NAME);r.text=loc("track_unpublished")}else{var r=t.game.overlays.show(e.overlays.Message.NAME);r.text=loc("error_track_unpublish")}})},n.prototype.reloadGallery=function(){if(this.game.screens.currentName!=e.screens.Start.NAME)return;var t=this.game.screens.current;t.tabGallery.getPage(t.tabGallery.galleryFilters)},n.prototype.onDelete=function(){var t=this;track("TrackDetails-Delete");var n=this.game.overlays.show(e.overlays.Confirm.NAME);n.title=loc("confirm_title"),n.text=loc("confirm_text"),n.confirmCb=function(){t.game.overlays.show(e.overlays.Loader.NAME),sTrack.delete(t._track.id,function(n){t.game.overlays.hide(e.overlays.Loader.NAME);if(n==kr3m.SUCCESS)t.game.overlays.hide(e.overlays.TrackDetails.NAME),t.reloadGallery();else{var r=t.game.overlays.show(e.overlays.Message.NAME);r.text=loc("error_delete_track")}})}},n.prototype.onLoad=function(){track("TrackDetails-Load"),this.emit(e.overlays.TrackDetails.LOADING),e.core.Loader.loadTrack(this.game,this._track,!1),this.game.overlays.hide(e.overlays.TrackDetails.NAME)},n.prototype.onClose=function(){track("TrackDetails-Close"),this.game.overlays.hide(e.overlays.TrackDetails.NAME)},n.prototype.update=function(){var t=this;if(!this.visible)return;this.trackInfo.update(this._track),this.tabScores.update(this._track),this.btUnpublish.isEnabled=!1,this.btDelete.isEnabled=mUser.isLoggedIn()&&this._track.owner.id==mUser.getUserId(),this._track.data.competition&&this._track.data.competition.id?(this.btDelete.isEnabled=!this._track.isSubmitted,this.btUnpublish.isEnabled=!1,this.btDuplicate.isEnabled=!1):this.btDuplicate.isEnabled=!0,this.btDelete.isEnabled&&(this.game.overlays.show(e.overlays.Loader.NAME),sTrack.isPublished(this._track.id,function(n){t.game.overlays.hide(e.overlays.Loader.NAME),n?(t.btDelete.isEnabled=!1,t.btUnpublish.isEnabled=!0):t.btDelete.isEnabled=!0,t._track.isCompetition&&(t.btDelete.isEnabled=!1)})),mUser.isLoggedIn()||(this.btDelete.isEnabled=!1),this.trackInfo.tfValues.x=this.trackInfo.tfTitles.right+e.PADDING},n.prototype.transitionIn=function(){t.prototype.transitionIn.call(this),this.tabs.current=this.tabScores},n.prototype.transitionOut=function(){t.prototype.transitionOut.call(this),this.tabShare.hide(),this.tabComments.scrollbar.disableMouseWheel(),this.tabHistory.scrollbar.disableMouseWheel();if(this.game.screens.currentName==e.screens.Start.NAME){var n=this.game.screens.current;n.tabs.current==n.tabGallery&&n.tabGallery.scrollbar.enableMouseWheel()}},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.btDuplicate.x=this.trackInfo.x=this.bg.x+20,this.tabs.x=this.bg.x,this.btDelete.x=this.btDuplicate.right+e.PADDING,this.btUnpublish.x=this.btDelete.right+e.PADDING,this.btLoad.x=this.bg.right-this.btLoad.width-20},Object.defineProperty(n.prototype,"track",{get:function(){return this._track},set:function(e){this._track=e,this.update()},enumerable:!0,configurable:!0}),n.NAME="trackDetails",n.LOADING="trackLoading",n}(e.overlays.Overlay);t.TrackDetails=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){t.prototype.init.call(this),this.btDuplicate.visible=!1,this.btLoad.visible=!1},n.prototype.onTab=function(e){switch(e){case this.tabComments:this.tabComments.update(this.track);break;case this.tabHistory:this.tabHistory.update(this.track);break;case this.tabScores:break;case this.tabShare:this.tabShare.update(this.track),this.tabShare.show()}e!=this.tabShare&&this.tabShare.hide(),this.btDuplicate.visible=this.btDelete.visible=this.btUnpublish.visible=e==this.tabScores},n.prototype.onClose=function(){track("TrackDetailsIngame-Close"),this.game.overlays.hide(e.overlays.TrackDetailsIngame.NAME)},n.prototype.onDuplicate=function(){track("TrackDetailsIngame-Duplicate"),this.emit(e.overlays.TrackDetails.LOADING),e.core.Loader.loadTrack(this.game,this._track,!0),this.game.overlays.hide(e.overlays.TrackDetailsIngame.NAME)},n.prototype.onDelete=function(){var t=this;track("TrackDetailsIngame-Delete");var n=this.game.overlays.show(e.overlays.Confirm.NAME);n.title=loc("confirm_title"),n.text=loc("confirm_text"),n.confirmCb=function(){t.game.overlays.show(e.overlays.Loader.NAME),sTrack.delete(t._track.id,function(n){t.game.overlays.hide(e.overlays.Loader.NAME);if(n==kr3m.SUCCESS)t.game.overlays.hide(e.overlays.TrackDetailsIngame.NAME),t.game.screens.show(e.screens.Start.NAME);else{var r=t.game.overlays.show(e.overlays.Message.NAME);r.text=loc("error_delete_track")}})}},n.prototype.update=function(){var t=this;this.trackInfo.update(this.track),this.tabScores.update(this.track),this.btUnpublish.isEnabled=!1,this.btDelete.isEnabled=!1,mUser.isLoggedIn()&&this.track.owner.id==mUser.getUserId()?(this.game.overlays.show(e.overlays.Loader.NAME),sTrack.isPublished(this.track.id,function(n){t.game.overlays.hide(e.overlays.Loader.NAME),n?(t.btUnpublish.isEnabled=!0,t.btDelete.isEnabled=!1):t.btDelete.isEnabled=!!mTrack.id,t._track.isCompetition&&(t.btDelete.isEnabled=!1),t._track.isCompetition&&t._track.data.competition.expired&&(t.btDelete.isEnabled=!0)})):(this.btDuplicate.isEnabled=this.btDelete.isEnabled=!this._track.data.competition,this._track.data.competition&&this._track.data.competition.expired&&(this.btDelete.isEnabled=!0)),this.trackInfo.tfValues.x=this.trackInfo.tfTitles.right+e.PADDING,this.onTab(this.tabScores),this.tabs.getTabButtonByContent(this.tabComments).isEnabled=this.tabs.getTabButtonByContent(this.tabHistory).isEnabled=this.tabs.getTabButtonByContent(this.tabShare).isEnabled=!!this.track.id,this.btDuplicate.isEnabled=this.btDelete.isEnabled=!this._track.data.competition,mUser.isLoggedIn()&&this.track.owner.id!=mUser.getUserId()&&(this.btDelete.isEnabled=!1)},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.btDuplicate.x=this.bg.x+20,this.btDelete.x=this.btDuplicate.right+e.PADDING,this.btUnpublish.x=this.btDelete.right+e.PADDING},n.NAME="trackDetailsIngame",n}(e.overlays.TrackDetails);t.TrackDetailsIngame=n})(t=e.overlays||(e.overlays={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){var t=function(e){function t(t){var n=e.call(this,t)||this;return n.hitArea=new PIXI.Rectangle(0,0,n.game.width,n.game.height),n.interactive=!0,n.on("mousemove",function(e){n.emit("onMouseMove",e.data.originalEvent)}),n.on("mousedown rightdown",function(e){n.emit("onMouseDown",e.data.originalEvent)}),n.on("mouseup mouseupoutside rightup rightupoutside",function(e){n.emit("onMouseUp",e.data.originalEvent)}),n.on("mouseout",function(e){n.emit("onMouseOut",e.data.originalEvent)}),n.on("click tap",function(e){n.emit("onClick",e.data.originalEvent)}),n.on("touchstart",function(e){n.emit("onTouchStart",e.data.originalEvent)}),n.on("touchend touchendoutside",function(e){n.emit("onTouchEnd",e.data.originalEvent)}),n.on("touchmove",function(e){n.emit("onTouchMove",e.data.originalEvent)}),document.addEventListener("contextmenu",function(e){e.preventDefault()},!1),n.mouseWheel=new gf.utils.MouseWheel,n.mouseWheel.on(gf.utils.MOUSE_WHEEL,function(e){e.preventDefault(),n.emit("onMouseWheel",e)},n),n}return __extends(t,e),t.prototype.onResize=function(){e.prototype.onResize.call(this),this.hitArea=new PIXI.Rectangle(0,0,this.game.width,this.game.height)},t}(gf.display.Sprite);e.Interaction=t})(t=e.core||(e.core={}))})(cuboro||(cuboro={}));var mTrack=new cuboro.vo.Track,cuboro;(function(e){var t;(function(e){var t;(function(e){var t=function(){function e(){this.edu=!1,this.limit=20,this.offset=0,this.own=!1,this.sortBy="rating"}return e}();e.Filters=t})(t=e.gallery||(e.gallery={}))})(t=e.vo||(e.vo={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){var t;(function(e){var t=function(){function e(){}return e}();e.Page=t})(t=e.gallery||(e.gallery={}))})(t=e.vo||(e.vo={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){var t=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.getPage=function(e,t){var n={filters:e};this.callService("Gallery.getPage",n,function(e){return t(e.data,e.status)})},t}(e.Abstract);e.Gallery=t})(t=e.stubs||(e.stubs={}))})(cuboro||(cuboro={}));var sGallery=new cuboro.stubs.Gallery,cuboro;(function(e){var t;(function(e){var t=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.generateUniqueRandomName=function(e,t){var n={namePrefix:e};this.callService("Track.generateUniqueRandomName",n,function(e){return t(e.data)})},t.prototype.delete=function(e,t){var n={trackId:e};this.callService("Track.delete",n,function(e){return t(e.status)})},t.prototype.unpublish=function(e,t){var n={trackId:e};this.callService("Track.unpublish",n,function(e){return t(e.status)})},t.prototype.publish=function(e,t,n){var r={trackId:e,name:t};this.callService("Track.publish",r,function(e){return n(e.status)})},t.prototype.load=function(e,t){var n={trackId:e};this.callService("Track.load",n,function(e){return t(e.data,e.status)})},t.prototype.save=function(e,t,n,r,i,s,o){var u={trackData:e,name:t,prefixName:n,previousId:r,trackId:i,sets:s};this.callService("Track.save",u,function(e){return o(e.data,e.status)})},t.prototype.saveTrackImage=function(e,t,n,r){var i={trackId:e,name:t,trackImage:n};this.callService("Track.saveTrackImage",i,function(e){return r(e.data)})},t.prototype.isNameUnique=function(e,t,n){var r={trackId:e,newName:t};this.callService("Track.isNameUnique",r,function(e){return n(e.data,e.status)})},t.prototype.isPublished=function(e,t){if(!e)return t(!1,kr3m.SUCCESS);var n={trackId:e};this.callService("Track.isPublished",n,function(e){return t(e.data,e.status)})},t.prototype.getHistory=function(e,t){var n={trackId:e};this.callService("Track.getHistory",n,function(e){return t(e.data,e.status)})},t}(e.Abstract);e.Track=t})(t=e.stubs||(e.stubs={}))})(cuboro||(cuboro={}));var sTrack=new cuboro.stubs.Track,cuboro;(function(e){var t;(function(t){var n=function(){function e(){}return e}(),r=function(){function e(){this.runs=[]}return e}(),i=function(){function t(){this.propMap={angularDamping:"pg.marble.body.angularDamping",angularFactorX:"pg.marble.body.angularFactor.x",angularFactorY:"pg.marble.body.angularFactor.y",angularFactorZ:"pg.marble.body.angularFactor.z",friction:"pg.world.defaultContactMaterial.friction",gravity:"pg.world.gravity.y",linearDamping:"pg.marble.body.linearDamping",linearFactorX:"pg.marble.body.linearFactor.x",linearFactorY:"pg.marble.body.linearFactor.y",linearFactorZ:"pg.marble.body.linearFactor.z",restitution:"pg.world.defaultContactMaterial.restitution",reflectRestitution:"pg.world.narrowphase.reflectRestitution",reflectFriction:"pg.world.narrowphase.reflectFriction",mass:"pg.marble.body.mass"},this.initialized=!1,this.running=!1,this.cancelled=!1}return t.prototype.onMarbleCollision=function(e){e.id===this.pg.ground.body.id&&!this.currentRun.groundTouchPosition&&(this.currentRun.groundTouchPosition=this.pg.marble.body.position.clone(),this.currentRun.groundTouchVelocity=this.pg.marble.body.velocity.clone(),this.currentRun.groundTouchRotation=this.pg.marble.body.quaternion.clone())},t.prototype.showProps=function(){var e={};for(var t in this.propMap)e[t]=kr3m.util.Util.getProperty(this,this.propMap[t]);log("props",e)},t.prototype.setProp=function(e,t){if(!this.propMap[e])return logError("unknown property name:",e);kr3m.util.Util.setProperty(this,this.propMap[e],t),log(e,"set to",t)},t.prototype.cancel=function(){this.cancelled=!0,log("----------------------------------------"),log("automated tests will be cancelled after next run"),log("----------------------------------------")},t.prototype.setDropHeight=function(t,n){e.MARBLE_DROP_HEIGHTS[t]=n,this.pg.gameScreen.bottomMenu.btDropHeight.dropHeight=t},t.prototype.loadTrack=function(t,n){this.pg.once(e.PLAYGROUND_READY,n,this),e.core.Loader.loadTrack(this.pg.game,t,!1)},t.prototype.startRun=function(t,r,i){var s=this;this.currentRun=new n,this.currentRun.cubeMapPosition=t.mapPosition.clone(),this.currentRun.dropHeight=r;var o=Date.now(),u=this.pg.map.getNextEmptyY(t.mapPosition.x,t.mapPosition.z),a=this.pg.map.to3DPos(t.mapPosition.x,u,t.mapPosition.z);this.pg.gameScreen.bottomMenu.btDropHeight.dropHeight=e.MARBLE_DROP_HEIGHTS[r],a.y+=e.MARBLE_DROP_HEIGHTS[r],this.pg.marble.x=a.x,this.pg.marble.y=a.y,this.pg.marble.z=a.z,this.pg.marble.mesh.visible=!0,this.pg.cubes.highlightMarble(!0),this.pg.marble.start(),this.pg.marble.once("stop",function(){s.currentRun.reachedGround=s.pg.marble.isOnGround(),s.currentRun.reachedContainer=s.pg.marble.isInContainer(),s.currentRun.hasSkipped=s.pg.marble.hasSkipped(),s.currentRun.success=!s.currentRun.hasSkipped&&(s.currentRun.reachedGround||s.currentRun.reachedContainer),s.currentRun.duration=Date.now()-o,s.currentRun.duration*=s.pg.physicSpeedFactor,s.currentRun.score=s.pg.evaluation.current.scoreTotal;var t=s.currentRun;s.currentRun=undefined,s.pg.game.overlays.hide(e.overlays.TrackDetailsIngame.NAME),s.pg.game.overlays.hide(e.overlays.Message.NAME),setTimeout(function(){return i(t)},1)})},t.prototype.showRunResult=function(e){var t=["start:",e.cubeMapPosition,"dropHeight:",e.dropHeight,"score:",e.score,"duration:",(e.duration/1e3).toFixed(1)+"s","hasSkipped:",e.hasSkipped,"reachedGround:",e.reachedGround,"reachedContainer:",e.reachedContainer,"groundTouchPosition:",e.groundTouchPosition,"groundTouchVelocity:",e.groundTouchVelocity,"groundTouchRotation:",e.groundTouchRotation];e.success?t.unshift("%cSUCCESS","background-color: green; color: white; padding: 5px;"):t.unshift("%cFAILURE","background-color: red; color: white; padding: 5px;"),log.apply(void 0,t)},t.prototype.runTests=function(t){var n=this;log("testing track",mTrack.id,"-",mTrack.name);var i=new r;i.trackId=mTrack.id,i.trackName=mTrack.name;var s=this.pg.cubes.getHighestStartCubes();if(s.length==0)return i.success=!1,logError("no starting cube found on the highest level"),t(i);kr3m.async.Loop.forEach(s,function(t,r){kr3m.async.Loop.forEachAssoc(e.MARBLE_DROP_HEIGHTS,function(e,r,s){if(n.cancelled)return n.pg.physicSpeedFactor=1,n.running=!1,log("automatic testing cancelled by user");n.startRun(t,e,function(e){i.runs.push(e),n.showRunResult(e),s()})},r)},function(){return t(i)})},t.prototype.showResults=function(e){log("----------------------------------------"),log("test run results"),log("----------------------------------------");var t=0,n=0;for(var r=0;r<e.length;++r){t+=e[r].runs.length;for(var i=0;i<e[r].runs.length;++i)e[r].runs[i].success&&++n}log("successfull",n,"/",t)},t.prototype.init=function(){var e=this;this.initialized=!0,this.pg.marble.body.addEventListener("collide",function(t){return e.onMarbleCollision(t.body)})},t.prototype.run=function(t,n){var r=this;t===void 0&&(t=1);if(this.running)return log("automated tests are already running");this.initialized||this.init(),console.clear(),log("----------------------------------------"),log("running automated tests"),log("----------------------------------------"),this.running=!0,this.cancelled=!1,this.pg.physicSpeedFactor=t;if(!mUser.isLoggedIn())return logError("user is not logged in");var i=new e.vo.gallery.Filters;i.limit=999999999,i.own=!0,sGallery.getPage(i,function(e,t){if(t!=kr3m.SUCCESS)return logError("error while loading tracks");var i=[],s;n?s=e.tracks.filter(function(e){return n.indexOf(e.id)>=0}):s=e.tracks,log("testing "+s.length+" tracks"),kr3m.async.Loop.forEach(s,function(e,t){r.loadTrack(e,function(){r.runTests(function(e){i.push(e);if(r.cancelled)return r.pg.physicSpeedFactor=1,r.running=!1,log("automatic testing cancelled by user");t()})})},function(){r.pg.physicSpeedFactor=1,r.running=!1,log("tests completed"),r.showResults(i)})})},t}();t.Tests=i})(t=e.clientmodels||(e.clientmodels={}))})(cuboro||(cuboro={}));var mTests=new cuboro.clientmodels.Tests,cuboro;(function(e){var t;(function(e){var t=function(e){function t(t,n){var r=e.call(this,t)||this;return r.assets=n,r.on(gf.LOAD_COMPLETE,r.onComplete,r),r}return __extends(t,e),t.prototype.onComplete=function(){this.game.overlays.hide("loader"),this._loaded=!0},t.prototype.loadFile=function(t){var n=this;switch(t.type){case"threeJSON":(new THREE.JSONLoader).load(t.url,function(e,r){t.geometry=e,t.materials=r,n.fileComplete(t)});break;case"texture":(new THREE.TextureLoader).load(t.url,function(e){t.texture=e,n.fileComplete(t)});break;case"cubeTexture":(new THREE.CubeTextureLoader).load(t.url,function(e){t.texture=e,n.fileComplete(t)});break;default:e.prototype.loadFile.call(this,t)}},t.prototype.fileComplete=function(t,n){var r=!0;switch(t.type){case"threeJSON":this.assets.addThreeJSON(t.key,t.url,t.geometry,t.materials);break;case"texture":this.assets.addTexture(t.key,t.url,t.texture);break;case"cubeTexture":this.assets.addTexture(t.key,t.url,t.texture);break;default:r=!1,e.prototype.fileComplete.call(this,t,n)}r&&this.asyncComplete(t)},t.prototype.threeJSON=function(e,t){this.addToFileList("threeJSON",e,t)},t.prototype.texture=function(e,t){this.addToFileList("texture",e,t)},t.prototype.cubeTexture=function(e,t){this.addToFileList("cubeTexture",e,t)},t.prototype.start=function(){this.game.overlays.show("loader"),e.prototype.start.call(this)},Object.defineProperty(t.prototype,"loaded",{get:function(){return this._loaded},enumerable:!0,configurable:!0}),t}(gf.core.Loader);e.AssetLoader=t})(t=e.core||(e.core={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){var t=function(){function e(e){this.playground=e,this.materials={},this.textures={},this.threeJSON={}}return e.prototype.getMesh=function(e){return this.threeJSON[e]?this.threeJSON[e].mesh.clone():null},e.prototype.meshExists=function(e){return this.threeJSON[e]},e.prototype.getMaterial=function(e){var t={};return t.color=16777215,t.map=this.getTexture(e),t.opacity=this.playground.cubeOpacity,t.flatShading=!0,t.side=THREE.DoubleSide,t.transparent=!0,t.reflectivity=0,t.name=e,new THREE.MeshLambertMaterial(t)},e.prototype.getColorMaterial=function(e){var t={};return t.color=e,t.opacity=1,t.flatShading=!0,t.transparent=!1,t.reflectivity=0,new THREE.MeshLambertMaterial(t)},e.prototype.getBody=function(e){var t,n=[],r,i=[],s;for(s=0;s<e.geometry.vertices.length;++s)t=e.geometry.vertices[s],n.push(t.x,t.y,t.z);for(s=0;s<e.geometry.faces.length;++s)r=e.geometry.faces[s],i.push(r.a,r.b,r.c);var o=new CANNON.Body({mass:0});return o.addShape(new CANNON.Trimesh(n,i)),o},e.prototype.getTexture=function(e){return this.textures[e].texture},e.prototype.addTexture=function(e,t,n){this.textures[e]={url:t,texture:n}},e.prototype.addThreeJSON=function(e,t,n,r){var i=new THREE.Mesh(n);this.threeJSON[e]={geometry:n,materials:r,url:t,mesh:i}},e}();e.Assets=t})(t=e.core||(e.core={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(){function t(e,t){var n=this;this.game=e,this._onUpdate=t,this._isRunning=!1,this.view=document.getElementById("playground"),(PIXI.utils.isMobile.tablet||PIXI.utils.isMobile.phone)&&!navigator.isCocoonJS&&$(window).on("focus",function(){$(n.view).hide(),setTimeout(function(){$(n.view).show()},100)}),PIXI.ticker.shared.add(function(){return n.onTick()},this);var r={};r.canvas=this.view,r.alpha=!0,r.antialias=this.game.client.config.useAntiAlias,r.preserveDrawingBuffer=!0,this.renderer=new THREE.WebGLRenderer(r),this.renderer.autoClear=!0}return t.getInstance=function(t,n){return this.instance?this.instance._onUpdate=n:this.instance=new e.core.Canvas(t,n),this.instance},t.prototype.onTick=function(){if(!this._isRunning||this._isPaused)return;this._onUpdate(PIXI.ticker.shared.elapsedMS)},t.prototype.pause=function(){this._isPaused=!0},t.prototype.resume=function(){this._isPaused=!1},t.prototype.start=function(){if(this._isRunning)return;this._isRunning=!0,this.resume(),this.onResize()},t.prototype.stop=function(){if(!this._isRunning)return;this._isRunning=!1,this.pause(),this.renderer.clear()},t.prototype.onResize=function(){var e=1;this.game.renderer.resolution>1&&(e=this.game.client.config.assetsResolution),this.renderer.setSize(this.game.scale.parentWidth*e,this.game.scale.parentHeight*e),this.view.style.width=this.game.scale.styleSize.x+"px",this.view.style.height=this.game.scale.styleSize.y+"px"},t}();t.Canvas=n})(t=e.core||(e.core={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){t.STATE_NONE=-1,t.STATE_ROTATE=0,t.STATE_ZOOM=1,t.STATE_PAN=2;var n=function(){function n(e,n){this._pos=new THREE.Vector3,this.playground=e,this.settings=n,this._mouse=new THREE.Vector2(0,0),this._lastMouse=new THREE.Vector2(0,0),this._state=t.STATE_NONE,this._panStart=new THREE.Vector2,this._panEnd=new THREE.Vector2,this._panDelta=new THREE.Vector2,this._minPan=new THREE.Vector3(-10,-10,-10),this._maxPan=new THREE.Vector3(10,10,10),this._pan=new THREE.Vector3,this.canPan=!0,this.canRotate=!0,this.canZoom=!0,this._distance=this.settings.distance,this._panAngle=this.settings.panAngle,this._tiltAngle=this.settings.tiltAngle,this.lookAt=this.settings.lookAt.clone(),this._zoomStart=new THREE.Vector2,this._zoomEnd=new THREE.Vector2,this._zoomDelta=new THREE.Vector2,this._currentPanAngle=this._panAngle,this._currentTiltAngle=this._tiltAngle,this._lastPanAngle=this._currentPanAngle,this._lastTiltAngle=this._currentTiltAngle,this.settings.interaction.on("onMouseDown",this.onMouseDown,this),this.settings.interaction.on("onMouseMove",this.onMouseMove,this),this.settings.interaction.on("onMouseUp",this.onMouseUp,this),this.settings.interaction.on("onMouseWheel",this.onMouseWheel,this),this.settings.interaction.on("onTouchStart",this.onTouchStart,this),this.settings.interaction.on("onTouchMove",this.onTouchMove,this),this.settings.interaction.on("onTouchEnd",this.onTouchEnd,this),this.enabled=!0,this.reset()}return n.prototype.update=function(t){var n=this;t===void 0&&(t=!1);if(this._tiltAngle!=this._currentTiltAngle||this._panAngle!=this._currentPanAngle)t?(this._currentTiltAngle+=(this._tiltAngle-this._currentTiltAngle)/(this.settings.steps+1),this._currentPanAngle+=(this._panAngle-this._currentPanAngle)/(this.settings.steps+1)):(this._currentPanAngle=this._panAngle,this._currentTiltAngle=this._tiltAngle),Math.abs(this.tiltAngle-this._currentTiltAngle)<.01&&Math.abs(this._panAngle-this._currentPanAngle)<.01&&(this._currentTiltAngle=this._tiltAngle,this._currentPanAngle=this._panAngle);this._pos.x=this.lookAt.x,this._pos.y=this.lookAt.y,this._pos.z=this.lookAt.z,this.settings.camera.position.x=this._pos.x-this._distance*Math.sin(this._currentPanAngle*PIXI.DEG_TO_RAD)*Math.cos(this._currentTiltAngle*PIXI.DEG_TO_RAD),this.settings.camera.position.z=this._pos.z+this._distance*Math.cos(this._currentPanAngle*PIXI.DEG_TO_RAD)*Math.cos(this._currentTiltAngle*PIXI.DEG_TO_RAD),this.settings.camera.position.y=this._pos.y+this._distance*Math.sin(this._currentTiltAngle*PIXI.DEG_TO_RAD)*this.settings.yFactor,this.settings.camera.lookAt(this.lookAt),this.playground.spotLight.position.x=this.settings.camera.position.x-2,this.playground.spotLight.position.y=this.settings.camera.position.y-2,this.playground.spotLight.position.z=this.settings.camera.position.z-2,this.playground.spotLight.target.position.copy(this.lookAt),setTimeout(function(){return n.playground.emit(e.CAMERA_UPDATE)},10)},n.prototype.hideMenus=function(){this.playground.gameScreen.moveMenu.alpha=.25,this.playground.gameScreen.rotateMenu.alpha=.25},n.prototype.showMenus=function(){this.playground.gameScreen.moveMenu.alpha=1,this.playground.gameScreen.rotateMenu.alpha=1},n.prototype.onMouseWheel=function(e){if(this.playground.game.renderer.plugins.interaction.mouse.global.y>this.playground.gameScreen.bottomMenu.y){this.playground.gameScreen.bottomMenu.cubeList.scrollbar.setMouseWheel(e);return}if(!this.canZoom)return;e.delta>0?this.distance*=.95:e.delta<0&&(this.distance/=.95),this.update()},n.prototype.onMouseMove=function(t){if(!this.enabled)return;this._mouse.set(t.clientX,t.clientY);if(this._state==e.core.STATE_ROTATE){if(!this.canRotate)return;this.panAngle=.3*(this._mouse.x-this._lastMouse.x)+this._lastPanAngle,this.tiltAngle=.3*(this._mouse.y-this._lastMouse.y)+this._lastTiltAngle,this.update()}else if(this._state==e.core.STATE_PAN){if(!this.canPan)return;this._panEnd.set(this._mouse.x,this._mouse.y),this._panDelta.subVectors(this._panEnd,this._panStart);var n=this.settings.camera.position.clone().sub(this.lookAt).length(),r=n*Math.tan(this.settings.camera.fov*.5*PIXI.DEG_TO_RAD);this.panLeft(2*this._panDelta.x*r/this.playground.game.height),this.panUp(2*this._panDelta.y*r/this.playground.game.height),this._panStart.copy(this._panEnd),this.lookAt.add(this._pan),this.lookAt.clamp(this._minPan,this._maxPan),this._pan.set(0,0,0),this.update()}},n.prototype.onMouseDown=function(t){if(!this.enabled)return;this.hideMenus(),this._lastPanAngle=this.panAngle,this._lastTiltAngle=this.tiltAngle,this._lastMouse.set(t.clientX,t.clientY);switch(t.button){case 0:if(!this.canRotate)return;this.playground.gameScreen.bottomMenu.btMoveView.isSelected&&this.canPan?(this._state=e.core.STATE_PAN,this._panStart.set(t.clientX,t.clientY)):this._state=e.core.STATE_ROTATE;break;case 2:if(!this.canPan)return;this._state=e.core.STATE_PAN,this._panStart.set(t.clientX,t.clientY)}},n.prototype.onMouseUp=function(){this.showMenus(),this._state=e.core.STATE_NONE,this.playground.emit(e.CAMERA_UPDATED)},n.prototype.onTouchStart=function(t){if(!this.enabled)return;this.hideMenus();var n=t.touches?t.touches.length:1,r=t.touches?t.touches[0].pageX:t.clientX,i=t.touches?t.touches[0].pageY:t.clientY;switch(n){case 1:this.playground.gameScreen.bottomMenu.btMoveView.isSelected&&this.canPan?(this._state=e.core.STATE_PAN,this._panStart.set(r,i)):this.canRotate&&(this._state=e.core.STATE_ROTATE,this._lastPanAngle=this.panAngle,this._lastTiltAngle=this.tiltAngle,this._lastMouse.set(r,i));break;case 2:if(!this.canZoom)return;this._state=e.core.STATE_ZOOM;var s=r-t.touches[1].pageX,o=i-t.touches[1].pageY,u=Math.sqrt(s*s+o*o);this._zoomStart.set(0,u);break;case 3:if(!this.canPan)return;this._state=e.core.STATE_PAN,this._panStart.set(r,i);break;default:this._state=e.core.STATE_NONE}},n.prototype.onTouchMove=function(t){if(this.enabled===!1)return;var n=t.touches?t.touches[0].pageX:t.clientX,r=t.touches?t.touches[0].pageY:t.clientY;switch(this._state){case e.core.STATE_ROTATE:if(!this.canRotate)return;this._mouse.set(n,r),this.panAngle=.3*(this._mouse.x-this._lastMouse.x)+this._lastPanAngle,this.tiltAngle=.3*(this._mouse.y-this._lastMouse.y)+this._lastTiltAngle,this.update();break;case e.core.STATE_ZOOM:if(!this.canZoom)return;var i=n-t.touches[1].pageX,s=r-t.touches[1].pageY,o=Math.sqrt(i*i+s*s);this._zoomEnd.set(0,o),this._zoomDelta.subVectors(this._zoomEnd,this._zoomStart),this._zoomDelta.y>0?this.distance*=.98:this._zoomDelta.y<0&&(this.distance/=.98),this._zoomStart.copy(this._zoomEnd),this.update();break;case e.core.STATE_PAN:if(!this.canPan)return;this._panEnd.set(n,r),this._panDelta.subVectors(this._panEnd,this._panStart);var u=this.settings.camera.position.clone().sub(this.lookAt).length(),a=u*Math.tan(this.settings.camera.fov*.5*PIXI.DEG_TO_RAD);this.panLeft(2*this._panDelta.x*a/this.playground.game.height),this.panUp(2*this._panDelta.y*a/this.playground.game.height),this._panStart.copy(this._panEnd),this.lookAt.add(this._pan),this.lookAt.clamp(this._minPan,this._maxPan),this._pan.set(0,0,0);break;default:this._state=e.core.STATE_NONE}},n.prototype.onTouchEnd=function(){this.showMenus(),this._state=e.core.STATE_NONE,this.playground.emit(e.CAMERA_UPDATED)},n.prototype.reset=function(){this.distance=this.settings.distance,this.panAngle=this.settings.panAngle,this.tiltAngle=this.settings.tiltAngle,this.lookAt=this.settings.lookAt.clone(),this.update()},n.prototype.panLeft=function(e){var t=new THREE.Vector3,n=this.settings.camera.matrix.elements;t.set(n[0],n[1],n[2]),t.multiplyScalar(-e),this._pan.add(t),this.lookAt.add(this._pan),this.lookAt.clamp(this._minPan,this._maxPan),this._pan.set(0,0,0),this.update()},n.prototype.panUp=function(e){var t=new THREE.Vector3,n=this.settings.camera.matrix.elements;t.set(n[4],n[5],n[6]),t.multiplyScalar(e),this._pan.add(t),this.lookAt.add(this._pan),this.lookAt.clamp(this._minPan,this._maxPan),this._pan.set(0,0,0),this.update()},Object.defineProperty(n.prototype,"isDirectionX",{get:function(){var e=new THREE.Vector3(0,-1,0);return e.applyQuaternion(this.settings.camera.quaternion),Math.abs(e.x)>Math.abs(e.z)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"direction",{get:function(){var e=new THREE.Vector3(0,-1,0);return e.applyQuaternion(this.settings.camera.quaternion),this.isDirectionX?e.x*-1>0?1:-1:e.z>0?1:-1},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"distance",{get:function(){return this._distance},set:function(e){if(this._distance==e)return;this._distance=Math.max(this.settings.minDistance,Math.min(this.settings.maxDistance,e)),this.update()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"panAngle",{get:function(){return this._panAngle},set:function(e){e=Math.max(this.settings.minPanAngle,Math.min(this.settings.maxPanAngle,e));if(this._panAngle==e)return;this._panAngle=e,this.update()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"tiltAngle",{get:function(){return this._tiltAngle},set:function(e){e=Math.max(this.settings.minTiltAngle,Math.min(this.settings.maxTiltAngle,e));if(this._tiltAngle==e)return;this._tiltAngle=e,this.update()},enumerable:!0,configurable:!0}),n}();t.Controls=n})(t=e.core||(e.core={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){var t=function(){function e(){this.panAngle=0,this.tiltAngle=10,this.distance=30,this.minDistance=8,this.maxDistance=40,this.minTiltAngle=5,this.maxTiltAngle=89,this.minPanAngle=-Infinity,this.maxPanAngle=Infinity,this.steps=8,this.yFactor=2}return e}();e.ControlsSettings=t})(t=e.core||(e.core={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(){function t(e,t){this.playground=e,this.key=t,this.mapPosition=new THREE.Vector3,this._hits=0,this._isFixed=!1,this._substructureHits=0,this._opacity=1,this.addMesh(),this.playground.scene.add(this.mesh),this.playground.world.addBody(this.body),this.addLayerInfo(),this._lastRotationX=0,this._lastRotationZ=0,this._lastRotationY=0,this._rotationX=0,this._rotationY=0,this._rotationZ=0,this._selected=!1,this._isMirrored=!1,this.materialDown=this.playground.assets.getMaterial("cube-down"),this.materialFixed=this.playground.assets.getMaterial("cube-fixed"),this.materialHighlight=this.playground.assets.getMaterial("cube-highlight"),this.materialHit1=this.playground.assets.getMaterial("cube-hit1"),this.materialHit2=this.playground.assets.getMaterial("cube-hit2"),this.materialHit3=this.playground.assets.getMaterial("cube-hit3"),this.materialHit4=this.playground.assets.getMaterial("cube-hit4"),this.materialHit5=this.playground.assets.getMaterial("cube-hit5"),this.materialOut=this.playground.assets.getMaterial("cube-out"),this.materialOver=this.playground.assets.getMaterial("cube-over"),this.materialSelected=this.playground.assets.getMaterial("cube-selected"),this.materialStuck=this.playground.assets.getMaterial("cube-stuck"),this.mesh.material=this.materialOut,this.id=PIXI.utils.uid().toString()}return t.prototype.addLayerInfo=function(){var t=!1;this.layer&&(t=this.layer.visible,this.layer.material.dispose(),this.playground.scene.remove(this.layer));var n=256,r=128,i=256,s=new PIXI.Container,o=new PIXI.Sprite(PIXI.Texture.EMPTY);o.width=n,o.height=i,s.addChild(o);var u=this.key.indexOf("mk")!=-1?loc("cube_mk_layer"):this.key.indexOf("d")!=-1?loc(this.key):this.key.substr(5),a=new gf.display.Text(this.playground.game,u,e.TEXT_STYLE_LAYER.clone());a.width>o.width-r&&(a.width=o.width-r,a.scaleY=a.scaleX),a.x=n-a.width>>1,a.y=i-a.height>>1,s.addChild(a);var f=new PIXI.CanvasRenderer(n,i,{transparent:!0,resolution:1});f.render(s);var l=new Image;l.src=f.view.toDataURL(),l.width=n,l.height=i,s.destroy({children:!0,texture:!0,baseTexture:!0}),f.destroy(!0);var c=new THREE.Texture(l);c.needsUpdate=!0;var h=new THREE.BoxGeometry(2.01,2.01,2.01),p=new THREE.MeshBasicMaterial({map:c,transparent:!0,depthWrite:!0});this.layer=new THREE.Mesh(h,p),this.layer.name="layer",this.layer.visible=t,this.playground.scene.add(this.layer),this.layer.position.x=this.x,this.layer.position.y=this.y,this.layer.position.z=this.z},t.prototype.setState=function(e){if(this._isFixed)return;if(!e&&this.playground.physicsEnabled){var t=this.playground.game.client.config.isRussian?this._hits:this._hits+this._substructureHits;switch(t){case 0:this.mesh.material=this.materialOut;break;case 1:this.mesh.material=this.materialHit1;break;case 2:this.mesh.material=this.materialHit2;break;case 3:this.mesh.material=this.materialHit3;break;case 4:this.mesh.material=this.materialHit4}t>4&&(this.mesh.material=this.materialHit5),this._isStuck&&(this.mesh.material=this.materialStuck)}else if(e)switch(e){case gf.OUT:this.mesh.material=this.materialOut;break;case gf.OVER:this.mesh.material=this.materialOver;break;case gf.DOWN:this.mesh.material=this.materialDown;break;case gf.SELECTED:this.mesh.material=this.materialSelected;break;case gf.HIGHLIGHT:this.mesh.material=this.materialHighlight}else this._isStuck?this.mesh.material=this.materialStuck:this._isSelected||this._isDown?this.mesh.material=this.materialDown:this.mesh.material=this.materialOut},t.prototype.remove=function(){this.materialFixed.dispose(),this.materialHit1.dispose(),this.materialHit2.dispose(),this.materialHit3.dispose(),this.materialHit4.dispose(),this.materialHit5.dispose(),this.materialOut.dispose(),this.materialOver.dispose(),this.materialDown.dispose(),this.materialSelected.dispose(),this.materialHighlight.dispose(),this.materialStuck.dispose();var e=this.playground.gameScreen.bottomMenu.cubeList.getItemByKey(this.key);e&&e.remaining++,this.playground.world.remove(this.body),this.playground.scene.remove(this.mesh),this.playground.scene.remove(this.layer)},t.prototype.addMesh=function(e){e===void 0&&(e=!1);var t,n,r;this.mesh&&e&&(t=new THREE.Vector3(this.mesh.rotation.x,this.mesh.rotation.y,this.mesh.rotation.z),n=new THREE.Vector3(this._rotationX,this._rotationY,this._rotationZ),r=new THREE.Vector3(this._lastRotationX,this._lastRotationY,this._lastRotationZ));if(e){var i=this._isMirrored?this.key:this.key+"_mirrored";this._isMirrored=!this._isMirrored,this.playground.scene.remove(this.mesh),this.playground.world.remove(this.body),this.mesh=this.playground.assets.getMesh(i),this.mesh.material=this.materialOut,this.mesh.name=this.key,this.body=this.playground.assets.getBody(this.mesh),this.playground.scene.add(this.mesh),this.playground.world.addBody(this.body)}else this.mesh=this.playground.assets.getMesh(this.key),this.body=this.playground.assets.getBody(this.mesh),this.mesh.name=this.key;this.mesh.userData.body=this.body,this.mesh.userData.cube=this,e&&(this._lastRotationX=r.x,this._lastRotationY=r.y,this._lastRotationZ=r.z,this._rotationX=n.x,this._rotationY=n.y,this._rotationZ=n.z,this.mesh.rotation.x=t.x,this.mesh.rotation.y=t.y,this.mesh.rotation.z=t.z,this.playground.cubes.update(this,!1))},t.prototype.reset=function(){this.mesh.material=this._isFixed?this.materialFixed:this.materialOut,this._hits=0,this._isStuck=!1,this.highlight(!1),this._substructureHits=0},t.prototype.drop=function(){var t=this;TweenMax.to(this,.5,{y:this.playground.map.yTo3DPos(this.mapPosition.y),ease:Bounce.easeOut,onUpdate:function(){t.playground.gameScreen.moveMenu.visible&&t.playground.emit(e.CUBE_UPDATE)}})},Object.defineProperty(t.prototype,"rotationX",{get:function(){return this._rotationX},set:function(e){this._rotationX=e;var t=this._rotationX-this._lastRotationX,n=new THREE.Matrix4;n.makeRotationAxis(new THREE.Vector3(1,0,0).normalize(),t),n.multiply(this.mesh.matrix),this.mesh.matrix=n,this.mesh.rotation.setFromRotationMatrix(this.mesh.matrix),this._lastRotationX=this._rotationX},enumerable:!0,configurable:!0}),t.prototype.resetRotationX=function(){this._rotationX=0,this._lastRotationX=0},Object.defineProperty(t.prototype,"rotationY",{get:function(){return this._rotationY},set:function(e){this._rotationY=e;var t=this._rotationY-this._lastRotationY,n=new THREE.Matrix4;n.makeRotationAxis(new THREE.Vector3(0,1,0).normalize(),t),n.multiply(this.mesh.matrix),this.mesh.matrix=n,this.mesh.rotation.setFromRotationMatrix(this.mesh.matrix),this._lastRotationY=this._rotationY},enumerable:!0,configurable:!0}),t.prototype.resetRotationY=function(){this._rotationY=0,this._lastRotationY=0},Object.defineProperty(t.prototype,"rotationZ",{get:function(){return this._rotationZ},set:function(e){this._rotationZ=e;var t=this._rotationZ-this._lastRotationZ,n=new THREE.Matrix4;n.makeRotationAxis(new THREE.Vector3(0,0,1).normalize(),t),n.multiply(this.mesh.matrix),this.mesh.matrix=n,this.mesh.rotation.setFromRotationMatrix(this.mesh.matrix),this._lastRotationZ=this._rotationZ},enumerable:!0,configurable:!0}),t.prototype.resetRotationZ=function(){this._rotationZ=0,this._lastRotationZ=0},t.prototype.highlight=function(e){if(this._isFixed)return;this.setState(e?gf.HIGHLIGHT:gf.OUT)},t.prototype.fromString=function(e){var t=JSON.parse(e);this.mapPosition.set(t.map.x,t.map.y,t.map.z),this.mesh.rotation.set(t.rot._x,t.rot._y,t.rot._z),this.isFixed=t.isFixed},t.prototype.toString=function(){var e={};return e.map=this.mapPosition,e.key=this.key,e.rot=this.mesh.rotation,e.isFixed=this._isFixed,JSON.stringify(e)},Object.defineProperty(t.prototype,"isSelected",{get:function(){return this._isSelected},set:function(e){if(this._isFixed)return;this._isSelected=e,this.setState(this.isSelected?gf.SELECTED:this.isOver?gf.OVER:gf.OUT)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isOver",{get:function(){return this._isOver},set:function(e){if(this._isFixed)return;this._isOver=e,this.isSelected||this.setState(this.isOver?gf.OVER:gf.OUT)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isDown",{get:function(){return this._isDown},set:function(e){if(this._isFixed)return;this._isDown=e,this.isSelected||this.setState(this._isDown?gf.DOWN:this.isOver?gf.OVER:gf.OUT)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isStuck",{get:function(){return this._isStuck},set:function(e){if(this._isFixed)return;this._isStuck=e,this.setState()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scale",{get:function(){return this.mesh.scale.x},set:function(e){this.mesh.scale.x=e,this.mesh.scale.y=e,this.mesh.scale.z=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"x",{get:function(){return this.body.position.x},set:function(e){this.mesh.position.x=e,this.body.position.x=e,this.layer.position.x=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this.body.position.y},set:function(e){this.mesh.position.y=e,this.body.position.y=e,this.layer.position.y=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"z",{get:function(){return this.body.position.z},set:function(e){this.mesh.position.z=e,this.body.position.z=e,this.layer.position.z=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hits",{get:function(){return this._hits},set:function(e){this._hits=e,this.setState()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"substructureHits",{get:function(){return this._substructureHits},set:function(e){this._substructureHits=e,this.setState()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"opacity",{get:function(){return this._opacity},set:function(e){this._opacity=e,this.materialFixed.opacity=this._opacity,this.materialHit1.opacity=this._opacity,this.materialHit2.opacity=this._opacity,this.materialHit3.opacity=this._opacity,this.materialHit4.opacity=this._opacity,this.materialHit5.opacity=this._opacity,this.materialOut.opacity=this._opacity,this.materialOver.opacity=this._opacity,this.materialDown.opacity=this._opacity,this.materialSelected.opacity=this._opacity,this.materialHighlight.opacity=this._opacity,this.materialStuck.opacity=this._opacity,this.mesh.material.opacity=this._opacity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isFixed",{get:function(){return this._isFixed},set:function(e){this._isFixed=e,this._isFixed?this.mesh.material=this.materialFixed:this.setState()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isMirrored",{get:function(){return this._isMirrored},enumerable:!0,configurable:!0}),t}();t.Cube=n})(t=e.core||(e.core={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(){function t(e){this.playground=e,this.cubes=[]}return t.prototype.remove=function(t,n){n===void 0&&(n=!1),t||(t=this.selected);if(!t)return;n||this.playground.map.setAt(e.EMPTY,t.mapPosition);var r=this.cubes.indexOf(t);r!=-1&&this.cubes.splice(r,1),t.remove(),t==this.selected&&(this.selected=null),this.updateY(),this.playground.placeables.update()},t.prototype.reset=function(){this._selected=null,this._down=null,this._over=null,this._swapping=null,this.cubes=[]},t.prototype.replaceRandom=function(){this.cubes.forEach(function(t){e.CUBES_RANDOM.indexOf(t.key)!=-1&&Math.random()<.5&&(t.addMesh(!0),t.addLayerInfo())})},t.prototype.swap=function(t){var n=this.selected.mapPosition.x,r=this.selected.mapPosition.y,i=this.selected.mapPosition.z;this.selected.mapPosition.x=t.mapPosition.x,this.selected.mapPosition.y=t.mapPosition.y,this.selected.mapPosition.z=t.mapPosition.z,t.mapPosition.x=n,t.mapPosition.y=r,t.mapPosition.z=i,this.update(t,!1),this.update(this.selected,!1),this.updateY(),this.playground.emit(e.SWAP)},t.prototype.getCubesBeyond=function(t){var n=[],r=this.getById(t).mapPosition.clone(),i;for(var s=r.y-1;s>=0;--s)i=this.playground.map.getAt(r.x,s,r.z),i&&i!=e.EMPTY&&n.push(this.getById(i));return n},t.prototype.getCubesAbove=function(t){var n=[],r=this.getById(t).mapPosition.clone();for(var i=r.y+1;i<e.MAX_Y;++i){var s=this.playground.map.getAt(r.x,i,r.z);s&&s!=e.EMPTY&&n.push(this.getById(s))}return n},t.prototype.getCubeAbove=function(t){var n=this.getById(t).mapPosition.clone(),r=this.playground.map.getAt(n.x,n.y+1,n.z);return r&&r!=e.EMPTY?this.getById(r):null},t.prototype.getById=function(e){var t=null;return this.cubes.forEach(function(n){if(n.id==e)return t=n,!0}),t},t.prototype.getHighestCube=function(t,n){for(var r=this.playground.maxY-1;r>=0;--r){var i=this.playground.map.getAt(t,r,n);if(i!=e.EMPTY)return this.getById(i)}return this.getById(e.EMPTY)},t.prototype.removeCubes=function(){while(this.cubes.length)this.remove(this.cubes[0]);this.cubes=[]},t.prototype.getHighestStartCubes=function(){var t=this.cubes.filter(function(t){return e.START_CUBES.indexOf(t.key)>=0}),n=0;for(var r=0;r<t.length;++r)n=Math.max(n,t[r].mapPosition.y);return t.filter(function(e){return e.mapPosition.y==n})},t.prototype.highlightMarble=function(t){this.cubes.forEach(function(n){e.START_CUBES.indexOf(n.key)!=-1&&n.highlight(t)})},t.prototype.update=function(e,t){t===void 0&&(t=!0);if(!e&&!this.selected)return;e||(e=this.selected),this.cubes.indexOf(e)==-1&&this.cubes.push(e);var n=e.mapPosition;this.playground.map.setAt(e.id,n),this.updatePosition(e),this.playground.placeables.update(),t&&this.updateY()},t.prototype.updatePosition=function(e){var t=this.playground.map.to3DPos(e.mapPosition);e.x=t.x,e.y=t.y,e.z=t.z},t.prototype.updateY=function(){var t=!1;for(var n=0;n<this.cubes.length;++n){var r=this.cubes[n];if(r.mapPosition.y>0&&this.playground.map.getAt(r.mapPosition.x,r.mapPosition.y-1,r.mapPosition.z)==e.EMPTY){this.playground.map.setAt(e.EMPTY,r.mapPosition),r.mapPosition.y=r.mapPosition.y-1,this.playground.map.setAt(r.id,r.mapPosition),r.drop(),t=!0;break}}t&&this.updateY()},t.prototype.getCubes=function(){var e=[];return this.cubes.forEach(function(t){t.isFixed||e.push(t.toString())}),e},t.prototype.setCubes=function(t,n){var r=this,i=[];return t.forEach(function(t){var s=kr3m.util.Json.decode(t).key;if(!r.playground.assets.meshExists(s))return;var o=new e.core.Cube(r.playground,s);o.fromString(t),o.isFixed=n;var u=r.playground.gameScreen.bottomMenu.cubeList.getItemByKey(o.key);u&&u.remaining--,r.update(o,!1),i.push(o.id)}),this.updateY(),i},Object.defineProperty(t.prototype,"over",{get:function(){return this._over},set:function(e){this._over!=e&&(this._over&&(this._over.isOver=!1),this._over=e,this._over&&(this._over.isOver=!0))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"down",{get:function(){return this._down},set:function(e){this._down!=e&&(this._down&&(this._down.isDown=!1),this._down=e,this._down&&(this._down.isDown=!0))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"selected",{get:function(){return this._selected},set:function(t){var n=this.playground.gameScreen.rotateMenu,r=this.playground.gameScreen.moveMenu;this._selected!=t?(this._selected&&(this._selected.isSelected=!1),this._selected=t,this.playground.emit(e.CUBE_SELECTED,this._selected),this._selected?(this._selected.isSelected=!0,this.playground.gameScreen.bottomMenu.btMoveCube.isSelected?r.show():n.show()):this.playground.emit(e.CUBE_DESELECTED)):this._selected&&(this._selected.isSelected=!1,this._selected=null,this.playground.emit(e.CUBE_DESELECTED))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"swapping",{get:function(){return this._swapping},set:function(e){this._swapping=e},enumerable:!0,configurable:!0}),t}();t.Cubes=n})(t=e.core||(e.core={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(){function t(e){this.playground=e,this.reset()}return t.prototype.reset=function(){this.current=new e.vo.EvaluationData,this.current.cubes=0,this.current.track=[0,0,0,0,0],this.current.substructure=0,this.current.scoreCubes=0,this.current.scoreTotal=0,this.current.scoreTrack=[0,0,0,0,0],this.current.scoreSubstructure=0},t.prototype.calculate=function(){var e=this;this.reset();var t=[],n=this.playground.marble.collisions;this.playground.cubes.cubes.forEach(function(r){var i=!1;n.forEach(function(n){!i&&n.cube.id==r.id&&(i=!0,t.indexOf(n.cube.id)==-1&&(e.current.cubes++,t.push(n.cube.id)))}),i||n.forEach(function(n){var s=e.playground.cubes.getCubesBeyond(n.cube.id);s.forEach(function(n){!i&&n&&n.id==r.id&&(t.indexOf(n.id)==-1&&(e.current.cubes++,t.push(n.id)),i=!0)})})}),this.current.trackCubeIds=t,this.current.scoreCubes=this.current.cubes,this.current.scoreTrack=[0,0,0,0,0],this.current.scoreSubstructure=0;var r=[];n.forEach(function(e){r.indexOf(e.cube)==-1&&r.push(e.cube)}),this.playground.cubes.cubes.forEach(function(t){t.hits>=1&&(e.current.track[0]++,e.current.scoreTrack[0]+=2),t.hits>=2&&(e.current.track[1]++,e.current.scoreTrack[1]+=2),t.hits>=3&&(e.current.track[2]++,e.current.scoreTrack[2]+=2),t.hits>=4&&(e.current.track[3]++,e.current.scoreTrack[3]+=2),t.hits>=5&&(e.current.track[4]+=t.hits-4,e.current.scoreTrack[4]+=(t.hits-4)*2),e.current.substructure+=t.substructureHits,e.current.scoreSubstructure+=t.substructureHits*2,e.current.cubesById.push({id:t.id,hits:t.hits,cubeNo:t.key.split("_")[1]})}),this.playground.game.client.config.isRussian&&(this.current.scoreSubstructure=0),this.current.scoreTotal=this.current.scoreCubes+this.current.scoreTrack[0]+this.current.scoreTrack[1]+this.current.scoreTrack[2]+this.current.scoreTrack[3]+this.current.scoreTrack[4]+this.current.scoreSubstructure,mTrack.data.evaluation=this.current,this.playground.game.stage.header.trackMenu.checkPublish(),this.playground.game.stage.header.trackMenu.checkSubmit()},t}();t.Evaluation=n})(t=e.core||(e.core={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(){function t(e){this.playground=e,this.createBody(),this.createGround(),this.createMap()}return t.prototype.createBody=function(){this.body=new CANNON.Body({mass:0}),this.body.addShape(new CANNON.Plane),this.body.quaternion.setFromAxisAngle(new CANNON.Vec3(1,0,0),-Math.PI/2),this.body.position=new CANNON.Vec3(1,0,1),this.playground.world.addBody(this.body)},t.prototype.createGround=function(){this.material=new THREE.MeshBasicMaterial({map:this.playground.assets.getTexture("ground")}),this.geometry=new THREE.PlaneBufferGeometry(2,2,1,1),this.tiles=[],this.tilesMap=[];var t,n,r;for(t=0;t<e.MAX_X;++t){this.tilesMap[t]=[];for(n=0;n<e.MAX_Z;++n)r=this.getTile(),r.name="ground"+n.toString()+"_"+t.toString(),r.position.z=n*2-(e.MAX_Z-1),r.position.y=0,r.position.x=t*2-(e.MAX_X-1),r.userData={x:t,z:n},this.playground.scene.add(r),this.tilesMap[t][n]=r,this.tiles.push(r)}},t.prototype.createMap=function(){var t,n;this.map=[];for(t=0;t<e.MAX_X;++t){this.map[t]=[];for(n=0;n<e.MAX_Z;++n)this.map[t][n]=1}},t.prototype.update=function(t){this.map=t;var n,r,i;for(n=0;n<e.MAX_X;++n)for(r=0;r<e.MAX_Z;++r)i=this.tilesMap[n][r],i.visible=t[n][r]==1,this.map[n][r]=i.visible?1:0},t.prototype.updateTile=function(e,t,n){this.tilesMap[e][t].visible=n,this.map[e][t]=n?1:0},t.prototype.getTile=function(){var t=new THREE.Mesh(this.geometry,this.material);return t.quaternion.setFromAxisAngle(new THREE.Vector3(1,0,0),-e.DEG_RAD_90),t},t}();t.Ground=n})(t=e.core||(e.core={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(e){var n=t.call(this)||this;return n.playground=e,n.history=[],n.index=0,n}return __extends(n,t),n.prototype.applyData=function(t){var n=this;if(!t)return;this.playground.cubes.selected=null,this.playground.cubes.removeCubes(),this.playground.placeables.hide(),this.playground.gameScreen.moveMenu.hide(),this.playground.gameScreen.rotateMenu.hide();var r;mTrack.data.competition&&mTrack.data.competition.baseTrack&&(mTrack.data.competition.solidCubes=this.playground.cubes.setCubes(mTrack.data.competition.baseTrack.data.cubes,!0)),t.forEach(function(t){if(!n.playground.assets.meshExists(t.key))return;r=new e.core.Cube(n.playground,t.key),r.mapPosition.set(t.pos[0],t.pos[1],t.pos[2]),r.mesh.rotation.set(t.rot[0],t.rot[1],t.rot[2]),n.playground.gameScreen.bottomMenu.cubeList.getItemByKey(r.key).remaining--,n.playground.cubes.update(r,!1)}),this.playground.save(),this.playground.emit(e.CUBE_UPDATE),this.save(!0)},n.prototype.reset=function(){this.history=[],this.index=0,this.emit(gf.CHANGE,0,!1)},n.prototype.save=function(e){e===void 0&&(e=!1);var t,n=[];this.playground.scene.children.forEach(function(e){e.name.indexOf("cube")!=-1&&(t=e.userData.cube,t.isFixed||n.push({key:t.key,pos:t.mapPosition.toArray(),rot:t.mesh.rotation.toArray()}))});var r=JSON.stringify(n)==JSON.stringify(this.history[this.index]);if(this.history.length==0||!r||e)e||(this.history=this.history.slice(0,this.index+1),this.history.push(n),this.index=this.history.length-1),this.emit(gf.CHANGE,this.index+1,this.canRedo)},n.prototype.redo=function(){if(!this.canRedo)return;this.index++,this.applyData(this.history[this.index])},n.prototype.undo=function(){if(this.index==-1)return;this.index--,this.applyData(this.history[this.index])},Object.defineProperty(n.prototype,"canRedo",{get:function(){return this.index<this.history.length-1&&this.history.length>0},enumerable:!0,configurable:!0}),n}(PIXI.utils.EventEmitter);t.History=n;var r=function(){function e(){}return e}();t.CubeData=r})(t=e.core||(e.core={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(){function t(t){this.playground=t,this.map=[];for(var n=0;n<e.MAX_X;++n){this.map[n]=[];for(var r=0;r<e.MAX_Y;++r){this.map[n][r]=[];for(var i=0;i<e.MAX_Z;++i)this.map[n][r][i]=e.EMPTY}}}return t.prototype.getAt=function(e,t,n){var r;if(typeof e!="number"){var i=e;r=i.x,t=i.y,n=i.z}else r=e;return this.onMap(r,n,t)?this.map[r][t]?this.map[r][t][n]:null:null},t.prototype.setAt=function(e,t,n,r){var i;if(typeof t!="number"){var s=t;i=s.x,n=s.y,r=s.z}else i=t;this.onMap(i,r,n)?this.map[i][n][r]=e:log("cuboro.core.Map.setAt error. Position "+i+", "+n+", "+r+" not on map!")},t.prototype.isValidX=function(t){return!(t<0||t>=e.MAX_X)},t.prototype.isValidY=function(e){return!(e<0||e>=this.playground.maxY)},t.prototype.isValidZ=function(t){return!(t<0||t>=e.MAX_Z)},t.prototype.isValid=function(e,t,n){return this.isValidX(e)?this.isValidY(t)?this.isValidZ(n):!1:!1},t.prototype.getNextEmptyY=function(t,n){for(var r=0;r<this.playground.maxY+1;++r)if(this.map[t]){if(!this.map[t][r])return r;if(this.map[t][r][n]==e.EMPTY)return r}},t.prototype.to3DPos=function(e,t,n){var r;if(typeof e!="number"){var i=e;r=i.x,t=i.y,n=i.z}else r=e;return r=this.xTo3DPos(r),t=this.yTo3DPos(t),n=this.zTo3DPos(n),new THREE.Vector3(r,t,n)},t.prototype.xTo3DPos=function(t){var n=e.MAX_X>>1;return t*2+this.playground.elementMargin*(t-n)-11},t.prototype.yTo3DPos=function(e){return e*2+this.playground.layerMargin*2*e+1},t.prototype.zTo3DPos=function(t){var n=e.MAX_Z>>1;return t*2+this.playground.elementMargin*(t-n)-11},t.prototype.toMapPos=function(e,t,n){var r;if(typeof e!="number"){var i=e;r=this.xToMapPos(i.x),t=this.yToMapPos(i.y),n=this.zToMapPos(i.z)}else r=this.xToMapPos(e),t=this.yToMapPos(t),n=this.zToMapPos(n);return new THREE.Vector3(r,t,n)},t.prototype.xToMapPos=function(t){var n=this.playground.elementMargin*(Math.round((t+11)*.5)-(e.MAX_X>>1));return Math.round((t+11-n)*.5)},t.prototype.yToMapPos=function(e){var t=this.playground.layerMargin*2*(e-1)*.5;return Math.round((e-t-1)*.5)},t.prototype.zToMapPos=function(t){var n=this.playground.elementMargin*(Math.round((t+11)*.5)-(e.MAX_Z>>1));return Math.round((t+11-n)*.5)},t.prototype.onMap3D=function(e,t){return e=this.xToMapPos(e),t=this.xToMapPos(t),this.onMap(e,t)},t.prototype.onMap=function(t,n,r){return t<0?!1:t>=e.MAX_X?!1:n<0?!1:n>=e.MAX_Z?!1:r==undefined?!0:r<0?!1:r<this.playground.maxY},t.prototype.mapItem=function(e,t,n){return this.map[e]?this.map[e][t]?this.map[e][t][n]?this.map[e][t][n]:null:null:null},t}();t.Map=n})(t=e.core||(e.core={}))})(cuboro||(cuboro={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(e){var n=t.call(this)||this;return n.game=e,n._duration=0,n._elapsed=0,n._paused=!1,n}return __extends(n,t),n.prototype.tick=function(){var t=this;this._elapsed+=100;if(!this._isEndless&&this._duration-this._elapsed<=0){this.stop(),this.emit(e.TIMER),this.emit(e.TIMER_COMPLETE);return}this._elapsed%1e3==0&&this.emit(e.TIMER),this._timerId=window.setTimeout(function(){return t.tick()},100)},n.prototype.round=function(e){return parseInt(e.toString(),10)},n.prototype.pause=function(){if(this._paused)return;return clearTimeout(this._timerId),this._paused=!0,this},n.prototype.resume=function(){if(!this._paused)return;return this.start((this._duration-this._elapsed)/1e3,this._isEndless),this._paused=!1,this},n.prototype.resumeEx=function(){if(!this._paused)return;var t=this._elapsed;return this.start(this._duration/1e3,this._isEndless),this._elapsed=t,this._paused=!1,this.emit(e.TIMER,this.round(this._duration)),this},n.prototype.stop=function(){return this._isRunning=!1,this._paused=!1,this._timerId&&clearTimeout(this._timerId),this},n.prototype.restart=function(){return this.stop().start(this._duration*.001,this._isEndless),this},n.prototype.start=function(t,n){var r=this;return n===void 0&&(n=!1),this._isRunning&&this.stop(),this._isEndless=n,this._isRunning=!0,this._duration=t*1e3,this._elapsed=0,this._timerId=window.setTimeout(function(){return r.tick()},100),this.emit(e.TIMER,this.round(t)),this},Object.defineProperty(n.prototype,"duration",{get:function(){return this._duration},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"elapsed",{get:function(){return this.round(this._elapsed*.001)},set:function(e){this._elapsed=e*1e3},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"elapsedEx",{get:function(){return this._elapsed*.001},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"left",{get:function(){return this.round(this._duration*.001-this.elapsed)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"paused",{get:function(){return this._paused},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isRunning",{get:function(){return this._isRunning},enumerable:!0,configurable:!0}),n}(PIXI.utils.EventEmitter);t.Timer=n})(t=e.utils||(e.utils={}))})(gf||(gf={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(e){var n=t.call(this)||this;return n.lastVelocity=new CANNON.Vec3,n.preTouching=[],n.preTouchingTime=[],n.touching=[],n.playground=e,n.create(),n.zeroTimer=new gf.utils.Timer(n.playground.game),n.zeroTimer.on(gf.TIMER_COMPLETE,function(){if(n.onGround||n.isStuck)return;if(n.preTouching.length==0||n.preTouching[0].length==0)return;var e=n.preTouching[0][0],t=n.bodies[e];t&&(t.isStuck=!0,n.isStuck=!0)}),n}return __extends(n,t),n.prototype.create=function(){var e=this;this.body=new CANNON.Body({mass:2.5}),this.body.angularDamping=.01,this.body.angularFactor.set(.9,.9,.9),this.body.linearDamping=.0895,this.body.linearFactor.set(.85,.85,.85),this.body.addShape(new CANNON.Sphere(.31)),this.body.addEventListener("collide",function(t){return e.onCollision(t.body)}),this.body.position.setZero(),this.body.previousPosition.setZero(),this.body.interpolatedPosition.setZero(),this.body.initPosition.setZero();var t={};t.color=16777215,t.map=this.playground.assets.getTexture("marble"),t.flatShading=!0,t.reflectivity=1,t.refractionRatio=.75,this.mesh=new THREE.Mesh(new THREE.SphereGeometry(.31,20,20)),this.mesh.material=new THREE.MeshPhongMaterial(t),this.mesh.name="marble",this.mesh.renderOrder=200,this.mesh.visible=!1,this.playground.scene.add(this.mesh),this.playground.world.addBody(this.body)},n.prototype.dumpCubes=function(e,t){var n=this;return t===void 0&&(t=!1),t?"["+e.map(function(e){return n.bodies[e].key.slice(5)})+"]":"["+e+"]"},n.prototype.isOnGround=function(){return this.onGround},n.prototype.onCollision=function(e){if(this.onGround||this.isStuck)return;e.id===this.playground.ground.body.id?(this.playground.game.sounds.stopAllFx(),this.playground.game.sounds.playFx("out","out"),this.onGround=!0,!this.isStuck&&this._collisions[this._collisions.length-1]&&this._collisions[this._collisions.length-1].cube&&this._collisions[this._collisions.length-1].cube.highlight(!0)):this.touching.includes(e.id)||this.touching.push(e.id)},n.prototype.isMK=function(e){return this.bodies[e]&&this.bodies[e].mesh.name=="cube_mk"},n.prototype.checkMaxCubes=function(){!this.preLayer||this.preLayer==Math.round(this.body.position.y)?this.sameLayerHits++:(this.sameLayerHits=0,this.isMax=!1),this.sameLayerHits>=e.MAX_SAME_Y_HITS&&(this.isMax=!0),this.preLayer=Math.round(this.body.position.y)},n.prototype.checkUpperCube=function(e){var t=this;if(this.isStuck||this.onGround||this.inContainer)return;var n=this.body.position.y-e.y>.9;if(n){var r=this.playground.cubes.getCubeAbove(e.id);if(r){if(this.preTouching.reduce(function(e,t){return e||t.includes(r.body.id)},!1))return;if(r.hits>0)++r.hits,this.checkSubstructure(r);else{var i=this.playground.cubes.getCubesAbove(r.id);i.forEach(function(e){e.hits>0&&(r.hits=1,t.checkSubstructure(r))})}}}},n.prototype.checkSubstructure=function(e){if(this.isStuck||this.onGround||this.inContainer)return;var t=this.playground.cubes.getCubesAbove(e.id);t.forEach(function(t){t.hits>0&&(e.substructureHits=1)})},n.prototype.checkThumbCubes=function(e){if(this.isStuck||this.onGround||this.inContainer)return;if(e.key=="cube_23"||e.key=="cube_53")if(this.lastCube.mapPosition.y>e.mapPosition.y){var t=Math.max(Math.abs(this.body.angularVelocity.x),Math.abs(this.body.angularVelocity.y),Math.abs(this.body.angularVelocity.z)),n=1.8;Math.abs(this.body.angularVelocity.x)==t?this.body.angularVelocity.x*=n:Math.abs(this.body.angularVelocity.y)==t?this.body.angularVelocity.y*=n:Math.abs(this.body.angularVelocity.z)==t&&(this.body.angularVelocity.z*=n)}},n.prototype.checkPendulumMotion=function(e){if(this.isStuck||this.onGround||this.inContainer)return;if(this._collisions.length>4){var t=0;for(var n=this._collisions.length-1;n>0;--n)this._collisions[n].bodyId==e&&++t;t>6&&(this.isStuck=!0)}},n.prototype.isInCollisions=function(e){var t=!1;return this._collisions.forEach(function(n){if(n.cube.id==e.id){t=!0;return}}),t},n.prototype.slowDown=function(){var t=e.MARBLE_DEATH_SLOW_FACTOR;this.body.velocity=this.body.velocity.mult(t),this.body.angularVelocity=this.body.angularVelocity.mult(t)},n.prototype.reset=function(){var e=this;this.inContainer=!1,this.isMax=!1,this.isStuck=!1,this.onGround=!1,this.startSoundPlayed=!1,this.stopped=!1,this.touching=[],this.preTouching=[],this.preTouchingTime=[],this.lastHitTime=null,this.preLayer=null,this.bodies={},this.sameLayerHits=0,this.playground.gameScreen.marbleRun.btSpeed.speed=1,this.resetBody(),this.playground.cubes.cubes.forEach(function(t){var n=t.body;n.position.copy(t.mesh.position),n.quaternion.copy(t.mesh.quaternion),e.lastVelocity.setZero(),n.velocity.setZero(),n.initVelocity.setZero(),n.angularVelocity.setZero(),n.initAngularVelocity.setZero(),n.previousPosition.setZero(),n.force.setZero(),n.torque.setZero(),n.sleepState=0,n.timeLastSleepy=0,t.reset(),e.bodies[n.id]=t})},n.prototype.resetBody=function(){this.body.quaternion.set(0,0,0,1),this.body.initQuaternion.set(0,0,0,1),this.body.previousQuaternion.set(0,0,0,1),this.body.interpolatedQuaternion.set(0,0,0,1),this.body.velocity.setZero(),this.body.initVelocity.setZero(),this.body.angularVelocity.setZero(),this.body.initAngularVelocity.setZero(),this.body.force.setZero(),this.body.torque.setZero(),this.body.previousPosition.setZero(),this.body.interpolatedPosition.setZero(),this.body.sleepState=0,this.body.timeLastSleepy=0,this.body._wakeUpAfterNarrowphase=!1},n.prototype.evaluate=function(t,n){if(t){this.playground.game.overlays.hide(e.overlays.Loader.NAME),this.playground.evaluation.calculate();var r=this.playground.game.overlays.show(e.overlays.TrackDetailsIngame.NAME);r.track=mTrack}else if(!n){var i=this.playground.game.overlays.show(e.overlays.Message.NAME);i.text=loc("marble_run_failed")}this.emit("stop"),this.reset(),this.body.position.setZero(),this.body.previousPosition.setZero(),this.body.interpolatedPosition.setZero(),this.body.initPosition.setZero(),this.playground.physicsEnabled=!1,this.playground.game.stage.header.show(),this.playground.gameScreen.bottomMenu.visible=!0,this.playground.gameScreen.layers.visible=!0,this.playground.gameScreen.marbleRun.visible=!1},n.prototype.checkCollisions=function(){var t=this,n=this.playground.map.toMapPos(this.x,this.y,this.z),r=this.playground.map.getAt(n);if(r&&r!=e.EMPTY){var i=this.playground.cubes.getById(r);if(i){var s=i.body.id;this.touching.includes(s)||this.touching.push(s)}}if(this.touching.length==0)return;var o=this.body.velocity.clone();o.normalize(),this.lastVelocity.copy(o);var u=(c=kr3m.util.Util).difference.apply(c,[this.touching].concat(this.preTouching));u.sort(function(e,n){return t.bodies[e].y-t.bodies[n].y});for(var a=0;a<u.length;++a){var s=u[a],i=this.bodies[s];i&&(this.lastHitTime=Date.now(),this._collisions.push({bodyId:s,cube:i}),++i.hits,this.checkMaxCubes(),this.checkThumbCubes(i),this.checkUpperCube(i),this.checkPendulumMotion(s),this.checkSubstructure(i),this.lastY=this.body.position.y,this.lastCube=i)}this.touching.forEach(function(e){var n=t.bodies[e];t.isMK(e)&&Math.max(Math.abs(n.x-t.body.position.x),Math.abs(n.y-t.body.position.y),Math.abs(n.z-t.body.position.z))<.75&&(t.inContainer=!0)});var f=this.playground.world.stepnumber,l=f-25;this.preTouchingTime.push(f),this.preTouchingTime=this.preTouchingTime.filter(function(e){return e>=l}),this.preTouching=this.preTouching.slice(-this.preTouchingTime.length),this.preTouching.push(this.touching),this.touching=[];var c},n.prototype.isInContainer=function(){return this.inContainer},n.prototype.hasSkipped=function(){return this.skipHeight>=e.MARBLE_SKIP_THRESHOLD},n.prototype.update=function(){var t=this,n=this.body.position.y-this.lowestY;this.skipHeight=Math.max(this.skipHeight,n),this.lowestY=Math.min(this.lowestY,this.body.position.y),this.checkCollisions();if(this.onGround||this.inContainer||this.isStuck||this.isMax)this.slowDown(),this.body.velocity.almostZero(.1)&&!this.stopped&&(TweenMax.delayedCall(1,function(){return t.stop(!1)}),!this.isStuck&&!this.isMax&&this._collisions[this._collisions.length-1]&&this._collisions[this._collisions.length-1].cube.highlight(!0),this.stopped=!0);if(!this.onGround&&!this.inContainer&&!this.isStuck){var r=this.playground.map.toMapPos(this.x,this.y,this.z),i=this.playground.map.getAt(r);i&&i!=e.EMPTY?this.startSoundPlayed?this.rollSound&&this.rollSound.volume(1):(this.startSoundPlayed=!0,this.playground.game.sounds.playFx("in","in"),this.rollSound=this.playground.game.sounds.playFx("rolling","rolling",!0,1)):this.rollSound&&this.rollSound.volume(0),this.body.velocity.almostZero(.5)?this.zeroTimer.isRunning||this.zeroTimer.start(3/this.playground.physicSpeedFactor):this.zeroTimer.stop()}this.mesh.position.set(this.body.position.x,this.body.position.y,this.body.position.z),this.mesh.quaternion.copy(this.body.quaternion)},n.prototype.start=function(){if(this.isRunning)return;this.isRunning=!0,this.bodies={},this.playground.game.stage.header.hide(),this.playground.gameScreen.bottomMenu.visible=!1,this.playground.gameScreen.layers.visible=!1,this.playground.gameScreen.marbleRun.visible=!0,this.playground.cubes.replaceRandom(),this.reset(),this.lowestY=this.body.position.y,this.skipHeight=0,this._collisions=[],this.playground.physicsEnabled=!0},n.prototype.stop=function(t){var n=this;if(!this.isRunning)return;this.isRunning=!1,this.mesh.visible=!1;var r=this.onGround||this.inContainer;this.playground.game.sounds.stopAllFx(),!t&&r?(this.playground.game.overlays.show(e.overlays.Loader.NAME),e.ui.TrackPreview.GetBase64(this.playground,300,function(r){mTrack.data.cubesHash=e.ui.TrackPreview.unique(JSON.stringify(n.playground.cubes.getCubes())),mUser.isLoggedIn()&&mTrack.owner.id==mUser.getUserId()&&mTrack.id?sTrack.saveTrackImage(mTrack.id,mTrack.name,r,function(e){mTrack.imageUrl=e,n.evaluate(!0,t),n.playground.save()}):n.evaluate(!0,t)})):this.evaluate(!1,t),this.zeroTimer.stop()},Object.defineProperty(n.prototype,"collisions",{get:function(){return this._collisions},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"x",{get:function(){return this.body.position.x},set:function(e){this.mesh.position.x=e,this.body.position.x=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"y",{get:function(){return this.body.position.y},set:function(e){this.mesh.position.y=e,this.body.position.y=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"z",{get:function(){return this.body.position.z},set:function(e){this.mesh.position.z=e,this.body.position.z=e},enumerable:!0,configurable:!0}),n}(PIXI.utils.EventEmitter);t.Marble=n})(t=e.core||(e.core={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(){function t(e){this.playground=e,this.createPlaceables(),this.hide()}return t.prototype.createPlaceables=function(){this.materialPlaceable=this.playground.assets.getColorMaterial(65280),this.materialPlaceable.name="materialPlaceable",this.materialPlaceable.transparent=!0,this.materialPlaceable.opacity=0,this.materialUnplaceable=this.playground.assets.getMaterial("unplaceable"),this.materialUnplaceable.name="materialUnplaceable",this.materialUnplaceable.transparent=!0,this.geometry=new THREE.PlaneBufferGeometry(2,2,1,1),this.tiles=[],this.tilesMap=[];var t,n,r;for(t=0;t<e.MAX_X;++t){this.tilesMap[t]=[];for(n=0;n<e.MAX_Z;++n)r=this.getTile(),r.name="placeable"+n.toString()+"_"+t.toString(),r.position.z=n*2-(e.MAX_Z-1),r.position.y=.05,r.position.x=t*2-(e.MAX_X-1),r.userData={x:t,z:n},r.material=this.materialPlaceable,this.playground.scene.add(r),this.tilesMap[t][n]=r,this.tiles.push(r)}},t.prototype.getTile=function(){var t=new THREE.Mesh(this.geometry,this.materialPlaceable);return t.quaternion.setFromAxisAngle(new THREE.Vector3(1,0,0),-e.DEG_RAD_90),t},t.prototype.update=function(){var t,n,r,i;for(t=0;t<e.MAX_X;++t)for(n=0;n<e.MAX_Z;++n){var s=this.playground.map.getNextEmptyY(t,n);r=this.tilesMap[t][n],r.position.y=this.playground.map.yTo3DPos(s)-.99,i=s==this.playground.maxY?this.materialUnplaceable:this.materialPlaceable,i.name!=r.material.name&&(r.material=i)}},t.prototype.hide=function(){this.tiles.forEach(function(e){e.visible=!1})},t.prototype.show=function(){this.update(),this.tiles.forEach(function(e){e.visible=!0})},t}();t.Placeables=n})(t=e.core||(e.core={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){var t=function(){function e(){}return e.isVector3Equal=function(e,t){return Math.abs(e.x-t.x)<1e-4&&Math.abs(e.y-t.y)<1e-4&&Math.abs(e.z-t.z)<1e-4},e}();e.Maths=t})(t=e.utils||(e.utils={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(){function t(e){this.playground=e,this.raycaster=new THREE.Raycaster,this.mouse=new THREE.Vector2,this.offset=new THREE.Vector3,this.plane=new THREE.Mesh(new THREE.PlaneBufferGeometry(2e3,2e3,8,8),new THREE.MeshBasicMaterial({color:65280})),this.plane.visible=!1,this.playground.scene.add(this.plane),this.offsetX=this.offsetY=0,this.interaction=this.playground.gameScreen.interaction,this.interaction.on("onMouseDown",this.onDown,this),this.interaction.on("onMouseMove",this.onMove,this),this.interaction.on("onMouseUp",this.onUp,this),this.interaction.on("onTouchStart",this.onDown,this),this.interaction.on("onTouchMove",this.onMove,this),this.interaction.on("onTouchEnd",this.onUp,this)}return t.prototype.getMouse3D=function(){this.mouse.x=(this._lastX-this.offsetX)/(this.playground.game.width*this.playground.game.scaleX)*2-1,this.mouse.y=-((this._lastY-this.offsetY)/(this.playground.game.height*this.playground.game.scaleY))*2+1;var e=new THREE.Vector3(0,0,0),t=new THREE.Vector3(this.mouse.x,this.mouse.y,1);t.unproject(this.playground.camera);var n=this.playground.camera.position,r=t.y/(t.y-n.y);return e.x=t.x+(n.x-t.x)*r,e.z=t.z+(n.z-t.z)*r,e},t.prototype.spawnCubeFromList=function(){var t=this.playground.gameScreen.bottomMenu.cubeList,n=t.currentItem;if(n&&n.remaining>0){n.remaining--;if(!this.playground.assets.meshExists(n.key))return;var r=new e.core.Cube(this.playground,n.key),i=this.intersection.userData.x,s=this.intersection.userData.z;r.x=this.playground.map.xTo3DPos(i),r.z=this.playground.map.zTo3DPos(s),r.y=this.playground.map.to3DPos(i,this.playground.map.getNextEmptyY(i,s),s).y,r.mapPosition=this.playground.map.toMapPos(r.x,r.y,r.z),this.playground.cubes.update(r),this.playground.cubes.selected=r,t.deselectItems(),this.playground.placeables.hide(),this.playground.game.sounds.playFx("fx","cube_placed")}},t.prototype.onMove=function(e){if(this.playground.physicsEnabled||!this.playground.ready)return;this.mouse.x=(this.getX(e)-this.offsetX)/(this.playground.game.width*this.playground.game.scaleX)*2-1,this.mouse.y=-((this.getY(e)-this.offsetY)/(this.playground.game.height*this.playground.game.scaleY))*2+1,this.raycaster.setFromCamera(this.mouse,this.playground.camera),this.intersections=this.raycaster.intersectObjects(this.playground.scene.children),this._marbleSpawning?this.moveMarble():this.playground.cubes.down&&this.interactionDistance>10&&!this.playground.missingSets?this.moveCube():this.playground.missingSets||this.onOver()},t.prototype.onOver=function(){if(this.playground.physicsEnabled||!this.playground.ready||this.playground.missingSets)return;this.intersections.length>0?(this.intersection!=this.intersections[0].object&&(this.intersection=this.intersections[0].object,this.intersection.name=="layer"&&this.intersection[1]&&(this.intersection=this.intersection[1].object,this.isCube||(this.intersection=this.intersections[0].object)),this.isCube?this.playground.cubes.over=this.intersection.userData.cube:this.playground.cubes.over=null,this.plane.position.copy(this.intersection.position),this.plane.lookAt(this.playground.camera.position)),this.interaction.buttonMode=!0):(this.intersection=null,this.playground.cubes.over=null,this.interaction.buttonMode=!1)},t.prototype.onDown=function(t){if(this.playground.physicsEnabled||!this.playground.ready||this.playground.missingSets)return;this.onMove(t),this.onOver(),this._startX=this.getX(t),this._startY=this.getY(t),this.getMouse3D();if(!this._marbleSpawning&&this.isCube&&!this.intersection.userData.cube.isFixed)this.playground.controls.enabled=!1,this.playground.cubes.down=this.intersection.userData.cube,this.playground.map.setAt(e.EMPTY,this.playground.cubes.down.mapPosition);else if(!this._marbleSpawning&&this.isPlaceable&&this.playground.cubes.selected){var n=this.playground.cubes.selected.mapPosition,r=this.intersection.userData;r.x==n.x&&r.z==n.z&&(this.playground.controls.enabled=!1,this.playground.cubes.down=this.playground.cubes.selected,this.playground.map.setAt(e.EMPTY,this.playground.cubes.down.mapPosition))}},t.prototype.onUp=function(e){if(this.playground.physicsEnabled||!this.playground.ready)return;this.onMove(e),this.playground.controls.enabled=!0,this._cubeSpawning&&(this.intersection=this.playground.cubes.down.mesh),this._marbleSpawning&&(this.intersection=this.playground.marble.mesh);if(!this._marbleSpawning&&(this.playground.cubes.down||this.isCube)){var t=this.playground.cubes.down||this.intersection.userData.cube;t.isFixed||this.placeCube()}else if(this.isPlaceable){var n=this.intersection.userData.x,r=this.intersection.userData.z,i=this.playground.map.isValidY(this.playground.map.getNextEmptyY(n,r));this.interactionDistance<10&&this.playground.gameScreen.bottomMenu.cubeList.currentItem!=null&&i&&(this.spawnCubeFromList(),this.playground.history.save()),this.playground.cubes.selected&&this.interactionDistance<10&&this.playground.gameScreen.moveMenu.visible&&i&&(this.moveCubeByPos(),this.playground.history.save())}else this.isMarble?this.placeMarble():this.isGround?this.deselectCube():this.deselectCube();this.interaction.buttonMode=!1},t.prototype.placeCube=function(){if(!this.playground.cubes.down&&!this.intersection)return;var e=this.playground.cubes.down||this.intersection.userData.cube;this.isCubeOnMap(e)?this.isDownSameAsUp&&this.interactionDistance<10?this.playground.cubes.swapping?(this.playground.cubes.swap(e),this.playground.cubes.swapping=null,this.playground.gameScreen.bottomMenu.btSwap.isSelected=!1,this.playground.history.save(),this.playground.save()):(this.playground.cubes.selected=e,this.playground.cubes.update(e)):(this._cubeSpawning&&(this.playground.cubes.selected=e,this.playground.gameScreen.bottomMenu.cubeList.deselectItems(),this.playground.placeables.hide(),this.playground.game.sounds.playFx("fx","cube_placed")),this.playground.cubes.update(e),this.playground.cubes.selected!=e&&(this.playground.cubes.selected=e),this.playground.history.save(),this.playground.save()):(this.playground.cubes.remove(e,this._cubeSpawning),this.playground.history.save(),this.playground.save()),this.playground.cubes.down=null,this.playground.gameScreen.layers.update(),this._cubeSpawning=!1},t.prototype.placeMarble=function(){this.canMarbleStart?(this._marbleTween&&(this._marbleTween.progress(1),this._marbleTween.kill()),this.playground.marble.start(),this.intersection=null):this.playground.marble.mesh.visible=!1,this._marbleSpawning=!1,this.playground.cubes.highlightMarble(!1),this.playground.gameScreen.bottomMenu.onMarbleUp()},t.prototype.deselectCube=function(){this.playground.cubes.selected&&(this.playground.cubes.selected=null),this.playground.cubes.swapping&&(this.playground.cubes.swapping=null),!this.playground.gameScreen.bottomMenu.cubeList.currentItem&&this.playground.placeables&&this.playground.placeables.hide()},t.prototype.moveMarble=function(){var t=this.getMouse3D();this.intersection=this.playground.marble.mesh;var n,r=this.intersections.length;for(var i=0;i<r;++i)this.intersections[i].object.name.indexOf("cube")!=-1&&!n&&(n=this.intersections[i].object.userData.cube);if(n){var s=this.playground.map.getNextEmptyY(n.mapPosition.x,n.mapPosition.z);t=this.playground.map.to3DPos(n.mapPosition.x,s,n.mapPosition.z),t.y+=e.MARBLE_DROP_HEIGHTS[this.playground.gameScreen.bottomMenu.btDropHeight.dropHeight],this._marbleTween&&this._marbleTween.kill(),this._marbleTween=TweenMax.to(this.playground.marble,.15,{x:t.x,y:t.y,z:t.z})}else{var o=this.playground.map.toMapPos(t.x,this.playground.marble.y,t.z),s=this.playground.map.getNextEmptyY(o.x,o.z);s!=null&&this.playground.map.isValidY(s)?(t=this.playground.map.to3DPos(o.x,s,o.z),t.y+=e.MARBLE_DROP_HEIGHTS[this.playground.gameScreen.bottomMenu.btDropHeight.dropHeight],this._marbleTween&&this._marbleTween.kill(),this._marbleTween=TweenMax.to(this.playground.marble,.15,{x:t.x,y:t.y,z:t.z})):(this.playground.marble.x=t.x,this.playground.marble.y=t.y,this.playground.marble.z=t.z)}},t.prototype.moveCube=function(){var t=this,n=this.getMouse3D(),r=this.playground.cubes.down;this._cubeSpawning&&(this.intersection=this.playground.cubes.down.mesh);var i,s,o=this.intersections.length;for(var u=0;u<o;++u)s=this.intersections[u].object,s.name.indexOf("cube")!=-1&&!i&&s.userData.cube!=r&&(i=s.userData.cube);if(i){var a=this.playground.map.getNextEmptyY(i.mapPosition.x,i.mapPosition.z);n=this.playground.map.to3DPos(i.mapPosition.x,a,i.mapPosition.z),this.playground.map.isValidY(a)?(r.isStuck=!1,r.mapPosition.set(i.mapPosition.x,a,i.mapPosition.z),TweenMax.to(r,.25,{x:n.x,y:n.y,z:n.z,onComplete:function(){return t.playground.emit(e.CUBE_UPDATE)}})):(TweenMax.killTweensOf(r),r.isStuck=!0,r.x=n.x,r.z=n.z)}else if(this.isCubeOnMap(r)){var f=this.playground.map.toMapPos(n.x,r.y,n.z),a=this.playground.map.getNextEmptyY(f.x,f.z);a!=null&&this.playground.map.isValidY(a)?(n=this.playground.map.to3DPos(f.x,a,f.z),r.isStuck=!1,r.mapPosition.set(f.x,a,f.z),TweenMax.to(r,.25,{x:n.x,y:n.y,z:n.z,onComplete:function(){return t.playground.emit(e.CUBE_UPDATE)}})):(TweenMax.killTweensOf(r),r.isStuck=!0,r.x=n.x,r.z=n.z),this.playground.cubes.down=r}else TweenMax.killTweensOf(r),r.isStuck=!0,r.x=n.x,r.z=n.z},t.prototype.moveCubeByPos=function(){var t=this,n=this.getMouse3D(),r=this.playground.cubes.selected,i=this.playground.map.toMapPos(n.x,n.y,n.z),s=this.playground.map.getNextEmptyY(i.x,i.z);s!=null&&this.playground.map.isValidY(s)&&(this.playground.map.setAt(e.EMPTY,r.mapPosition),n=this.playground.map.to3DPos(i.x,s,i.z),r.mapPosition.set(i.x,s,i.z),this.playground.map.map[i.x][s][i.z]=r.id,TweenMax.to(r,.25,{x:n.x,y:n.y,z:n.z,onComplete:function(){return t.playground.emit(e.CUBE_UPDATE)}}),this.playground.placeables.update())},t.prototype.getIntersects=function(){var e=new THREE.Vector3(this.mouse.x,this.mouse.y,.5).unproject(this.playground.camera),t=new THREE.Raycaster(this.playground.camera.position,e.sub(this.playground.camera.position).normalize());return t.intersectObjects(this.playground.scene.children)},t.prototype.spawnCube=function(t,n){if(this._cubeSpawning){console.log("cube already spawning");return}this._cubeSpawning=!0,this._startX=this._lastX=this.getX(t),this._startY=this._lastY=this.getY(t);var r=this.getMouse3D();if(!this.playground.assets.meshExists(n))return;this.playground.cubes.down=new e.core.Cube(this.playground,n),this.playground.cubes.down.x=r.x,this.playground.cubes.down.y=1,this.playground.cubes.down.z=r.z,this.moveCube()},t.prototype.spawnMarble=function(e){this.playground.resetView(),this._marbleSpawning=!0,this._startX=this._lastX=this.getX(e),this._startY=this._lastY=this.getY(e);var t=this.getMouse3D();this.playground.marble.x=t.x,this.playground.marble.y=1,this.playground.marble.z=t.z,this.playground.marble.mesh.visible=!0,this.playground.cubes.highlightMarble(!0)},t.prototype.reset=function(){this._cubeSpawning=!1,this._marbleSpawning=!1},t.prototype.getX=function(e){return this._lastX=e.touches&&e.touches.length>0?e.touches[0].pageX:e.pageX||e.clientX||this._lastX,this._lastX},t.prototype.getY=function(e){return this._lastY=e.touches&&e.touches.length>0?e.touches[0].pageY:e.pageY||e.clientY||this._lastY,this._lastY},t.prototype.isCubeOnMap=function(e){if(!e)return;var t=this.playground.map.onMap3D(e.x,e.z);if(!t)return!1;var n=e.mapPosition;return this.playground.map.isValid(n.x,n.y,n.z)},Object.defineProperty(t.prototype,"canMarbleStart",{get:function(){var e=this.playground.map.toMapPos(this.playground.marble.mesh.position),t=this.playground.cubes.getHighestCube(e.x,e.z);return!!t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isCube",{get:function(){return this.intersection?this.intersection.name.indexOf("cube")!=-1:!1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isGround",{get:function(){return this.intersection?this.intersection.name.indexOf("ground")!=-1:!1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isMarble",{get:function(){return this.intersection?this.intersection.name=="marble":!1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isPlaceable",{get:function(){return this.intersection?this.intersection.name.indexOf("placeable")!=-1:!1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isDownSameAsUp",{get:function(){return this.playground.cubes.down?this.intersection?this.intersection.userData.cube?this.playground.cubes.down==this.intersection.userData.cube:!1:!1:!1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"interactionDistance",{get:function(){return gf.utils.Maths.distance(this._startX,this._startY,this._lastX,this._lastY)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"cubeSpawning",{get:function(){return this._cubeSpawning},enumerable:!0,configurable:!0}),t}();t.Select=n})(t=e.core||(e.core={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n.game)||this;return r.playground=n,r.bg=new gf.display.Sprite(r.game,PIXI.Texture.WHITE),r.bg.width=270,r.bg.height=315,r.bg.tint=e.COLOR_YELLOW,r.addChild(r.bg),r.tfTitle=new gf.display.Text(r.game),r.tfTitle.style=e.TEXT_STYLE_TITLE_TAB.clone(),r.tfTitle.text="Physics",r.tfTitle.x=e.PADDING*2,r.tfTitle.y=e.PADDING*2,r.addChild(r.tfTitle),r.btClose=new e.ui.CloseButton(r.game),r.btClose.on(gf.CLICK,r.onClose,r),r.btClose.x=r.bg.width-r.btClose.width-e.PADDING*2,r.btClose.y=r.bg.y+e.PADDING*2+2,r.btClose.overColor=e.COLOR_WHITE,r.addChild(r.btClose),r.form=new gf.input.Form(r.game,"changePassword"),r.addChild(r.form),r.angularFactorX=new e.input.TextInput(r.game,r.form,"angularFactorX"),r.angularFactorX.value=r.playground.marble.body.angularFactor.x.toString(),r.angularFactorX.maxLength=10,r.angularFactorX.placeholder="AngularFactorX",r.angularFactorX.tabIndex=1,r.angularFactorX.inputDom.step="any",r.angularFactorX.type="number",r.angularFactorX.tfTitle.text="AngularFactorX",r.angularFactorX.x=r.tfTitle.x,r.angularFactorX.y=r.tfTitle.bottom+20,r.angularFactorX.onChange=function(){r.playground.marble.body.angularFactor.x=parseFloat(r.angularFactorX.value),log("changed angularFactorX: "+r.playground.marble.body.angularFactor.x)},r.form.addChild(r.angularFactorX),r.angularFactorY=new e.input.TextInput(r.game,r.form,"angularFactorY"),r.angularFactorY.value=r.playground.marble.body.angularFactor.y.toString(),r.angularFactorY.maxLength=10,r.angularFactorY.placeholder="AngularFactorY",r.angularFactorY.tabIndex=2,r.angularFactorY.inputDom.step="any",r.angularFactorY.type="number",r.angularFactorY.tfTitle.text="AngularFactorY",r.angularFactorY.x=r.tfTitle.x,r.angularFactorY.y=r.angularFactorX.bottom,r.angularFactorY.onChange=function(){r.playground.marble.body.angularFactor.y=parseFloat(r.angularFactorY.value),log("changed angularFactorY: "+r.playground.marble.body.angularFactor.y)},r.form.addChild(r.angularFactorY),r.angularFactorZ=new e.input.TextInput(r.game,r.form,"angularFactorZ"),r.angularFactorZ.value=r.playground.marble.body.angularFactor.z.toString(),r.angularFactorZ.maxLength=10,r.angularFactorZ.placeholder="AngularFactorZ",r.angularFactorZ.tabIndex=3,r.angularFactorZ.inputDom.step="any",r.angularFactorZ.type="number",r.angularFactorZ.tfTitle.text="AngularFactorZ",r.angularFactorZ.x=r.tfTitle.x,r.angularFactorZ.y=r.angularFactorY.bottom,r.angularFactorZ.onChange=function(){r.playground.marble.body.angularFactor.z=parseFloat(r.angularFactorZ.value),log("changed angularFactorZ: "+r.playground.marble.body.angularFactor.z)},r.form.addChild(r.angularFactorZ),r.friction=new e.input.TextInput(r.game,r.form,"friction"),r.friction.value=r.playground.world.defaultContactMaterial.friction.toString(),r.friction.maxLength=10,r.friction.placeholder="Friction",r.friction.tabIndex=4,r.friction.inputDom.step="any",r.friction.type="number",r.friction.tfTitle.text="Friction",r.friction.x=r.tfTitle.x,r.friction.y=r.angularFactorZ.bottom,r.friction.onChange=function(){r.playground.world.defaultContactMaterial.friction=parseFloat(r.friction.value)},r.form.addChild(r.friction),r.gravity=new e.input.TextInput(r.game,r.form,"gravity"),r.gravity.value=r.playground.world.gravity.y.toString(),r.gravity.maxLength=10,r.gravity.placeholder="Gravity",r.gravity.tabIndex=5,r.gravity.inputDom.step="any",r.gravity.type="number",r.gravity.tfTitle.text="Gravity",r.gravity.x=r.tfTitle.x,r.gravity.y=r.friction.bottom,r.gravity.onChange=function(){r.playground.world.gravity.y=parseFloat(r.gravity.value)},r.form.addChild(r.gravity),r.linearDamping=new e.input.TextInput(r.game,r.form,"linearDamping"),r.linearDamping.value=r.playground.marble.body.linearDamping.toString(),r.linearDamping.maxLength=10,r.linearDamping.placeholder="LinearDamping",r.linearDamping.tabIndex=6,r.linearDamping.inputDom.step="any",r.linearDamping.type="number",r.linearDamping.tfTitle.text="LinearDamping",r.linearDamping.x=r.tfTitle.x,r.linearDamping.y=r.gravity.bottom,r.linearDamping.onChange=function(){r.playground.marble.body.linearDamping=parseFloat(r.linearDamping.value)},r.form.addChild(r.linearDamping),r.linearFactorX=new e.input.TextInput(r.game,r.form,"linearFactorX"),r.linearFactorX.value=r.playground.marble.body.linearFactor.x.toString(),r.linearFactorX.maxLength=10,r.linearFactorX.placeholder="LinearFactorX",r.linearFactorX.tabIndex=7,r.linearFactorX.inputDom.step="any",r.linearFactorX.type="number",r.linearFactorX.tfTitle.text="LinearFactorX",r.linearFactorX.x=r.tfTitle.x,r.linearFactorX.y=r.linearDamping.bottom,r.linearFactorX.onChange=function(){r.playground.marble.body.linearFactor.x=parseFloat(r.linearFactorX.value)},r.form.addChild(r.linearFactorX),r.linearFactorY=new e.input.TextInput(r.game,r.form,"linearFactorY"),r.linearFactorY.value=r.playground.marble.body.linearFactor.y.toString(),r.linearFactorY.maxLength=10,r.linearFactorY.placeholder="LinearFactorY",r.linearFactorY.tabIndex=8,r.linearFactorY.inputDom.step="any",r.linearFactorY.type="number",r.linearFactorY.tfTitle.text="LinearFactorY",r.linearFactorY.x=r.tfTitle.x,r.linearFactorY.y=r.linearFactorX.bottom,r.linearFactorY.onChange=function(){r.playground.marble.body.linearFactor.y=parseFloat(r.linearFactorY.value)},r.form.addChild(r.linearFactorY),r.linearFactorZ=new e.input.TextInput(r.game,r.form,"linearFactorZ"),r.linearFactorZ.value=r.playground.marble.body.linearFactor.z.toString(),r.linearFactorZ.maxLength=10,r.linearFactorZ.placeholder="LinearFactorZ",r.linearFactorZ.tabIndex=9,r.linearFactorZ.type="number",r.linearFactorZ.inputDom.step="any",r.linearFactorZ.tfTitle.text="LinearFactorZ",r.linearFactorZ.x=r.tfTitle.x,r.linearFactorZ.y=r.linearFactorY.bottom,r.linearFactorZ.onChange=function(){r.playground.marble.body.linearFactor.z=parseFloat(r.linearFactorZ.value)},r.form.addChild(r.linearFactorZ),r.mass=new e.input.TextInput(r.game,r.form,"mass"),r.mass.value=r.playground.marble.body.mass.toString(),r.mass.maxLength=10,r.mass.placeholder="Mass",r.mass.tabIndex=10,r.mass.inputDom.step="any",r.mass.type="number",r.mass.tfTitle.text="Mass",r.mass.x=r.tfTitle.x,r.mass.y=r.linearFactorZ.bottom,r.mass.onChange=function(){r.playground.marble.body.mass=parseFloat(r.mass.value)},r.form.addChild(r.mass),r.restitution=new e.input.TextInput(r.game,r.form,"restitution"),r.restitution.value=r.playground.world.defaultContactMaterial.restitution.toString(),r.restitution.maxLength=10,r.restitution.placeholder="Restitution",r.restitution.tabIndex=11,r.restitution.inputDom.step="any",r.restitution.type="number",r.restitution.tfTitle.text="Restitution",r.restitution.x=r.tfTitle.x,r.restitution.y=r.mass.bottom,r.restitution.onChange=function(){r.playground.world.defaultContactMaterial.restitution=parseFloat(r.restitution.value)},r.form.addChild(r.restitution),r.angularDamping=new e.input.TextInput(r.game,r.form,"restitution"),r.angularDamping.value=r.playground.marble.body.angularDamping.toString(),r.angularDamping.maxLength=10,r.angularDamping.placeholder="AngularDamping",r.angularDamping.tabIndex=11,r.angularDamping.inputDom.step="any",r.angularDamping.type="number",r.angularDamping.tfTitle.text="AngularDamping",r.angularDamping.x=r.tfTitle.x,r.angularDamping.y=r.restitution.bottom,r.angularDamping.onChange=function(){r.playground.marble.body.angularDamping=parseFloat(r.angularDamping.value)},r.form.addChild(r.angularDamping),r.bg.height=r.angularDamping.bottom+40,r.form.showDom(),r.on(gf.DRAG_CHANGE,r.onResize,r),r}return __extends(n,t),n.prototype.onClose=function(){this.form.hideDom(),this.parent.removeChild(this)},n}(gf.display.Draggable);t.Physics=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this)||this;r.physicSpeedFactor=1,mTests.pg=r,r._isSaving=!1,r.game=n.game,r.game.stage.header.trackMenu.playground=r,r.gameScreen=n,r.world=new CANNON.World,r.world.bodies=[],r.world.gravity.set(0,-50,0),r.world.defaultContactMaterial.friction=99e-5,r.world.defaultContactMaterial.restitution=.1,r.camera=new THREE.PerspectiveCamera(50,r.game.width/r.game.height,1,100),r.camera.rotation.set(-e.DEG_RAD_90,10,e.DEG_RAD_90),r.scene=new THREE.Scene,r.scene.add(r.camera);var i=new THREE.HemisphereLight(16777215,16777215,.75);i.position.set(12,500,12),r.scene.add(i),r.spotLight=new THREE.SpotLight(16777215,.5,200);var s=r.spotLight.shadow.camera;s.near=r.camera.near,s.far=r.camera.far,s.fov=r.camera.fov,r.spotLight.target.position.set(12,0,12),r.scene.add(r.spotLight);var o=new e.core.ControlsSettings;return o.interaction=r.gameScreen.interaction,o.camera=r.camera,o.lookAt=new THREE.Vector3(0,0,0),r.controls=new e.core.Controls(r,o),r.cubes=new e.core.Cubes(r),r.history=new e.core.History(r),r.evaluation=new e.core.Evaluation(r),r.map=new e.core.Map(r),r.select=new e.core.Select(r),r.assets=new e.core.Assets(r),r.cubeOpacity=1,r.elementMargin=0,r.layerMargin=0,r.game.on(gf.RESIZE,r.onResize,r),mAbo.on(e.clientmodels.Abo.ABO,r.detectMissingSets,r),mGift.on(e.clientmodels.Gift.GIFT,r.detectMissingSets,r),mUser.on("loggedIn",function(){r._isRunning&&(r._saveChanges=2,r.save())},r),gf.utils.Keyboard.add(function(e){r.gameScreen.bottomMenu.onDelete()},46),r}return __extends(n,t),n.prototype.detectMissingSets=function(){var t=this;this.missingSets=!1;var n=[];if(mAbo.hasAbo()||mAbo.getAbo().sets.length>0)n=n.concat(mAbo.getAbo().sets);return n=n.concat(mGift.getGift().sets),mTrack.data.sets.forEach(function(r){r!=e.SETS.WEB_ONE&&n.indexOf(r)==-1&&(t.missingSets=!0)}),mTrack.data.competition&&mTrack.owner.id==mUser.getUserId()&&(this.missingSets=!1),mTrack.data.competition&&mTrack.data.competition.hasSubmitted&&(this.missingSets=!0),this.gameScreen.bottomMenu.btAddSets.isEnabled=!this.isCompetition&&!this.missingSets,this.missingSets},n.prototype.load=function(){var t=this;this._ready=!1;var n=new e.core.AssetLoader(this.game,this.assets);n.texture("cube-fixed","img/texture-cube-fixed.png"),n.texture("cube-hit1","img/texture-cube-hit1.png"),n.texture("cube-hit2","img/texture-cube-hit2.png"),n.texture("cube-hit3","img/texture-cube-hit3.png"),n.texture("cube-hit4","img/texture-cube-hit4.png"),n.texture("cube-hit5","img/texture-cube-hit5.png"),n.texture("cube-out","img/texture-cube-out.png"),n.texture("cube-over","img/texture-cube-over.png"),n.texture("cube-down","img/texture-cube-down.png"),n.texture("cube-highlight","img/texture-cube-highlight.png"),n.texture("cube-selected","img/texture-cube-selected.png"),n.texture("cube-stuck","img/texture-cube-stuck.png"),n.texture("ground","img/ground.png"),n.texture("unplaceable","img/unplaceable.png"),n.texture("marble","img/marble.jpg");var r=this.gameScreen.bottomMenu.cubeList.getItems();r.forEach(function(t){n.threeJSON(t.key,"models/"+t.key+".json"),e.CUBES_RANDOM.indexOf(t.key)!=-1&&n.threeJSON(t.key+"_mirrored","models/"+t.key+"_mirrored.json")}),mTrack.data.competition&&mTrack.data.competition.baseTrackId?sTrack.load(mTrack.data.competition.baseTrackId,function(r){mTrack.data.competition.baseTrack=r,r.data.cubes.forEach(function(t){var r=kr3m.util.Json.decode(t).key;n.threeJSON(r,"models/"+r+".json"),e.CUBES_RANDOM.indexOf(r)!=-1&&n.threeJSON(r+"_mirrored","models/"+r+"_mirrored.json")}),n.on(gf.LOAD_COMPLETE,t.loadComplete,t),n.start()}):(n.on(gf.LOAD_COMPLETE,this.loadComplete,this),n.start())},n.prototype.loadComplete=function(){this.ground||(this.ground=new e.core.Ground(this)),this.placeables||(this.placeables=new e.core.Placeables(this)),this.marble||(this.marble=new e.core.Marble(this)),this.game.stage.header.trackMenu.onTrackLoaded(),this.gameScreen.bottomMenu.btAddSets.isEnabled=!this.isCompetition&&!this.missingSets,mTrack.data.competition&&mTrack.data.competition.baseTrack&&(mTrack.data.competition.solidCubes=this.cubes.setCubes(mTrack.data.competition.baseTrack.data.cubes,!0)),mTrack.data.cubes&&(this.cubes.setCubes(mTrack.data.cubes,!1),mTrack.data.evaluation&&(this.evaluation.current=mTrack.data.evaluation)),this.history.save(),this._ready=!0,this.missingSets=this.detectMissingSets(),this.emit(e.PLAYGROUND_READY),this.game.stage.header.trackMenu.onAbo(),mTrack.eduTask&&mTrack.eduTask.length>0&&this.game.overlays.show(e.overlays.EduTrackTask.NAME)},n.prototype.onResize=function(){this.camera.aspect=this.game.width/this.game.height,this.camera.updateProjectionMatrix(),this.canvas&&this.canvas.onResize()},n.prototype.resetView=function(){this.elementMargin>0&&(this.elementMargin=this.gameScreen.bottomMenu.elementMargin=0),this.layerMargin>0&&(this.layerMargin=this.gameScreen.bottomMenu.layerMargin=0)},n.prototype.save=function(t){var n=this;if(this._isSaving||this.missingSets)return;this._isSaving=!0;var r=new e.vo.TrackData;r.cubes=this.cubes.getCubes(),r.cubesHash=mTrack.data.cubesHash,r.evaluation=this.evaluation.current,r.competition=mTrack.data.competition,r.sets=mTrack.data.sets;var i=this.game.stage.header.trackMenu.trackName.value;if(!mTrack.owner||mTrack.owner.id!=mUser.getUserId()||mTrack.isPublished||!mUser.isLoggedIn())return this.saveCheck(r,t);if(mTrack.data.competition&&mTrack.data.competition.id&&mTrack.id&&mTrack.isSubmitted)return this.saveCheck(r,t);mTrack.id&&!mTrack.imageUrl&&this.saveImage(t),this.saveId=window.setTimeout(function(){return n.saveTimeout()},1e4),sTrack.save(r,i,loc("trackname_prefix"),mTrack.data.previousId,mTrack.id,r.sets,function(i,s){clearTimeout(n.saveId);if(s=="ERROR_IS_NOT_TRACK_OWNER")n.game.overlays.show(e.overlays.Loader.NAME),sTrack.generateUniqueRandomName(loc("trackname_prefix"),function(t){n.game.overlays.hide(e.overlays.Loader.NAME);var r=n.game.overlays.show(e.overlays.Message.NAME);r.text=loc("error_track_name_taken"),mTrack.name=t,n.game.stage.header.trackMenu.trackName.value=mTrack.name});else{if(s=="ERROR_TRACK_IS_PUBLISHED"){n.saveCheck(r,t);return}s==kr3m.SUCCESS&&(mTrack=i,n.game.stage.header.trackMenu.saveText=locDate("track_info_saved",mTrack.lastSavedWhen),mTrack.imageUrl||n.saveImage())}t&&t(),n._isSaving=!1})},n.prototype.saveCheck=function(t,n){this._saveChanges!=-1&&this._saveChanges++;if(this._saveChanges==3){if(!mUser.isLoggedIn()){this.game.overlays.show(e.overlays.LoginToSave.NAME),this._isSaving=!1,n&&n();return}this.showSaving(t,n)}else this._isSaving=!1,n&&n()},n.prototype.showSaving=function(t,n){var r=this,i=this.game.overlays.show(e.overlays.SaveChanges.NAME);i.onSave=function(){r.saveDupe(i.trackName.value,t,n)},i.onQuit=function(){r.game.stage.header.trackMenu.btDuplicate.label=loc("bt_save_changes"),r.game.stage.header.trackMenu.btDuplicate.icon.frameName="icon_save",r.game.stage.header.trackMenu.btDuplicate.isPrimary=!0,r.game.stage.header.trackMenu.trackName.readOnly=!0,n&&n(),r._isSaving=!1}},n.prototype.saveDupe=function(e,t,n){var r=this;mTrack.owner=mUser.getUser(),mTrack.name=e,mTrack.data.previousId=mTrack.id,mTrack.id=null,mTrack.isPublished=!1,this.game.stage.header.trackMenu.trackName.value=mTrack.name,this.saveId=window.setTimeout(function(){return r.saveTimeout()},1e4),sTrack.save(t,mTrack.name,loc("trackname_prefix"),mTrack.data.previousId,null,t.sets,function(e,t){clearTimeout(r.saveId),t==kr3m.SUCCESS&&(r.game.stage.header.trackMenu.saveText=locDate("track_info_saved",e.lastSavedWhen),mTrack=e,mTrack.imageUrl||r.saveImage()),n&&n(),r._isSaving=!1})},n.prototype.saveImage=function(t){var n=this;e.ui.TrackPreview.GetBase64(this,300,function(e){sTrack.saveTrackImage(mTrack.id,mTrack.name,e,function(e){mTrack.imageUrl=e,n._isSaving=!1,t&&t()})})},n.prototype.saveTimeout=function(){clearTimeout(this.saveId),navigator.onLine?this.game.stage.header.trackMenu.saveText=loc("error_save"):this.game.stage.header.trackMenu.saveText=loc("error_save_offline"),this._isSaving=!1},n.prototype.start=function(){var t=this;if(this._isRunning)return;this._isRunning=!0,this.canvas||(this.canvas=e.core.Canvas.getInstance(this.game,function(e){return t.update(e)})),this.canvas.start(),this.history.reset(),this.select.reset(),this.cubes.reset(),this._saveChanges=0,this._isCompetition=!!mTrack.data.competition&&!!mTrack.data.competition.id,this._maxY=this.isCompetition?mTrack.data.competition.layers:e.MAX_Y,this.load()},n.prototype.stop=function(){if(!this._isRunning)return;this._isRunning=!1,this.canvas.stop(),this.reset()},n.prototype.reset=function(){this.game.stage.header.trackMenu.toggleDuplicateButton(),this._isCompetition=!1,this._isSaving=!1,this.cubes.removeCubes(),this.history.reset(),this.gameScreen.moveMenu.hide(),this.gameScreen.rotateMenu.hide()},n.prototype.update=function(t){if(this._physicsEnabled){t*=this.physicSpeedFactor*.001,this.accumulator+=t;while(this.accumulator>=e.TIMESTEP)this.world.step(e.TIMESTEP),this.marble.update(),this.accumulator-=e.TIMESTEP;this.elapsedMS+=t}else this.accumulator=0;this.canvas.renderer.render(this.scene,this.camera)},Object.defineProperty(n.prototype,"physicsEnabled",{get:function(){return this._physicsEnabled},set:function(e){e&&(this.elapsedMS=0),this._physicsEnabled=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"ready",{get:function(){return this._ready},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"maxY",{get:function(){return this._maxY},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isCompetition",{get:function(){return this._isCompetition},enumerable:!0,configurable:!0}),n}(PIXI.utils.EventEmitter);t.Playground=n})(t=e.core||(e.core={}))})(cuboro||(cuboro={}));var gf;(function(e){var t;(function(t){var n=function(t){function n(e,n,r,i){var s=t.call(this,e,n,r)||this;return s._textStyles={},i&&s.createTextStyles(i),s}return __extends(n,t),n.prototype.createTextStyles=function(e){if(!e)return;this._textStyles={};for(var t in e){this._textStyles[t]=this._style.clone();for(var n in e[t])this._textStyles[t][n]=e[t][n]}this.dirty=!0},n.prototype.createTextData=function(e,t){return{text:e,style:t,width:0,height:0,fontProperties:null}},n.prototype.getTextDataPerLine=function(e){var t=[];this._textStyles||(this._textStyles={});var n=Object.keys(this._textStyles).join("|"),r=new RegExp("</?("+n+")>","g"),i=this.style;for(var s=0;s<e.length;s++){var o=[],u=[],a=void 0;while((a=r.exec(e[s]))!==null&&u.push(a));if(!u.length)o.push(this.createTextData(e[s],i));else{var f=0;for(var l=0;l<u.length;l++)u[l].index>f&&o.push(this.createTextData(e[s].substring(f,u[l].index),i)),u[l][0][1]=="/"?i=this.style:i=this._textStyles[u[l][1]]||this.style,f=u[l].index+u[l][0].length;f<e[s].length&&o.push({text:e[s].substring(f),style:i})}t.push(o)}return t},n.prototype.getFont=function(e){var t=typeof e.fontSize=="number"?e.fontSize+"px":e.fontSize,n;Array.isArray(e.fontFamily)?n=e.fontFamily:n=e.fontFamily.split(",");for(var r=n.length-1;r>=0;r--){var i=n[r].trim();/([\"\'])[^\'\"]+\1/.test(i)||(i='"'+i+'"'),n[r]=i}return e.fontStyle+" "+e.fontVariant+" "+e.fontWeight+" "+t+" "+n.join(",")},n.prototype.updateText=function(t){var n=this;this.localStyleID!==this._style.styleID&&(this.dirty=!0,this.localStyleID=this._style.styleID);if(!this.dirty&&t)return;var r=this._style.wordWrap?this.wordWrap(this._text):this._text,i=r.split(/(?:\r\n|\r|\n)/),s=new Array(i.length),o=new Array(i.length),u=0,a=this.getTextDataPerLine(i),f,l,c,h,p;for(f=0;f<i.length;f++){c=0,h=0;for(l=0;l<a[f].length;l++)this.context.font=this.getFont(a[f][l].style),p=a[f][l].fontProperties=PIXI.Text.calculateFontProperties(this.getFont(a[f][l].style)),a[f][l].width=this.context.measureText(a[f][l].text).width,a[f][l].height=Math.max(a[f][l].fontProperties.fontSize,a[f][l].style.fontSize+a[f][l].style.strokeThickness,a[f][l].style.lineHeight),c+=a[f][l].width,a[f][l].style.lineHeight!=0?h=Math.max(h,a[f][l].style.lineHeight):h=Math.max(h,a[f][l].height);s[f]=c,o[f]=h,u=Math.max(u,c)}this.style.wordWrap&&this.style.wordWrapWidth&&(u=Math.max(u,this.style.wordWrapWidth));var d=Object.keys(this._textStyles).map(function(e){return n._textStyles[e]}),v=d.reduce(function(e,t){return Math.max(e,t.strokeThickness)},0),m=d.reduce(function(e,t){var n=t.dropShadow?t.dropShadowDistance:0;return Math.max(e,n)},0),g=d.reduce(function(e,t){return Math.max(e,t.padding)},0),y=u+m;y+=g*2,this.canvas.width=Math.ceil((y+this.context.lineWidth)*this.resolution);var b=Math.max.apply(null,o)*i.length+m;b+=g*2,this.canvas.height=b*this.resolution,this.context.scale(this.resolution,this.resolution),this.context.textBaseline=this._style.textBaseline,this.context.lineJoin=this._style.lineJoin,this.context.miterLimit=this._style.miterLimit;var w,E,S=0;for(f=0;f<a.length;f++){var x=a[f],T=0,N=0,C=0,k=this.style.align===e.JUSTIFY&&f<a.length-1;if(k){for(l=0;l<x.length;l++){var L=x[l].style,A=x[l].text;this.context.font=L.font,this.context.strokeStyle=L.stroke,this.context.lineWidth=L.strokeThickness,this.context.fillStyle=this._generateFillStyle(L.fill,[x[l].text]);var O=A.split(" ");for(var M=0;M<O.length;M++)M<O.length-1?(N+=this.context.measureText(O[M]+" ").width,T++):N+=this.context.measureText(O[M]).width}T>0&&(C=(u-N)/T)}w=0;for(l=0;l<x.length;l++){var L=x[l].style,A=x[l].text,_=x[l].fontProperties;this.context.font=L.font,this.context.strokeStyle=L.stroke,this.context.lineWidth=L.strokeThickness,w+=v*.5,E=v*.5+S+_.ascent,E-=o[f]-x[l].height-(v-L.strokeThickness)*.5;var D=k,P=this.style.align;P==e.JUSTIFY&&(f==a.length-1&&(D=!1,P=this._lastLineAlign),T==0&&(D=!1,P=this._lastLineAlign)),P==e.RIGHT&&w===0?w+=u-s[f]:P==e.CENTER&&w===0&&(w+=(u-s[f])*.5),this._verticalAlign==e.BOTTOM?E+=(o[f]-x[l].height)*2-(v-L.strokeThickness)*.5:this._verticalAlign==e.CENTER&&(E+=(o[f]-x[l].height)*.5-(v-L.strokeThickness)*.5),this.context.fillStyle=this._generateFillStyle(L,[x[l].text]);if(L.dropShadow){this.context.fillStyle=L.dropShadowColor;var H=Math.sin(L.dropShadowAngle)*L.dropShadowDistance,B=Math.cos(L.dropShadowAngle)*L.dropShadowDistance;L.fill&&this.drawLetterSpacing(A,w+H,E+B)}this.context.fillStyle=this._generateFillStyle(L.fill,[x[l].text]),D?(L.stroke&&L.strokeThickness&&(x[l].width=this.drawLetterSpacingJustify(A,w,E,!0,C)),L.fill&&(x[l].width=this.drawLetterSpacingJustify(A,w,E,!1,C))):(L.stroke&&L.strokeThickness&&this.drawLetterSpacing(A,w,E,!0),L.fill&&this.drawLetterSpacing(A,w,E)),w+=x[l].width,w-=v*.5}S+=o[f]}this.updateTexture(),this.onResize()},n.prototype.drawLetterSpacingJustify=function(e,t,n,r,i){var s=0,o=e.split(" ");for(var u=0;u<o.length;u++)this.drawLetterSpacing(o[u],Math.floor(t+s+.5),n,r),u<o.length-1?s+=this.context.measureText(o[u]+" ").width+i:s+=this.context.measureText(o[u]).width;return s},n.prototype.stripTags=function(e){for(var t in this._textStyles)e=e.replace(new RegExp("</?("+t+")>","g"),"");return e},n.prototype.wordWrap=function(e){var t="",n=e.split("\n"),r=this._style.wordWrapWidth,i=[];for(var s=0;s<n.length;s++){var o=n[s].split(" ");i=i.concat(o)}var u=this.getTextDataPerLine(i),a=0;for(var s=0;s<n.length;s++){var f=r,o=n[s].split(" ");for(var l=0;l<o.length;l++){if(u[a].length!=0){this.context.font=this.getFont(u[a][0].style);var c=this.context.measureText(this.stripTags(o[l])).width;if(this._style.breakWords&&c>r){var h=o[l].split("");for(var p=0;p<h.length;p++){var d=this.context.measureText(h[p]).width;d>f?(t+="\n"+h[p],f=r-d):(p===0&&(t+=" "),t+=h[p],f-=d)}}else{var v=c+this.context.measureText(" ").width;l===0||v>f?(l>0&&(t+="\n"),t+=o[l],f=r-c):(f-=v,t+=" "+o[l])}}a++}s<n.length-1&&(t+="\n")}return t},Object.defineProperty(n.prototype,"textStyles",{get:function(){return this._textStyles},set:function(e){this.createTextStyles(e)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"verticalAlign",{get:function(){return this._verticalAlign},set:function(e){if(e==this._verticalAlign)return;this._verticalAlign=e,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"lastLineAlign",{get:function(){return this._lastLineAlign},set:function(e){if(e==this._lastLineAlign)return;this._lastLineAlign=e,this.dirty=!0},enumerable:!0,configurable:!0}),n}(e.display.Text);t.MultiStyleText=n})(t=e.display||(e.display={}))})(gf||(gf={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n,r,i,s){var o=t.call(this,n.game)||this;return o.cubeList=n,o.key="cube_"+r,o._count=Math.max(0,i),o._id=r,o._remaining=Math.max(0,i),o._index=s,o.bg=new gf.display.Sprite(o.game,PIXI.Texture.WHITE),o.bg.tint=e.COLOR_LIGHT_GREY,o.bg.width=o.bg.height=65,o.addChild(o.bg),o.cube=new gf.display.Sprite(o.game,"sprites",o.key),o.cube.width=o.bg.width,o.cube.height=o.bg.height,o.addChild(o.cube),o.tfLabel=new gf.display.Text(o.game,loc(o.key),e.TEXT_STYLE_BUTTON_ICON.clone()),o.tfLabel.anchor.set(.5,1),o.tfLabel.x=o.bg.width>>1,o.tfLabel.y=o.bg.height,o.addChild(o.tfLabel),o.tfCount=new gf.display.Text(o.game,loc("cubes_count",{count:o._count,remaining:o._count}),e.TEXT_STYLE_BUTTON_ICON.clone()),o.tfCount.style.fontFamily=e.DEFAULT_FONT_HEAVY,o.tfCount.x=2,o.addChild(o.tfCount),o.hitArea=o.getLocalBounds(),o.setState(gf.OUT),o}return __extends(n,t),n.prototype.setState=function(t){if(this._remaining==0){this.bg.tint=e.COLOR_LIGHT_GREY;return}if(this._isSelected){this.bg.tint=e.COLOR_YELLOW;return}switch(this._currentState){case gf.DOWN:this.bg.tint=e.COLOR_YELLOW;break;case gf.OUT:this.bg.tint=e.COLOR_LIGHT_GREY;break;case gf.OVER:this.bg.tint=e.COLOR_YELLOW;break;case gf.UP:this.isOver?this.bg.tint=e.COLOR_YELLOW:this.bg.tint=e.COLOR_LIGHT_GREY}},Object.defineProperty(n.prototype,"count",{get:function(){return this._count},set:function(e){this._count=Math.max(0,e),this.tfCount.text=loc("cubes_count",{count:this._count,remaining:this._remaining})},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"index",{get:function(){return this._index},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isSelected",{get:function(){return this._isSelected},set:function(e){if(e==this._isSelected)return;this._isSelected=e,this.setState(this.currentState)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"remaining",{get:function(){return this._remaining},set:function(e){this._remaining=Math.max(0,e),this.tfCount.text=loc("cubes_count",{count:this._count,remaining:this._remaining}),this.cubeList.updateUsed(),this.alpha=this._remaining>0?1:.5},enumerable:!0,configurable:!0}),n}(gf.ui.Button);t.CubeListItem=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n.game)||this;return r.cubeList=n,r.interactive=!0,r.bg=new gf.display.Sprite(r.game,PIXI.Texture.WHITE),r.bg.alpha=.9,r.bg.width=r.bg.height=r.cubeList.listMask.height,r.addChild(r.bg),r.contentMask=new gf.display.Sprite(r.game,PIXI.Texture.WHITE),r.contentMask.width=r.bg.width,r.contentMask.height=r.bg.height,r.addChild(r.contentMask),r.content=new gf.display.Container(r.game),r.content.mask=r.contentMask,r.addChild(r.content),r.scrollbar=new e.ui.Scrollbar(r.game),r.addChild(r.scrollbar),r.bounds=new gf.display.Sprite(r.game,PIXI.Texture.EMPTY),r.content.addChild(r.bounds),r.tf=new gf.display.Text(r.game),r.tf.x=e.PADDING,r.tf.y=e.PADDING,r.tf.style=e.TEXT_STYLE_SMALL.clone(),r.tf.style.wordWrap=!0,r.content.addChild(r.tf),r.bt=new e.ui.TextButton(r.game,loc("bt_shop_visit"),!0),r.bt.on(gf.CLICK,r.onShop,r),r.bt.x=e.PADDING,r.bt.visible=r.game.client.config.isShopAvailable,r.content.addChild(r.bt),mAbo.on(e.clientmodels.Abo.ABO,function(){return r.onSets()}),mGift.on(e.clientmodels.Gift.GIFT,function(){return r.onSets()}),r.cubeList.bottomMenu.gameScreen.playground.on(e.PLAYGROUND_READY,function(){return r.onSets()}),r}return __extends(n,t),n.prototype.onSets=function(){var t=this;this.setsMissing=[];var n=[],r=!1;if(mAbo.hasAbo()||mAbo.getAbo().sets.length>0)n=n.concat(mAbo.getAbo().sets);n=n.concat(mGift.getGift().sets),mTrack.data.sets.forEach(function(i){i!=e.SETS.WEB_ONE&&n.indexOf(i)==-1&&(r=!0,t.setsMissing.push(i))}),mTrack.data.competition&&mTrack.owner.id==mUser.getUserId()&&(r=!1),mTrack.data.competition&&mTrack.data.competition.hasSubmitted&&(r=!0),r?this.show():this.hide()},n.prototype.onShop=function(){track("CubesMissing-Shop"),this.game.client.config.isRussian?mUser.isLoggedIn()?window.open(e.SHOP_LINK_RU,"_blank"):this.game.overlays.show(e.overlays.Login.NAME):this.game.overlays.show(e.overlays.Shop.NAME)},n.prototype.show=function(){var e="";mTrack.data.competition&&mTrack.data.competition.hasSubmitted?(this.tf.text=loc("error_track_competition"),this.bt.visible=!1):(this.setsMissing.forEach(function(t,n){n!=0&&(e+=", "),e+=loc("packshot_"+t)}),this.tf.text=loc("shop_cubes_missing",{sets:e}),this.bt.visible=!0),this.visible=!0,this.onResize()},n.prototype.hide=function(){this.visible=!1},n.prototype.onResize=function(){if(!this.visible)return;t.prototype.onResize.call(this),this.bg.width=this.cubeList.bottomMenu.listBg.width-e.PADDING*2,this.contentMask.width=this.bounds.width=this.bg.width-this.scrollbar.width,this.bg.height=this.contentMask.height=this.cubeList.listMask.height,this.tf.style.wordWrapWidth=this.bg.width-e.PADDING*3-this.scrollbar.width,this.bt.y=this.tf.bottom+e.PADDING*2,this.bounds.height=this.bt.bottom+e.PADDING,this.scrollbar.update(this.content,this.contentMask,-e.PADDING),this.scrollbar.visible=this.scrollbar.sizeScroll>this.scrollbar.sizeVisible},n}(gf.display.Container);t.CubeListMissing=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n.game)||this;return r.bottomMenu=n,r.interactive=!0,r.items=[],r.scrollEnd=0,r._total=0,r.listMask=new gf.display.Sprite(r.game,PIXI.Texture.WHITE),r.listMask.height=135,r.addChild(r.listMask),r.scrollbar=new e.ui.Scrollbar(r.game),r.scrollbar.on(gf.UPDATE,r.onScrollbar,r),r.addChild(r.scrollbar),r.list=new gf.display.Container(r.game),r.list.interactive=!0,r.list.mask=r.listMask,r.addChild(r.list),r.bounds=new gf.display.Sprite(r.game,PIXI.Texture.EMPTY),r.bounds.on("touchstart mousedown",r.onDown,r),r.bounds.interactive=!0,r.list.addChild(r.bounds),r.missing=new e.ui.CubeListMissing(r),r.missing.visible=!1,r.addChild(r.missing),r.sets=r.game.cache.getJSON("sets"),r}return __extends(n,t),n.prototype.onScrollbar=function(){this.bounds.width=this.bounds.height=1,this._minY=this.listMask.y-this.list.height+this.listMask.height,this.bounds.width=this.listMask.width,this.bounds.height=this.scrollbar.sizeScroll},n.prototype.onDown=function(e){if(this._isDragging)return;if(!this.scrollbar.visible)return;if(this.missing.visible)return;this.game.sounds.playFx("fx","click"),this.on("mouseup mouseupoutside touchend touchendoutside",this.onUp,this),this._dragDistance=0,this.onMove(e)},n.prototype.onMove=function(e){if(this._isDragging){var t=e.data.global.y-this._dragStart;this.list.y=Math.min(this.listMask.y,Math.max(this._minY,this._startY+t)),this.scrollbar.updateToContentPosition()}else this._isDragging=!0,this._dragStart=e.data.global.y,this._startY=this.list.y,this.on("mousemove touchmove",this.onMove,this),this.emit(gf.DRAG_START)},n.prototype.onUp=function(){this._isDragging&&(this._isDragging=!1,this.removeAllListeners("mousemove mouseup mouseupoutside touchmove touchend touchendoutside"))},n.prototype.selectItem=function(e){this.currentItem&&(this.currentItem.isSelected=!1),this.currentItem==e?this.deselectItems():(this.currentItem=e,this.currentItem.isSelected=!0,this.bottomMenu.gameScreen.playground.placeables.show()),this.bottomMenu.gameScreen.playground.cubes.selected=null},n.prototype.getIndex=function(e){return this.sets.index[e]},n.prototype.onItemClick=function(t,n){var r=this.bottomMenu.gameScreen.playground;if(n.remaining===0||r.select.cubeSpawning)return;if(r.cubes.swapping){this.deselectItems();var i=r.cubes.selected.id,s=new e.core.Cube(r,n.key);r.cubes.swap(s),r.cubes.remove(r.cubes.getById(i)),r.cubes.selected=s,n.remaining--}else this.bottomMenu.gameScreen.moveMenu.hide(),this.bottomMenu.gameScreen.rotateMenu.hide(),this.selectItem(n);this.dragItem.removeAllListeners("mousemove touchmove")},n.prototype.onItemDown=function(e,t){var n=this;t.remaining>0&&!this.itemSpawned&&(this.dragItem=t,this.dragStart=e.data.global.clone(),this.dragItem.on("mousemove touchmove",function(e){return n.onItemMove(e,t)},this))},n.prototype.onItemMove=function(e,t){var n=this,r=this.bottomMenu.gameScreen.playground;if(r.select.cubeSpawning)return;!this.itemSpawned&&gf.utils.Maths.distance(this.dragStart,e.data.global)>10&&(t.remaining--,this.itemSpawned=!0,this.selectItem(t),r.cubes.selected=null,r.select.spawnCube(e.data.originalEvent,t.key),t.once(gf.UP,function(e){return n.onItemUp(e,t)},this))},n.prototype.onItemUp=function(e,t){this.dragItem.removeAllListeners("mousemove touchmove"),this.itemSpawned&&(this.bottomMenu.gameScreen.playground.select.placeCube(),this.deselectItems()),this.itemSpawned=!1},n.prototype.addItem=function(t,n,r){var i=this,s=this.getItemById(t);s?(s.count+=n,s.remaining+=n):(s=new e.ui.CubeListItem(this,t,n,r),s.on(gf.CLICK,function(e){return i.onItemClick(e,s)},this),s.on(gf.DOWN,function(e){return i.onItemDown(e,s)},this),this.list.addChild(s),this.items.push(s)),this._total+=n},n.prototype.addItems=function(e){for(var t in e)this.addItem(t,e[t],this.getIndex(t))},n.prototype.addSet=function(e){var t=this;if(!this.sets[e])return;this.sets[e].forEach(function(e){t.addItem(e[0],e[1],t.getIndex(e[0]))})},n.prototype.deselectItems=function(){this.currentItem&&(this.currentItem.isSelected=!1),this.currentItem=null,this.bottomMenu.gameScreen.playground.placeables.hide()},n.prototype.getItems=function(){return this.items},n.prototype.getItemByKey=function(e){var t=null;return this.items.forEach(function(n){if(n.key===e)return t=n,!0}),t},n.prototype.getItemById=function(e){var t=null;return this.items.forEach(function(n){if(n.id===e)return t=n,!0}),t},n.prototype.updateUsed=function(){var e=0;this.items.forEach(function(t){e+=t.remaining,t.buttonMode=t.remaining>0}),this.used=this.total-e},n.prototype.arrange=function(t){if(this.items.length==0)return;this.items.sort(function(e,t){return e.index<t.index?-1:1}),this.lastWidth=t,this.bounds.height=1;var n;this.list.y=this.listMask.y,n=this.items[0].width,t-=this.scrollbar.width+e.PADDING*2;var r=0,i=0,s=Math.floor(t/(n+e.PADDING));this.items.forEach(function(t){r==s&&(i++,r=0),t.x=r*n+r*e.PADDING,t.y=i*n+i*e.PADDING,t.buttonMode=t.remaining>0,r++}),this.scrollbar.x=s*n+s*e.PADDING,this.listMask.width=this.scrollbar.x,this.bounds.width=this.listMask.width,this.bounds.height=this.list.height,this.scrollbar.update(this.list,this.listMask,0),this.scrollbar.visible=this.scrollbar.sizeScroll>this.scrollbar.sizeVisible,this.missing.onResize()},n.prototype.reset=function(){this.list.removeChildren(),this.list.y=this.listMask.y,this.list.addChild(this.bounds),this.itemSpawned=!1,this.scrollbar.reset(),this.currentItem=null,this.dragItem=null,this.items=[],this._total=0},Object.defineProperty(n.prototype,"total",{get:function(){return this._total},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"used",{set:function(e){this.game.stage.header.trackMenu.updateCubesUsed(this._total,e)},enumerable:!0,configurable:!0}),n}(gf.display.Container);t.CubeList=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n)||this;return r.interactiveChildren=!1,r.bg=new gf.display.Sprite(n,"sprites","bt_dropheight_out"),r.addChild(r.bg),r.icon=new gf.display.Sprite(n,"sprites"),r.icon.anchor.set(.5),r.icon.x=r.bg.width>>1,r.icon.y=r.bg.height>>1,r.addChild(r.icon),r.hitArea=r.getLocalBounds(),r.setState(gf.OUT),r.on(gf.CLICK,function(){return r.game.sounds.playFx("fx","click")},r),r.dropHeight=e.MARBLE_DROP_HEIGHT_DEFAULT,r}return __extends(n,t),n.prototype.setState=function(t){if(this._isSelected)return;if(!this._isEnabled){this.bg.frameName="bt_dropheight_down",this.bg.alpha=.6,this.icon&&(this.icon.alpha=.6,this.icon.tint=e.COLOR_DARK_GREY);return}this.bg.alpha=1,this.icon&&(this.icon.alpha=1);switch(this._currentState){case gf.DOWN:this.bg.frameName="bt_dropheight_down",this.icon&&(this.icon.tint=e.COLOR_DARK_GREY);break;case gf.OUT:this.bg.frameName="bt_dropheight_out",this.icon&&(this.icon.tint=e.COLOR_DARK_GREY);break;case gf.OVER:this.bg.frameName="bt_dropheight_over",this.icon&&(this.icon.tint=e.COLOR_WHITE);break;case gf.UP:this.isOver?(this.bg.frameName="bt_dropheight_over",this.icon&&(this.icon.tint=e.COLOR_WHITE)):(this.bg.frameName="bt_dropheight_out",this.icon&&(this.icon.tint=e.COLOR_DARK_GREY))}},n.prototype.forceState=function(e){this._currentState=e,this.setState(e)},Object.defineProperty(n.prototype,"isSelected",{get:function(){return this._isSelected},set:function(e){this._isSelected=e,this._isOver=!1,this.setState(this._currentState)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"dropHeight",{get:function(){return this._dropHeight},set:function(e){if(this._dropHeight==e)return;this._dropHeight=e;switch(this._dropHeight){case"LOW":this.icon.frameName="icon_dropheight_1";break;case"MEDIUM":this.icon.frameName="icon_dropheight_2";break;case"HIGH":this.icon.frameName="icon_dropheight_3"}},enumerable:!0,configurable:!0}),n}(gf.ui.Button);t.DropHeightButton=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(e){var n=t.call(this,e,"marble",loc("bt_marble"))||this;return n.setState(gf.OUT),n}return __extends(n,t),n.prototype.setState=function(t){if(this._isSelected){this.bg.tint!=e.COLOR_YELLOW&&(this.bg.tint=e.COLOR_YELLOW);return}if(!this._isEnabled){this.bg.tint=e.COLOR_GREY,this.icon.alpha=.6,this.icon.tint=e.COLOR_DARK_GREY,this.tfLabel.alpha=.6,this.tfLabel.style.fill=e.COLOR_DARK_GREY;return}this.icon.alpha=1,this.tfLabel.alpha=1;switch(this._currentState){case gf.DOWN:this.bg.tint=e.COLOR_WHITE,this.icon.tint=e.COLOR_DARK_GREY,this.tfLabel.style.fill=e.COLOR_DARK_GREY;break;case gf.OUT:this.bg.tint=e.COLOR_YELLOW,this.icon.tint=e.COLOR_DARK_GREY,this.tfLabel.style.fill=e.COLOR_DARK_GREY;break;case gf.OVER:this.bg.tint=e.COLOR_YELLOW,this.icon.tint=e.COLOR_WHITE,this.tfLabel.style.fill=e.COLOR_WHITE;break;case gf.UP:this.isOver?(this.bg.tint=e.COLOR_YELLOW,this.icon.tint=e.COLOR_WHITE,this.tfLabel.style.fill=e.COLOR_WHITE):(this.bg.tint=e.COLOR_YELLOW,this.icon.tint=e.COLOR_DARK_GREY,this.tfLabel.style.fill=e.COLOR_DARK_GREY)}},n}(e.ui.IconButton);t.MarbleButton=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(e){return t.call(this,e,"arrow")||this}return __extends(n,t),n.prototype.setState=function(t){if(this._isSelected){this.bg.tint!=e.COLOR_YELLOW&&(this.bg.tint=e.COLOR_YELLOW);return}if(!this._isEnabled){this.bg.tint=e.COLOR_GREY,this.icon.alpha=.6,this.icon.tint=e.COLOR_DARK_GREY;return}this.icon.alpha=1;switch(this._currentState){case gf.DOWN:this.bg.tint=e.COLOR_WHITE,this.icon.tint=e.COLOR_DARK_GREY;break;case gf.OUT:this.bg.tint=e.COLOR_YELLOW,this.icon.tint=e.COLOR_DARK_GREY;break;case gf.OVER:this.bg.tint=e.COLOR_YELLOW,this.icon.tint=e.COLOR_WHITE;break;case gf.UP:this.isOver?(this.bg.tint=e.COLOR_YELLOW,this.icon.tint=e.COLOR_WHITE):(this.bg.tint=e.COLOR_YELLOW,this.icon.tint=e.COLOR_DARK_GREY)}},n}(e.ui.IconButton);t.MoveTrackIconButton=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n.game,"move_track",loc("bt_move_track"))||this;r.playground=n.gameScreen.playground,r.interactiveChildren=!0,r.hitArea=null,r.buttons=new gf.display.Container(r.game),r.buttons.interactive=!0,r.buttons.x=-2,r.buttons.y=-262,r.buttons.visible=!1,r.addChildAt(r.buttons,0);var i=new gf.display.Sprite(r.game,PIXI.Texture.WHITE);i.width=r.bg.width+4,i.height=262,i.tint=e.COLOR_LIGHT_GREY,r.buttons.addChild(i);var s=new gf.display.Sprite(r.game,PIXI.Texture.WHITE);s.width=r.bg.width,s.height=260,s.x=2,s.y=2,s.tint=e.COLOR_YELLOW,r.buttons.addChild(s),r.btUp=new e.ui.MoveTrackIconButton(r.game),r.btUp.on(gf.CLICK,r.onUp,r),r.btUp.icon.angle=-90,r.btUp.x=2,r.btUp.y=2,r.buttons.addChild(r.btUp),r.btRight=new e.ui.MoveTrackIconButton(r.game),r.btRight.on(gf.CLICK,r.onRight,r),r.btRight.x=2,r.btRight.y=67,r.buttons.addChild(r.btRight),r.btLeft=new e.ui.MoveTrackIconButton(r.game),r.btLeft.on(gf.CLICK,r.onLeft,r),r.btLeft.icon.angle=180,r.btLeft.x=2,r.btLeft.y=132,r.buttons.addChild(r.btLeft),r.btDown=new e.ui.MoveTrackIconButton(r.game),r.btDown.on(gf.CLICK,r.onDown,r),r.btDown.icon.angle=90,r.btDown.x=2,r.btDown.y=197,r.buttons.addChild(r.btDown);var o=new gf.display.Sprite(r.game,PIXI.Texture.EMPTY);return o.interactive=!0,o.buttonMode=!0,o.width=r.bg.width,o.height=r.bg.height,o.on("click tap",r.onMoveTrack,r),r.addChild(o),r}return __extends(n,t),n.prototype.onClickOutside=function(e){if(!this.isSelected)return;var t=e.data.getLocalPosition(this);this.getLocalBounds().contains(t.x,t.y)||this.onMoveTrack()},n.prototype.getLimits=function(){var e=this;this.maxX=-1,this.maxZ=-1,this.minX=-1,this.minZ=-1,this.playground.cubes.cubes.forEach(function(t){e.maxX=e.maxX==-1?t.mapPosition.x:Math.max(e.maxX,t.mapPosition.x),e.maxZ=e.maxZ==-1?t.mapPosition.z:Math.max(e.maxZ,t.mapPosition.z),e.minX=e.minX==-1?t.mapPosition.x:Math.min(e.minX,t.mapPosition.x),e.minZ=e.minZ==-1?t.mapPosition.z:Math.min(e.minZ,t.mapPosition.z)})},n.prototype.moveCubes=function(t,n){var r=this;if(this.playground.controls.isDirectionX){var i=t;t=n,n=i,this.playground.controls.direction==1&&(t*=-1),this.playground.controls.direction==-1&&(n*=-1)}else t*=this.playground.controls.direction,n*=this.playground.controls.direction;if(this.minX+t<0)return;if(this.minZ+n<0)return;if(this.maxX+t>=e.MAX_X)return;if(this.maxZ+n>=e.MAX_Z)return;this.playground.cubes.cubes.forEach(function(i){r.playground.map.setAt(e.EMPTY,i.mapPosition.x,i.mapPosition.y,i.mapPosition.z),i.mapPosition.x+=t,i.mapPosition.z+=n}),this.playground.cubes.cubes.forEach(function(e){r.playground.map.setAt(e.id,e.mapPosition.x,e.mapPosition.y,e.mapPosition.z),r.playground.cubes.updatePosition(e)}),this.playground.save(),this.playground.history.save(),this.getLimits()},n.prototype.checkCubes=function(t,n){if(this.playground.isCompetition)return!1;if(this.playground.controls.isDirectionX){var r=t;t=n,n=r,this.playground.controls.direction==1&&(t*=-1),this.playground.controls.direction==-1&&(n*=-1)}else t*=this.playground.controls.direction,n*=this.playground.controls.direction;return this.minX+t<0?!1:this.minZ+n<0?!1:this.maxX+t>=e.MAX_X?!1:this.maxZ+n<e.MAX_Z},n.prototype.updateButtons=function(){this.btDown.isEnabled=this.checkCubes(0,1),this.btLeft.isEnabled=this.checkCubes(-1,0),this.btRight.isEnabled=this.checkCubes(1,0),this.btUp.isEnabled=this.checkCubes(0,-1)},n.prototype.onDown=function(){if(this.playground.missingSets||!this.isEnabled)return;this.getLimits(),this.moveCubes(0,1),this.playground.emit(e.CUBE_UPDATE),this.updateButtons()},n.prototype.onLeft=function(){if(this.playground.missingSets||!this.isEnabled)return;this.getLimits(),this.moveCubes(-1,0),this.playground.emit(e.CUBE_UPDATE),this.updateButtons()},n.prototype.onRight=function(){if(this.playground.missingSets||!this.isEnabled)return;this.getLimits(),this.moveCubes(1,0),this.playground.emit(e.CUBE_UPDATE),this.updateButtons()},n.prototype.onUp=function(){if(this.playground.missingSets||!this.isEnabled)return;this.getLimits(),this.moveCubes(0,-1),this.playground.emit(e.CUBE_UPDATE),this.updateButtons()},n.prototype.onMoveTrack=function(){if(this.playground.missingSets||!this.isEnabled)return;this.isSelected=!this.isSelected,this.buttons.visible=this.isSelected,this.isSelected&&(this.getLimits(),this.updateButtons()),this.isSelected?this.game.stage.on("mousedown touchstart",this.onClickOutside,this):this.game.stage.off("mousedown touchstart",this.onClickOutside)},n}(e.ui.IconButton);t.MoveTrackButton=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n,r){var i=t.call(this,n.game)||this;return i.packshotList=n,i.key="packshot_"+r,i._id=r,i.bg=new gf.display.Sprite(i.game,PIXI.Texture.WHITE),i.bg.tint=e.COLOR_LIGHT_GREY,i.bg.width=80,i.bg.height=65,i.addChild(i.bg),i.packshot=new gf.display.Sprite(i.game,"sprites",i.key),i.addChild(i.packshot),i.tfLabel=new gf.display.Text(i.game,loc(i.key),e.TEXT_STYLE_BUTTON_ICON.clone()),i.tfLabel.anchor.set(.5,1),i.tfLabel.x=i.bg.width>>1,i.tfLabel.y=i.bg.height,i.addChild(i.tfLabel),i.hitArea=i.getLocalBounds(),i.on(gf.CLICK,function(){return i.game.sounds.playFx("fx","click")},i),i.setState(gf.OUT),i}return __extends(n,t),n.prototype.setState=function(t){if(this._isSelected){this.bg.tint=e.COLOR_YELLOW;return}switch(this._currentState){case gf.DOWN:this.bg.tint=e.COLOR_YELLOW;break;case gf.OUT:this.bg.tint=e.COLOR_LIGHT_GREY;break;case gf.OVER:this.bg.tint=e.COLOR_YELLOW;break;case gf.UP:this.isOver?this.bg.tint=e.COLOR_YELLOW:this.bg.tint=e.COLOR_LIGHT_GREY}},Object.defineProperty(n.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isSelected",{get:function(){return this._isSelected},set:function(e){if(e==this._isSelected)return;this._isSelected=e,this.setState(this.currentState)},enumerable:!0,configurable:!0}),n}(gf.ui.Button);t.PackshotListItem=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n.game)||this;return r.bottomMenu=n,r.interactive=!0,r.items=[],r.scrollEnd=0,r.listMask=new gf.display.Sprite(r.game,PIXI.Texture.WHITE),r.listMask.width=80,r.listMask.height=135,r.addChild(r.listMask),r.scrollbar=new e.ui.Scrollbar(r.game),r.addChild(r.scrollbar),r.list=new gf.display.Container(r.game),r.list.interactive=!0,r.list.mask=r.listMask,r.addChild(r.list),r.sets=r.game.cache.getJSON("sets"),r}return __extends(n,t),n.prototype.selectItem=function(e){this.currentItem&&(this.currentItem.isSelected=!1),this.currentItem==e?(this.currentItem=null,this.bottomMenu.gameScreen.playground.placeables.hide()):(this.currentItem=e,this.bottomMenu.gameScreen.playground.placeables.show()),this.bottomMenu.gameScreen.playground.cubes.selected=null},n.prototype.onItemClick=function(e){this.selectItem(e)},n.prototype.addItem=function(t){var n=this,r=new e.ui.PackshotListItem(this,t);r.on(gf.CLICK,function(){return n.onItemClick(r)},this),this.list.addChild(r),this.items.push(r),this.arrange()},n.prototype.deselectItems=function(){this.currentItem&&(this.currentItem.isSelected=!1),this.currentItem=null},n.prototype.arrange=function(){if(this.items.length==0)return;this.list.y=0,this.items.forEach(function(t,n){t.y=n*65+n*e.PADDING}),this.scrollbar.update(this.list,this.listMask,e.PADDING),this.scrollbar.visible=this.scrollbar.sizeScroll>this.scrollbar.sizeVisible},n.prototype.reset=function(){this.list.removeChildren(),this.items=[]},n}(gf.display.Container);t.PackshotList=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n,r,i){var s=t.call(this,n,r,i)||this;s.interactiveChildren=!0,s.inverse=!1,s.hitArea=null,s.slider=new gf.display.Container(s.game),s.slider.interactive=!0,s.slider.x=-2,s.slider.y=-134,s.slider.visible=!1,s.addChildAt(s.slider,0);var o=new gf.display.Sprite(s.game,PIXI.Texture.WHITE);o.width=s.bg.width+4,o.height=134,o.tint=e.COLOR_LIGHT_GREY,s.slider.addChild(o);var u=new gf.display.Sprite(s.game,PIXI.Texture.WHITE);u.width=s.bg.width,u.height=132,u.x=2,u.y=2,u.tint=e.COLOR_YELLOW,s.slider.addChild(u),s.track=new gf.display.Sprite(s.game,PIXI.Texture.WHITE),s.track.interactive=!0,s.track.width=15,s.track.height=105,s.track.tint=e.COLOR_WHITE,s.track.x=u.width-s.track.width>>1,s.track.y=17,s.track.on("click tap",s.onClick,s),s.slider.addChild(s.track),s.thumb=new gf.display.Sprite(s.game,PIXI.Texture.WHITE),s.thumb.tint=e.COLOR_DARK_GREY,s.thumb.interactive=!0,s.thumb.buttonMode=!0,s.thumb.width=17,s.thumb.height=17,s.thumb.x=u.width-s.thumb.width>>1,s.thumb.y=s.track.y,s.thumb.on("mouseover",s.onOver,s),s.thumb.on("mouseout",s.onOut,s),s.thumb.on("mousedown touchstart",s.onDown,s),s.thumb.on("mouseup touchend mouseupoutside",s.onUp,s),s.thumb.on("mousemove touchmove",s.onMove,s),s.slider.addChild(s.thumb),s.iconTop=new gf.display.Sprite(s.game,"sprites","icon_slider_top"),s.iconTop.tint=e.COLOR_DARK_GREY,s.iconTop.x=s.track.x,s.iconTop.y=s.track.y-s.iconTop.height,s.slider.addChild(s.iconTop),s.iconBottom=new gf.display.Sprite(s.game,"sprites","icon_slider_bottom"),s.iconBottom.tint=e.COLOR_DARK_GREY,s.iconBottom.x=s.track.x,s.iconBottom.y=s.track.bottom,s.slider.addChild(s.iconBottom),s.max=s.track.y,s.min=s.track.y+s.track.height-s.thumb.height;var a=new gf.display.Sprite(s.game,PIXI.Texture.EMPTY);return a.interactive=!0,a.buttonMode=!0,a.width=s.bg.width,a.height=s.bg.height,a.on("click tap",s.onSlider,s),s.addChild(a),s}return __extends(n,t),n.prototype.onClickOutside=function(e){if(!this.isSelected)return;var t=e.data.getLocalPosition(this);this.getLocalBounds().contains(t.x,t.y)||this.onSlider()},n.prototype.onClick=function(e){this.thumb.y=Math.max(this.max,Math.min(this.min,e.data.getLocalPosition(this.slider).y-(this.thumb.height>>1))),this.update()},n.prototype.onOver=function(){this.thumb.tint=e.COLOR_GREY},n.prototype.onOut=function(){this.isDragging||(this.thumb.tint=e.COLOR_DARK_GREY)},n.prototype.onDown=function(t){this.startDragY=t.data.global.y,this.startY=this.thumb.y,this.thumb.tint=e.COLOR_DARK_GREY,this.isDragging=!0},n.prototype.onUp=function(){this.thumb.alpha=1,this.isDragging=!1,this.thumb.tint=this.isOver?e.COLOR_GREY:e.COLOR_DARK_GREY,this.update()},n.prototype.onMove=function(e){this.isDragging&&(this.thumb.y=Math.max(this.max,Math.min(this.min,this.startY+(e.data.global.y-this.startDragY))),this.update())},n.prototype.update=function(){this.emit(gf.CHANGE,this.value)},n.prototype.onSlider=function(){this.isSelected=!this.isSelected,this.slider.visible=this.isSelected,track("Ingame-"+this._icon+(this.slider.visible?"_show":"_hide")),this.isSelected?this.game.stage.on("mousedown touchstart",this.onClickOutside,this):this.game.stage.off("mousedown touchstart",this.onClickOutside)},Object.defineProperty(n.prototype,"value",{get:function(){var e=(this.thumb.y-this.track.y)/(this.track.height-this.thumb.height);return this.inverse?Math.abs(e-1):e},set:function(e){this.inverse&&(e=Math.abs(e-1)),this.thumb.y=Math.max(this.max,Math.min(this.min,e*(this.track.height-this.thumb.height)+this.track.y))},enumerable:!0,configurable:!0}),n}(e.ui.IconButton);t.SliderButton=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n.game)||this;r.interactive=!0,r.gameScreen=n,r.bg=new gf.display.Sprite(r.game,PIXI.Texture.WHITE),r.bg.height=145,r.bg.tint=e.COLOR_LIGHT_GREY,r.addChild(r.bg),r.btMoveView=new e.ui.IconButton(r.game,"move_view",loc("bt_move_view")),r.btMoveView.on(gf.CLICK,r.onMoveView,r),r.btMoveView.x=e.PADDING,r.btMoveView.y=e.PADDING,r.addChild(r.btMoveView),r.btLayerDistance=new e.ui.SliderButton(r.game,"distance_layer",loc("bt_distance_layer")),r.btLayerDistance.on(gf.CHANGE,r.onLayerDistance,r),r.btLayerDistance.on(gf.CLICK,r.updateSlider,r),r.btLayerDistance.inverse=!0,r.btLayerDistance.x=e.PADDING,r.btLayerDistance.y=r.bg.height-r.btLayerDistance.height-e.PADDING,r.addChild(r.btLayerDistance),r.btOpacity=new e.ui.SliderButton(r.game,"opacity",loc("bt_opacity")),r.btOpacity.on(gf.CHANGE,r.onOpacity,r),r.btOpacity.on(gf.CLICK,r.updateSlider,r),r.btOpacity.inverse=!0,r.btOpacity.x=r.btMoveView.right+e.PADDING,r.btOpacity.y=r.btMoveView.y,r.addChild(r.btOpacity),r.btAddSets=new e.ui.IconButton(r.game,"plus",loc("bt_select_sets",{count:0})),r.btAddSets.on(gf.CLICK,r.onAddSets,r),r.btAddSets.x=r.btOpacity.right+e.PADDING,r.btAddSets.y=r.btMoveView.y,r.addChild(r.btAddSets);var i=new gf.display.Sprite(r.game,"sprites","icon_add_set");return r.btAddSets.addChildAt(i,r.btAddSets.getChildIndex(r.btAddSets.icon)),r.btElementsDistance=new e.ui.SliderButton(r.game,"distance_elements",loc("bt_distance_elements")),r.btElementsDistance.on(gf.CHANGE,r.onElementsDistance,r),r.btElementsDistance.on(gf.CLICK,r.updateSlider,r),r.btElementsDistance.inverse=!0,r.btElementsDistance.x=r.btOpacity.x,r.btElementsDistance.y=r.btLayerDistance.y,r.addChild(r.btElementsDistance),r.btZoom=new e.ui.SliderButton(r.game,"zoom",loc("bt_zoom")),r.btZoom.on(gf.CHANGE,r.onZoom,r),r.btZoom.on(gf.CLICK,r.updateSlider,r),r.btZoom.inverse=!0,r.btZoom.x=r.btAddSets.x,r.btZoom.y=r.btLayerDistance.y,r.addChild(r.btZoom),r.listBg=new gf.display.Sprite(r.game,PIXI.Texture.WHITE),r.listBg.tint=e.COLOR_MID_GREY,r.listBg.height=r.bg.height,r.listBg.x=r.btZoom.right+e.PADDING,r.addChild(r.listBg),r.cubeList=new e.ui.CubeList(r),r.cubeList.x=r.listBg.x+e.PADDING,r.cubeList.y=e.PADDING,r.addChild(r.cubeList),r.btUndo=new e.ui.IconButton(r.game,"undo",loc("bt_undo")),r.btUndo.y=e.PADDING,r.btUndo.on(gf.CLICK,r.onUndo,r),r.addChild(r.btUndo),r.btRedo=new e.ui.IconButton(r.game,"redo",loc("bt_redo")),r.btRedo.y=e.PADDING,r.btRedo.on(gf.CLICK,r.onRedo,r),r.addChild(r.btRedo),r.btDelete=new e.ui.IconButton(r.game,"delete",loc("bt_delete")),r.btDelete.on(gf.CLICK,r.onDelete,r),r.btDelete.y=r.btLayerDistance.y,r.addChild(r.btDelete),r.btSwap=new e.ui.IconButton(r.game,"swap",loc("bt_swap")),r.btSwap.on(gf.CLICK,r.onSwap,r),r.btSwap.y=r.btLayerDistance.y,r.addChild(r.btSwap),r.btMoveCube=new e.ui.IconButton(r.game,"move_cube",loc("bt_move_cube")),r.btMoveCube.on(gf.CLICK,r.onMoveCube,r),r.btMoveCube.y=r.btLayerDistance.y,r.addChild(r.btMoveCube),r.btDropHeight=new e.ui.DropHeightButton(r.game),r.btDropHeight.on(gf.CLICK,r.onDropHeight,r),r.btDropHeight.y=e.PADDING,r.addChild(r.btDropHeight),r.btMoveTrack=new e.ui.MoveTrackButton(r),r.btMoveTrack.y=r.btLayerDistance.y,r.addChild(r.btMoveTrack),r.btMarble=new e.ui.MarbleButton(r.game),r.btMarble.y=e.PADDING,r.btMarble.on(gf.DOWN,r.onMarbleDown,r),r.btMarble.on(gf.UP,r.onMarbleUp,r),r.btMarble.on(gf.CLICK,r.onMarbleClick,r),r.addChild(r.btMarble),r.gameScreen.playground.history.on(gf.CHANGE,r.onHistory,r),r.gameScreen.playground.on(e.CAMERA_UPDATE,r.updateSlider,r),r.gameScreen.playground.on(e.CUBE_DESELECTED,r.deselectCube,r),r.onResize(),r}return __extends(n,t),n.prototype.updateSlider=function(){var e=this.gameScreen.playground;this.btElementsDistance.value=e.elementMargin,this.btLayerDistance.value=e.layerMargin,this.btOpacity.value=Math.abs(e.cubeOpacity/.5-2);var t=e.controls.settings.maxDistance,n=e.controls.settings.minDistance;this.btZoom.value=1-(e.controls.distance-n)/(t-n)},n.prototype.deselectCube=function(){this.btSwap.isSelected=!1,this.gameScreen.moveMenu.hide(),this.gameScreen.rotateMenu.hide()},n.prototype.updateElementMargin=function(){var t=this.gameScreen.playground;t.elementMargin=this._elementMargin,this.btElementsDistance.value=this._elementMargin,t.cubes.cubes.forEach(function(e){e.x=t.map.xTo3DPos(e.mapPosition.x),e.z=t.map.zTo3DPos(e.mapPosition.z)}),t.ground.tiles.forEach(function(e){e.position.x=t.map.xTo3DPos(e.userData.x),e.position.z=t.map.zTo3DPos(e.userData.z)}),t.placeables.tiles.forEach(function(e){e.position.x=t.map.xTo3DPos(e.userData.x),e.position.z=t.map.zTo3DPos(e.userData.z)}),t.emit(e.CUBE_UPDATE)},n.prototype.updateLayerMargin=function(){var t=this.gameScreen.playground;t.layerMargin=this._layerMargin,this.btLayerDistance.value=this._layerMargin,t.cubes.cubes.forEach(function(e){e.y=t.map.yTo3DPos(e.mapPosition.y)}),t.emit(e.CUBE_UPDATE)},n.prototype.spawnMarble=function(e){this.gameScreen.playground.cubes.selected=null,this.gameScreen.playground.select.spawnMarble(e),this.gameScreen.playground.placeables.hide(),this.gameScreen.moveMenu.hide(),this.gameScreen.rotateMenu.hide()},n.prototype.onAddSets=function(){track("Ingame-Add_sets");var t=this.game.overlays.show(e.overlays.AddSets.NAME);t.bottomMenu=this},n.prototype.onHistory=function(e,t){this.btUndo.isEnabled=e>1,this.btRedo.isEnabled=t},n.prototype.onOpacity=function(e){var t=this.gameScreen.playground;t.cubeOpacity=1-e*.5,t.cubes.cubes.forEach(function(e){e.opacity=t.cubeOpacity})},n.prototype.onElementsDistance=function(e){this.elementMargin=e},n.prototype.onLayerDistance=function(e){this.layerMargin=e},n.prototype.onMoveView=function(){track("Ingame-Move_view"),this.btMoveView.isSelected=!this.btMoveView.isSelected},n.prototype.onZoom=function(e){var t=this.gameScreen.playground,n=t.controls.settings.maxDistance,r=t.controls.settings.minDistance;t.controls.distance=(1-e)*(n-r)+r},n.prototype.onSwap=function(){if(!this.gameScreen.playground.cubes.selected)return;this.btSwap.isSelected?(this.btSwap.isSelected=!1,this.gameScreen.playground.cubes.swapping=null,this.gameScreen.rotateMenu.show()):(this.btSwap.isSelected=!0,this.btMoveCube.isSelected=!1,this.gameScreen.moveMenu.hide(),this.gameScreen.rotateMenu.hide(),this.gameScreen.playground.cubes.swapping=this.gameScreen.playground.cubes.selected)},n.prototype.onDropHeight=function(){this.btDropHeight.dropHeight=="HIGH"?this.btDropHeight.dropHeight="LOW":this.btDropHeight.dropHeight=="LOW"?this.btDropHeight.dropHeight="MEDIUM":this.btDropHeight.dropHeight="HIGH"},n.prototype.onRedo=function(){track("Ingame-Redo"),this.gameScreen.playground.history.redo()},n.prototype.onUndo=function(){track("Ingame-Undo"),this.gameScreen.playground.history.undo()},n.prototype.onMoveCube=function(){this.btMoveCube.isSelected?(this.btMoveCube.isSelected=!1,this.gameScreen.moveMenu.hide()):(this.btMoveCube.isSelected=!0,this.gameScreen.playground.cubes.selected&&this.gameScreen.moveMenu.show())},n.prototype.onPlaygroundReady=function(){this.elementMargin=0,this.layerMargin=0,this.onOpacity(0),this.gameScreen.playground.controls.distance=this.gameScreen.playground.controls.settings.maxDistance,this.btOpacity.value=0,this.btZoom.value=0,this.btMoveTrack.isEnabled=!this.gameScreen.playground.isCompetition||!mTrack.data.competition.baseTrackId},n.prototype.onMarbleClick=function(e){this.btMarble.removeAllListeners("mousemove touchmove"),this.spawnMarble(e),this.marbleSpawned=!1},n.prototype.onMarbleDown=function(e){var t=this;this.dragStart=e.data.global.clone(),this.btMarble.on("mousemove touchmove",function(e){return t.onMarbleMove(e)})},n.prototype.onMarbleMove=function(e){!this.marbleSpawned&&gf.utils.Maths.distance(this.dragStart,e.data.global)>10&&(this.marbleSpawned=!0,this.spawnMarble(e))},n.prototype.onMarbleUp=function(){this.btMarble.removeAllListeners("mousemove touchmove"),this.marbleSpawned=!1},n.prototype.onDelete=function(){track("Ingame-Delete_cube");if(!this.gameScreen.playground.cubes.selected)return;this.game.sounds.playFx("fx","cube_remove"),this.gameScreen.moveMenu.hide(),this.gameScreen.rotateMenu.hide(),this.gameScreen.playground.cubes.remove(),this.btMoveCube.isSelected&&(this.btMoveCube.isSelected=!1),this.gameScreen.playground.emit(e.CUBE_UPDATE),this.gameScreen.playground.history.save(),this.gameScreen.playground.save()},n.prototype.start=function(){var t=this;this.cubeList.reset(),mTrack.data.sets.forEach(function(e){t.cubeList.addSet(e)}),!!mTrack.data.competition&&!!mTrack.data.competition.availableCubes&&this.cubeList.addItems(mTrack.data.competition.availableCubes),this.btAddSets.label=loc("bt_select_sets",{count:mTrack.data.sets.length}),this.game.stage.header.trackMenu.checkPublish(),this.game.stage.header.trackMenu.checkSubmit(),this.btDropHeight.dropHeight=e.MARBLE_DROP_HEIGHT_DEFAULT,this.btMoveCube.isSelected&&(this.btMoveCube.isSelected=!1),this.btMoveTrack.isSelected&&this.btMoveTrack.onMoveTrack(),this.btElementsDistance.isSelected&&this.btElementsDistance.onSlider(),this.btLayerDistance.isSelected&&this.btLayerDistance.onSlider(),this.btOpacity.isSelected&&this.btOpacity.onSlider(),this.btZoom.isSelected&&this.btZoom.onSlider(),this.btMoveTrack.isSelected=!1,this.btMoveView.isSelected=!1,this.btSwap.isSelected=!1,this.gameScreen.playground.cubes.swapping=null,this.gameScreen.layers.reset(),this.game.stage.header.trackMenu.btDetails.isSelected=!1,this.game.stage.header.trackMenu.saveText="",this.cubeList.updateUsed(),this.gameScreen.playground.on(e.PLAYGROUND_READY,this.onPlaygroundReady,this),this.onResize()},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.y=this.game.height-this.bg.height-this.game.stage.footer.height,this.bg.width=this.game.width,this.btDelete.x=this.game.width-this.btDelete.width-e.PADDING,this.btSwap.x=this.btDelete.x-this.btSwap.width-e.PADDING,this.btMoveTrack.x=this.btSwap.x-this.btMoveTrack.width-e.PADDING,this.btMoveCube.x=this.btMoveTrack.x-this.btMoveCube.width-e.PADDING,this.btMarble.x=this.btMoveCube.x,this.btDropHeight.x=this.btMarble.right,this.btUndo.x=this.btSwap.x,this.btRedo.x=this.btDelete.x,this.listBg.width=this.btMoveCube.x-e.PADDING-this.listBg.x,this.cubeList.arrange(this.listBg.width-(this.cubeList.x-this.listBg.x)),this.gameScreen.layers.resize(this.y)},Object.defineProperty(n.prototype,"layerMargin",{get:function(){return this._layerMargin},set:function(e){if(e==this._layerMargin)return;this._layerMargin=e,this.updateLayerMargin()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"elementMargin",{get:function(){return this._elementMargin},set:function(e){if(e==this._elementMargin)return;this._elementMargin=e,this.updateElementMargin()},enumerable:!0,configurable:!0}),n}(gf.display.Container);t.BottomMenu=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n,r){var i=t.call(this,n,"bt_layer_out",r.toString())||this;return i.layer=r,i.bg.width=i.icon.width,i.bg.height=i.icon.height,i.icon.x=i.bg.width>>1,i.icon.y=i.bg.height>>1,i.tfLabel.anchor.set(.5),i.tfLabel.x=i.bg.width>>1,i.tfLabel.y=i.bg.height>>1,i.tfLabel.style.fill=e.COLOR_WHITE,i.hitArea=i.getLocalBounds(),i.setState(gf.OUT),i}return __extends(n,t),n.prototype.addIcon=function(){this.icon=new gf.display.Sprite(this.game,"sprites","bt_layer_out"),this.icon.anchor.set(.5),this.addChild(this.icon)},n.prototype.setState=function(t){if(this._isSelected){this.icon.frameName!="bt_layer_down"&&(this.icon.frameName="bt_layer_down"),this.bg.tint=e.COLOR_YELLOW;return}switch(this._currentState){case gf.DOWN:this.icon.frameName="bt_layer_down",this.bg.tint=e.COLOR_YELLOW;break;case gf.OUT:this.icon.frameName="bt_layer_out",this.bg.tint=e.COLOR_WHITE;break;case gf.OVER:this.icon.frameName="bt_layer_over",this.bg.tint=e.COLOR_LIGHT_GREY;break;case gf.UP:this.isOver?(this.icon.frameName="bt_layer_over",this.bg.tint=e.COLOR_LIGHT_GREY):(this.icon.frameName="bt_layer_out",this.bg.tint=e.COLOR_WHITE)}},n}(e.ui.IconButton);t.LayerButton=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n.game)||this;r.gameScreen=n,r.bg=new gf.display.Sprite(r.game,PIXI.Texture.WHITE),r.bg.tint=e.COLOR_LIGHT_GREY,r.bg.width=69,r.addChild(r.bg),r.tfLayers=new gf.display.Text(r.game,loc("layers"),e.TEXT_STYLE_BUTTON_ICON.clone()),r.tfLayers.x=r.bg.width-r.tfLayers.width>>1,r.tfLayers.visible=!1,r.addChild(r.tfLayers),r.buttonContainer=new gf.display.Container(r.game),r.addChild(r.buttonContainer),r.buttons=[],r.buttonsHeight=0;var i,s=function(){var t=new e.ui.LayerButton(o.game,e.MAX_Y-i);t.on(gf.CLICK,function(){return r.onLayer(t)},o),t.y=i*t.height+i*e.PADDING,o.buttonsHeight+=t.height+e.PADDING,t.visible=!1,o.buttonContainer.addChild(t),o.buttons.push(t)},o=this;for(i=0;i<e.MAX_Y;++i)s();return r.btAll=new e.ui.LayerButton(r.game,0),r.btAll.on(gf.CLICK,r.onAll,r),r.btAll.y=i*r.btAll.height+i*e.PADDING,r.btAll.label=loc("bt_show_all_layers"),r.btAll.tfLabel.anchor.y=0,r.btAll.tfLabel.style.fill=e.COLOR_DARK_GREY,r.btAll.tfLabel.y=r.btAll.icon.bottom+e.PADDING,r.btAll.bg.height=r.btAll.tfLabel.bottom+e.PADDING,r.buttonsHeight+=r.btAll.height+e.PADDING,r.buttonContainer.addChild(r.btAll),r.gameScreen.playground.on(e.CUBE_UPDATE,r.update,r),r}return __extends(n,t),n.prototype.onAll=function(){track("Ingame-Layers_show_all"),this.buttons.forEach(function(e){e.isSelected=!1}),this.onLayer()},n.prototype.onLayer=function(e){var t=this;e&&(e.isSelected=!e.isSelected,track("Ingame-Layer"+e.layer+"_"+(e.isSelected?"_show":"_hide")),this.buttons.forEach(function(t){t!=e&&(t.isSelected=!1)}));var n=!1;this.buttons.forEach(function(e){if(e.isSelected){n=!0;return}});var r=this.gameScreen.playground.cubeOpacity;this.gameScreen.playground.cubes.cubes.forEach(function(e){e.opacity=n?t.isSelected(e.mapPosition.y+1)?r:.2:r,e.layer.visible=n?t.isSelected(e.mapPosition.y+1):!1})},n.prototype.isSelected=function(e){var t=!1;return this.buttons.forEach(function(n){if(n.isSelected&&n.layer==e){t=!0;return}}),t},n.prototype.update=function(){var e=[0,0,0,0,0,0,0,0,0];this.gameScreen.playground.cubes.cubes.forEach(function(t){e[t.mapPosition.y]++}),this.buttons.forEach(function(t){t.visible=e[t.layer-1]>0}),this.tfLayers.visible=this.buttons[this.buttons.length-1].visible,this.onLayer(),this.onResize()},n.prototype.reset=function(){this.buttons.forEach(function(e){e.isSelected=!1}),this.update()},n.prototype.resize=function(t){this.bg.height=Math.max(0,t-this.game.stage.header.bg.height),this.tfLayers.y=this.bg.height-this.tfLayers.height-e.PADDING*2,this.buttonContainer.y=this.tfLayers.y-this.buttonsHeight-e.PADDING*2},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.resize(this.gameScreen.bottomMenu.y)},n}(gf.display.Container);t.Layers=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n,r,i,s){s===void 0&&(s=!1);var o=t.call(this,n,r,i,s)||this;return o.container=new gf.display.Container(o.game),o.container.position.set(40,37),o.addChild(o.container),o.indicatorBg=new gf.display.Sprite(o.game,"sprites","indicator_bg"),o.indicatorBg.tint=e.COLOR_INDICATOR,o.container.addChild(o.indicatorBg),o.tfIndicator=new gf.display.Text(o.game),o.tfIndicator.style=e.TEXT_STYLE_INDICATOR.clone(),o.container.addChild(o.tfIndicator),o.on(gf.OVER,function(){o.indicatorBg.tint=e.COLOR_WHITE,o.tfIndicator.style.fill=e.COLOR_YELLOW},o),o.on(gf.OUT,function(){o.indicatorBg.tint=e.COLOR_INDICATOR,o.tfIndicator.style.fill=e.TEXT_STYLE_INDICATOR.fill},o),o.on(gf.DOWN,function(){o.indicatorBg.tint=e.COLOR_DARK_GREY,o.tfIndicator.style.fill=e.COLOR_YELLOW},o),o.on(gf.UP,function(){o.isOver?(o.indicatorBg.tint=e.COLOR_WHITE,o.tfIndicator.style.fill=e.COLOR_YELLOW):(o.indicatorBg.tint=e.COLOR_INDICATOR,o.tfIndicator.style.fill=e.TEXT_STYLE_INDICATOR.fill)},o),o.container.visible=!1,o}return __extends(n,t),Object.defineProperty(n.prototype,"indicator",{get:function(){return parseInt(this.tfIndicator.text)},set:function(e){this.tfIndicator.text=e.toString(),this.tfIndicator.x=this.indicatorBg.width-this.tfIndicator.width>>1,this.container.visible=e!=0},enumerable:!0,configurable:!0}),n}(e.ui.IconButton);t.IndicatorIconButton=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(e,n,r){var i=t.call(this,e,"sound",loc("bt_sound_on"))||this;return i.on(gf.CLICK,i.onToggle),i}return __extends(n,t),n.prototype.onToggle=function(){this.isSelected=!this.isSelected,track("Menu-Sound_"+(this.isSelected?"on":"off")),this.game.sounds.muteFx(this.isSelected)},n.prototype.setState=function(t){this.isSelected?(this.icon.frameName="icon_mute",this.label=loc("bt_sound_off")):this.icon.frameName!="icon_sound"&&(this.icon.frameName="icon_sound",this.label=loc("bt_sound_on"));switch(this._currentState){case gf.DOWN:this.bg.tint=e.COLOR_YELLOW,this.icon&&(this.icon.tint=e.COLOR_DARK_GREY),this.tfLabel&&(this.tfLabel.style.fill=e.COLOR_DARK_GREY);break;case gf.OUT:this.bg.tint=e.COLOR_WHITE,this.icon&&(this.icon.tint=e.COLOR_DARK_GREY),this.tfLabel&&(this.tfLabel.style.fill=e.COLOR_DARK_GREY);break;case gf.OVER:this.bg.tint=e.COLOR_YELLOW,this.icon&&(this.icon.tint=e.COLOR_WHITE),this.tfLabel&&(this.tfLabel.style.fill=e.COLOR_WHITE);break;case gf.UP:this.isOver?(this.bg.tint=e.COLOR_YELLOW,this.icon&&(this.icon.tint=e.COLOR_WHITE),this.tfLabel&&(this.tfLabel.style.fill=e.COLOR_WHITE)):(this.bg.tint=e.COLOR_WHITE,this.icon&&(this.icon.tint=e.COLOR_DARK_GREY),this.tfLabel&&(this.tfLabel.style.fill=e.COLOR_DARK_GREY))}},n}(e.ui.IconButton);t.SoundButton=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n)||this;return r.bg=new gf.display.Sprite(r.game,PIXI.Texture.WHITE),r.bg.tint=e.COLOR_LIGHT_GREY,r.addChild(r.bg),r.btAccount=new e.ui.IconButton(r.game,"options",loc("bt_account_management")),r.btAccount.x=e.PADDING,r.btAccount.on(gf.CLICK,r.onAccount,r),r.addChild(r.btAccount),r.btChangePassword=new e.ui.IconButton(r.game,"password",loc("bt_change_password")),r.btChangePassword.x=e.PADDING,r.btChangePassword.y=r.btAccount.bottom+e.PADDING,r.btChangePassword.on(gf.CLICK,r.onChangePassword,r),r.addChild(r.btChangePassword),r.btAbo=new e.ui.IconButton(r.game,"abo",loc("bt_shop_abo")),r.btAbo.x=e.PADDING,r.btAbo.y=r.btChangePassword.bottom+e.PADDING,r.btAbo.on(gf.CLICK,r.onAbo,r),r.addChild(r.btAbo),r.btGifts=new e.ui.IndicatorIconButton(r.game,"gifts",loc("bt_gifts")),r.btGifts.x=e.PADDING,r.btGifts.y=r.btAbo.bottom+e.PADDING,r.btGifts.on(gf.CLICK,r.onGifts,r),r.addChild(r.btGifts),r.btLogout=new e.ui.IconButton(r.game,"logout",loc("bt_logout")),r.btLogout.x=e.PADDING,r.btLogout.y=r.btAbo.bottom+e.PADDING,r.btLogout.on(gf.CLICK,r.onLogout,r),r.addChild(r.btLogout),r.bg.width=r.btAccount.width+e.PADDING*2,r.bg.height=r.btLogout.bottom+e.PADDING,mAbo.on(e.clientmodels.Abo.ABO,r.onAboChanged,r),mGift.on(e.clientmodels.Gift.GIFT,r.onGiftChanged,r),mAbo.isInitialized()&&r.onAboChanged(),mGift.isInitialized()&&r.onGiftChanged(),r}return __extends(n,t),n.prototype.arrangeButtons=function(){var t=this.btChangePassword.bottom+e.PADDING;this.btAbo.visible&&(this.btAbo.y=t,t=this.btAbo.bottom+e.PADDING),this.btGifts.visible&&(this.btGifts.y=t,t=this.btGifts.bottom+e.PADDING),this.btLogout.y=t,this.bg.height=this.btLogout.bottom+e.PADDING},n.prototype.onAccount=function(){track("AccountMenu-Account"),this.game.overlays.show(e.overlays.Account.NAME),this.hide()},n.prototype.onAbo=function(){mAbo.hasAbo()?(track("AccountMenu-Shop"),this.game.overlays.show(e.overlays.Shop.NAME)):(track("AccountMenu-Abo"),this.game.overlays.show(e.overlays.Abo.NAME)),this.hide()},n.prototype.onAboChanged=function(){this.btAbo.visible=mAbo.hasAbo();if(!this.game.client.config.isShopAvailable||this.game.client.config.isRussian)this.btAbo.visible=!1;this.arrangeButtons()},n.prototype.onGiftChanged=function(){this.btGifts.visible=mGift.hasGift(),!this.game.client.config.isShopAvailable&&!this.game.client.config.isRussian&&(this.btGifts.visible=!1),this.btGifts.visible&&(this.btGifts.indicator=1),this.arrangeButtons()},n.prototype.onChangePassword=function(){track("AccountMenu-ChangePassword"),this.game.overlays.show(e.overlays.ChangePassword.NAME),this.hide()},n.prototype.onGifts=function(){track("AccountMenu-Gifts"),this.game.overlays.show(e.overlays.Gifts.NAME),this.hide()},n.prototype.onLogout=function(){var t=this;track("AccountMenu-Logout"),this.game.overlays.show(e.overlays.Loader.NAME),mUser.logout(function(){t.game.overlays.hide(e.overlays.Loader.NAME),t.game.screens.show(e.screens.Start.NAME),t.hide()})},n.prototype.onClickOutside=function(e){if(!this.game.stage.header.btAccount.isSelected)return;var t=e.data.getLocalPosition(this);this.getLocalBounds().contains(t.x,t.y)||this.hide()},n.prototype.show=function(){var t=this;mUser.isLoggedIn()&&!mGift.isInitialized()?(this.game.overlays.show(e.overlays.Loader.NAME),mGift.once(e.clientmodels.Gift.GIFT,function(){t.game.overlays.hide(e.overlays.Loader.NAME),t.visible=!0,t.game.stage.on("mousedown touchstart",t.onClickOutside,t)})):(this.visible=!0,this.game.stage.on("mousedown touchstart",this.onClickOutside,this))},n.prototype.hide=function(){this.game.stage.header.btAccount.isSelected=!1,this.visible=!1,this.game.stage.off("mousedown touchstart",this.onClickOutside)},n}(gf.display.Container);t.AccountMenu=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(e){function t(t){var n=e.call(this,t.game,"speed_1",loc("bt_speed_1"))||this;return n.gameScreen=t,n.playground=n.gameScreen.playground,n.speed=1,n.on(gf.CLICK,n.onToggle),n}return __extends(t,e),t.prototype.onToggle=function(){this.speed==3?this.speed=1:this.speed++},Object.defineProperty(t.prototype,"speed",{get:function(){return this._speed},set:function(e){this._speed=e,this.icon.frameName="icon_speed_"+this.speed,this.tfLabel.text=loc("bt_speed_"+this.speed),this.playground.physicSpeedFactor=this.speed},enumerable:!0,configurable:!0}),t}(e.ui.IconButton);t.SpeedButton=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n)||this;return r.bg=new gf.display.Sprite(r.game,PIXI.Texture.WHITE),r.bg.tint=e.COLOR_LIGHT_GREY,r.addChild(r.bg),r.btGallery=new e.ui.IconButton(r.game,"gallery",loc("bt_gallery_home")),r.btGallery.x=e.PADDING,r.btGallery.on(gf.CLICK,r.onGallery,r),r.addChild(r.btGallery),r.btHelp=new e.ui.IconButton(r.game,"help",loc("bt_help")),r.btHelp.x=e.PADDING,r.btHelp.y=r.btGallery.bottom+e.PADDING,r.btHelp.on(gf.CLICK,r.onHelp,r),r.addChild(r.btHelp),r.btSpecialCases=new e.ui.IconButton(r.game,"special",loc("bt_special_cases")),r.btSpecialCases.x=e.PADDING,r.btSpecialCases.y=r.btHelp.bottom+e.PADDING,r.btSpecialCases.on(gf.CLICK,r.onSpecialCases,r),r.addChild(r.btSpecialCases),r.btAbout=new e.ui.IconButton(r.game,"cuboro",loc("bt_about")),r.btAbout.x=e.PADDING,r.btAbout.y=r.btSpecialCases.bottom+e.PADDING,r.btAbout.on(gf.CLICK,r.onAbout,r),r.addChild(r.btAbout),r.btSound=new e.ui.SoundButton(r.game),r.btSound.x=e.PADDING,r.btSound.y=r.btAbout.bottom+e.PADDING,r.addChild(r.btSound),r.bg.width=r.btGallery.width+e.PADDING*2,r.bg.height=r.btSound.bottom+e.PADDING,r}return __extends(n,t),n.prototype.onGallery=function(){track("Menu-Gallery"),this.game.screens.show(e.screens.Start.NAME),this.hide()},n.prototype.onHelp=function(){track("Menu-Help"),this.game.client.showVideo(),this.hide()},n.prototype.onSpecialCases=function(){track("Menu-SpecialCases"),this.game.client.config.language=="de"?window.open("/pdf/list_special_cases_20200131_de.pdf","_blank"):this.game.client.config.language=="ru"?window.open("/pdf/list_special_cases_20200131_en.pdf","_blank"):window.open("/pdf/list_special_cases_20200131_en.pdf","_blank"),this.hide()},n.prototype.onClickOutside=function(e){if(!this.game.stage.header.btMenu.isSelected)return;var t=e.data.getLocalPosition(this);this.getLocalBounds().contains(t.x,t.y)||this.hide()},n.prototype.onAbout=function(){track("Menu-About"),this.game.client.config.isRussian?window.open("https://cuboro.ru","_blank"):window.open("https://www.cuboro.ch","_blank"),this.hide()},n.prototype.show=function(){this.visible=!0,this.game.stage.on("mousedown touchstart",this.onClickOutside,this),this.btSound.isSelected=this.game.storage.getItem("fxMuted")==1},n.prototype.hide=function(){this.game.stage.header.btMenu.isSelected=!1,this.visible=!1,this.game.stage.off("mousedown touchstart",this.onClickOutside)},n}(gf.display.Container);t.TopMenu=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n.game)||this;return r.gameScreen=n,r.interactive=!0,r.bg=new gf.display.Sprite(r.game,PIXI.Texture.WHITE),r.bg.height=75,r.bg.tint=e.COLOR_LIGHT_GREY,r.addChild(r.bg),r.btSpeed=new e.ui.SpeedButton(r.gameScreen),r.btSpeed.x=e.PADDING,r.btSpeed.y=e.PADDING,r.addChild(r.btSpeed),r.btAbort=new e.ui.IconButton(r.game,"abort",loc("bt_abort")),r.btAbort.on(gf.CLICK,r.onAbort,r),r.btAbort.y=e.PADDING,r.addChild(r.btAbort),r}return __extends(n,t),n.prototype.onAbort=function(){this.gameScreen.playground.marble.stop(!0)},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.bg.width=this.game.width,this.btAbort.x=this.game.width-this.btAbort.width-e.PADDING},n}(gf.display.Container);t.MarbleRun=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){var t=function(e){function t(t,n){var r=e.call(this,t)||this;return r.interactiveChildren=!1,r._icon=n,r.bg=new gf.display.Sprite(t,"sprites","bt_round_out"),r.addChild(r.bg),r.addIcon(),r.hitArea=r.getLocalBounds(),r.on(gf.CLICK,function(){return r.game.sounds.playFx("fx","click")},r),r.setState(gf.OUT),r}return __extends(t,e),t.prototype.addIcon=function(){this.icon=new gf.display.Sprite(this.game,"sprites","icon_"+this._icon),this.icon.anchor.set(.5),this.icon.x=this.bg.width>>1,this.icon.y=this.bg.height>>1,this.addChild(this.icon)},t.prototype.setState=function(e){if(!this._isEnabled){this.bg.frameName="bt_round_over",this.icon.alpha=.6;return}this.icon.alpha=1;switch(this._currentState){case gf.DOWN:this.bg.frameName="bt_round_down";break;case gf.OUT:this.bg.frameName="bt_round_out";break;case gf.OVER:this.bg.frameName="bt_round_over";break;case gf.UP:this.isOver?this.bg.frameName="bt_round_over":this.bg.frameName="bt_round_out"}},t.prototype.forceState=function(e){this._currentState=e,this.setState(e)},t}(gf.ui.Button);e.RoundIconButton=t})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n.game)||this;return r.interactive=!0,r.playground=n,r.btUp=new e.ui.RoundIconButton(r.game,"arrow"),r.btUp.on(gf.CLICK,r.onUp,r),r.btUp.icon.angle=-90,r.addChild(r.btUp),r.btLeft=new e.ui.RoundIconButton(r.game,"arrow"),r.btLeft.on(gf.CLICK,r.onLeft,r),r.btLeft.icon.angle=180,r.addChild(r.btLeft),r.btRight=new e.ui.RoundIconButton(r.game,"arrow"),r.btRight.on(gf.CLICK,r.onRight,r),r.addChild(r.btRight),r.btDown=new e.ui.RoundIconButton(r.game,"arrow"),r.btDown.on(gf.CLICK,r.onDown,r),r.btDown.icon.angle=90,r.addChild(r.btDown),r.btUp.x=r.btUp.width+25,r.btLeft.y=r.btUp.bottom+10,r.btRight.x=r.btUp.right+25,r.btRight.y=r.btLeft.y,r.btDown.x=r.btUp.x,r.btDown.y=r.btLeft.bottom+10,r.playground.on(e.CAMERA_UPDATED,r.toScreen,r),r.playground.on(e.CUBE_UPDATE,r.toScreen,r),r.visible=!1,r}return __extends(n,t),n.prototype.isValidY=function(e,t){return this.playground.map.getNextEmptyY(e,t)<this.playground.maxY},n.prototype.update=function(t){var n=this;t||(t=this.playground.cubes.selected),this.playground.map.getAt(t.mapPosition)!=e.EMPTY&&(t.mapPosition.y=this.playground.map.getNextEmptyY(t.mapPosition.x,t.mapPosition.z)),TweenMax.to(t,.25,{x:this.playground.map.xTo3DPos(t.mapPosition.x),y:this.playground.map.yTo3DPos(t.mapPosition.y),z:this.playground.map.zTo3DPos(t.mapPosition.z),onUpdate:function(){return n.playground.emit(e.CUBE_UPDATE)}}),this.playground.cubes.update(t),this.updateButtons(),this.playground.history.save()},n.prototype.onUp=function(){var t=this.playground.cubes.selected;this.playground.map.setAt(e.EMPTY,t.mapPosition),this.playground.controls.isDirectionX?t.mapPosition.x=Math.max(0,Math.min(e.MAX_X-1,t.mapPosition.x+this.playground.controls.direction)):t.mapPosition.z=Math.max(0,Math.min(e.MAX_Z-1,t.mapPosition.z-this.playground.controls.direction)),this.update(t)},n.prototype.onLeft=function(){var t=this.playground.cubes.selected;this.playground.map.setAt(e.EMPTY,t.mapPosition),this.playground.controls.isDirectionX?t.mapPosition.z=Math.max(0,Math.min(e.MAX_Z-1,t.mapPosition.z-this.playground.controls.direction)):t.mapPosition.x=Math.max(0,Math.min(e.MAX_X-1,t.mapPosition.x-this.playground.controls.direction)),this.update(t)},n.prototype.onRight=function(){var t=this.playground.cubes.selected;this.playground.map.setAt(e.EMPTY,t.mapPosition),this.playground.controls.isDirectionX?t.mapPosition.z=Math.max(0,Math.min(e.MAX_Z-1,t.mapPosition.z+this.playground.controls.direction)):t.mapPosition.x=Math.max(0,Math.min(e.MAX_X-1,t.mapPosition.x+this.playground.controls.direction)),this.update(t)},n.prototype.onDown=function(){var t=this.playground.cubes.selected;this.playground.map.setAt(e.EMPTY,t.mapPosition),this.playground.controls.isDirectionX?t.mapPosition.x=Math.max(0,Math.min(e.MAX_X-1,t.mapPosition.x-this.playground.controls.direction)):t.mapPosition.z=Math.max(0,Math.min(e.MAX_Z-1,t.mapPosition.z+this.playground.controls.direction)),this.update(t)},n.prototype.toScreen=function(){if(!this.visible)return;if(!this.playground.cubes.selected)return;var e=new THREE.Vector3,t=.5*(this.playground.canvas.renderer.context.canvas.width/this.game.scaleX),n=.5*(this.playground.canvas.renderer.context.canvas.height/this.game.scaleY);this.playground.cubes.selected.mesh.updateMatrixWorld(!0),e.setFromMatrixPosition(this.playground.cubes.selected.mesh.matrixWorld),e.project(this.playground.camera),e.x=(e.x*t+t)/this.game.client.config.resolution,e.y=(-(e.y*n)+n)/this.game.client.config.resolution,this.x=e.x-(this.width>>1),this.y=e.y-(this.height>>1),this.updateButtons(),this.checkBounds()},n.prototype.checkBounds=function(){var t=this.x<this.playground.gameScreen.layers.right,n=this.right>this.game.width,r=this.bottom>this.playground.gameScreen.bottomMenu.y,i=this.y<this.game.stage.header.bottom,s=!1;!t&&n?(this.playground.controls.panLeft(-1),s=!0):t&&!n&&(this.playground.controls.panLeft(1),s=!0),!r&&i?(this.playground.controls.panUp(1),s=!0):r&&!i&&(this.playground.controls.panUp(-1),s=!0),s&&this.playground.once(e.CAMERA_UPDATE,this.toScreen,this)},n.prototype.updateButtons=function(){var e=this.playground.cubes.selected;if(!e)return;var t;this.playground.controls.isDirectionX?(t=e.mapPosition.x+this.playground.controls.direction,this.btUp.isEnabled=this.playground.map.isValidX(t),this.isValidY(t,e.mapPosition.z)||(this.btUp.isEnabled=!1),t=e.mapPosition.z-this.playground.controls.direction,this.btLeft.isEnabled=this.playground.map.isValidZ(t),this.isValidY(e.mapPosition.x,t)||(this.btLeft.isEnabled=!1),t=e.mapPosition.z+this.playground.controls.direction,this.btRight.isEnabled=this.playground.map.isValidZ(t),this.isValidY(e.mapPosition.x,t)||(this.btRight.isEnabled=!1),t=e.mapPosition.x-this.playground.controls.direction,this.btDown.isEnabled=this.playground.map.isValidX(t),this.isValidY(t,e.mapPosition.z)||(this.btDown.isEnabled=!1)):(t=e.mapPosition.z-this.playground.controls.direction,this.btUp.isEnabled=this.playground.map.isValidZ(t),this.isValidY(e.mapPosition.x,t)||(this.btUp.isEnabled=!1),t=e.mapPosition.x-this.playground.controls.direction,this.btLeft.isEnabled=this.playground.map.isValidX(t),this.isValidY(t,e.mapPosition.z)||(this.btLeft.isEnabled=!1),t=e.mapPosition.x+this.playground.controls.direction,this.btRight.isEnabled=this.playground.map.isValidX(t),this.isValidY(t,e.mapPosition.z)||(this.btRight.isEnabled=!1),t=e.mapPosition.z+this.playground.controls.direction,this.btDown.isEnabled=this.playground.map.isValidZ(t),this.isValidY(e.mapPosition.x,t)||(this.btDown.isEnabled=!1))},n.prototype.hide=function(){this.visible&&(this.playground.placeables.hide(),this.playground.cubes.selected&&this.playground.gameScreen.rotateMenu.show()),this.visible=!1},n.prototype.show=function(){this.playground.placeables.show(),this.playground.gameScreen.rotateMenu.hide(),this.visible=!0,this.toScreen()},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.toScreen()},n}(gf.display.Container);t.MoveMenu=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n.game)||this;return r.interactive=!0,r.playground=n,r.btUp=new e.ui.RoundIconButton(r.game,"cube_up"),r.btUp.on(gf.CLICK,r.onUp,r),r.addChild(r.btUp),r.btDown=new e.ui.RoundIconButton(r.game,"cube_down"),r.btDown.on(gf.CLICK,r.onDown,r),r.addChild(r.btDown),r.btLeft=new e.ui.RoundIconButton(r.game,"cube_left"),r.btLeft.on(gf.CLICK,r.onLeft,r),r.addChild(r.btLeft),r.btLeftSide=new e.ui.RoundIconButton(r.game,"cube_side_left"),r.btLeftSide.on(gf.CLICK,r.onLeftSide,r),r.addChild(r.btLeftSide),r.btRight=new e.ui.RoundIconButton(r.game,"cube_right"),r.btRight.on(gf.CLICK,r.onRight,r),r.addChild(r.btRight),r.btRightSide=new e.ui.RoundIconButton(r.game,"cube_side_right"),r.btRightSide.on(gf.CLICK,r.onRightSide,r),r.addChild(r.btRightSide),r.btUp.x=r.btUp.width+25,r.btLeftSide.y=r.btUp.bottom+10,r.btRightSide.x=r.btUp.right+25,r.btRightSide.y=r.btLeftSide.y,r.btLeft.y=r.btLeftSide.bottom+20,r.btRight.x=r.btRightSide.x,r.btRight.y=r.btLeft.y,r.btDown.x=r.btUp.x,r.btDown.y=r.btLeft.bottom+10,r.playground.on(e.CAMERA_UPDATED,r.toScreen,r),r.playground.on(e.CUBE_UPDATE,r.toScreen,r),r.visible=!1,r}return __extends(n,t),n.prototype.onUp=function(){var t=this;TweenMax.killChildTweensOf(this,!0),this.game.sounds.playFx("fx","cube_rotate"),this.playground.controls.isDirectionX?TweenMax.to(this.playground.cubes.selected,.25,{rotationZ:this.playground.controls.direction*-e.DEG_RAD_90,onComplete:function(){t.playground.cubes.selected.resetRotationZ(),t.onRotation()}}):TweenMax.to(this.playground.cubes.selected,.25,{rotationX:this.playground.controls.direction*-e.DEG_RAD_90,onComplete:function(){t.playground.cubes.selected.resetRotationX(),t.onRotation()}})},n.prototype.onDown=function(){var t=this;TweenMax.killChildTweensOf(this,!0),this.game.sounds.playFx("fx","cube_rotate"),this.playground.controls.isDirectionX?TweenMax.to(this.playground.cubes.selected,.25,{rotationZ:this.playground.controls.direction*e.DEG_RAD_90,onComplete:function(){t.playground.cubes.selected.resetRotationZ(),t.onRotation()}}):TweenMax.to(this.playground.cubes.selected,.25,{rotationX:this.playground.controls.direction*e.DEG_RAD_90,onComplete:function(){t.playground.cubes.selected.resetRotationX(),t.onRotation()}})},n.prototype.onLeft=function(){var t=this;TweenMax.killChildTweensOf(this,!0),this.game.sounds.playFx("fx","cube_rotate"),TweenMax.to(this.playground.cubes.selected,.25,{rotationY:-e.DEG_RAD_90,onComplete:function(){t.playground.cubes.selected.resetRotationY(),t.onRotation()}})},n.prototype.onLeftSide=function(){var t=this;TweenMax.killChildTweensOf(this,!0),this.game.sounds.playFx("fx","cube_rotate"),this.playground.controls.isDirectionX?TweenMax.to(this.playground.cubes.selected,.25,{rotationX:this.playground.controls.direction*-e.DEG_RAD_90,onComplete:function(){t.playground.cubes.selected.resetRotationX(),t.onRotation()}}):TweenMax.to(this.playground.cubes.selected,.25,{rotationZ:this.playground.controls.direction*e.DEG_RAD_90,onComplete:function(){t.playground.cubes.selected.resetRotationZ(),t.onRotation()}})},n.prototype.onRight=function(){var t=this;TweenMax.killChildTweensOf(this,!0),this.game.sounds.playFx("fx","cube_rotate"),TweenMax.to(this.playground.cubes.selected,.25,{rotationY:e.DEG_RAD_90,onComplete:function(){t.playground.cubes.selected.resetRotationY(),t.onRotation()}})},n.prototype.onRightSide=function(){var t=this;TweenMax.killChildTweensOf(this,!0),this.game.sounds.playFx("fx","cube_rotate"),this.playground.controls.isDirectionX?TweenMax.to(this.playground.cubes.selected,.25,{rotationX:this.playground.controls.direction*e.DEG_RAD_90,onComplete:function(){t.playground.cubes.selected.resetRotationX(),t.onRotation()}}):TweenMax.to(this.playground.cubes.selected,.25,{rotationZ:this.playground.controls.direction*-e.DEG_RAD_90,onComplete:function(){t.playground.cubes.selected.resetRotationZ(),t.onRotation()}})},n.prototype.onRotation=function(){this.playground.history.save(),this.playground.save()},n.prototype.toScreen=function(){if(!this.visible)return;if(!this.playground.cubes.selected)return;var e=new THREE.Vector3,t=.5*(this.playground.canvas.renderer.context.canvas.width/this.game.scaleX),n=.5*(this.playground.canvas.renderer.context.canvas.height/this.game.scaleY);this.playground.cubes.selected.mesh.updateMatrixWorld(!0),e.setFromMatrixPosition(this.playground.cubes.selected.mesh.matrixWorld),e.project(this.playground.camera),e.x=(e.x*t+t)/this.game.client.config.resolution,e.y=(-(e.y*n)+n)/this.game.client.config.resolution,this.x=e.x-(this.width>>1),this.y=e.y-(this.height>>1),this.checkBounds()},n.prototype.checkBounds=function(){var t=this.x<this.playground.gameScreen.layers.right,n=this.right>this.game.width,r=this.bottom>this.playground.gameScreen.bottomMenu.y,i=this.y<this.game.stage.header.bottom,s=!1;!t&&n?(this.playground.controls.panLeft(-1),s=!0):t&&!n&&(this.playground.controls.panLeft(1),s=!0),!r&&i?(this.playground.controls.panUp(1),s=!0):r&&!i&&(this.playground.controls.panUp(-1),s=!0),s&&this.playground.once(e.CAMERA_UPDATE,this.toScreen,this)},n.prototype.hide=function(){this.visible=!1},n.prototype.show=function(){this.visible=!0,this.toScreen()},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.toScreen()},n}(gf.display.Container);t.RotateMenu=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var gf;(function(e){var t;(function(t){var n=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.start=function(){},t.prototype.transitionIn=function(){e.prototype.transitionIn.call(this),this.start()},t.NAME="game",t}(e.screens.Screen);t.Game=n})(t=e.screens||(e.screens={}))})(gf||(gf={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){this.interaction=new e.core.Interaction(this.game),this.addChild(this.interaction),this.playground=new e.core.Playground(this),this.marbleRun=new e.ui.MarbleRun(this),this.addChild(this.marbleRun),this.moveMenu=new e.ui.MoveMenu(this.playground),this.addChild(this.moveMenu),this.rotateMenu=new e.ui.RotateMenu(this.playground),this.addChild(this.rotateMenu),this.layers=new e.ui.Layers(this),this.layers.y=this.game.stage.header.bottom,this.addChild(this.layers),this.bottomMenu=new e.ui.BottomMenu(this),this.addChild(this.bottomMenu)},n.prototype.transitionInComplete=function(){t.prototype.transitionInComplete.call(this),this.game.stage.header.trackMenu.show()},n.prototype.transitionOutComplete=function(){t.prototype.transitionOutComplete.call(this),this.playground.stop(),this.game.stage.header.trackMenu.hide()},n}(gf.screens.Game);t.Game=n})(t=e.screens||(e.screens={}))})(cuboro||(cuboro={}));var kr3m;(function(e){var t;(function(e){var t=function(){function e(){}return e.track=function(){if(typeof trackGTMCustom!="function")return;var t=typeof arguments[0]=="string"?{eventAction:arguments[0]}:arguments[0]||{};t.event=t.event||"kr3m",t.hitType=t.hitType||"Button",t.eventCategory=t.eventCategory||"Click",trackGTMCustom(t),e.eventsCount++,e.lastEvent=t,e.onTrackEvent!=null&&e.onTrackEvent(t)},e.eventsCount=0,e}();e.Track=t})(t=e.tracking3||(e.tracking3={}))})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(e){var t=function(){function t(){}return t.setFormatter=function(e,n){t.formatters[e]=n},t.setToken=function(e,n){t.globalTokens[e]=n},t.mergeTokens=function(e){var t={};for(var n in e)for(var r in e[n])if(typeof e[n][r]!="function"){var i=n+"_"+r;i=i.replace(/\W/g,""),i=i.replace(/([a-z])([A-Z])/g,"$1_$2"),i=i.replace(/__+/g,"_"),i=i.toUpperCase(),t[i]=e[n][r]}return t},t.get=function(n,r,i){i===void 0&&(i="##"),r=e.Util.mergeAssoc(t.globalTokens,r);var s=n.split(i);for(var o=1;o<s.length;o+=2){var u=s[o].split(":");if(u.length<1)continue;var a=e.Util.getProperty(r,u[0]);if(u.length>1){var f=t.formatters[u[1]];if(f)try{a=f(a,r,u[0])}catch(l){e.Log.logError(l)}else e.Log.logWarning("unknown token-formatter:",u[1])}s[o]=a!==null?a:""}return s.join("")},t.revertValues=function(e,t,n){n===void 0&&(n="##");var r={},i=e.split(n);if(i.length==1)return{};var s=t.indexOf(i[0],s);if(s<0)return null;var o=0;for(var u=0;u<i.length-1;u+=2){s+=i[u].length,o=i[u+2]!=""?t.indexOf(i[u+2],s):t.length;if(o<0)return null;r[i[u+1]]=t.substring(s,o),s=o}return r},t.globalTokens={},t.formatters={},t}();e.Tokenizer=t})(t=e.util||(e.util={}))})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(e){var t=function(){function e(){this.counter=0,this.callbacks=[],this.results={}}return e.prototype.getOpenCount=function(){return this.counter},e.prototype.getResult=function(e){var t=this.results[e];return t&&t.length>0?t[0]:undefined},e.prototype.getResults=function(e){return this.results[e]?this.results[e]:undefined},e.prototype.getAllResults=function(){return this.results},e.prototype.clearCallbacks=function(e){e===void 0&&(e=!1);if(e)for(var t=0;t<this.callbacks.length;++t)this.callbacks[t]();this.callbacks=[]},e.prototype.terminator=function(e){var t=[];for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];e!==undefined&&(this.results[e]=t),--this.counter;if(this.counter<=0){this.counter=0;for(var r=0;r<this.callbacks.length;++r)this.callbacks[r]();this.callbacks=[]}},e.prototype.fork=function(e){e===void 0&&(e=1),this.counter+=e},e.prototype.done=function(e){var t=[];for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];this.terminator.apply(this,[e].concat(t))},e.prototype.getCallback=function(e){return this.fork(),this.terminator.bind(this,e)},e.prototype.addCallback=function(e){this.counter>0?this.callbacks.push(e):e()},e}();e.Join=t})(t=e.async||(e.async={}))})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(e){var t;(function(e){function t(e,t,n){var r=0,i=e.length,s=-1;while(i!=r){s=Math.floor((i-r)/2)+r;var o=n(e[s],t);if(o==0)return s;o>0?i=s:r=s+1}return-1}function n(e,t,n){var r=0,i=e.length,s=0;while(i!=r){s=Math.floor((i-r)/2)+r;var o=n(e[s],t);if(o==0)return s;o>0?i=s:r=s+1}return o<0?s+1:s}e.bisect=t,e.bisectInsertPos=n})(t=e.search||(e.search={}))})(t=e.algorithms||(e.algorithms={}))})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(t){var n=function(){function t(e){this.sortFunc=e,this.items=[]}return t.prototype.useList=function(e,t){t===void 0&&(t=!0),this.items=e,t||this.items.sort(this.sortFunc)},t.prototype.clear=function(){this.items=[]},t.prototype.insertSortedValues=function(){var e=this,t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];var r=t.map(function(t){return e.insertIndexOf(t)});for(var i=1;i<r.length;++i)r[i]+=i;(o=this.items).push.apply(o,t);var s=r.length;for(var i=this.items.length-1;i>=0;--i)i==r[s-1]?(this.items[i]=t.pop(),--s):this.items[i]=this.items[i-s];var o},t.prototype.insert=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];if(this.items.length==0){this.items=e.slice(),this.items.sort(this.sortFunc);return}if(e.length/this.items.length>.3){(n=this.items).push.apply(n,e),this.items.sort(this.sortFunc);return}e.sort(this.sortFunc),this.insertSortedValues.apply(this,e);var n},t.prototype.insertFrom=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];for(var n=0;n<e.length;++n)this.insertSortedValues.apply(this,e[n].items)},t.prototype.pop=function(){return this.items.pop()},t.prototype.shift=function(){return this.items.shift()},t.prototype.getLength=function(){return this.items.length},t.prototype.getItem=function(e){return this.items[e]},t.prototype.findIndex=function(e){return this.items.findIndex(e)},t.prototype.find=function(e){return this.items.find(e)},t.prototype.toArray=function(e,t){return this.items.slice(e,t)},t.prototype.slice=function(e,n){var r=new t(this.sortFunc);return r.useList(this.items.slice(e,n)),r},t.prototype.splice=function(e,t){var n=[];for(var r=2;r<arguments.length;r++)n[r-2]=arguments[r];this.items.splice(e,t),this.insert.apply(this,n)},t.prototype.indexOf=function(t){return e.algorithms.search.bisect(this.items,t,this.sortFunc)},t.prototype.insertIndexOf=function(t){return e.algorithms.search.bisectInsertPos(this.items,t,this.sortFunc)},t.prototype.contains=function(e){return this.indexOf(e)>=0},t}();t.SortedList=n})(t=e.util||(e.util={}))})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(t){var n=function(){function t(t,n){t===void 0&&(t=!1),n===void 0&&(n=1),this.pending=new e.util.SortedList(function(e,t){return e.p-t.p}),this.callbacks=[],this.runningCount=0,this.autoRun=t,this.parallelCount=n}return t.prototype.setParallelCount=function(e){this.parallelCount=e},t.prototype.getLength=function(){return this.pending.getLength()},t.prototype.getItem=function(e){return this.pending.getItem(e)},Object.defineProperty(t.prototype,"length",{get:function(){return this.pending.getLength()},enumerable:!0,configurable:!0}),t.prototype.clear=function(){this.pending.clear()},t.prototype.insert=function(e,t){t===void 0&&(t=0),this.pending.insert({p:t,f:e}),this.autoRun&&this.start()},t.prototype.addCallback=function(e){this.callbacks.push(e)},t.prototype.callCallbacks=function(){for(var e=0;e<this.callbacks.length;++e)this.callbacks[e]();this.callbacks=[]},t.prototype.isRunning=function(){return this.runningCount>0},t.prototype.run=function(){this.start()},t.prototype.start=function(){var e=this;if(this.runningCount<this.parallelCount){var t=this.pending.shift();t?(++this.runningCount,t.f(function(){--e.runningCount,e.start()})):this.runningCount==0&&this.callCallbacks()}},t}();t.PriorityQueue=n})(t=e.async||(e.async={}))})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(t){var n;(function(t){var n=function(){function t(){}return t.prototype.applyToUrl=function(t){var n=t.indexOf("?");if(n>=0){var r=t.substring(n+1),i=e.util.StringEx.splitAssoc(r);i._=this.getString(),t=t.substring(0,n),t=t+"?"+e.util.StringEx.joinAssoc(i)}else t=t+"?_="+this.getString();return t},t}();t.CacheBuster=n})(n=t.cache||(t.cache={}))})(t=e.loading||(e.loading={}))})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(t){var n;(function(t){var n=function(e){function t(t){var n=e.call(this)||this;return n.version=t.replace(/[^_\w]/gi,"_"),n}return __extends(t,e),t.prototype.getString=function(){return this.version},t}(e.loading.cache.CacheBuster);t.CacheBusterVersion=n})(n=t.cache||(t.cache={}))})(t=e.loading||(e.loading={}))})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(t){var n=function(){function n(){this.queue=new e.async.PriorityQueue(!0,4),this.loadedCount=0,this.cacheBuster=new t.cache.CacheBusterVersion(e.VERSION)}return n.getInstance=function(){return n.instance||(n.instance=new n),n.instance},n.prototype.getLoadedCount=function(){return this.loadedCount},n.prototype.getQueueLength=function(){return this.queue.getLength()},n.prototype.getPendingByPriority=function(){var e={},t=this.queue.getLength();for(var n=0;n<t;++n){var r=this.queue.getItem(n).p;e[r]=(e[r]||0)+1}return e},n.prototype.setMaxParallelDownloads=function(e){this.queue.setParallelCount(e)},n.prototype.setCacheBuster=function(e){this.cacheBuster=e},n.prototype.getCacheBusterString=function(){return this.cacheBuster.getString()},n.prototype.loadFile=function(){var t=this,n=e.util.Util,r=arguments[0],i=n.getFirstOfType(arguments,"string",1),s=n.getFirstOfType(arguments,"function"),o=n.getFirstOfType(arguments,"number")||0,u=n.getFirstOfType(arguments,"function",0,1),a=this.cacheBuster.applyToUrl(r);this.queue.insert(function(n){i=i||e.util.Ajax.getTypeFromUrl(r)||"json";if(i=="image"){var o=new Image;o.onload=function(){++t.loadedCount,n(),s&&s(o)},o.onerror=function(){n(),u&&u()},o.src=a}else e.util.Ajax.call(a,function(e){++t.loadedCount,n(),s&&s(e)},i,function(){n(),u&&u()})},o)},n.prototype.loadFiles=function(){var t=e.util.Util,n=arguments[0],r=t.getFirstOfType(arguments,"function"),i=t.getFirstOfType(arguments,"number")||0,s=t.getFirstOfType(arguments,"function",0,1),o=n.length,u=0,a=0,f=new e.async.Join;for(var l=0;l<n.length;++l){var c=f.getCallback(n[l]);this.loadFile(n[l],i,function(e){++u,s&&s(u,a,o),c(e)},function(){++a,s&&s(u,a,o),c(null)})}f.addCallback(function(){return r&&r(f.getAllResults())})},n}();t.Loader2=n})(t=e.loading||(e.loading={}))})(kr3m||(kr3m={}));var kr3m;(function(e){var t;(function(t){t.LANGUAGE_NAMES={de:"deutsch",en:"english"};var n=function(){function n(){}return n.setModuleItem=function(e,t,r){if(r===undefined||r===null)return;if(r||n.allowEmptyStrings)e.items[t]=r.toString()},n.setRaw=function(e,t,r){r=r||n.language;var i=n.getModule(r);n.setModuleItem(i,e,t)},n.getRaw=function(e,t){t=t||n.language;var r=n.modules[t];if(r)for(var i=0;i<r.length;++i){var s=r[i];if(s.items[e]!==undefined)return s.items[e]}return undefined},n.get=function(e,r,i){i=i||n.language;var s=n.getRaw(e,i);return s!==undefined?t.Tokenizer.get(s,r):i!=n.fallback?n.get(e,r,n.fallback):(t.Log.logWarning("missing localization",e,"for language",i),"")},n.cloneLanguage=function(e,r){n.modules[r]=t.Util.clone(n.modules[e])},n.getFormattedDate=function(e,t,r){return t===void 0&&(t=new Date),t===null||t=="0000-00-00"||t=="0000-00-00 00:00:00"?"":(t instanceof Date||(t=new Date(t)),n.get(e,n.getDateTokens(t),r))},n.getDateTokens=function(e){e===void 0&&(e=new Date);var t={};return t.D=e.getDate(),t.DD=t.D<10?"0"+t.D:t.D,t.M=e.getMonth()+1,t.MM=t.M<10?"0"+t.M:t.M,t.YYYY=e.getFullYear(),t.YY=t.YYYY%100,t.H=e.getHours(),t.HH=t.H<10?"0"+t.H:t.H,t.I=e.getMinutes(),t.II=t.I<10?"0"+t.I:t.I,t.S=e.getSeconds(),t.SS=t.S<10?"0"+t.S:t.S,t},n.getDateFromString=function(e,r,i){i=i||n.language;var s=n.getRaw(e,i);if(!s)return null;var o=t.Tokenizer.revertValues(s,r);if(!o)return null;var u=new Date(0);for(var a in o){var f=parseInt(o[a],0);if(isNaN(f))return null;switch(a){case"YY":var l=f;l>30?u.setFullYear(l+1900):u.setFullYear(l+2e3);break;case"YYYY":u.setFullYear(f);break;case"M":case"MM":u.setMonth(f-1);break;case"D":case"DD":u.setDate(f);break;case"H":case"HH":u.setHours(f);break;case"I":case"II":u.setMinutes(f);break;case"S":case"SS":u.setSeconds(f)}}return u},n.getModule=function(e,t){e=e||n.language,n.modules[e]==null&&(n.modules[e]=[]);for(var r=0;r<n.modules[e].length;++r)if(n.modules[e][r].name==t)return n.modules[e][r];var i={name:t,items:{}};return n.modules[e].push(i),i},n.dropModule=function(e){for(var t in n.modules)n.modules[t][e]&&delete n.modules[t][e]},n.mergeModule=function(e,t){if(e==t)return;for(var r in n.modules){var i=n.getModule(r,e),s=n.getModule(r,t);for(var o in i.items)n.setModuleItem(s,o,i.items[o])}n.dropModule(e)},n.addJSONModule=function(e,t,r,i){t=t||n.language;var s=n.getModule(t,i);for(var o in e)n.setModuleItem(s,o,e[o]);r&&r()},n.addJSONModuleFromUrl=function(r,i,s,o){i=i||n.language;var u=e.loading.Loader2.getInstance();u.loadFile(r,-1,function(e){n.addJSONModule(e,i,s,o)},function(){t.Log.logError("localization file "+r+" could not be loaded"),s&&s()})},n.addXMLModule=function(e,r,i,s){if(!e)return i&&i();r=r||n.language;var o=n.getModule(r,s),u=e.getElementsByTagName("text"),a=t.Device.getInstance();if(a.ie)for(var f=0;f<u.length;++f){var l=u[f].getAttribute("id"),c=u[f].childNodes[0].nodeValue;n.setModuleItem(o,l,c.replace(/^\s*\<\!\[CDATA\[([\s\S]*?)\]\]\>\s*$/i,"$1"))}else for(var f=0;f<u.length;++f){var l=u[f].id,c=u[f].innerHTML;o.items[l]=c.replace(/^\s*\<\!\[CDATA\[([\s\S]*?)\]\]\>\s*$/i,"$1"),n.setModuleItem(o,l,c.replace(/^\s*\<\!\[CDATA\[([\s\S]*?)\]\]\>\s*$/i,"$1"))}i&&i()},n.addXMLModuleFromRawXml=function(t,r,i,s){r=r||n.language;var o=n.getModule(r,s),u=e.xml.parseString(t),a=Array.isArray(u.text)?u.text:[u.text];for(var f=0;f<a.length;++f){var l=a[f]._attributes.id,c=a[f]._data;n.setModuleItem(o,l,c)}i&&i()},n.addXMLModuleFromUrl=function(r,i,s,o){i=i||n.language;var u=e.loading.Loader2.getInstance();u.loadFile(r,-1,"text",function(e){n.addXMLModuleFromRawXml(e,i,s,o)},function(){t.Log.logError("localization file "+r+" could not be loaded"),s&&s()})},n.fallback="en",n.language="en",n.allowEmptyStrings=!0,n.modules={},n}();t.Localization=n})(t=e.util||(e.util={}))})(kr3m||(kr3m={})),kr3m.util.Tokenizer.setFormatter("loc",function(e,t,n){return kr3m.util.Localization.get(e,t)}),kr3m.util.Tokenizer.setFormatter("date",function(e,t,n){return kr3m.util.Localization.getFormattedDate(kr3m.FORMAT_DATE,e)}),kr3m.util.Tokenizer.setFormatter("time",function(e,t,n){return kr3m.util.Localization.getFormattedDate(kr3m.FORMAT_TIME,e)}),kr3m.util.Tokenizer.setFormatter("dateTime",function(e,t,n){return kr3m.util.Localization.getFormattedDate(kr3m.FORMAT_DATETIME,e)});var gf;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){this.addBtPlay(),this.addVersion()},n.prototype.addBtPlay=function(){this.btPlay&&this.btPlay.on(e.CLICK,this.onPlay,this)},n.prototype.addVersion=function(){this.tfVersion=new e.display.Text(this.game,loc("say_hello",{name:loc("app_title"),version:this.game.client.config.version.toString()})),this.tfVersion.style.fontFamily="Arial",this.tfVersion.style.fontSize=8,this.tfVersion.hAlign(e.RIGHT,this.game,-5),this.tfVersion.vAlign(e.BOTTOM,this.game,-5),this.addChild(this.tfVersion)},n.prototype.onPlay=function(){var e=this;track("Start-Play"),this.game.levels.levelCount==1?(this.game.stage.header.hide(),this.game.levels.loadLevel(0,function(){e.game.overlays.show("detail")})):this.game.screens.show("trail")},n.prototype.transitionIn=function(){t.prototype.transitionIn.call(this),this.game.stage.header&&this.game.stage.header.show()},n.NAME="start",n}(e.screens.Screen);t.Start=n})(t=e.screens||(e.screens={}))})(gf||(gf={}));var cuboro;(function(e){var t;(function(e){var t=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t}(gf.screens.Screen);e.Screen=t})(t=e.screens||(e.screens={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n,r){var i=t.call(this,n)||this;return i.tfLabel=new gf.display.Text(n,"",e.TEXT_STYLE_BUTTON_FOOTER.clone()),i.addChild(i.tfLabel),i.label=r,i.on(gf.CLICK,function(){return i.game.sounds.playFx("fx","click")},i),i.setState(gf.OUT),i}return __extends(n,t),n.prototype.setState=function(t){this.tfLabel.alpha=1;if(!this.isEnabled){this.tfLabel.alpha=.5;return}switch(this._currentState){case gf.DOWN:this.tfLabel.style.fill=e.COLOR_GREY;break;case gf.OUT:this.tfLabel.style.fill=e.COLOR_DARK_GREY;break;case gf.OVER:this.tfLabel.style.fill=e.COLOR_YELLOW;break;case gf.UP:this.isOver?this.tfLabel.style.fill=e.COLOR_YELLOW:this.tfLabel.style.fill=e.COLOR_DARK_GREY}},n.prototype.enable=function(){t.prototype.enable.call(this),this.setState(this._currentState)},n.prototype.disable=function(){t.prototype.disable.call(this),this.setState(this._currentState)},Object.defineProperty(n.prototype,"label",{get:function(){return this._label},set:function(e){if(e==this._label)return;this._label=e,this.tfLabel.text=this._label,this.hitArea=this.getLocalBounds()},enumerable:!0,configurable:!0}),n}(gf.ui.Button);t.TextLinkButton=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n)||this;return mConfig.getLanguages(function(t){r.icon=new gf.display.Sprite(r.game,"sprites","icon_language"),r.icon.tint=e.COLOR_DARK_GREY,r.addChild(r.icon);var n=function(e){return window.location.href="/?lang="+e},i=r.icon.right+e.PADDING;for(var s=0;s<t.length;++s){var o=new e.ui.TextLinkButton(r.game,t[s].caption);o.x=i,o.on(gf.CLICK,n.bind(null,t[s].id),r),r.addChild(o),i=o.right+e.PADDING;if(s+1<t.length){var u=new gf.display.Text(r.game,"|",e.TEXT_STYLE_VERSION.clone());u.x=i,r.addChild(u),i=u.right+e.PADDING}}}),r}return __extends(n,t),n}(gf.display.Container);t.Language=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n,r,i){var s=t.call(this,n,r,!0)||this;return s.icon=new gf.display.Sprite(s.game,"sprites",i),s.icon.tint=e.COLOR_DARK_GREY,s.addChild(s.icon),s.bg.y=s.icon.bottom,s.tfLabel.y+=s.bg.y,s.tfLabel.style.align=gf.CENTER,s.tfLabel.style.lineHeight=12,s.label=r,s}return __extends(n,t),n.prototype.setState=function(e){t.prototype.setState.call(this,e),this.icon&&(this.icon.alpha=1);if(!this.isEnabled){this.icon&&(this.icon.alpha=.5);return}},n.prototype.setWidth=function(e){t.prototype.setWidth.call(this,e);var n=Math.max(this.bg.width,this.icon.width);this.bg.hAlign(gf.CENTER,n),this.tfLabel.hAlign(gf.CENTER,n),this.icon.hAlign(gf.CENTER,n),this.hitArea=this.getLocalBounds()},Object.defineProperty(n.prototype,"label",{get:function(){return this._label},set:function(e){if(!this.icon||e==this._label)return;this._label=e,this.tfLabel.text=this._label,this.setWidth(Math.max(Math.round(this.tfLabel.width+20),this.icon.width))},enumerable:!0,configurable:!0}),n}(e.ui.TextButton);t.CompetitionButton=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n;(function(t){var n=function(t){function n(n){var r=t.call(this,n,"Competition")||this;return r.tfNewCompetition=new gf.display.Text(r.game,loc("competition_new"),e.TEXT_STYLE_TITLE_HINT.clone()),r.tfNewCompetition.style.align=gf.CENTER,r.tfNewCompetition.style.wordWrap=!0,r.tfNewCompetition.visible=!1,r.addChild(r.tfNewCompetition),r.tfNoCompetition=new gf.display.Text(r.game,loc("competition_empty"),e.TEXT_STYLE_TITLE_HINT.clone()),r.tfNoCompetition.style.align=gf.CENTER,r.tfNoCompetition.style.wordWrap=!0,r.tfNoCompetition.visible=!1,r.addChild(r.tfNoCompetition),r.btNew=new e.ui.CompetitionButton(r.game,loc("bt_competition_new"),"icon_competition_new"),r.btNew.on(gf.CLICK,r.onNew,r),r.addChild(r.btNew),r.btRanking=new e.ui.CompetitionButton(r.game,loc("bt_competition_ranking"),"icon_competition_ranking"),r.btRanking.on(gf.CLICK,r.onRanking,r),r.addChild(r.btRanking),r.game.overlays.show(e.overlays.Loader.NAME),sCompetition.getCurrent(function(t){t.current&&t.current.id?sCompetition.hasSeen(t.current.id,function(n){r.game.overlays.hide(e.overlays.Loader.NAME),r.current=t.current,r.last=t.last,r.updateButtons();if(r.game.screens.currentName==e.screens.Start.NAME){var i=r.game.screens.current,s=i.tabs.getTabButtonByContent(i.tabCompetition);s.indicator=1}if(!n){var o=r.game.overlays.show(e.overlays.CompetitionNew.NAME);o.update(r.current)}}):t.last&&t.last.id?(r.game.overlays.hide(e.overlays.Loader.NAME),r.last=t.last,r.updateButtons()):(r.game.overlays.hide(e.overlays.Loader.NAME),r.updateButtons())}),r}return __extends(n,t),n.prototype.updateButtons=function(){this.btRanking.isEnabled=!!this.last,this.btNew.isEnabled=!!this.current,this.tfNoCompetition.visible=!this.current,this.btNew.isEnabled=!!this.current,this.btRanking.isEnabled=!!this.last,this.updateSize(this.contentMask.width,this.contentMask.height)},n.prototype.onNew=function(){var t=this;if(mUser.isLoggedIn())this.game.overlays.show(e.overlays.Loader.NAME),sCompetition.getById(this.current.id,function(n){t.game.overlays.hide(e.overlays.Loader.NAME);var r=t.game.overlays.show(e.overlays.Competition.NAME);r.update(n)});else{var n=this.game.overlays.show(e.overlays.Message.NAME);n.text=loc("error_not_logged_in_competition")}},n.prototype.onRanking=function(){track("Competition-Ranking");var t=this.game.overlays.show(e.overlays.CompetitionRanking.NAME);t.update(this.last)},n.prototype.updateSize=function(n,r){t.prototype.updateSize.call(this,n,r),this.btNew.x=(this.game.width>>1)-this.btNew.width-50,this.btNew.y=r-this.btNew.height>>1,this.tfNoCompetition.style.wordWrapWidth=n-e.PADDING*4,this.tfNoCompetition.visible&&(this.btNew.y-=(this.tfNoCompetition.height>>1)+e.PADDING*4),this.tfNewCompetition.style.wordWrapWidth=n-e.PADDING*4,this.tfNewCompetition.x=n-this.tfNewCompetition.width>>1,this.tfNewCompetition.y=this.btNew.y-this.tfNewCompetition.height-e.PADDING*4,this.btRanking.x=(this.game.width>>1)+50,this.btRanking.y=this.btNew.y,this.tfNoCompetition.x=n-this.tfNoCompetition.width>>1,this.tfNoCompetition.y=this.btNew.bottom+e.PADDING*4},n}(e.ui.tabs.Tab);t.Competition=n})(n=t.tabs||(t.tabs={}))})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n;(function(t){var n=function(t){function n(n){var r=t.call(this,n,"Create_new_track")||this;r.content.x=r.contentMask.x=e.PADDING,r.content.y=r.contentMask.y=e.PADDING*2,r.tfShop=new gf.display.Text(r.game,loc("shop_visit"),e.TEXT_STYLE_SMALL.clone()),r.tfShop.style.align=gf.CENTER,r.addChild(r.tfShop),r.btShop=new e.ui.TextIconButton(r.game,"shop_bt",loc("bt_shop_visit"),!1),r.btShop.on(gf.CLICK,r.onShop,r),r.btShop.autoFit(),r.addChild(r.btShop),r.btCreateNewTrack=new e.ui.TextButton(r.game,loc("bt_create_track"),!0),r.btCreateNewTrack.on(gf.CLICK,r.onCreateTrack,r),r.btCreateNewTrack.autoFit(),r.addChild(r.btCreateNewTrack);var i=Math.max(r.btShop.width,r.btCreateNewTrack.width);return r.btShop.setWidth(i),r.btCreateNewTrack.setWidth(i),r.tfSelected=new gf.display.Text(r.game,loc("new_track_selected",{sets:0}),e.TEXT_STYLE_TITLE_TAB.clone()),r.tfSelected.style.fontSize=13,r.tfSelected.x=e.PADDING,r.addChild(r.tfSelected),r.activeSets=r.game.cache.getJSON("sets").active,r.addSets(),mAbo.on(e.clientmodels.Abo.ABO,function(){return r.onSets()}),mGift.on(e.clientmodels.Gift.GIFT,function(){return r.onSets()}),r.onSets(),r}return __extends(n,t),n.prototype.onSets=function(){var t=e.DEFAULT_SETS.concat(mAbo.getAbo().sets,mGift.getGift().sets);this.items.forEach(function(e){return e.isEnabled=t.includes(e.setName)})},n.prototype.onSet=function(){var e=0;this.items.forEach(function(t){t.isSelected&&e++}),this.tfSelected.text=loc("new_track_selected",{sets:e}),this.btCreateNewTrack.isEnabled=e>0},n.prototype.addSet=function(t){var n=new e.ui.SelectSetButton(this.game,t);n.isEnabled=this.activeSets.indexOf(t)!=-1||mAbo.getAbo().sets.indexOf(t)!=-1,n.on(gf.CHANGE,this.onSet,this),this.content.addChild(n),this.items.push(n)},n.prototype.addSets=function(){var t=this;this.items=[],e.SET_ORDER.forEach(function(e){return t.addSet(e)}),this.onResize()},n.prototype.onCreateTrack=function(){var t=this;track("Create-Create");var n=[];this.items.forEach(function(e){e.isSelected&&n.push(e.setName)}),n.length>0&&(mTrack=new e.vo.Track,mTrack.data.sets=n,mUser.isLoggedIn()&&(mTrack.owner=mUser.getUser()),this.game.overlays.show(e.overlays.Loader.NAME),sTrack.generateUniqueRandomName(loc("trackname_prefix"),function(n){t.game.overlays.hide(e.overlays.Loader.NAME),mTrack.name=n,e.core.Loader.loadTrack(t.game,mTrack,!1)}))},n.prototype.onShop=function(){track("Create-Shop"),this.game.client.config.isRussian?mUser.isLoggedIn()?window.open(e.SHOP_LINK_RU,"_blank"):this.game.overlays.show(e.overlays.Login.NAME):this.game.overlays.show(e.overlays.Shop.NAME)},n.prototype.reset=function(){this.items.forEach(function(e){e.isSelected=!1}),this.tfSelected.text=loc("new_track_selected",{sets:0}),this.btCreateNewTrack.isEnabled=!1},n.prototype.arrange=function(){if(this.items.length==0)return;var t;t=this.items[1].width;var n=this.contentMask.width-(this.scrollbar.width+e.PADDING*2),r=0,i=0,s=Math.min(Math.floor(n/(t+e.PADDING)),5),o=this.contentMask.width-(s*t+s*e.PADDING*2)>>1;this.items.forEach(function(n){r==s&&(i++,r=0),n.x=r*t+r*e.PADDING*2+o,n.y=i*t+i*e.PADDING,r++}),this.bounds.width=this.contentMask.width,this.bounds.height=i*t+i*e.PADDING+t,this.scrollbar.update(this.content,this.contentMask,0),this.scrollbar.visible?this.content.y=this.contentMask.y:this.content.y=this.contentMask.height-this.content.height>>1},n.prototype.updateSize=function(n,r){t.prototype.updateSize.call(this,n-this.scrollbar.width-e.PADDING*2,r-e.PADDING*4-this.btCreateNewTrack.height),this.onResize()},n.prototype.show=function(){t.prototype.show.call(this),this.onSet(),this.scrollbar.enableMouseWheel(),this.scrollbar.visible?this.content.y=this.contentMask.y:this.content.y=this.contentMask.height-this.content.height>>1,this.tfShop.visible=this.btShop.visible=!0;if(mAbo.getAbo().type==e.ABO_ALL||!this.game.client.config.isShopAvailable)this.tfShop.visible=this.btShop.visible=!1},n.prototype.hide=function(){t.prototype.hide.call(this),this.scrollbar.disableMouseWheel()},Object.defineProperty(n.prototype,"offsetHeight",{get:function(){return this.tfShop.height+this.btShop.height+this.btCreateNewTrack.height+e.PADDING*3},enumerable:!0,configurable:!0}),n.prototype.onResize=function(){t.prototype.onResize.call(this),this.tfShop.x=this.game.width-this.tfShop.width>>1,this.tfShop.y=this.contentMask.bottom+e.PADDING,this.btShop.x=this.game.width-(this.btCreateNewTrack.width+this.btShop.width+e.PADDING*4)>>1,this.btShop.y=this.tfShop.bottom+e.PADDING*2,this.btCreateNewTrack.x=this.btShop.visible?this.btShop.right+e.PADDING*4:this.game.width-this.btCreateNewTrack.width>>1,this.btCreateNewTrack.y=this.btShop.y,this.tfSelected.y=this.btCreateNewTrack.y+(this.btCreateNewTrack.height-this.tfSelected.height>>1),this.arrange()},n}(e.ui.tabs.Tab);t.Create=n})(n=t.tabs||(t.tabs={}))})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n,r){var i=t.call(this,n)||this;return i.colorOver=e.COLOR_WHITE,i.icon=new gf.display.Sprite(i.game,"sprites","icon_details_gallery"),i.icon.tint=e.COLOR_DARK_GREY,i.icon.y=1,i.addChild(i.icon),i.tfLabel=new gf.display.Text(n,"",e.TEXT_STYLE_SMALL.clone()),i.tfLabel.x=i.icon.right+e.PADDING,i.addChild(i.tfLabel),i.label=r,i.on(gf.CLICK,function(){return i.game.sounds.playFx("fx","click")},i),i.setState(gf.OUT),i}return __extends(n,t),n.prototype.setState=function(t){this.tfLabel.alpha=1;if(!this.isEnabled){this.tfLabel.alpha=.5;return}switch(this._currentState){case gf.DOWN:this.tfLabel.style.fill=e.COLOR_GREY,this.icon.tint=e.COLOR_GREY;break;case gf.OUT:this.tfLabel.style.fill=e.COLOR_DARK_GREY,this.icon.tint=e.COLOR_DARK_GREY;break;case gf.OVER:this.tfLabel.style.fill=this.colorOver,this.icon.tint=this.colorOver;break;case gf.UP:this.isOver?(this.tfLabel.style.fill=this.colorOver,this.icon.tint=this.colorOver):(this.tfLabel.style.fill=e.COLOR_DARK_GREY,this.icon.tint=e.COLOR_DARK_GREY)}},n.prototype.enable=function(){t.prototype.enable.call(this),this.setState(this._currentState)},n.prototype.disable=function(){t.prototype.disable.call(this),this.setState(this._currentState)},Object.defineProperty(n.prototype,"label",{get:function(){return this._label},set:function(e){if(e==this._label)return;this._label=e,this.tfLabel.text=this._label,this.hitArea=this.getLocalBounds()},enumerable:!0,configurable:!0}),n}(gf.ui.Button);t.GalleryItemButton=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n)||this;return r.interactive=!0,r.bg=new gf.display.Sprite(r.game,PIXI.Texture.WHITE),r.bg.tint=e.COLOR_MID_GREY,r.bg.width=150,r.bg.height=150,r.addChild(r.bg),r.preview=new e.ui.TrackPreview(r.game),r.preview.x=1,r.preview.y=1,r.preview.width=148,r.preview.height=148,r.addChild(r.preview),r.bgTop=new gf.display.Sprite(r.game,PIXI.Texture.WHITE),r.bgTop.tint=e.COLOR_MID_GREY,r.bgTop.width=150,r.bgTop.height=22,r.addChild(r.bgTop),r.icon=new gf.display.Sprite(r.game,"sprites","icon_eye"),r.icon.height=r.bgTop.height,r.icon.scaleX=r.icon.scaleY,r.icon.x=r.bgTop.width-r.icon.width>>0,r.icon.tint=e.COLOR_DARK_GREY,r.icon.alpha=.75,r.addChild(r.icon),r.iconCompetition=new gf.display.Sprite(r.game,"sprites","icon_gallery_competition"),r.iconCompetition.x=e.PADDING,r.iconCompetition.y=r.bgTop.bottom+e.PADDING>>0,r.iconCompetition.tint=e.COLOR_DARK_GREY,r.iconCompetition.alpha=.75,r.addChild(r.iconCompetition),r.tfDate=new gf.display.Text(r.game),r.tfDate.style=e.TEXT_STYLE_SMALL.clone(),r.tfDate.style.fontSize=11,r.tfDate.y=r.bgTop.bottom+e.PADDING>>0,r.addChild(r.tfDate),r.tfTrackName=new gf.display.Text(r.game),r.tfTrackName.style=e.TEXT_STYLE_BUTTON_CUBE.clone(),r.tfTrackName.x=e.PADDING,r.tfTrackName.y=r.bgTop.height-r.tfTrackName.height>>1,r.addChild(r.tfTrackName),r.bgBottom=new gf.display.Sprite(r.game,PIXI.Texture.WHITE),r.bgBottom.tint=e.COLOR_MID_GREY,r.bgBottom.width=150,r.bgBottom.height=22,r.bgBottom.y=128,r.addChild(r.bgBottom),r.btLoad=new gf.display.Sprite(r.game,PIXI.Texture.EMPTY),r.btLoad.on("click tap",r.onLoad,r),r.btLoad.width=r.bg.width,r.btLoad.height=r.bg.height-r.bgBottom.height,r.btLoad.interactive=!0,r.btLoad.buttonMode=!0,r.addChild(r.btLoad),r.trophy=new gf.display.Sprite(r.game,"sprites","icon_trophy"),r.trophy.tint=e.COLOR_DARK_GREY,r.trophy.x=e.PADDING,r.trophy.y=132,r.trophy.alpha=.75,r.addChild(r.trophy),r.tfScoreTotal=new gf.display.Text(r.game),r.tfScoreTotal.style=e.TEXT_STYLE_SMALL.clone(),r.tfScoreTotal.x=r.trophy.right+e.PADDING,r.tfScoreTotal.y=132,r.addChild(r.tfScoreTotal),r.btDetails=new e.ui.GalleryItemButton(r.game,loc("bt_track_details")),r.btDetails.on("click tap",r.onDetails,r),r.btDetails.x=150-r.btDetails.width-e.PADDING>>0,r.btDetails.y=r.tfScoreTotal.y,r.addChild(r.btDetails),r}return __extends(n,t),n.prototype.onDetails=function(){track("Gallery-Track_details"),this.emit(gf.CLICK);var t=this.game.overlays.show(e.overlays.TrackDetails.NAME);t.track=this._track},n.prototype.onLoad=function(){track("Gallery-Load_track"),e.core.Loader.loadTrack(this.game,this.track,!1)},n.prototype.update=function(){if(!this._track||!this._track.data)return;this._track.imageUrl&&(this.preview.url=this._track.imageUrl),this.tfDate.text=locDate("track_info_last_saved",this._track.publishedWhen?this._track.publishedWhen:this._track.lastSavedWhen),this.tfTrackName.text=this._track.name,this.tfTrackName.truncate(this.icon.x-e.PADDING*2),this._track.data.evaluation?this.tfScoreTotal.text=this._track.data.evaluation.scoreTotal.toString():this.tfScoreTotal.text="-",this.iconCompetition.visible=!1,this._track.isCompetition?(this.iconCompetition.visible=!0,this._track.owner.id==mUser.getUserId()&&!this._track.data.competition.hasSubmitted?(this.bgTop.tint=this.bgBottom.tint=e.COLOR_TRACK_COMPETITION,this.icon.frameName="icon_pen"):(this.bgTop.tint=this.bgBottom.tint=e.COLOR_TRACK_PUBLISHED,this.icon.frameName="icon_eye")):this._track.owner.id!=mUser.getUserId()?(this.bgTop.tint=this.bgBottom.tint=e.COLOR_TRACK_PUBLISHED,this.icon.frameName="icon_eye"):this._track.isPublished?(this.bgTop.tint=this.bgBottom.tint=e.COLOR_TRACK_PUBLISHED_OWN,this.icon.frameName="icon_eye"):(this.bgTop.tint=this.bgBottom.tint=e.COLOR_TRACK_OWN,this.icon.frameName="icon_pen"),this.onResize()},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.tfDate.x=this.bgTop.width-this.tfDate.width-e.PADDING>>0},Object.defineProperty(n.prototype,"track",{get:function(){return this._track},set:function(e){this._track=e,this.update()},enumerable:!0,configurable:!0}),n}(gf.display.Sprite);t.GalleryItem=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n,r,i,s){s===void 0&&(s=!1);var o=t.call(this,n,i,s)||this;return o.icon=new gf.display.Sprite(o.game,"sprites","icon_"+r),o.icon.x=e.PADDING,o.addChild(o.icon),o.tfLabel.x=o.icon.right+e.PADDING,o.label=i,o.setState(o._currentState),o}return __extends(n,t),n.prototype.setState=function(t){if(!this.icon)return;this.icon.alpha=1,this.tfLabel.alpha=1;if(!this.isEnabled){this.bg.frameName="bt_text_disabled",this.icon.alpha=.5,this.tfLabel.alpha=.5;return}if(this.isSelected){this.bg.frameName="bt_text_over",this.tfLabel.style.fill=e.COLOR_DARK_GREY,this.icon.tint=e.COLOR_DARK_GREY;return}switch(this._currentState){case gf.DOWN:this.bg.frameName="bt_text_down",this.icon.tint=e.COLOR_YELLOW,this.tfLabel.style.fill=e.COLOR_YELLOW;break;case gf.OUT:this.bg.frameName=this.isPrimary?"bt_text_out":"bt_text_sek_out",this.icon.tint=e.COLOR_DARK_GREY,this.tfLabel.style.fill=e.COLOR_DARK_GREY;break;case gf.OVER:this.bg.frameName="bt_text_over",this.icon.tint=e.COLOR_DARK_GREY,this.tfLabel.style.fill=e.COLOR_DARK_GREY;break;case gf.UP:this.isOver?(this.bg.frameName="bt_text_over",this.icon.tint=e.COLOR_DARK_GREY,this.tfLabel.style.fill=e.COLOR_DARK_GREY):(this.bg.frameName=this.isPrimary?"bt_text_out":"bt_text_sek_out",this.icon.tint=e.COLOR_DARK_GREY,this.tfLabel.style.fill=e.COLOR_DARK_GREY)}},n.prototype.setWidth=function(e){this.bg.width=e,this.hitArea=this.getLocalBounds()},n.prototype.autoFit=function(t){t===void 0&&(t=e.PADDING),this.bg.width=this.tfLabel.width+this.icon.width+t*3},Object.defineProperty(n.prototype,"label",{get:function(){return this._label},set:function(e){if(e==this._label||!this.icon)return;this._label=e,this.tfLabel.text=this._label,this.bg.width=Math.round(this.tfLabel.width)+this.icon.width+20,this.hitArea=this.getLocalBounds()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isSelected",{get:function(){return this._isSelected},set:function(e){this._isSelected=e,this._isOver=!1,this.setState(this._currentState)},enumerable:!0,configurable:!0}),n}(e.ui.TextButton);t.TextIconButton=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n;(function(t){var n=function(t){function n(n){var r=t.call(this,n,"Gallery")||this;return r.items=[],r.buttons=new gf.display.Container(r.game),r.buttons.interactive=!0,r.buttons.y=e.PADDING*2,r.addChild(r.buttons),r.btBest=new e.ui.TextIconButton(r.game,"best",loc("bt_tracks_best")),r.btBest.isSelected=!0,r.btBest.setWidth(150),r.btBest.on(gf.CLICK,function(){return r.onFilter("rating",!1,!1,r.btBest,!0)},r),r.buttons.addChild(r.btBest),r.btNewest=new e.ui.TextIconButton(r.game,"newest",loc("bt_tracks_newest")),r.btNewest.x=r.btBest.right+e.PADDING,r.btNewest.setWidth(Math.max(150,r.btNewest.width)),r.btNewest.on(gf.CLICK,function(){return r.onFilter("age",!1,!1,r.btNewest,!0)},r),r.buttons.addChild(r.btNewest),r.btOwn=new e.ui.TextIconButton(r.game,"own",loc("bt_tracks_own")),r.btOwn.x=r.btNewest.right+e.PADDING,r.btOwn.setWidth(Math.max(150,r.btOwn.width)),r.btOwn.isEnabled=mUser.isLoggedIn(),r.btOwn.on(gf.CLICK,function(){return r.onFilter("age",!0,!1,r.btOwn,!0)},r),r.buttons.addChild(r.btOwn),r.btEdu=new e.ui.TextIconButton(r.game,"edu",loc("bt_tracks_edu")),r.btEdu.x=r.btOwn.right+e.PADDING,r.btEdu.setWidth(150),r.btEdu.on(gf.CLICK,function(){return r.onFilter("age",!1,!0,r.btEdu,!0)},r),r.buttons.addChild(r.btEdu),r.btSets=new e.ui.TextIconButton(r.game,"sets",loc("bt_tracks_sets"),!0),r.btSets.x=e.PADDING,r.btSets.y=r.buttons.y,r.btSets.setWidth(150),r.btSets.on(gf.CLICK,r.onSets,r),r.addChild(r.btSets),r.sets=[],r.tfSets=new gf.display.Text(r.game),r.tfSets.style=e.TEXT_STYLE_SMALL.clone(),r.tfSets.style.wordWrap=!0,r.tfSets.style.lineHeight=13,r.addChild(r.tfSets),r.tfNoTracks=new gf.display.Text(r.game,loc("gallery_no_tracks"),e.TEXT_STYLE_DEFAULT_HEAVY.clone()),r.addChild(r.tfNoTracks),r.content.x=r.contentMask.x=e.PADDING,r.content.y=r.contentMask.y=r.buttons.bottom+e.PADDING*2,r.btLoadMore=new e.ui.TextButton(r.game,loc("bt_load_more"),!1),r.btLoadMore.isEnabled=!1,r.btLoadMore.on(gf.CLICK,r.onLoadMore,r),r.addChild(r.btLoadMore),r.tfTracks=new gf.display.Text(r.game,loc("gallery_tracks",{value:0})),r.tfTracks.style=e.TEXT_STYLE_BUTTON_TEXT.clone(),r.tfTracks.visible=!1,r.addChild(r.tfTracks),mUser.on("loggedIn",function(){r.btOwn.isEnabled=!0}),mUser.on("logout",function(){r.btOwn.isEnabled=!1,r.onFilter("rating",!1,!1,r.btBest,!0)}),r.updateSetText(),r}return __extends(n,t),n.prototype.onLoadMore=function(){this.galleryFilters.offset+=this.galleryFilters.limit,this.getPage(this.galleryFilters,!1)},n.prototype.onSets=function(){track("Gallery-Filter_sets");var t=this.game.overlays.show(e.overlays.SelectSets.NAME);t.update(this)},n.prototype.addItem=function(t){var n=this,r=new e.ui.GalleryItem(this.game);r.track=t,r.on(gf.CLICK,function(){n.scrollbar.disableMouseWheel()},this),this.content.addChild(r),this.items.push(r)},n.prototype.getItem=function(e){var t=null;return this.items.forEach(function(n){if(n.track.id==e)return t=n,!0}),t},n.prototype.onFilter=function(e,t,n,r,i){i===void 0&&(i=!1);var s={offset:0,limit:20,own:t,edu:n,sets:this.sets,sortBy:e};this.btBest.isSelected=this.btBest==r,this.btNewest.isSelected=this.btNewest==r,this.btOwn.isSelected=this.btOwn==r,this.btEdu.isSelected=this.btEdu==r,this.getPage(s,i)},n.prototype.getPage=function(t,n){var r=this;n===void 0&&(n=!0);if(this.isLoading)return;this.isLoading=!0,this.galleryFilters=t,this.game.overlays.show(e.overlays.Loader.NAME),n&&this.reset(),sGallery.getPage(this.galleryFilters,function(t,n){r.game.overlays.hide(e.overlays.Loader.NAME);if(n==kr3m.SUCCESS){t.tracks.forEach(function(e){r.addItem(e)});var i=t.totalCount-t.usedFilters.offset-t.tracks.length;r.btLoadMore.isEnabled=i>0,r.tfTracks.visible=i>0,r.tfTracks.text=loc("gallery_tracks",{value:i}),r.arrange(),r.isLoading=!1}r.emit("galleryLoaded")})},n.prototype.alignSetText=function(){this.buttons.x-this.btSets.right<200?(this.tfSets.style.wordWrapWidth=this.game.width,this.tfSets.x=this.btSets.x,this.tfSets.y=this.btSets.bottom+e.PADDING):(this.tfSets.style.wordWrapWidth=this.buttons.x-this.btSets.right-e.PADDING*2,this.tfSets.x=this.btSets.right+e.PADDING,this.tfSets.y=this.btSets.y+(this.btSets.height-this.tfSets.height>>1))},n.prototype.updateSetText=function(){this.sets.length==0?this.tfSets.text=loc("selected_sets",{sets:loc("selected_sets_all")}):this.sets.length==1?this.tfSets.text=loc("selected_sets",{sets:loc("packshot_"+this.sets[0])}):this.tfSets.text=loc("selected_sets_count",{count:this.sets.length}),this.alignSetText()},n.prototype.arrange=function(){var t=150,n=0,r=0,i=this.contentMask.width-(this.scrollbar.width+e.PADDING*2),s=Math.floor(i/(t+e.PADDING*2)),o=Math.min(s,this.items.length),u=this.contentMask.width-o*(t+e.PADDING*2)>>1;this.items.forEach(function(i){n==s&&(n=0,r++),i.scaleXY=1,i.x=n*t+n*e.PADDING*2+u,i.y=r*t+r*e.PADDING*3,n++}),this.bounds.width=this.contentMask.width,this.bounds.height=r*t+r*e.PADDING+t,this.scrollbar.update(this.content,this.contentMask,0),this.scrollbar.visible=this.scrollbar.sizeScroll>this.scrollbar.sizeVisible,this.tfNoTracks.visible=this.items.length==0},n.prototype.reset=function(){this.content.y=this.contentMask.y,this.scrollbar.updateToContentPosition(),this.content.removeChildren(),this.content.addChild(this.bounds),this.items=[]},n.prototype.updateSets=function(e){this.sets=e,this.galleryFilters.offset=0,this.galleryFilters.sets=e,this.updateSetText(),this.reload()},n.prototype.updateSize=function(n,r){this.galleryHeight=r-this.btLoadMore.height-e.PADDING*4-this.btBest.bottom,t.prototype.updateSize.call(this,n-this.scrollbar.width-e.PADDING*2,this.galleryHeight),this.onResize()},n.prototype.reload=function(){this.getPage(this.galleryFilters,!0)},n.prototype.show=function(){t.prototype.show.call(this),this.onFilter("rating",!1,!1,this.btBest,!0),this.scrollbar.enableMouseWheel()},n.prototype.hide=function(){t.prototype.hide.call(this),this.scrollbar.disableMouseWheel()},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.tfTracks.visible?this.btLoadMore.x=this.game.width-this.btLoadMore.width-this.tfTracks.width-e.PADDING>>1:this.btLoadMore.x=this.game.width-this.btLoadMore.width>>1,this.btLoadMore.y=this.galleryHeight+this.btBest.bottom+e.PADDING*3,this.buttons.x=this.game.width-this.buttons.width-e.PADDING,this.tfTracks.x=this.btLoadMore.right+e.PADDING,this.tfTracks.y=this.btLoadMore.y+(this.btLoadMore.height-this.tfTracks.height>>1),this.tfNoTracks.x=this.contentMask.x+(this.contentMask.width-this.tfNoTracks.width>>1),this.tfNoTracks.y=this.contentMask.y+(this.contentMask.height-this.tfNoTracks.height>>1),this.alignSetText(),this.arrange()},n}(e.ui.tabs.Tab);t.Gallery=n})(n=t.tabs||(t.tabs={}))})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){t.prototype.init.call(this),this.content=new gf.display.Container(this.game),this.content.y=this.game.stage.header.bg.height,this.content.interactive=!0,this.addChild(this.content),this.logoBgMask=new gf.display.Sprite(this.game,PIXI.Texture.WHITE),this.content.addChild(this.logoBgMask),this.logoBg=new gf.display.Sprite(this.game,"logoBg"),this.logoBg.mask=this.logoBgMask,this.content.addChild(this.logoBg),this.logo=new gf.display.Sprite(this.game,"logo"),this.content.addChild(this.logo),this.cuboroWebkit=new gf.display.Text(this.game,"cuboro webkit"),this.cuboroWebkit.style.fontFamily=e.DEFAULT_FONT_HEAVY,this.cuboroWebkit.style.fill=16777215,this.cuboroWebkit.style.fontSize=this.cuboroWebkit.style.lineHeight=96,this.content.addChild(this.cuboroWebkit),this.tabCompetition=new e.ui.tabs.Competition(this.game),this.tabCreate=new e.ui.tabs.Create(this.game),this.tabGallery=new e.ui.tabs.Gallery(this.game),this.tabs=new e.ui.Tabs(this.game),this.tabs.y=this.logo.bottom,this.tabs.add(this.tabGallery,loc("bt_gallery")),this.tabs.add(this.tabCreate,loc("bt_create_track")),this.tabs.add(this.tabCompetition,loc("bt_competition")),this.tabs.current=this.tabGallery,this.content.addChild(this.tabs),this.language=new e.ui.Language(this.game),this.addChild(this.language)},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.logoBg.width=this.game.width,this.logoBg.scaleY=this.logoBg.scaleX,this.logoBgMask.width=this.game.width,this.logoBgMask.height=this.game.height*.55,this.logoBg.height<this.logoBgMask.height&&(this.logoBg.height=this.logoBgMask.height,this.logoBg.scaleX=this.logoBg.scaleY),this.logoBg.y=this.logoBgMask.height-this.logoBg.height>>1,this.logo.height=this.logoBgMask.height-e.PADDING*4,this.logo.scaleXY=Math.min(1,this.logo.scaleY),this.logo.y=this.logoBgMask.height-this.logo.height>>1,this.logo.x=this.game.width-this.logo.width-this.logo.y>>0,this.language.x=this.game.width-this.language.width-e.PADDING,this.language.y=this.game.height-this.game.stage.footer.bg.height-this.language.height-e.PADDING,this.tabs.y=this.logoBgMask.bottom;var n=this.game.height-this.tabs.y-this.tabs.tabButtons.height-this.game.stage.footer.height-this.game.stage.header.bg.height;this.tabs.maxWidth=this.game.width,this.tabs.updateSize(this.game.width,n),this.tabCreate.updateSize(this.game.width,n-this.tabCreate.offsetHeight+30),this.cuboroWebkit.width=this.tabs.getTabButtonByContent(this.tabCreate).width,this.cuboroWebkit.scaleY=this.cuboroWebkit.scaleX,this.cuboroWebkit.x=this.game.width-this.cuboroWebkit.width>>1,this.cuboroWebkit.y=this.logoBgMask.height-this.cuboroWebkit.height+10},n.prototype.transitionIn=function(){t.prototype.transitionIn.call(this),this.tabCreate.reset(),this.tabs.current==this.tabGallery&&this.tabGallery.reload()},n.NAME="start",n}(e.screens.Screen);t.Start=n})(t=e.screens||(e.screens={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n)||this;r.bg=new gf.display.Sprite(r.game,PIXI.Texture.WHITE),r.bg.height=20,r.bg.tint=e.COLOR_WHITE,r.addChild(r.bg),r.btImprint=new e.ui.TextLinkButton(r.game,loc("bt_imprint")),r.btImprint.x=e.PADDING,r.btImprint.y=e.PADDING,r.btImprint.on(gf.CLICK,r.onImprint,r),r.addChild(r.btImprint);var i=new gf.display.Text(r.game,"|",e.TEXT_STYLE_VERSION.clone());i.x=r.btImprint.right+e.PADDING,i.y=e.PADDING,r.addChild(i),r.btContact=new e.ui.TextLinkButton(r.game,loc("bt_contact")),r.btContact.x=i.right+e.PADDING,r.btContact.y=e.PADDING,r.btContact.on(gf.CLICK,r.onContact,r),r.addChild(r.btContact);var s=new gf.display.Text(r.game,"|",e.TEXT_STYLE_VERSION.clone());s.x=r.btContact.right+e.PADDING,s.y=e.PADDING,r.addChild(s),r.btPrivacy=new e.ui.TextLinkButton(r.game,loc("bt_legal_notices")),r.btPrivacy.x=s.right+e.PADDING,r.btPrivacy.y=e.PADDING,r.btPrivacy.on(gf.CLICK,r.onLegalNotices,r),r.addChild(r.btPrivacy);var o=new gf.display.Text(r.game,"|",e.TEXT_STYLE_VERSION.clone());o.x=r.btPrivacy.right+e.PADDING,o.y=e.PADDING,r.addChild(o),r.btTerms=new e.ui.TextLinkButton(r.game,loc("bt_terms")),r.btTerms.x=o.right+e.PADDING,r.btTerms.y=e.PADDING,r.btTerms.on(gf.CLICK,r.onTerms,r),r.addChild(r.btTerms);if(!r.game.client.config.isRussian){var u=new gf.display.Text(r.game,"|",e.TEXT_STYLE_VERSION.clone());u.x=r.btTerms.right+e.PADDING,u.y=e.PADDING,r.addChild(u),r.btTermsParticipation=new e.ui.TextLinkButton(r.game,loc("bt_terms_participation")),r.btTermsParticipation.x=u.right+e.PADDING,r.btTermsParticipation.y=e.PADDING,r.btTermsParticipation.on(gf.CLICK,r.onTermsParticipation,r),r.addChild(r.btTermsParticipation)}return r.tfVersion=new gf.display.Text(r.game),r.tfVersion.style=e.TEXT_STYLE_VERSION.clone(),r.tfVersion.text=loc("say_hello",{name:loc("app_title"),version:e.VERSION}),r.tfVersion.y=e.PADDING,r.addChild(r.tfVersion),r}return __extends(n,t),n.prototype.onImprint=function(){track("Footer-Imprint"),this.game.overlays.show(e.overlays.Imprint.NAME)},n.prototype.onContact=function(){track("Footer-Contact"),this.game.overlays.show(e.overlays.Contact.NAME)},n.prototype.onLegalNotices=function(){track("Footer-LegalNotices");var e=this.game.client.supportedLanguage;e=="de"?window.open("/html/privacy_de.html","_blank"):e=="ru"?window.open("https://cuboro.ru/news/poleznaya-informatsiya/politika-konfidentsialnosti/","_blank"):window.open("/html/privacy_en.html","_blank")},n.prototype.onTerms=function(){track("Footer-TermsAndConditions");var e=this.game.client.supportedLanguage;window.open("/html/terms_"+e+".html","_blank")},n.prototype.onTermsParticipation=function(){track("Footer-TermsParticipation");var e=this.game.client.supportedLanguage;window.open("/html/terms_participation_"+e+".html","_blank")},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.y=this.game.height-this.bg.height,this.bg.width=this.game.width,this.tfVersion.x=this.game.width-this.tfVersion.width-e.PADDING},n}(gf.display.Container);t.Footer=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(e){var t=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.printPdf=function(e,t,n){var r={trackId:e,screenshot:t};this.callService("Pdf.printPdf",r,n)},t}(e.Abstract);e.Pdf=t})(t=e.stubs||(e.stubs={}))})(cuboro||(cuboro={}));var sPdf=new cuboro.stubs.Pdf,cuboro;(function(e){var t;(function(e){var t=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.printPdf=function(e,t,n){sPdf.printPdf(e,t,function(e){open(e,"_blank"),n()})},t}(kr3m.model.EventDispatcher);e.Pdf=t})(t=e.clientmodels||(e.clientmodels={}))})(cuboro||(cuboro={}));var mPdf=new cuboro.clientmodels.Pdf,cuboro;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n)||this;r.interactive=!0,r.trackNameBg=new gf.display.Slice3(r.game,10,10,"sprites","bg_dropdown"),r.trackNameBg.width=220,r.trackNameBg.x=e.PADDING,r.trackNameBg.y=21,r.addChild(r.trackNameBg),r.form=new gf.input.Form(r.game,"login"),r.addChild(r.form),r.trackName=new gf.input.TextInput(r.game,r.form,"trackName"),r.trackName.x=(r.trackNameBg.x+e.PADDING)*r.game.scaleX,r.trackName.y=22*r.game.scaleY,r.trackName.width=r.trackNameBg.width-e.PADDING*2,r.trackName.value=loc("unnamed_track"),r.trackName.fontFamily=e.DEFAULT_FONT,r.trackName.bold=!0,r.trackName.fontSize=20,r.trackName.inputDom.style.textOverflow="ellipsis",r.trackName.maxLength=e.TRACK_NAME_MAX_LENGTH,r.trackName.on(gf.FOCUS,r.onTrackNameFocus,r),r.trackName.on(gf.BLUR,r.onTrackNameChange,r),r.form.addChild(r.trackName);var i={bold:e.TEXT_STYLE_DEFAULT_HEAVY.clone()};return r.tfUsed=new gf.display.MultiStyleText(r.game,loc("cubes_used",{total:0,used:0}),e.TEXT_STYLE_DEFAULT.clone(),i),r.tfUsed.x=r.trackName.x,r.tfUsed.y=r.trackNameBg.bottom+e.PADDING,r.addChild(r.tfUsed),r.tfTrackName=new gf.display.Text(r.game,loc("track_name"),e.TEXT_STYLE_BUTTON_ICON.clone()),r.tfTrackName.x=r.trackName.x,r.tfTrackName.y=r.trackNameBg.y-r.tfTrackName.height>>0,r.addChild(r.tfTrackName),r.btDetails=new e.ui.IconButton(r.game,"details",loc("bt_track_details")),r.btDetails.on(gf.CLICK,r.onDetails,r),r.btDetails.y=e.PADDING,r.addChild(r.btDetails),r.btDuplicate=new e.ui.IconButton(r.game,"duplicate",loc("bt_track_duplicate")),r.btDuplicate.on(gf.CLICK,r.onDuplicate,r),r.btDuplicate.y=e.PADDING,r.addChild(r.btDuplicate),r.btPrint=new e.ui.IconButton(r.game,"print",loc("bt_print")),r.btPrint.on(gf.CLICK,r.onPrint,r),r.btPrint.y=e.PADDING,r.addChild(r.btPrint),r.btPublish=new e.ui.IconButton(r.game,"publish",loc("bt_publish")),r.btPublish.on(gf.CLICK,r.onPublish,r),r.btPublish.y=e.PADDING,r.btPublish.visible=!1,r.addChild(r.btPublish),r.btSubmit=new e.ui.IconButton(r.game,"competition",loc("bt_submit_competition")),r.btSubmit.on(gf.CLICK,r.onSubmit,r),r.btSubmit.y=e.PADDING,r.btSubmit.visible=!1,r.addChild(r.btSubmit),r.btGoals=new e.ui.IconButton(r.game,"competition_goals",loc("bt_competition_goal")),r.btGoals.on(gf.CLICK,r.onGoals,r),r.btGoals.y=e.PADDING,r.btGoals.visible=!1,r.addChild(r.btGoals),r.tfSaved=new gf.display.Text(r.game,"",e.TEXT_STYLE_BUTTON_TEXT.clone()),r.tfSaved.style.fontFamily=e.DEFAULT_FONT_HEAVY,r.tfSaved.style.align=gf.LEFT,r.tfSaved.visible=!1,r.addChild(r.tfSaved),mUser.on("loggedIn",function(){r.toggleDuplicateButton(),r.btPrint.isEnabled=!0,r.checkPublish()}),mUser.on("logout",function(){r.toggleDuplicateButton(),r.btPrint.isEnabled=r.btPublish.isEnabled=!1}),r.toggleDuplicateButton(),mAbo.on(e.clientmodels.Abo.ABO,function(){r.onAbo()}),r}return __extends(n,t),n.prototype.trackNameValidation=function(){var t=!1;if(this.trackName.value.length>=3)t=!0;else{var n=this.game.overlays.show(e.overlays.Message.NAME);n.text=loc("error_input_track_name"),this.trackName.value=this.lastName}return t},n.prototype.onDetails=function(){track("Ingame-Track-Details");var t=this.game.overlays.show(e.overlays.TrackDetailsIngame.NAME);t.track=mTrack},n.prototype.onDuplicate=function(){var t=this;track("Ingame-Track-Duplicate");if(mUser.isLoggedIn()){var n=this.game.screens.current.playground,r=new e.vo.TrackData;r.cubes=n.cubes.getCubes(),r.cubesHash=mTrack.data.cubesHash,r.evaluation=n.evaluation.current,r.competition=mTrack.data.competition,r.sets=mTrack.data.sets;var i=this.game.overlays.show(e.overlays.SaveChanges.NAME);i.onQuit=function(){},i.onSave=function(){t.game.overlays.show(e.overlays.Loader.NAME),n.saveDupe(i.trackName.value,r,function(){t.toggleDuplicateButton(),t.game.overlays.hide(e.overlays.Loader.NAME)})}}else this.game.overlays.show(e.overlays.LoginToSave.NAME)},n.prototype.onGoals=function(){mTrack.eduTask?(track("Ingame-EduTrack-Task"),this.game.overlays.show(e.overlays.EduTrackTask.NAME)):(track("Ingame-Competition-Goals"),this.game.overlays.show(e.overlays.CompetitionGoals.NAME))},n.prototype.onPrint=function(){var t=this;track("Ingame-Print"),this.game.overlays.show(e.overlays.Loader.NAME);var n=!1;if(!mTrack.owner||mTrack.owner.id!=mUser.getUserId()||mTrack.isPublished||!mUser.isLoggedIn())n=!0;mTrack.data.competition&&mTrack.data.competition.id&&mTrack.id&&mTrack.isSubmitted&&(n=!0),this.game.screens.current.playground.detectMissingSets()&&(n=!0),mTrack.id&&!mTrack.imageUrl&&!n?this.game.screens.current.playground.saveImage(function(){return t.onPrint()}):n?e.ui.TrackPreview.GetBase64(this.game.screens.current.playground,600,function(n){mPdf.printPdf(mTrack.id,n,function(){t.game.overlays.hide(e.overlays.Loader.NAME)})}):this.game.screens.current.playground.save(function(){e.ui.TrackPreview.GetBase64(t.game.screens.current.playground,600,function(n){mPdf.printPdf(mTrack.id,n,function(){t.game.overlays.hide(e.overlays.Loader.NAME)})})})},n.prototype.onPublish=function(){track("Ingame-Publish");var t=e.ui.TrackPreview.unique(JSON.stringify(this.playground.cubes.getCubes()));if(t==mTrack.data.cubesHash)this.game.overlays.show(e.overlays.Publish.NAME);else{var n=this.game.overlays.show(e.overlays.Message.NAME);n.text=loc("error_track_publish_changed")}},n.prototype.onSubmit=function(){var t=this;track("Ingame-Submit-Competition"),this.game.overlays.show(e.overlays.Loader.NAME);var n=this.game.screens.current;n.playground.save(function(){t.game.overlays.hide(e.overlays.Loader.NAME),t.game.overlays.show(e.overlays.CompetitionApply.NAME)})},n.prototype.onTrackNameChange=function(){var t=this;this.trackNameValidation()&&!this.trackName.readOnly&&(this.game.overlays.show(e.overlays.Loader.NAME),sTrack.isNameUnique(mTrack.id,this.trackName.value,function(n){if(n){t.game.overlays.hide(e.overlays.Loader.NAME),mTrack.name=t.trackName.value;if(mTrack.id&&mTrack.owner&&mTrack.owner.id==mUser.getUserId()){var r=t.game.screens.current;r.playground.save()}}else sTrack.generateUniqueRandomName(loc("trackname_prefix"),function(n){t.game.overlays.hide(e.overlays.Loader.NAME),mTrack.name=n,t.trackName.value=n;var r=t.game.overlays.show(e.overlays.Message.NAME);r.text=loc("error_track_name_taken")})}))},n.prototype.onTrackNameFocus=function(){this.trackName.value.length>=3&&(this.lastName=this.trackName.value)},n.prototype.getAmountByCubeNo=function(e){if(!mTrack.data.evaluation.cubesById)return 0;var t=0;return mTrack.data.evaluation.cubesById.forEach(function(n){n.cubeNo==e&&n.hits>0&&t++}),t},n.prototype.detectMissingSets=function(){var t=!1,n=[];if(mAbo.hasAbo()||mAbo.getAbo().sets.length>0)n=n.concat(mAbo.getAbo().sets);return n=n.concat(mGift.getGift().sets),mTrack.data.sets.forEach(function(r){r!=e.SETS.WEB_ONE&&n.indexOf(r)==-1&&(t=!0)}),mTrack.data.competition&&mTrack.owner.id==mUser.getUserId()&&(t=!1),mTrack.data.competition&&(mTrack.data.competition.hasSubmitted||mTrack.data.competition.expired)&&(t=!0),t},n.prototype.onAbo=function(){this.btDuplicate.isEnabled=!this.detectMissingSets(),this.checkPublish(),this.btSubmit.isEnabled=!1,mTrack.data.competition&&mTrack.data.competition.id&&(this.btDuplicate.isEnabled=!1),this.trackName.readOnly=this.detectMissingSets()},n.prototype.updateCubesUsed=function(e,t){this.tfUsed.text=loc("cubes_used",{total:e,used:t})},n.prototype.toggleDuplicateButton=function(){mUser.isLoggedIn()?(this.btDuplicate.label=loc("bt_track_duplicate"),this.btDuplicate.icon.frameName="icon_duplicate",this.btDuplicate.isPrimary=!1):(this.btDuplicate.label=loc("bt_save_changes"),this.btDuplicate.icon.frameName="icon_save",this.btDuplicate.isPrimary=!0)},n.prototype.onTrackLoaded=function(){mTrack.data.competition&&mTrack.data.competition.id&&(this.btDuplicate.isEnabled=!1),this.btPublish.visible=!this.playground.isCompetition,this.btSubmit.visible=this.playground.isCompetition,this.btSubmit.isEnabled=!1,this.btGoals.visible=this.playground.isCompetition||mTrack.eduTask&&mTrack.eduTask.length>0,this.btGoals.visible&&(this.btGoals.label=loc(mTrack.eduTask?"bt_edutrack_goal":"bt_competition_goal"))},n.prototype.checkPublish=function(){var e=this;this.btPublish.isEnabled=!1;if(!mUser.isLoggedIn())return;if(mTrack.data.evaluation.scoreTotal==0)return;sTrack.isPublished(mTrack.id,function(t){t||(e.btPublish.isEnabled=!e.detectMissingSets())})},n.prototype.checkSubmit=function(){var e=this;if(!mTrack.data.competition||!mTrack.data.competition.id)return;this.btSubmit.isEnabled=mTrack.data.evaluation.scoreTotal!=0,mTrack.data.evaluation.scoreTotal<mTrack.data.competition.minScore&&(this.btSubmit.isEnabled=!1);if(mTrack.data.competition.baseTrackId){var t=!0;mTrack.data.competition.solidCubes?mTrack.data.competition.solidCubes.forEach(function(e){var n=!1;mTrack.data.evaluation.trackCubeIds&&mTrack.data.evaluation.trackCubeIds.forEach(function(t){if(t==e){n=!0;return}}),n||(t=!1)}):t=!1,t||(this.btSubmit.isEnabled=!1)}if(mTrack.data.competition.requiredCubes){var n=mTrack.data.competition.requiredCubes;for(var r in n){var i=this.getAmountByCubeNo(r);i<n[r]&&(this.btSubmit.isEnabled=!1)}}if(mTrack.data.competition.touches)if(!mTrack.data.evaluation.cubesById)this.btSubmit.isEnabled=!1;else{var s=mTrack.data.evaluation.cubesById.concat([]).sort(function(e,t){return e.hits-t.hits}),o=mTrack.data.competition.touches.concat([]).sort(function(e,t){return e.amount-t.amount});o.forEach(function(t){var n=!1;s.forEach(function(e,r){!n&&t.id==e.cubeNo&&e.hits>=t.amount&&(n=!0,s.splice(r,1))}),n||(e.btSubmit.isEnabled=!1)})}},n.prototype.show=function(){this.visible=!0,this.form.showDom(),this.btPrint.isEnabled=mUser.isLoggedIn(),this.btSubmit.visible=!1,this.btGoals.visible=!1,this.btPublish.visible=!1},n.prototype.hide=function(){this.visible=!1,this.form.hideDom()},n.prototype.onResize=function(){t.prototype.onResize.call(this);if(!this.game.stage.header)return;this.btDetails.x=this.trackNameBg.right+e.PADDING*2,this.btDuplicate.x=this.btDetails.right+e.PADDING,this.btPrint.x=this.btDuplicate.right+e.PADDING,this.btPublish.x=this.btSubmit.x=this.btPrint.right+e.PADDING,this.btGoals.x=this.btSubmit.right+e.PADDING,this.tfSaved.x=(this.btGoals.visible?this.btGoals.right:this.btPublish.right)+e.PADDING*2,this.tfSaved.style.wordWrap=!0;var n=this.game.stage.header.btShop.x-e.PADDING*2-this.tfSaved.x;this.tfSaved.style.wordWrapWidth=Math.max(100,n),TweenMax.isTweening(this.tfSaved)||(this.tfSaved.y=this.btPublish.y+(this.btPublish.height-this.tfSaved.height>>1))},Object.defineProperty(n.prototype,"saveText",{get:function(){return this.tfSaved.text},set:function(e){this.tfSaved.text=e,this.onResize();if(TweenMax.isTweening(this.tfSaved))return;if(!this.tfSaved.visible&&e!=""){this.tfSaved.y=-this.tfSaved.height,this.tfSaved.visible=!0;var t=this.btPublish.y+(this.btPublish.height-this.tfSaved.height>>1);TweenMax.to(this.tfSaved,1,{y:t,ease:Elastic.easeOut})}else this.tfSaved.alpha=1,TweenMax.to(this.tfSaved,.25,{alpha:0,repeat:1,yoyo:!0})},enumerable:!0,configurable:!0}),n}(gf.display.Container);t.TrackMenu=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n)||this;r.interactive=!0,r.bg=new gf.display.Sprite(r.game,PIXI.Texture.WHITE),r.bg.height=75,r.bg.tint=e.COLOR_LIGHT_GREY,r.addChild(r.bg),r.videoContent=new gf.display.Container(r.game),r.videoContent.interactive=!0,r.videoContent.buttonMode=!0,r.videoContent.visible=!r.game.client.config.isRussian,r.videoContent.on("click tap",r.onVideo,r),r.addChild(r.videoContent);var i=new gf.display.Sprite(r.game,"sprites","icon_video");i.tint=e.COLOR_DARK_GREY,r.videoContent.addChild(i);var s=new gf.display.Text(r.game,loc("video"),e.TEXT_STYLE_BUTTON_TAB_SELECTED.clone());return s.style.fill=e.COLOR_DARK_GREY,s.style.lineHeight=20,s.style.dropShadow=!1,s.x=i.right+10,s.y=i.height-s.height>>1,r.videoContent.addChild(s),r.videoContent.hitArea=new PIXI.Rectangle(0,0,r.videoContent.width,r.videoContent.height),r.btAccount=new e.ui.IconButton(r.game,"account",loc("bt_account")),r.btAccount.tfLabel.style.wordWrap=!0,r.btAccount.tfLabel.style.breakWords=!0,r.btAccount.tfLabel.style.wordWrapWidth=r.btAccount.width,r.btAccount.on(gf.CLICK,r.onAccount,r),r.btAccount.y=e.PADDING,r.btAccount.visible=!1,r.addChild(r.btAccount),r.accountMenu=new e.ui.AccountMenu(r.game),r.accountMenu.y=r.bg.bottom,r.accountMenu.visible=!1,r.addChild(r.accountMenu),r.btMenu=new e.ui.IconButton(r.game,"menu",loc("bt_menu")),r.btMenu.on(gf.CLICK,r.onMenu,r),r.btMenu.y=e.PADDING,r.addChild(r.btMenu),r.topMenu=new e.ui.TopMenu(r.game),r.topMenu.y=r.bg.bottom,r.topMenu.visible=!1,r.addChild(r.topMenu),r.btLogin=new e.ui.IconButton(r.game,"login",loc("bt_login")),r.btLogin.on(gf.CLICK,r.onLogin,r),r.btLogin.y=e.PADDING,r.addChild(r.btLogin),r.btShop=new e.ui.IconButton(r.game,"shop",loc("bt_shop"),!0),r.btShop.on(gf.CLICK,r.onShop,r),r.btShop.y=e.PADDING,r.btShop.visible=r.game.client.config.isShopAvailable||r.game.client.config.isRussian,r.addChild(r.btShop),r.trackMenu=new e.ui.TrackMenu(r.game),r.trackMenu.hide(),r.addChild(r.trackMenu),mUser.on("loggedIn",r.onUserStatus,r),mUser.on("logout",r.onUserStatus,r),r.game.screens.on(gf.SCREEN,r.onScreen,r),r.onUserStatus(),r}return __extends(n,t),n.prototype.onScreen=function(){this.videoContent.visible=this.game.screens.currentName==e.screens.Start.NAME&&!this.game.client.config.isRussian},n.prototype.onUserStatus=function(){this.btLogin.visible=!mUser.isLoggedIn(),this.btAccount.visible=mUser.isLoggedIn(),mUser.isLoggedIn()&&(mTrack.owner||(mTrack.owner=mUser.getUser())),this.getUsername()},n.prototype.getUsername=function(){var e=this;if(!mUser.isLoggedIn())return;casClient.getUserAccount(function(t){e.btAccount.label=t.user.name})},n.prototype.onLogin=function(){track("Header-Login"),this.game.overlays.show(e.overlays.Login.NAME)},n.prototype.onShop=function(){track("Header-Shop"),this.game.client.config.isRussian?mUser.isLoggedIn()?window.open(e.SHOP_LINK_RU,"_blank"):this.game.overlays.show(e.overlays.Login.NAME):this.game.overlays.show(e.overlays.Shop.NAME)},n.prototype.onAccount=function(){track("Header-Account"),this.accountMenu.visible?this.accountMenu.hide():this.accountMenu.show(),this.btAccount.isSelected=this.accountMenu.visible},n.prototype.onMenu=function(){track("Header-Menu"),this.topMenu.visible?this.topMenu.hide():this.topMenu.show(),this.btMenu.isSelected=this.topMenu.visible},n.prototype.onVideo=function(e){this.game.client.showVideo()},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.bg.width=this.game.width,this.btMenu.x=this.game.width-this.btMenu.width-e.PADDING,this.topMenu.x=this.btMenu.x-e.PADDING,this.btLogin.x=this.btAccount.x=this.btMenu.x-this.btAccount.width-e.PADDING,this.accountMenu.x=this.btAccount.x-e.PADDING,this.btShop.x=this.btLogin.x-this.btShop.width-e.PADDING,this.videoContent.height=this.bg.height,this.videoContent.scaleXY=Math.min(1,this.videoContent.scaleY),this.videoContent.x=e.PADDING*2,this.videoContent.y=this.bg.height-this.videoContent.height>>1,this.trackMenu.onResize()},n.prototype.hide=function(){this.trackMenu.visible&&this.trackMenu.form.hideDom(),this.visible=!1},n.prototype.show=function(){this.trackMenu.visible&&this.trackMenu.form.showDom(),this.visible=!0},n}(gf.display.Container);t.Header=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t=function(t){function n(){var n=t!==null&&t.apply(this,arguments)||this;return n.FooterClass=e.ui.Footer,n.HeaderClass=e.ui.Header,n.canvasDomId="game",n.cheat=!1,n.hasEndless=!1,n.hasInbox=!1,n.hasLives=!1,n.hasLogin=!1,n.isRussian=!0,n.isShopAvailable=!1,n.lowQuality=!1,n.minHeight=421,n.muteFxDefault=!0,n.muteMusicDefault=!0,n.roundPixels=!0,n.useAntiAlias=!0,n.overlays=[e.overlays.Abo,e.overlays.AboChanged,e.overlays.AboTerminate,e.overlays.Account,e.overlays.AddSets,e.overlays.ChangePassword,e.overlays.Competition,e.overlays.CompetitionApply,e.overlays.CompetitionGoals,e.overlays.CompetitionNew,e.overlays.CompetitionRanking,e.overlays.Confirm,e.overlays.Contact,e.overlays.EduTrackTask,e.overlays.FinishRegister,e.overlays.ForgotPassword,e.overlays.Gifts,e.overlays.Imprint,e.overlays.LegacyUser,e.overlays.Loader,e.overlays.Login,e.overlays.LoginToSave,e.overlays.LowQuality,e.overlays.Message,e.overlays.NewComment,e.overlays.PaymentFailed,e.overlays.PaymentSuccess,e.overlays.Publish,e.overlays.Register,e.overlays.ResetPassword,e.overlays.RevokeFailed,e.overlays.SaveChanges,e.overlays.SelectSets,e.overlays.Shop,e.overlays.TrackDetails,e.overlays.TrackDetailsIngame],n.screens=[e.screens.Game,e.screens.Start],n}return __extends(n,t),n.prototype.addAssets=function(e){e.game.loader.json("language","js/data/lang_"+this.language+".json"),e.game.loader.json("countries","js/data/countries.json"),e.game.loader.json("sets","js/data/sets.json"),e.game.loader.atlas("sprites","img/sprites.png","js/data/sprites.json"),e.game.loader.atlas("sprites-sets","img/sprites-sets.png","js/data/sprites-sets.json"),this.language=="ru"?(e.game.loader.woff("avenir","fonts/avenir-next-cyr-light.woff"),e.game.loader.woff("avenir-heavy","fonts/avenir-next-cyr-demi.woff")):(e.game.loader.woff("avenir","fonts/avenir-next-cyr-light.woff"),e.game.loader.woff("avenir-heavy","fonts/avenir-next-cyr-demi.woff")),e.game.loader.audiosprite("fx","snd/fx.mp3","snd/fx.json"),e.game.loader.audiosprite("rolling","snd/rolling.mp3","snd/rolling.json"),e.game.loader.audiosprite("in","snd/in.mp3","snd/in.json"),e.game.loader.audiosprite("out","snd/out.mp3","snd/out.json"),e.game.loader.image("logo","img/logo.png"),e.game.loader.image("logoBg","img/logo_bg.jpg")},n.prototype.onRun=function(e){},n}(gf.core.Config);e.Config=t})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(){function t(){}return t.loadTrack=function(t,n,r,i){var s=this;i===void 0&&(i=!1),mTrack=n,mUser.isLoggedIn()&&n.owner.id!=mUser.getUserId()&&!r&&(mTrack.data.competition&&(mTrack.data.competition.id=null),mTrack.data.previousId=mTrack.id),r?(mTrack.owner=mUser.getUser(),sTrack.generateUniqueRandomName(loc("trackname_prefix"),function(e){mTrack.name=e,mTrack.data.competition&&(mTrack.data.competition.id=null),mTrack.data.previousId=mTrack.id,mTrack.id=null,mTrack.isPublished=!1,t.stage.header.trackMenu.trackName.value=mTrack.name,s.switchScreen(t,i)})):n.owner&&mUser.isLoggedIn()&&n.owner.id!=mUser.getUserId()?(mTrack.data.competition&&(mTrack.data.competition.id=null),mTrack.data.previousId=mTrack.id,t.stage.header.trackMenu.trackName.value=mTrack.name,this.switchScreen(t,i)):mTrack.data.competition&&mTrack.data.competition.id&&mTrack.id?mTrack.isSubmitted?(mTrack.data.competition.id=null,mTrack.data.previousId=mTrack.id,t.stage.header.trackMenu.trackName.value=mTrack.name,this.switchScreen(t,i)):sCompetition.canSubmit(mTrack.data.competition.id,mTrack.id,function(n){if(n!=kr3m.SUCCESS){if(n=="ERROR_ALREADY_PARTICIPATED"){var r=t.overlays.show(e.overlays.Message.NAME);r.text=loc("competition_submit_already_participated")}else if(n=="ERROR_EXPIRED"){var r=t.overlays.show(e.overlays.Message.NAME);r.text=loc("competition_submit_expired"),mTrack.data.competition.expired=!0}mTrack.data.competition.id=null,mTrack.data.previousId=mTrack.id}t.stage.header.trackMenu.trackName.value=mTrack.name,s.switchScreen(t,i)}):(mTrack.data.previousId=mTrack.id,t.stage.header.trackMenu.trackName.value=mTrack.name,this.switchScreen(t,i))},t.switchScreen=function(t,n){n===void 0&&(n=!1);if(t.screens.currentName!=e.screens.Game.NAME){var r=t.screens.show(e.screens.Game.NAME);r.once(gf.TRANSITION_IN_COMPLETE,function(){r.playground.once(e.PLAYGROUND_READY,function(){r.layers.update(),n&&r.playground.save()}),r.playground.reset(),r.bottomMenu.start(),r.playground.start()})}else{var i=t.screens.current;i.playground.stop(),i.playground.once(e.PLAYGROUND_READY,function(){i.layers.update(),n&&i.playground.save()}),i.playground.reset(),i.bottomMenu.start(),i.playground.start()}},t}();t.Loader=n})(t=e.core||(e.core={}))})(cuboro||(cuboro={}));var cuboro;(function(e){var t;(function(t){var n=function(t){function n(n){var r=t.call(this,n)||this;return r.border=new gf.display.Sprite(r.game,PIXI.Texture.WHITE),r.border.x=-2,r.border.y=-2,r.border.width=404,r.border.height=54,r.addChild(r.border),r.bg=new gf.display.Sprite(r.game,PIXI.Texture.WHITE),r.bg.tint=e.COLOR_YELLOW,r.bg.width=400,r.bg.height=50,r.addChild(r.bg),r.queue=[],r.addCloseButton(),r.addTextFields(),r.visible=!1,r}return __extends(n,t),n.prototype.addTextFields=function(){this.tfTitle=new gf.display.Text(this.game,"",e.TEXT_STYLE_TITLE_TAB.clone()),this.tfTitle.style.wordWrap=!0,this.tfTitle.style.wordWrapWidth=this.btClose.x-e.PADDING*2,this.tfTitle.x=e.PADDING,this.tfTitle.y=e.PADDING*2,this.addChild(this.tfTitle),this.tfMessage=new gf.display.Text(this.game,"",e.TEXT_STYLE_SMALL.clone()),this.tfMessage.style.wordWrap=!0,this.tfMessage.style.wordWrapWidth=this.btClose.x-e.PADDING*2,this.tfMessage.x=e.PADDING,this.tfMessage.y=this.tfTitle.bottom+e.PADDING,this.addChild(this.tfMessage)},n.prototype.addCloseButton=function(){this.btClose=new e.ui.CloseButton(this.game),this.btClose.on(gf.CLICK,this.hide,this),this.btClose.x=this.bg.right-this.btClose.width-e.PADDING*2,this.btClose.y=e.PADDING*2+2,this.btClose.overColor=e.COLOR_WHITE,this.addChild(this.btClose)},n.prototype.show=function(t,n){this.visible?this.queue.push({title:t,message:n}):(this.tfTitle.text=t,this.tfMessage.text=n,this.tfMessage.y=this.tfTitle.bottom+e.PADDING,this.bg.height=this.tfMessage.bottom+e.PADDING*4,this.border.height=this.bg.height+4,this.x=this.game.width-this.bg.width>>1,this.y=this.game.height,TweenMax.to(this,.25,{y:this.game.height-this.bg.height+e.PADDING*2,ease:Back.easeOut}),this.visible=!0)},n.prototype.hide=function(){var e=this;TweenMax.to(this,.25,{y:this.game.height,ease:Back.easeIn,onComplete:function(){e.visible=!1;if(e.queue.length>0){var t=e.queue.shift();e.show(t.title,t.message)}}})},n.prototype.onResize=function(){t.prototype.onResize.call(this),this.x=this.game.width-this.bg.width>>1,this.y=this.game.height-this.bg.height+e.PADDING*2},n}(gf.display.Container);t.Hint=n})(t=e.ui||(e.ui={}))})(cuboro||(cuboro={}));var gf;(function(e){var t;(function(t){t.LEFT=37,t.UP=38,t.RIGHT=39,t.DOWN=40;var n=function(){function t(){}return t.add=function(t){var n=this;t.data||(t.data={}),t.data.buttonMode=t.buttonMode,t.data.interactive=t.interactive,t.data.interactiveChildren=t.interactiveChildren,t.buttonMode=!0,t.interactive=!0,t.interactiveChildren=!0,t.data.downListener=function(e){logDebug(t),n._currentDisplay&&n.removeMovement(n._currentDisplay),n._currentDisplay=t,n.addMovement(t),n.onDown(e,t)},t.data.upListener=function(e){n.onUp(e,t)},t.on("mousedown touchstart",t.data.downListener),t.on("mouseup mouseupoutside touchend touchendoutside",t.data.upListener);var r=t.getLocalBounds(),i=new e.display.Graphics(t.game);i.lineStyle(2,16711935,.5),i.f(16711935,0).dr(r.x,r.y,r.width,r.height).ef(),t.addChildAt(i,0),t.data.debug=i},t.remove=function(e){if(!e.data||!e.data.debug)return;e.removeChild(e.data.debug),e.buttonMode=e.data.buttonMode,e.interactive=e.data.interactive,e.interactiveChildren=e.data.interactiveChildren,this.removeMovement(e),e.off("mousedown touchstart",e.data.downListener),e.off("mouseup mouseupoutside touchend touchendoutside",e.data.upListener)},t.addMovement=function(t){t.data.movementLeft=function(){t.x-=1,logDebug(t.x+", "+t.y,t)},t.data.movementRight=function(){t.x+=1,logDebug(t.x+", "+t.y,t)},t.data.movementUp=function(){t.y-=1,logDebug(t.x+", "+t.y,t)},t.data.movementDown=function(){t.y+=1,logDebug(t.x+", "+t.y,t)},t.data.leftId=e.utils.Keyboard.add(function(){return t.data.movementLeft()},e.utils.LEFT),t.data.rightId=e.utils.Keyboard.add(function(){return t.data.movementRight()},e.utils.RIGHT),t.data.upId=e.utils.Keyboard.add(function(){return t.data.movementUp()},e.utils.UP),t.data.downId=e.utils.Keyboard.add(function(){return t.data.movementDown()},e.utils.DOWN)},t.removeMovement=function(t){e.utils.Keyboard.remove([t.data.leftId,t.data.rightId,t.data.upId,t.data.downId])},t.onDown=function(e,t){this.onDragStart(e,t)},t.onMove=function(e,t){t.data&&t.data.isDragging?this.onDragMove(e,t):this.onDragStart(e,t)},t.onUp=function(e,t){t.data.isDragging&&(this.onDragStop(e,t),t.removeListener("mousemove",t.data.moveListener),t.removeListener("touchmove",t.data.moveListener))},t.onDragStart=function(e,t){var n=this;t.data.isDragging=!0,t.data.dragData=e.data,t.data.dragStart=t.data.dragData.getLocalPosition(t).clone(),t.data.moveListener=function(e){n.onMove(e,t)},t.on("mousemove touchmove",t.data.moveListener)},t.onDragMove=function(e,t){if(t.data.isDragging){var n=e.data.getLocalPosition(t.parent);t.x=Math.round(n.x-t.data.dragStart.x),t.y=Math.round(n.y-t.data.dragStart.y)}},t.onDragStop=function(e,t){t.data.isDragging=!1,logDebug(t.x+", "+t.y,t)},t.domLog=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];this._dom||(this._dom=document.createElement("div"),this._dom.style.cssText="position:fixed;display:block;top:0;left:0;height:200px;overflow:auto;cursor:pointer;opacity:0.9;z-index:10000;background-color:#fff;color:#000;font-size:10px;padding:2px;",document.body.appendChild(this._dom)),this._dom.innerHTML+=(this._dom.innerText.length!=0?"<br>":"")+e.join(","),this._dom.scrollTop=this._dom.scrollHeight},t}();t.Debug=n})(t=e.utils||(e.utils={}))})(gf||(gf={}));var gf;(function(e){var t;(function(t){var n=function(){function t(){}return t.update=function(){this._frames++;var e=(performance||Date).now();e>this._prevTime+1e3&&(this._fps=this._frames*1e3/(e-this._prevTime),this._prevTime=e,this._frames=0,this._total.push(this._fps),this._total.length>60&&(this._total=[this.average]),this._dom&&(this._dom.innerText="FPS: "+Math.round(this._fps)+" (∅ "+Math.round(this.average)+")"))},t.reset=function(){this._frames=0,this._prevTime=(performance||Date).now(),this._total=[]},t.add=function(t){if(this._isAdded)return;this._isAdded=!0,this.reset(),t.ticker.add(this.update,this),t.on(e.FOCUS,this.reset,this)},t.remove=function(t){this._isAdded=!1,t.ticker.remove(this.update,this),t.off(e.FOCUS,this.reset,this)},t.addToDom=function(e){this._isAdded||this.add(e),this._dom=document.createElement("div"),this._dom.style.cssText="position:fixed;display:block;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000;background-color:#fff;color:#000;font-size:10px;padding:2px;",document.body.appendChild(this._dom)},Object.defineProperty(t,"fps",{get:function(){return this._fps},enumerable:!0,configurable:!0}),Object.defineProperty(t,"average",{get:function(){return this._total.reduce(function(e,t){return e+t},0)/this._total.length},enumerable:!0,configurable:!0}),t.removeFromDOM=function(e){this._isAdded&&(this.remove(e),document.body.removeChild(this._dom))},t}();t.FPS=n})(t=e.utils||(e.utils={}))})(gf||(gf={}));var kr3m;(function(e){var t;(function(t){var n=function(){function t(){}return t.email=function(t){return t?e.REGEX_EMAIL.test(t):!1},t.date=function(e,t,n){var r=new Date(n,t-1,e);return r.getFullYear()==n&&r.getMonth()+1==t&&r.getDate()==e},t.username=function(t){return t?e.REGEX_USERNAME.test(t):!1},t.deviceId=function(t){return t?e.REGEX_DEVICE_ID.test(t):!1},t.url=function(t){return t?e.REGEX_URL.test(t):!1},t.dataUrl=function(t){return t?e.REGEX_DATA_URL.test(t):!1},t.isInt=function(t){return t?e.REGEX_INTEGER.test(t):!1},t.isFloat=function(t){return t?e.REGEX_FLOAT.test(t):!1},t.getPasswordSecurity=function(e){var n=3;for(var r=n;r>=0;--r)if(t.securePassword(e,r))return r/n;return 0},t.securePassword=function(t,n){n===void 0&&(n=e.PASSWORD_SECURITY_LOW);if(!t)return!1;if(n<=e.PASSWORD_SECURITY_NONE)return!0;if(t.length<4)return!1;if(n<=e.PASSWORD_SECURITY_LOW)return!0;if(t.length<6)return!1;if(n<=e.PASSWORD_SECURITY_MEDIUM)return!0;if(t.length<8)return!1;var r={digits:/\d/,capitalLetters:/[A-Z]/,letters:/[a-z]/},i={digits:0,capitalLetters:0,letters:0,others:0};for(var s=0;s<t.length;++s){var o=t.substr(s,1),u=!1;for(var a in r)r[a].test(o)&&(++i[a],u=!0);u||++i.others}return i.digits<=0||i.capitalLetters<=0||i.others<=0?!1:!0},t}();t.Validator=n})(t=e.util||(e.util={}))})(kr3m||(kr3m={}));var Client=function(e){function t(){var t=e.call(this)||this;return mConfig.getLanguages(function(e){kr3m.loading.Loader2.getInstance().loadFile("js/data/config.json?_="+cuboro.VERSION,function(n){t.config=$.extend({},new cuboro.Config,n),t.config.language=kr3m.util.Browser.getQueryValue("lang")||e[0]&&e[0].id||t.config.language,casClient.setLanguage(t.config.language);var r=kr3m.util.Browser.getBaseUrl();t.config.isRussian=r.indexOf("cuboro-ru")!=-1||r.indexOf("cuboro-webkit.ru")!=-1;switch(t.config.language){case"de":case"ch":t.supportedLanguage="de";break;case"ru":t.supportedLanguage="ru";break;default:t.supportedLanguage="en"}t.game=new gf.core.Game(t),t.game.loader.on(gf.LOAD_PROGRESS,t.onLoadProgress,t),t.game.loader.once(gf.LOAD_COMPLETE,t.onLoadComplete,t),t.config.addAssets(t),t.game.loader.start(),casClient.on(cas.POPUP_EMAIL_VALIDATED,function(e){t.popupType=cas.POPUP_EMAIL_VALIDATED,t.popupData=e,t.clientReady&&t.showPop()}),casClient.on(cas.POPUP_RESET_PASSWORD,function(e){t.popupType=cas.POPUP_RESET_PASSWORD,t.popupData=e,t.clientReady&&t.showPop()}),casClient.on(cas.POPUP_EMAIL_REMINDER,function(e){t.popupType=cas.POPUP_EMAIL_REMINDER,t.popupData=e,t.clientReady&&t.showPop()})})}),t}return __extends(t,e),t.prototype.onLoadProgress=function(){$("#progress").text(this.game.loader.progress+"%"),$("#bar").width(this.game.loader.progress+"%")},t.prototype.onLoadComplete=function(){var e=this;this.game.loader.off(gf.LOAD_PROGRESS,this.onLoadProgress),mConfig.isShopAvailable(function(t){$("#loader").remove(),e.config.isShopAvailable=t,kr3m.util.Localization.fallback=e.config.language,kr3m.util.Localization.language=e.config.language,kr3m.util.Localization.addJSONModule(e.game.cache.getJSON("language"),e.config.language),setToken("pixi",PIXI.VERSION),setToken("three",THREE.REVISION),setToken("renderer",e.game.renderer.type==PIXI.RENDERER_TYPE.CANVAS?"Canvas":"WebGL"),log(loc("say_hello",{name:loc("app_title"),version:cuboro.VERSION})),e.game.once(gf.RUNNING,e.onRun,e),e.game.start()})},t.prototype.onRun=function(){var e=this;log(this.game),this.hint=new cuboro.ui.Hint(this.game),this.game.stage.addChild(this.hint);if(PIXI.utils.isMobile.any){var t=new cuboro.overlays.Orientation(this.game);t.checkOrientation(),this.game.stage.addChild(t)}var n=parseInt(kr3m.util.Browser.getQueryValue("tid"),10);n?(this.game.overlays.show(cuboro.overlays.Loader.NAME),sTrack.load(n,function(t){e.game.overlays.hide(cuboro.overlays.Loader.NAME),t?cuboro.core.Loader.loadTrack(e.game,t,!1):e.game.screens.show("start")})):this.game.screens.show("start"),this.clientReady=!0,this.popupType&&this.showPop(),(!PIXI.utils.isWebGLSupported()||this.game.renderer.type==PIXI.RENDERER_TYPE.CANVAS)&&this.hint.show(loc("hint_webgl_title"),loc("hint_webgl")),this.game.storage.isSupported||this.hint.show(loc("hint_cookies_title"),loc("hint_cookies")),mUser.isInitialized()||(this.game.overlays.show(cuboro.overlays.Loader.NAME),mUser.once("init",function(){e.game.overlays.hide(cuboro.overlays.Loader.NAME)})),mUser.on("blocked",this.showBlockMessage,this),mUser.isBlocked()&&this.showBlockMessage(),mGift.isInitialized()?this.checkGift():mGift.once(cuboro.clientmodels.Gift.GIFT,function(){e.checkGift()})},t.prototype.showBlockMessage=function(){var e=this.game.overlays.show(cuboro.overlays.Message.NAME);e.text=loc("user_blocked"),this.game.overlays.getOverlay(cuboro.overlays.FinishRegister.NAME).isActive&&this.game.overlays.hide(cuboro.overlays.FinishRegister.NAME)},t.prototype.checkGift=function(){mGift.getGift().show&&this.game.overlays.show(cuboro.overlays.Gifts.NAME),mGift.getGift().showLegacy&&this.game.overlays.show(cuboro.overlays.LegacyUser.NAME)},t.prototype.showPop=function(){if(this.popupType==cas.POPUP_EMAIL_VALIDATED){var e=this.game.overlays.show(cuboro.overlays.Message.NAME);e.text=loc("email_validated")}if(this.popupType==cas.POPUP_RESET_PASSWORD){var e=this.game.overlays.show(cuboro.overlays.ResetPassword.NAME);e.token=this.popupData.token}if(this.popupType==cas.POPUP_EMAIL_REMINDER){var e=this.game.overlays.show(cuboro.overlays.FinishRegister.NAME);e.email=this.popupData.email}},t.prototype.logTotalCubes=function(){var e=0,t=0,n=0,r=this.game.cache.getJSON("sets"),i=function(i){r[cuboro.SETS[i]].forEach(function(n){cuboro.SETS[i]!=cuboro.SETS.WEB_ONE?e+=n[1]:t+=n[1]}),n++};for(var s in cuboro.SETS)i(s);console.log("sets: "+n+", cubes: "+e+", default: "+t+", total: "+(e+t))},t.prototype.showVideo=function(){$(".overlay-video").off().click(function(e){if(!$(e.target).closest(".videoWrapperExt").length){var t=$("#player").attr("src").replace("&autoplay=1","");$("#player").attr("src",t),$(".overlay-video").removeClass("o1"),setTimeout(function(){$(".overlay-video").hide()},600)}});var e=this.game.client.config.language=="de"?"https://www.youtube.com/embed/2CrbO48BmZA":"https://www.youtube.com/embed/NmBGfW4sYiI";$(".overlay-video").show(),setTimeout(function(){$(".overlay-video").addClass("o1"),$("#player").attr("src",e)},100)},t}(gf.Client);window.client=new Client;